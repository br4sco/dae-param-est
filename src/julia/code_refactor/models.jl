module DynamicalModels

import Interpolations
using DifferentialEquations: DAESolution
using LinearAlgebra: ⋅  # dot product

const func_type = Interpolations.Extrapolation

struct Model
    f!::Function                  # residual function
    jac!::Function                # jacobian function
    x0::Vector{Float64}           # initial values of x
    dx0::Vector{Float64}          # initial values of x'
    dvars::Array{Bool, 1}         # bool array indicating differential variables
    ic_check::Vector{Float64}     # residual at t0 (DEBUG)
end

struct Model_ode
    f::Function             # ODE Function
    x0::Vector{Float64}     # initial values of x
end

# When using the version of the adjoint method that approximates the disturbance SDE
# by an ODE to incorporate it into the DAE-system, additional data needs to be passed
# to the model creation function. This data is stored in this struct.
struct AdjointSDEApproxData
    xw::Function
    v::Function
    # TODO: Generally, but especially when having many free disturbance parameters, the below matrices will be very sparse.
    # It would be wise to use a sparse matrix implementation instead. That's a future project though.
    Ǎη::AbstractMatrix{Float64}
    B̌η::AbstractMatrix{Float64}
    Čη::AbstractMatrix{Float64}
    Ǎ::AbstractMatrix{Float64}
    Č::AbstractMatrix{Float64}
    # TODO: Now that I have introduced Ǎ in here, I don't think we need ρ anymore. But maybe check performance to make sure.
    ρ::Vector{Float64}  # Contains all disturbance parameters, both free and known
    na::Int64           # Number of the disturbance parameters that correspond to the a-parameters
    nxw::Int64          # Dimension of xw
    nw::Int64           # Dimension of w
    nη::Int64           # Number of unknown disturbance parameters
end

# TODO: Now that you make models disturbace model agnostic, you should be more explicit that all models assume B not parametrized! Make comments more helpful, why isn't B in formulas?

# Just for delta robot
struct DeltaInitData
    H::Matrix{Float64}
    m1::Matrix{Float64}
    m2::Matrix{Float64}
    m3::Matrix{Float64}
    HinvM::Matrix{Float64}
    cgBu::Vector{Float64}
end

################################ PENDULUM MODELS ################################
# NOTE: Used to be called pendulum_new
function pendulum(u::Function, w::Function, pars::Vector{Float64}, model_data::NamedTuple)::Model
    let m = pars[1], L = pars[2], g = pars[3], k = pars[4]

        # the residual function
        function f!(res, dx, x, _, t)
            wt = w(t)
            ut = u(t)
            # Dynamic Equations
            res[1] = dx[1] - x[4] + 2dx[6]*x[1]
            res[2] = dx[2] - x[5] + 2dx[6]*x[2]
            res[3] = m*dx[4] - dx[3]*x[1] + k*abs(x[4])*x[4] - ut[1] - wt[1]^2
            res[4] = m*dx[5] - dx[3]*x[2] + k*abs(x[5])*x[5] + m*g
            res[5] = x[1]^2 + x[2]^2 - L^2
            res[6] = x[4]*x[1] + x[5]*x[2]
            # Equation for obtaining angle
            res[7] = x[7] - atan(x[1] / -x[2])
            nothing
        end

        # Finding consistent initial conditions
        x0, dx0 = get_pendulum_initial(pars, u(0.0)[1], w(0.0)[1], model_data.φ0)

        dvars = vcat(fill(true, 6), [false])

        r0 = zeros(length(x0))
        f!(r0, dx0, x0, [], 0.0)

        # t -> 0.0 is just a dummy function, not to be used
        Model(f!, t -> 0.0, x0, dx0, dvars, r0)
    end
end

# -------------------- Forward sensitivity models ---------------------------

# NOTE: Used to be called pendulum_sensitivity_m
function pendulum_forward_m(u::Function, w::Function, pars::Vector{Float64}, model_data::NamedTuple)::Model
    let m = pars[1], L = pars[2], g = pars[3], k = pars[4]

        # the residual function
        function f!(res, dx, x, _, t)
            wt = w(t)
            ut = u(t)
            # Dynamic Equations
            res[1] = dx[1] - x[4] + 2dx[6]*x[1]
            res[2] = dx[2] - x[5] + 2dx[6]*x[2]
            res[3] = m*dx[4] - dx[3]*x[1] + k*abs(x[4])*x[4] - ut[1] - wt[1]^2
            res[4] = m*dx[5] - dx[3]*x[2] + k*abs(x[5])*x[5] + m*g
            res[5] = x[1]^2 + x[2]^2 - L^2
            res[6] = x[4]*x[1] + x[5]*x[2]
            # Angle of pendulum
            res[7] = x[7] - atan(x[1] / -x[2])
            # Sensitivity with respect to m
            res[8]  = -x[11] + dx[8] + 2x[1]*dx[13] + 2x[8]*dx[6]
            res[9]  = -x[12] + dx[9] + 2x[2]*dx[13] + 2x[9]*dx[6]
            res[10] = 2k*x[11]*abs(x[4]) - x[1]*dx[10] + m*dx[11] - x[8]*dx[3] + dx[4]
            res[11] = 2k*x[12]*abs(x[5]) - x[2]*dx[10] + m*dx[12] - x[9]*dx[3] + g + dx[5]
            res[12] = -2x[8]*x[1] - 2x[9]*x[2]
            res[13] = x[11]*x[1] + x[12]*x[2] + x[8]*x[4] + x[9]*x[5]
            res[14] = x[14] - (x[1]*x[9] - x[2]*x[8])/(L^2)

            nothing
        end
        
        u0 = u(0.0)[1]
        w0 = w(0.0)[1]
        pend0, dpend0 = get_pendulum_initial(pars, u0, w0, model_data.φ0)
        sm0, dsm0 = get_pendulum_initial_msens(pars, u0, w0, model_data.φ0, pend0, dpend0)

        x0  = vcat(pend0, sm0)
        dx0 = vcat(dpend0, dsm0)

        dvars = vcat(fill(true, 6), [false], fill(true, 6), [false])

        r0 = zeros(length(x0))
        f!(r0, dx0, x0, [], 0.0)

        # t -> 0.0 is just a dummy function, not to be used
        Model(f!, t -> 0.0, x0, dx0, dvars, r0)
    end
end

function pendulum_forward_k(u::Function, w::Function, pars::Vector{Float64}, model_data::NamedTuple)::Model
    let m = pars[1], L = pars[2], g = pars[3], k = pars[4]

        # the residual function
        function f!(res, dx, x, _, t)
            wt = w(t)
            ut = u(t)
            # Dynamic Equations
            res[1] = dx[1] - x[4] + 2dx[6]*x[1]
            res[2] = dx[2] - x[5] + 2dx[6]*x[2]
            res[3] = m*dx[4] - dx[3]*x[1] + k*abs(x[4])*x[4] - ut[1] - wt[1]^2
            res[4] = m*dx[5] - dx[3]*x[2] + k*abs(x[5])*x[5] + m*g
            res[5] = x[1]^2 + x[2]^2 - L^2
            res[6] = x[4]*x[1] + x[5]*x[2]
            # Angle of pendulum
            res[7] = x[7] - atan(x[1] / -x[2])
            # Sensitivity Equations (wrt k)
            res[8]  = -x[11] + dx[8] + 2x[1]*dx[13] + 2x[8]*dx[6]
            res[9]  = -x[12] + dx[9] + 2x[2]*dx[13] + 2x[9]*dx[6]
            res[10] = abs(x[4])*x[4] + 2k*x[11]*abs(x[4]) - x[1]*dx[10] + m*dx[11] - x[8]*dx[3]
            res[11] = abs(x[5])*x[5] + 2k*x[12]*abs(x[5]) - x[2]*dx[10] + m*dx[12] - x[9]*dx[3]
            res[12] = -2x[8]*x[1] - 2x[9]*x[2]
            res[13] = x[11]*x[1] + x[12]*x[2] + x[8]*x[4] + x[9]*x[5]
            # Sensitivity of angle of pendulum
            res[14] = x[14] - (x[1]*x[9] - x[8]*x[2])/(L^2)

            nothing
        end

        u0 = u(0.0)[1]
        w0 = w(0.0)[1]
        pend0, dpend0 = get_pendulum_initial(pars, u0, w0, model_data.φ0)
        sk0, dsk0 = get_pendulum_initial_ksens(pars, u0, w0, model_data.φ0, pend0, dpend0)
        x0  = vcat(pend0, sk0)
        dx0 = vcat(dpend0, dsk0)

        dvars = vcat(fill(true, 6), [false], fill(true, 6), [false])

        r0 = zeros(length(x0))
        f!(r0, dx0, x0, [], 0.0)

        # t -> 0.0 is just a dummy function, not to be used
        Model(f!, t -> 0.0, x0, dx0, dvars, r0)
    end
end

function pendulum_forward_k_1dist(u::Function, w::Function, pars::Vector{Float64}, model_data::NamedTuple)::Model
    let m = pars[1], L = pars[2], g = pars[3], k = pars[4]

        # the residual function
        function f!(res, dx, x, _, t)
            wt = w(t)
            ut = u(t)
            # Dynamic Equations
            res[1] = dx[1] - x[4] + 2dx[6]*x[1]
            res[2] = dx[2] - x[5] + 2dx[6]*x[2]
            res[3] = m*dx[4] - dx[3]*x[1] + k*abs(x[4])*x[4] - ut[1] - wt[1]^2
            res[4] = m*dx[5] - dx[3]*x[2] + k*abs(x[5])*x[5] + m*g
            res[5] = x[1]^2 + x[2]^2 - L^2
            res[6] = x[4]*x[1] + x[5]*x[2]
            # Angle of pendulum
            res[7] = x[7] - atan(x[1] / -x[2])

            # Sensitivity with respect to k
            res[8]  = -x[11] + dx[8] + 2x[1]*dx[13] + 2x[8]*dx[6]
            res[9]  = -x[12] + dx[9] + 2x[2]*dx[13] + 2x[9]*dx[6]
            res[10] = 2k*x[11]*abs(x[4]) - x[1]*dx[10] + m*dx[11] - x[8]*dx[3] + abs(x[4])x[4]
            res[11] = 2k*x[12]*abs(x[5]) - x[2]*dx[10] + m*dx[12] - x[9]*dx[3] + abs(x[5])x[5]
            res[12] = -2x[8]*x[1] - 2x[9]*x[2]
            res[13] = x[11]*x[1] + x[12]*x[2] + x[8]*x[4] + x[9]*x[5]
            res[14] = x[14] - (x[1]*x[9] - x[2]*x[8])/(L^2)

            # Sensitivty wrt first disturbance parameter
            # (i.e. parameter corresponding to wt[2])
            res[15] = 2dx[6]x[15] - x[18] + dx[15] + 2x[1]dx[20]
            res[16] = 2dx[6]x[16] - x[19] + dx[16] + 2x[2]dx[20]
            res[17] = -dx[3]x[15] + 2k*abs(x[4])*x[18] - x[1]*dx[17] + m*dx[18] - 2*wt[1]*wt[2]
            res[18] = -dx[3]x[16] + 2k*abs(x[5])*x[19] - x[2]*dx[17] + m*dx[19]
            res[19] = 2x[1]x[15] + 2x[2]x[16]
            res[20] = x[4]x[15] + x[5]x[16] + x[1]x[18] + x[2]x[19]
            # Sensitivity of angle of pendulum to disturbance parameter
            res[21] = x[21] - (x[1]*x[16] - x[2]*x[15])/(L^2)

            nothing
        end

        u0 = u(0.0)[1]
        w0 = w(0.0)[1]
        pend0, dpend0 = get_pendulum_initial(pars, u0, w0, model_data.φ0)
        sk0, dsk0 = get_pendulum_initial_ksens(pars, u0, w0, model_data.φ0, pend0, dpend0)
        r0, dr0 = get_pendulum_initial_distsens(pars, u0, w0, model_data.φ0, pend0, dpend0)

        x0  = vcat(pend0, sk0, r0)
        dx0 = vcat(dpend0, dsk0, dr0)

        dvars = repeat(vcat(fill(true, 6), [false]), 3)

        r0 = zeros(length(x0))
        f!(r0, dx0, x0, [], 0.0)

        # t -> 0.0 is just a dummy function, not to be used
        Model(f!, t -> 0.0, x0, dx0, dvars, r0)
    end
end

# -------------------- Adjoint sensitivity models ---------------------------

# NOTE: Used to be called my_pendulum_adjoint_monly
function pendulum_adjoint_m(_::Function, pars::Vector{Float64}, T::Float64, x::func_type, x2::func_type, y::func_type, dy::func_type, xθ0::Matrix{Float64}, dx::func_type, dx2::func_type)::Tuple{Model,Function}
    let m = pars[1], L = pars[2], g = pars[3], k = pars[4]
        nx, nθ = size(xθ0)
        @assert (nθ == 1) "pendulum_adjoint_m is hard-coded to only handle one parameter m, make sure to pass correct xθ0. Currently passing $nθ parameters."
        @assert (nx == 7) "pendulum_adjoint_m expects the DAE state to have 7 components, the passed state has $nx components instead"

        FxT = [2dx(T,6)          0.0            0.0   -1.0              0.0             0.0   0.0
                0.0           2*dx(T,6)         0.0    0.0             -1.0             0.0   0.0
                -dx(T,3)         0.0            0.0   2k*abs(x(T,4))    0.0             0.0   0.0
                0.0            -dx(T,3)         0.0   0.0              2k*abs(x(T,5))  0.0   0.0
                2x(T,1)        2x(T,2)          0.0   0.0              0.0             0.0   0.0
                x(T,4)         x(T,5)           0.0   x(T,1)            x(T,2)          0.0   0.0
                x(T,2)/(L^2)  -x(T,1)/(L^2)     0.0   0.0               0.0             0.0   1.0]
        Fdx = t-> vcat([1.0   0.0   0.0          0.0   0.0     2x(t,1)    0.0
                        0.0   1.0   0.0          0.0   0.0     2x(t,2)    0.0
                        0.0   0.0   -x(t,1)      m     0.0     0.0        0.0
                        0.0   0.0   -x(t,2)      0.0   m       0.0        0.0], zeros(3,7))
        dFdxT = vcat([  0.0   0.0  0.0         0.0   0.0   2dx(T,1)    0.0
                        0.0   0.0  0.0         0.0   0.0   2dx(T,2)    0.0
                        0.0   0.0  -dx(T,1)    0.0   0.0   0.0         0.0
                        0.0   0.0  -dx(T,2)    0.0   0.0   0.0         0.0], zeros(3,7))
        FθT = [.0; .0; dx(T,4); dx(T,5)+g; .0; .0; .0 ;;]
        gₓT  = [.0    .0    .0    .0    .0    .0    2(x2(T,7)-y(T,1))/T]
        dgₓT = [.0    .0    .0    .0    .0    .0    2(dx2(T,7)-dy(T,1))/T]


        # The residual function
        function f!(res, dz, z, _, t)
            # ---------- Adjoint system ----------
            # 0 = dλᵀ Fdx + λᵀ(dFdx - Fx) + gₓ                      # Analytical adjoint system
            # 0 = (dz')*Fdx(t) + (z')*(dFdx(t) - Fx(t)) + gₓ(t)     # Matrix form adjoint system
            # Expanded adjoint system residual equations:
            res[1]  = dz[1] - 2*dx(t,6)*z[1] + dx(t,3)*z[3] - 2*x(t,1)*z[5] - x(t,4)*z[6] - (x(t,2)*z[7])/(L^2)
            res[2]  = dz[2] - 2*dx(t,6)*z[2] + dx(t,3)*z[4] - 2*x(t,2)*z[5] - x(t,5)*z[6] + (x(t,1)*z[7])/(L^2)
            res[3]  = -x(t,1)*dz[3] - x(t,2)*dz[4] - dx(t,1)*z[3] - dx(t,2)*z[4]
            res[4]  = m*dz[3] + z[1] - 2*k*abs(x(t,4))*z[3] - x(t,1)*z[6]
            res[5]  = m*dz[4] + z[2] - 2*k*abs(x(t,5))*z[4] - x(t,2)*z[6]
            res[6]  = 2*x(t,1)*dz[1] + 2*x(t,2)*dz[2] + 2*dx(t,1)*z[1] + 2*dx(t,2)*z[2]
            res[7]  = (2*(x2(t,7) - y(t,1)))/T - z[7]
            # ---------- β-equations ----------
            # 0 = dβᵢ - gθᵢ + λᵀ(Fθᵢ + Fw wθᵢ)   
            res[8]  = dz[8] - z[3]*dx(t,4) - z[4]*(dx(t,5)+g)       # For parameter m, only dβᵢ - λᵀFθᵢ
            nothing
        end

        # At least for the two forms of index 1 DAEs in my licentiate thesis, λd are always differential and λa are always algebraic.
        # λd always correspond to the differential equations in F, which are equations 1,....,18, from which we get the following dinds and ainds
        # The pendulum is an index 1 DAE exactly on one of these forms
        dinds  = 1:4 # Indices of differential variables
        ainds  = 5:7 # Indices of algebraic variables

        ######################## INITIALIZING ADJOINT SYSTEM (Computing terminal values) ####################
        λT, dλT = get_initial_adjoint(dinds, ainds, gₓT, dgₓT, FxT, Fdx(T), dFdxT)
        βT, dβT = get_initial_adjoint_beta(λT, FθT, zeros(nθ))
        z0 = vcat(λT, βT)
        dz0 = vcat(dλT, dβT)

        # Function returning Gθ given adjoint solution
        function get_Gθ(adj_sol::DAESolution)
            # Because the problem is solved backwards in time, the end of the solution corresponds to t=0
            # Gθᵢ = βᵢ(0) + (λᵀFdx xθᵢ)(0)
            adj_sol.u[end][nx+1:nx+nθ] .+ (((adj_sol.u[end][1:nx]')*Fdx(0.0))*xθ0)
        end

        dvars = fill(false, nx+nθ)
        dvars[dinds] .= true
        dvars[end-nθ:end] .= true

        r0 = zeros(length(z0))
        f!(r0, dz0, z0, [], T)
        # @info "r0 is: $r0"

        # t -> 0.0 is just a dummy function, not to be used
        return Model(f!, t -> 0.0, z0, dz0, dvars, r0), get_Gθ
    end
end

function pendulum_adjoint_k_1dist(w::Function, pars::Vector{Float64}, T::Float64, x::func_type, x2::func_type, y::func_type, dy::func_type, xθ0::Matrix{Float64}, dx::func_type, dx2::func_type)::Tuple{Model,Function}
    let m = pars[1], L = pars[2], g = pars[3], k = pars[4]
        nx, nθ = size(xθ0)
        @assert (nθ == 2) "pendulum_adjoint_k_1dist is hard-coded to only handle two parameters, k and one disturbance parameter. Make sure to pass correct xθ0. Currently passing $nθ parameters."
        @assert (nx == 7) "pendulum_adjoint_k_1dist expects the DAE state to have 7 components, the passed state has $nx components instead"

        # Most matrices need only to be evaluated at t=T, because inside f!() we hardcode the equations and don't use these matrices
        FxT = [2dx(T,6)          0.0            0.0   -1.0              0.0             0.0   0.0
                0.0           2*dx(T,6)         0.0    0.0             -1.0             0.0   0.0
                -dx(T,3)         0.0            0.0   2k*abs(x(T,4))    0.0             0.0   0.0
                0.0            -dx(T,3)         0.0   0.0               2k*abs(x(T,5))  0.0   0.0
                2x(T,1)        2x(T,2)          0.0   0.0               0.0             0.0   0.0
                x(T,4)         x(T,5)           0.0   x(T,1)            x(T,2)          0.0   0.0
                x(T,2)/(L^2)  -x(T,1)/(L^2)     0.0   0.0               0.0             0.0   1.0]
        Fdx = t-> vcat([1.0   0.0   0.0          0.0   0.0     2x(t,1)    0.0
                        0.0   1.0   0.0          0.0   0.0     2x(t,2)    0.0
                        0.0   0.0   -x(t,1)      m     0.0     0.0        0.0
                        0.0   0.0   -x(t,2)      0.0   m       0.0        0.0], zeros(3,7))
        dFdxT = vcat([  0.0   0.0  0.0         0.0   0.0   2dx(T,1)    0.0
                        0.0   0.0  0.0         0.0   0.0   2dx(T,2)    0.0
                        0.0   0.0  -dx(T,1)    0.0   0.0   0.0         0.0
                        0.0   0.0  -dx(T,2)    0.0   0.0   0.0         0.0], zeros(3,7))
        FwT = [.0; .0; -2w(T)[1]; .0; .0; .0; .0 ;;]
        FθT = [ .0
                .0
                abs(x(T,4))*x(T,4)
                abs(x(T,5))*x(T,5)
                .0
                .0
                .0 ;;] # NOTE: Just for dynamical parameter
        gₓT  = [.0    .0    .0    .0    .0    .0    2(x2(T,7)-y(T,1))/T]
        dgₓT = [.0    .0    .0    .0    .0    .0    2(dx2(T,7)-dy(T,1))/T]

        # The residual function
        function f!(res, dz, z, _, t)
            # ---------- Adjoint system ----------
            # 0 = dλᵀ Fdx + λᵀ(dFdx - Fx) + gₓ                      # Analytical adjoint system
            # 0 = (dz')*Fdx(t) + (z')*(dFdx(t) - Fx(t)) + gₓ(t)     # Matrix form adjoint system
            # Expanded adjoint system residual equations:
            res[1]  = dz[1] - 2*dx(t,6)*z[1] + dx(t,3)*z[3] - 2*x(t,1)*z[5] - x(t,4)*z[6] - (x(t,2)*z[7])/(L^2)
            res[2]  = dz[2] - 2*dx(t,6)*z[2] + dx(t,3)*z[4] - 2*x(t,2)*z[5] - x(t,5)*z[6] + (x(t,1)*z[7])/(L^2)
            res[3]  = -x(t,1)*dz[3] - x(t,2)*dz[4] - dx(t,1)*z[3] - dx(t,2)*z[4]
            res[4]  = m*dz[3] + z[1] - 2*k*abs(x(t,4))*z[3] - x(t,1)*z[6]
            res[5]  = m*dz[4] + z[2] - 2*k*abs(x(t,5))*z[4] - x(t,2)*z[6]
            res[6]  = 2*x(t,1)*dz[1] + 2*x(t,2)*dz[2] + 2*dx(t,1)*z[1] + 2*dx(t,2)*z[2]
            res[7]  = (2*(x2(t,7) - y(t,1)))/T - z[7]
            # ---------- β-equations ----------
            # 0 = dβᵢ - gθᵢ + λᵀ(Fθᵢ + Fw wθᵢ)                                  # Full analytical form
            res[8] = dz[8] - z[3]*abs(x(t,4))*x(t,4) - z[4]*abs(x(t,5))*x(t,5)  # For parameter k, only dβᵢ - λᵀFθᵢ
            res[9] = dz[9] + 2z[3]*w(t)[1]*w(t)[2]                              # For disturbance parameter, only dβᵢ - λᵀ Fw wθᵢ
            nothing
        end

        # At least for the two forms of index 1 DAEs in my licentiate thesis, λd are always differential and λa are always algebraic.
        # λd always correspond to the differential equations in F, which are equations 1,....,18, from which we get the following dinds and ainds
        # The pendulum is an index 1 DAE exactly on one of these forms
        dinds = 1:4 # Indices of differential variables
        ainds = 5:7 # Indices of algebraic variables

        ######################## INITIALIZING ADJOINT SYSTEM (Computing terminal values) ####################
        λT, dλT = get_initial_adjoint(dinds, ainds, gₓT, dgₓT, FxT, Fdx(T), dFdxT)
        βT, dβT = get_initial_adjoint_beta(λT, FθT, zeros(1))
        βdistT, dβdistT = get_initial_adjoint_beta_dist(λT, FwT, w(T)[2:2], 1)
        z0 = vcat(λT, βT, βdistT)
        dz0 = vcat(dλT, dβT, dβdistT)

        # Function returning Gθ given adjoint solution
        function get_Gθ(adj_sol::DAESolution)::Vector{Float64}
            # Because the problem is solved backwards in time, the end of the solution corresponds to t=0
            # Gθᵢ = βᵢ(0) + (λᵀFdx xθᵢ)(0)
            adj_sol.u[end][nx+1:nx+nθ] .+ (((adj_sol.u[end][1:nx]')*Fdx(0.0))*xθ0)[:]
        end

        dvars = fill(false, nx+nθ)
        dvars[dinds] .= true
        dvars[end-nθ:end] .= true

        r0 = zeros(length(z0))
        f!(r0, dz0, z0, [], T)
        # @info "r0 is: $r0"

        # t -> 0.0 is just a dummy function, not to be used
        return Model(f!, t -> 0.0, z0, dz0, dvars, r0), get_Gθ
    end
end

# -------------------- Adjoint sensitivity models with ODE disturbance model ---------------------------

# NOTE: Additional assumptions are nxw=2, nw=1, only relevant in residual function
function pendulum_adjoint_k_1dist_ODEdist(w::Function, pars::Vector{Float64}, T::Float64, x::func_type, x2::func_type, y::func_type, dy::func_type, xθ0::Matrix{Float64}, dx::func_type, dx2::func_type, ad::AdjointSDEApproxData)::Tuple{Model,Function}
    let m = pars[1], L = pars[2], g = pars[3], k = pars[4], nxw = ad.nxw, nw = ad.nw
        nθ = size(xθ0,2)
        nx = size(xθ0,1)    # TODO: This should be the number of variables/equations in ADJOINT VERSION of system. So 33 in Delta case. Check your implementation, what is the size of x in delta case? Is it 33???
        ndist = nxw + nw
        @assert (nθ == 2) "pendulum_adjoint_k_1dist_ODEdist is hard-coded to only handle parameters k, and one disturbance parameter. Make sure to pass correct xθ0 (currently passing for $nθ parameters)"

        # Most matrices need only to be evaluated at t=T, because inside f!() we hardcode the equations and don't use these matrices
        FxT = [2dx(T,6)          0.0            0.0   -1.0              0.0             0.0   0.0
                0.0           2*dx(T,6)         0.0    0.0             -1.0             0.0   0.0
                -dx(T,3)         0.0            0.0   2k*abs(x(T,4))    0.0             0.0   0.0
                0.0            -dx(T,3)         0.0   0.0              2k*abs(x(T,5))  0.0   0.0
                2x(T,1)        2x(T,2)          0.0   0.0              0.0             0.0   0.0
                x(T,4)         x(T,5)           0.0   x(T,1)            x(T,2)          0.0   0.0
                x(T,2)/(L^2)  -x(T,1)/(L^2)     0.0   0.0               0.0             0.0   1.0]
        Fdx = t-> vcat([1.0   0.0   0.0          0.0   0.0     2x(t,1)    0.0
                        0.0   1.0   0.0          0.0   0.0     2x(t,2)    0.0
                        0.0   0.0   -x(t,1)      m     0.0     0.0        0.0
                        0.0   0.0   -x(t,2)      0.0   m       0.0        0.0], zeros(3,7))
        dFdxT = vcat([  0.0   0.0  0.0         0.0   0.0   2dx(T,1)    0.0
                        0.0   0.0  0.0         0.0   0.0   2dx(T,2)    0.0
                        0.0   0.0  -dx(T,1)    0.0   0.0   0.0         0.0
                        0.0   0.0  -dx(T,2)    0.0   0.0   0.0         0.0], zeros(3,7))
        Fw(t) = [.0; .0; -2w(t)[1]; .0; .0; .0; .0 ;;]
        FθT = [ .0
                .0
                abs(x(T,4))*x(T,4)
                abs(x(T,5))*x(T,5)
                .0
                .0
                .0 ;;] # NOTE: Just for dynamical parameter
        gₓT  = [.0    .0    .0    .0    .0    .0    2(x2(T,7)-y(T,1))/T]
        dgₓT = [.0    .0    .0    .0    .0    .0    2(dx2(T,7)-dy(T,1))/T]

        # The residual function
        # Note, everything except the residual function is independent of which disturbance model is used.
        # This residual function assumes that the disturbance model has nxw = 2, nw = 1
        function f!(res, dz, z, _, t)
            # ---------- Nominal adjoint system ----------
            # 0 = dλ̇ᵀ Fdx + λᵀ(dFdx - Fx) + gₓ                      # Analytical adjoint system
            # 0 = (dz')*Fdx(t) + (z')*(dFdx(t) - Fx(t)) + gₓ(t)     # Matrix form adjoint system
            # Expanded adjoint system residual equations:
            res[1]  = dz[1] - 2*dx(t,6)*z[1] + dx(t,3)*z[3] - 2*x(t,1)*z[5] - x(t,4)*z[6] - (x(t,2)*z[7])/(L^2)
            res[2]  = dz[2] - 2*dx(t,6)*z[2] + dx(t,3)*z[4] - 2*x(t,2)*z[5] - x(t,5)*z[6] + (x(t,1)*z[7])/(L^2)
            res[3]  = -x(t,1)*dz[3] - x(t,2)*dz[4] - dx(t,1)*z[3] - dx(t,2)*z[4]
            res[4]  = m*dz[3] + z[1] - 2*k*abs(x(t,4))*z[3] - x(t,1)*z[6]
            res[5]  = m*dz[4] + z[2] - 2*k*abs(x(t,5))*z[4] - x(t,2)*z[6]
            res[6]  = 2*x(t,1)*dz[1] + 2*x(t,2)*dz[2] + 2*dx(t,1)*z[1] + 2*dx(t,2)*z[2]
            res[7]  = (2*(x2(t,7) - y(t,1)))/T - z[7]
            # ---------- Disturbance adjoint system ---------- (This part is hard-coded and assumes nxw=2, nw=1)
            # 0 = dλₓᵀ + λₓᵀǍ + λwᵀČ                                 # Analytical form
            # 0 = dzₓ' + (zₓ')*Ǎ + (zw')*Č                          # Matrix form
            res[nx+1:nx+nxw] = dz[nx+1:nx+nxw]' + (z[nx+1:nx+nxw]')*ad.Ǎ + (z[nx+nxw+1:nx+ndist]')*ad.Č
            # 0 = λwᵀ + λᵀFw                                        # Analytical form              
            # 0 = zw' + (z')*Fw(t)                                  # Matrix form
            res[nx+nxw+1:nx+ndist] = z[nx+nxw+1:nx+ndist]' + (z[1:nx]')*Fw(t)

            # ---------- β-equations ----------
            # 0 = dβᵢ - gθᵢ + λᵀFθᵢ + λₓᵀ(Ǎθᵢ*xw(t) + B̌θᵢ*v(t)) + λwᵀČθᵢxw(t)                                     # Analytical form
            res[nx+ndist+1]  = dz[nx+ndist+1] - z[3]*abs(x(t,4))*x(t,4) - z[4]*abs(x(t,5))*x(t,5)                                 # For parameter k, only dβᵢ + λᵀFθᵢ
            res[nx+ndist+2]  = dz[nx+ndist+2] + z[8:9]⋅(ad.Ǎη[1:nxw,:]*ad.xw(t) - ad.B̌η[1:nxw,:]*ad.v(t)) + z[10]⋅(ad.Čη*ad.xw(t))        # For disturbance parameter, only  dβᵢ + λₓᵀ(Ǎθᵢ*xw(t) + B̌θᵢ*v(t)) + λwᵀČθᵢxw(t)

            nothing
        end
        
        # At least for the two forms of index 1 DAEs in my licentiate thesis, λd are always differential and λa are always algebraic.
        # λd always correspond to the differential equations in F, which are equations 1,....,18, from which we get the following dinds and ainds
        # The pendulum is an index 1 DAE exactly on one of these forms
        dinds  = 1:4 # Indices of differential variables
        ainds  = 5:7 # Indices of algebraic variables
        xwinds = 8:9
        ######################## INITIALIZING ADJOINT SYSTEM (Computing terminal values) ####################
        λT, dλT = get_initial_adjoint(dinds, ainds, gₓT, dgₓT, FxT, Fdx(T), dFdxT)
        λdistT, dλdistT = get_initial_adjoint_ODEdist(λT, ad.Č, Fw(T))
        βT, dβT = get_initial_adjoint_beta(λT, FθT, zeros(nθ-ad.nη))
        βdistT, dβdistT = get_initial_adjoint_ODEdistbeta(λdistT[1:ad.nxw], λdistT[ad.nxw+1:end], ad, T, length(w(0.0)))
        z0 = vcat(λT, λdistT, βT, βdistT)
        dz0 = vcat(dλT, dλdistT, dβT, dβdistT)

        # Function returning Gθ given adjoint solution
        function get_Gθ(adj_sol::DAESolution)
            # Because the problem is solved backward in time, the end of the solution corresponds to t=0
            # Gθᵢ = βᵢ(0) + (λᵀFdx xθᵢ)(0) + (λₓᵀ xwθᵢ)(0), though we assume xwθᵢ(0) = 0
            Gθ = adj_sol.u[end][nx+ndist+1:nx+ndist+nθ] + (((adj_sol.u[end][1:nx]')*Fdx(0.0))*xθ0)[:]
        end

        dvars = fill(false, nx+ndist+nθ)
        dvars[dinds] .= true
        dvars[xwinds] .= true
        dvars[end-nθ:end] .= true

        r0 = zeros(length(z0))
        f!(r0, dz0, z0, [], 0.0)
        # @info "r0 is: $r0 here, λ0: $λ0, dλ0: $dλ0"

        # t -> 0.0 is just a dummy function, not to be used
        return Model(f!, t -> 0.0, z0, dz0, dvars, r0), get_Gθ
    end
end

################################ PENDULUM INITIALIZATIONS ################################

function get_pendulum_initial(pars::Vector{Float64}, u0::Float64, w0::Float64, φ0::Float64)::Tuple{Vector{Float64}, Vector{Float64}}
    let m = pars[1], L = pars[2], g = pars[3], k = pars[4]
        x1_0 = L * sin(φ0)
        x2_0 = -L * cos(φ0)
        dx3_0 = (m*g*x2_0 - x1_0*(u0 + w0^2))/(L^2)
        dx4_0 = (dx3_0*x1_0 + u0 + w0^2)/m
        dx5_0 = (dx3_0*x2_0 - m*g)/m

        pend0 = vcat([x1_0, x2_0], zeros(4), [atan(x1_0 / -x2_0)])
        dpend0 = vcat([0., 0., dx3_0, dx4_0, dx5_0], zeros(2))
        pend0, dpend0
    end
end
 
function get_pendulum_initial_msens(pars::Vector{Float64}, u0::Float64, w0::Float64, φ0::Float64, x0::Vector{Float64}, dx0::Vector{Float64})::Tuple{Vector{Float64}, Vector{Float64}}
    let m = pars[1], L = pars[2], g = pars[3], k = pars[4]
        dsm3_0 = g*x0[2]/(L^2)
        dsm4_0 = -(dx0[3]*x0[1] + u0 + w0^2)/(m^2) + (dsm3_0*x0[1])/m
        dsm5_0 = -(dx0[3]*x0[2] - m*g)/(m^2) + (dsm3_0*x0[2] - g)/m
        dsm0 = vcat(zeros(2), [dsm3_0, dsm4_0, dsm5_0, 0., 0.])
        zeros(7), dsm0
    end
end

function get_pendulum_initial_gsens(pars::Vector{Float64}, u0::Float64, w0::Float64, φ0::Float64, x0::Vector{Float64}, dx0::Vector{Float64})::Tuple{Vector{Float64}, Vector{Float64}}
    let m = pars[1], L = pars[2], g = pars[3], k = pars[4]
        dsg3_0 = m*x0[2]/(L^2)
        dsg4_0 = dsg3_0*x0[1]/m
        dsg5_0 = dsg3_0*x0[2]/m - 1
        dsg0 = vcat(zeros(2), [dsg3_0, dsg4_0, dsg5_0], zeros(2))
        zeros(7), dsg0
    end
end

function get_pendulum_initial_Lsens(pars::Vector{Float64}, u0::Float64, w0::Float64, φ0::Float64, x0::Vector{Float64}, dx0::Vector{Float64})::Tuple{Vector{Float64}, Vector{Float64}}
    let m = pars[1], L = pars[2], g = pars[3], k = pars[4]
        dsL3_0 = (-m*g*cos(φ0) - sin(φ0)*(u0+w0^2))/(L^2) - 2*(m*g*x0[2] - x0[1]*(u0+w0^2))/(L^3)
        dsL4_0 = (dsL3_0*x0[1] + dx0[3]*sin(φ0))/m
        dsL5_0 = (dsL3_0*x0[2] - dx0[3]*cos(φ0))/m
        sL0  = vcat([sin(φ0), -cos(φ0)], zeros(5))
        dsL0 = vcat(zeros(2), [dsL3_0, dsL4_0, dsL5_0], zeros(2))
        sL0, dsL0
    end
end

function get_pendulum_initial_ksens(kwargs...)::Tuple{Vector{Float64}, Vector{Float64}}
    zeros(7), zeros(7)
end

################################ DELTA ROBOT MODELS ################################

# Used to be called delta_robot_gc
function delta_robot(u::Function, w::Function, pars::Vector{Float64}, model_data::NamedTuple)::Model
    # g = 0 because this is the gravity-compensated model
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]

        # the residual function
        function f!(res, dz, z, _, t)
            wt = w(t)
            ut = u(t)
            # Dynamic Equations
            res[1] = dz[1]-z[10]+L1*cos(z[1])*dz[27]+L1*cos(z[1])*dz[30]-L1*sin(z[1])*dz[26]-L1*sin(z[1])*dz[29]
            res[2] = dz[2]-z[11]-L2*sin(z[2])*dz[26]-L2*sin(z[2])*dz[29]+L2*cos(z[2])*cos(z[3])*dz[27]+L2*cos(z[2])*cos(z[3])*dz[30]+L2*cos(z[2])*sin(z[3])*dz[25]+L2*cos(z[2])*sin(z[3])*dz[28]
            res[3] = dz[3]-z[12]+L2*cos(z[3])*sin(z[2])*dz[25]+L2*cos(z[3])*sin(z[2])*dz[28]-L2*sin(z[2])*sin(z[3])*dz[27]-L2*sin(z[2])*sin(z[3])*dz[30]
            res[4] = dz[4]-z[13]-L1*cos(z[4])*dz[27]-(L1*sin(z[4])*dz[26])*0.5-(sqrt(3)*L1*sin(z[4])*dz[25])*0.5
            res[5] = dz[5]-z[14]+dz[25]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dz[26]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-L2*cos(z[5])*cos(z[6])*dz[27]
            res[6] = dz[6]-z[15]+(L2*cos(z[6])*sin(z[5])*dz[25])*0.5+L2*sin(z[5])*sin(z[6])*dz[27]-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dz[26])*0.5
            res[7] = dz[7]-z[16]-L1*cos(z[7])*dz[30]-(L1*sin(z[7])*dz[29])*0.5+(sqrt(3)*L1*sin(z[7])*dz[28])*0.5
            res[8] = dz[8]-z[17]+dz[28]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dz[29]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)-L2*cos(z[8])*cos(z[9])*dz[30]
            res[9] = dz[9]-z[18]+(L2*cos(z[9])*sin(z[8])*dz[28])*0.5+L2*sin(z[8])*sin(z[9])*dz[30]+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dz[29])*0.5
            res[10] = dz[10]*(J1+L1^2*(M2+M3)+LC1^2*M1)-ut[1]-wt[1]^2+γ*z[10]-0.0*cos(z[1])*(L1*(M2+M3)+LC1*M1)-L1*cos(z[1])*dz[21]-L1*cos(z[1])*dz[24]+L1*sin(z[1])*dz[20]+L1*sin(z[1])*dz[23]+L1*dz[11]*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*dz[12]*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2)
            res[11] = dz[11]*(J2+L2^2*M3+LC2^2*M2)+γ*z[11]+L2*sin(z[2])*dz[20]+L2*sin(z[2])*dz[23]-L2*cos(z[2])*cos(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[24]-L2*cos(z[2])*sin(z[3])*dz[19]-L2*cos(z[2])*sin(z[3])*dz[22]+L1*dz[10]*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))-cos(z[2])*sin(z[2])*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(z[2])*cos(z[3])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))
            res[12] = γ*z[12]+sin(z[2])^2*dz[12]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[3])*sin(z[2])*dz[19]-L2*cos(z[3])*sin(z[2])*dz[22]+L2*sin(z[2])*sin(z[3])*dz[21]+L2*sin(z[2])*sin(z[3])*dz[24]+sin(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+0.0*sin(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*dz[10]*(L2*M3+LC2*M2)
            res[13] = dz[13]*(J1+L1^2*(M2+M3)+LC1^2*M1)-ut[2]-wt[2]^2+γ*z[13]-0.0*cos(z[4])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[4])*dz[21]+(L1*sin(z[4])*dz[20])*0.5+(sqrt(3)*L1*sin(z[4])*dz[19])*0.5+L1*dz[14]*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)-L1*cos(z[4])*sin(z[5])*sin(z[6])*dz[15]*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2)
            res[14] = dz[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-dz[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)+dz[14]*(J2+L2^2*M3+LC2^2*M2)+γ*z[14]+L2*cos(z[5])*cos(z[6])*dz[21]+L1*dz[13]*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))-cos(z[5])*sin(z[5])*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(z[5])*cos(z[6])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))
            res[15] = γ*z[15]+sin(z[5])^2*dz[15]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(z[6])*sin(z[5])*dz[19])*0.5-L2*sin(z[5])*sin(z[6])*dz[21]+sin(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+0.0*sin(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[6])*sin(z[5])*dz[20])*0.5+L1*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)-L1*cos(z[4])*sin(z[5])*sin(z[6])*dz[13]*(L2*M3+LC2*M2)
            res[16] = dz[16]*(J1+L1^2*(M2+M3)+LC1^2*M1)-ut[3]-wt[3]^2+γ*z[16]-0.0*cos(z[7])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[7])*dz[24]+(L1*sin(z[7])*dz[23])*0.5-(sqrt(3)*L1*sin(z[7])*dz[22])*0.5+L1*dz[17]*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)-L1*cos(z[7])*sin(z[8])*sin(z[9])*dz[18]*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2)
            res[17] = dz[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)-dz[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)+dz[17]*(J2+L2^2*M3+LC2^2*M2)+γ*z[17]+L2*cos(z[8])*cos(z[9])*dz[24]+L1*dz[16]*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))-cos(z[8])*sin(z[8])*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(z[8])*cos(z[9])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))
            res[18] = γ*z[18]+sin(z[8])^2*dz[18]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(z[9])*sin(z[8])*dz[22])*0.5-L2*sin(z[8])*sin(z[9])*dz[24]+sin(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+0.0*sin(z[8])*sin(z[9])*(L2*M3+LC2*M2)-(sqrt(3)*L2*cos(z[9])*sin(z[8])*dz[23])*0.5+L1*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)-L1*cos(z[7])*sin(z[8])*sin(z[9])*dz[16]*(L2*M3+LC2*M2)
            res[19] = (sqrt(3)*(L0-L3+L1*cos(z[4])+L2*cos(z[5])))*0.5+L2*sin(z[2])*sin(z[3])+(L2*sin(z[5])*sin(z[6]))*0.5
            res[20] = (3*L0)*0.5-(3*L3)*0.5+L1*cos(z[1])+L2*cos(z[2])+(L1*cos(z[4]))*0.5+(L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5
            res[21] = L1*sin(z[1])-L1*sin(z[4])+L2*cos(z[3])*sin(z[2])-L2*cos(z[6])*sin(z[5])
            res[22] = L2*sin(z[2])*sin(z[3])-(sqrt(3)*(L0-L3+L1*cos(z[7])+L2*cos(z[8])))*0.5+(L2*sin(z[8])*sin(z[9]))*0.5
            res[23] = (3*L0)*0.5-(3*L3)*0.5+L1*cos(z[1])+L2*cos(z[2])+(L1*cos(z[7]))*0.5+(L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5
            res[24] = L1*sin(z[1])-L1*sin(z[7])+L2*cos(z[3])*sin(z[2])-L2*cos(z[9])*sin(z[8])
            res[25] = L2*cos(z[2])*sin(z[3])*z[11]-(sqrt(3)*(L1*sin(z[4])*z[13]+L2*sin(z[5])*z[14]))*0.5+L2*cos(z[3])*sin(z[2])*z[12]+(L2*cos(z[5])*sin(z[6])*z[14])*0.5+(L2*cos(z[6])*sin(z[5])*z[15])*0.5
            res[26] = -L1*sin(z[1])*z[10]-L2*sin(z[2])*z[11]-(L1*sin(z[4])*z[13])*0.5-(L2*sin(z[5])*z[14])*0.5-(sqrt(3)*L2*cos(z[5])*sin(z[6])*z[14])*0.5-(sqrt(3)*L2*cos(z[6])*sin(z[5])*z[15])*0.5
            res[27] = L1*cos(z[1])*z[10]-L1*cos(z[4])*z[13]+L2*cos(z[2])*cos(z[3])*z[11]-L2*cos(z[5])*cos(z[6])*z[14]-L2*sin(z[2])*sin(z[3])*z[12]+L2*sin(z[5])*sin(z[6])*z[15]
            res[28] = (sqrt(3)*(L1*sin(z[7])*z[16]+L2*sin(z[8])*z[17]))*0.5+L2*cos(z[2])*sin(z[3])*z[11]+L2*cos(z[3])*sin(z[2])*z[12]+(L2*cos(z[8])*sin(z[9])*z[17])*0.5+(L2*cos(z[9])*sin(z[8])*z[18])*0.5
            res[29] = (sqrt(3)*L2*cos(z[8])*sin(z[9])*z[17])*0.5-L2*sin(z[2])*z[11]-(L1*sin(z[7])*z[16])*0.5-(L2*sin(z[8])*z[17])*0.5-L1*sin(z[1])*z[10]+(sqrt(3)*L2*cos(z[9])*sin(z[8])*z[18])*0.5
            res[30] = L1*cos(z[1])*z[10]-L1*cos(z[7])*z[16]+L2*cos(z[2])*cos(z[3])*z[11]-L2*cos(z[8])*cos(z[9])*z[17]-L2*sin(z[2])*sin(z[3])*z[12]+L2*sin(z[8])*sin(z[9])*z[18]

            nothing
        end

        # Finding consistent initial conditions
        x0, dx0 ,_ = get_delta_initial_with_mats(pars, u(0.0), w(0.0))

        dvars = vcat(fill(true, 30))
        r0 = zeros(length(x0))
        f!(r0, dx0, x0, [], 0.0)

        # t -> 0.0 is just a dummy function, not to be used
        Model(f!, t -> 0.0, x0, dx0, dvars, r0)
    end
end

# -------------------- Forward sensitivity models ---------------------------

# Used to be called delta_robot_gc_γsens
function delta_forward_γ(u::Function, w::Function, pars::Vector{Float64}, model_data::NamedTuple)::Model
    # g = 0 because this is the gravity-compensated model
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]

        # the residual function
        function f!(res, dz, z, _, t)
            wt = w(t)
            ut = u(t)
            # Dynamic Equations
            res[1] = dz[1]-z[10]+L1*cos(z[1])*dz[27]+L1*cos(z[1])*dz[30]-L1*sin(z[1])*dz[26]-L1*sin(z[1])*dz[29]
            res[2] = dz[2]-z[11]-L2*sin(z[2])*dz[26]-L2*sin(z[2])*dz[29]+L2*cos(z[2])*cos(z[3])*dz[27]+L2*cos(z[2])*cos(z[3])*dz[30]+L2*cos(z[2])*sin(z[3])*dz[25]+L2*cos(z[2])*sin(z[3])*dz[28]
            res[3] = dz[3]-z[12]+L2*cos(z[3])*sin(z[2])*dz[25]+L2*cos(z[3])*sin(z[2])*dz[28]-L2*sin(z[2])*sin(z[3])*dz[27]-L2*sin(z[2])*sin(z[3])*dz[30]
            res[4] = dz[4]-z[13]-L1*cos(z[4])*dz[27]-(L1*sin(z[4])*dz[26])*0.5-(sqrt(3)*L1*sin(z[4])*dz[25])*0.5
            res[5] = dz[5]-z[14]+dz[25]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dz[26]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-L2*cos(z[5])*cos(z[6])*dz[27]
            res[6] = dz[6]-z[15]+(L2*cos(z[6])*sin(z[5])*dz[25])*0.5+L2*sin(z[5])*sin(z[6])*dz[27]-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dz[26])*0.5
            res[7] = dz[7]-z[16]-L1*cos(z[7])*dz[30]-(L1*sin(z[7])*dz[29])*0.5+(sqrt(3)*L1*sin(z[7])*dz[28])*0.5
            res[8] = dz[8]-z[17]+dz[28]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dz[29]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)-L2*cos(z[8])*cos(z[9])*dz[30]
            res[9] = dz[9]-z[18]+(L2*cos(z[9])*sin(z[8])*dz[28])*0.5+L2*sin(z[8])*sin(z[9])*dz[30]+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dz[29])*0.5
            res[10] = dz[10]*(J1+L1^2*(M2+M3)+LC1^2*M1)-ut[1]-wt[1]^2+γ*z[10]-0.0*cos(z[1])*(L1*(M2+M3)+LC1*M1)-L1*cos(z[1])*dz[21]-L1*cos(z[1])*dz[24]+L1*sin(z[1])*dz[20]+L1*sin(z[1])*dz[23]+L1*dz[11]*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*dz[12]*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2)
            res[11] = dz[11]*(J2+L2^2*M3+LC2^2*M2)+γ*z[11]+L2*sin(z[2])*dz[20]+L2*sin(z[2])*dz[23]-L2*cos(z[2])*cos(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[24]-L2*cos(z[2])*sin(z[3])*dz[19]-L2*cos(z[2])*sin(z[3])*dz[22]+L1*dz[10]*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))-cos(z[2])*sin(z[2])*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(z[2])*cos(z[3])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))
            res[12] = γ*z[12]+sin(z[2])^2*dz[12]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[3])*sin(z[2])*dz[19]-L2*cos(z[3])*sin(z[2])*dz[22]+L2*sin(z[2])*sin(z[3])*dz[21]+L2*sin(z[2])*sin(z[3])*dz[24]+sin(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+0.0*sin(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*dz[10]*(L2*M3+LC2*M2)
            res[13] = dz[13]*(J1+L1^2*(M2+M3)+LC1^2*M1)-ut[2]-wt[2]^2+γ*z[13]-0.0*cos(z[4])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[4])*dz[21]+(L1*sin(z[4])*dz[20])*0.5+(sqrt(3)*L1*sin(z[4])*dz[19])*0.5+L1*dz[14]*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)-L1*cos(z[4])*sin(z[5])*sin(z[6])*dz[15]*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2)
            res[14] = dz[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-dz[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)+dz[14]*(J2+L2^2*M3+LC2^2*M2)+γ*z[14]+L2*cos(z[5])*cos(z[6])*dz[21]+L1*dz[13]*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))-cos(z[5])*sin(z[5])*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(z[5])*cos(z[6])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))
            res[15] = γ*z[15]+sin(z[5])^2*dz[15]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(z[6])*sin(z[5])*dz[19])*0.5-L2*sin(z[5])*sin(z[6])*dz[21]+sin(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+0.0*sin(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[6])*sin(z[5])*dz[20])*0.5+L1*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)-L1*cos(z[4])*sin(z[5])*sin(z[6])*dz[13]*(L2*M3+LC2*M2)
            res[16] = dz[16]*(J1+L1^2*(M2+M3)+LC1^2*M1)-ut[3]-wt[3]^2+γ*z[16]-0.0*cos(z[7])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[7])*dz[24]+(L1*sin(z[7])*dz[23])*0.5-(sqrt(3)*L1*sin(z[7])*dz[22])*0.5+L1*dz[17]*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)-L1*cos(z[7])*sin(z[8])*sin(z[9])*dz[18]*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2)
            res[17] = dz[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)-dz[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)+dz[17]*(J2+L2^2*M3+LC2^2*M2)+γ*z[17]+L2*cos(z[8])*cos(z[9])*dz[24]+L1*dz[16]*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))-cos(z[8])*sin(z[8])*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(z[8])*cos(z[9])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))
            res[18] = γ*z[18]+sin(z[8])^2*dz[18]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(z[9])*sin(z[8])*dz[22])*0.5-L2*sin(z[8])*sin(z[9])*dz[24]+sin(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+0.0*sin(z[8])*sin(z[9])*(L2*M3+LC2*M2)-(sqrt(3)*L2*cos(z[9])*sin(z[8])*dz[23])*0.5+L1*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)-L1*cos(z[7])*sin(z[8])*sin(z[9])*dz[16]*(L2*M3+LC2*M2)
            res[19] = (sqrt(3)*(L0-L3+L1*cos(z[4])+L2*cos(z[5])))*0.5+L2*sin(z[2])*sin(z[3])+(L2*sin(z[5])*sin(z[6]))*0.5
            res[20] = (3*L0)*0.5-(3*L3)*0.5+L1*cos(z[1])+L2*cos(z[2])+(L1*cos(z[4]))*0.5+(L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5
            res[21] = L1*sin(z[1])-L1*sin(z[4])+L2*cos(z[3])*sin(z[2])-L2*cos(z[6])*sin(z[5])
            res[22] = L2*sin(z[2])*sin(z[3])-(sqrt(3)*(L0-L3+L1*cos(z[7])+L2*cos(z[8])))*0.5+(L2*sin(z[8])*sin(z[9]))*0.5
            res[23] = (3*L0)*0.5-(3*L3)*0.5+L1*cos(z[1])+L2*cos(z[2])+(L1*cos(z[7]))*0.5+(L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5
            res[24] = L1*sin(z[1])-L1*sin(z[7])+L2*cos(z[3])*sin(z[2])-L2*cos(z[9])*sin(z[8])
            res[25] = L2*cos(z[2])*sin(z[3])*z[11]-(sqrt(3)*(L1*sin(z[4])*z[13]+L2*sin(z[5])*z[14]))*0.5+L2*cos(z[3])*sin(z[2])*z[12]+(L2*cos(z[5])*sin(z[6])*z[14])*0.5+(L2*cos(z[6])*sin(z[5])*z[15])*0.5
            res[26] = -L1*sin(z[1])*z[10]-L2*sin(z[2])*z[11]-(L1*sin(z[4])*z[13])*0.5-(L2*sin(z[5])*z[14])*0.5-(sqrt(3)*L2*cos(z[5])*sin(z[6])*z[14])*0.5-(sqrt(3)*L2*cos(z[6])*sin(z[5])*z[15])*0.5
            res[27] = L1*cos(z[1])*z[10]-L1*cos(z[4])*z[13]+L2*cos(z[2])*cos(z[3])*z[11]-L2*cos(z[5])*cos(z[6])*z[14]-L2*sin(z[2])*sin(z[3])*z[12]+L2*sin(z[5])*sin(z[6])*z[15]
            res[28] = (sqrt(3)*(L1*sin(z[7])*z[16]+L2*sin(z[8])*z[17]))*0.5+L2*cos(z[2])*sin(z[3])*z[11]+L2*cos(z[3])*sin(z[2])*z[12]+(L2*cos(z[8])*sin(z[9])*z[17])*0.5+(L2*cos(z[9])*sin(z[8])*z[18])*0.5
            res[29] = (sqrt(3)*L2*cos(z[8])*sin(z[9])*z[17])*0.5-L2*sin(z[2])*z[11]-(L1*sin(z[7])*z[16])*0.5-(L2*sin(z[8])*z[17])*0.5-L1*sin(z[1])*z[10]+(sqrt(3)*L2*cos(z[9])*sin(z[8])*z[18])*0.5
            res[30] = L1*cos(z[1])*z[10]-L1*cos(z[7])*z[16]+L2*cos(z[2])*cos(z[3])*z[11]-L2*cos(z[8])*cos(z[9])*z[17]-L2*sin(z[2])*sin(z[3])*z[12]+L2*sin(z[8])*sin(z[9])*z[18]
            # Sensitivity equations, parameter-agnostic part
            res[31] = dz[31]-z[40]-z[31]*(L1*cos(z[1])*dz[26]+L1*cos(z[1])*dz[29]+L1*sin(z[1])*dz[27]+L1*sin(z[1])*dz[30])+L1*cos(z[1])*dz[57]+L1*cos(z[1])*dz[60]-L1*sin(z[1])*dz[56]-L1*sin(z[1])*dz[59]
            res[32] = dz[32]-z[41]+z[33]*(L2*cos(z[2])*cos(z[3])*dz[25]+L2*cos(z[2])*cos(z[3])*dz[28]-L2*cos(z[2])*sin(z[3])*dz[27]-L2*cos(z[2])*sin(z[3])*dz[30])-z[32]*(L2*cos(z[2])*dz[26]+L2*cos(z[2])*dz[29]+L2*cos(z[3])*sin(z[2])*dz[27]+L2*cos(z[3])*sin(z[2])*dz[30]+L2*sin(z[2])*sin(z[3])*dz[25]+L2*sin(z[2])*sin(z[3])*dz[28])-L2*sin(z[2])*dz[56]-L2*sin(z[2])*dz[59]+L2*cos(z[2])*cos(z[3])*dz[57]+L2*cos(z[2])*cos(z[3])*dz[60]+L2*cos(z[2])*sin(z[3])*dz[55]+L2*cos(z[2])*sin(z[3])*dz[58]
            res[33] = dz[33]-z[42]+z[32]*(L2*cos(z[2])*cos(z[3])*dz[25]+L2*cos(z[2])*cos(z[3])*dz[28]-L2*cos(z[2])*sin(z[3])*dz[27]-L2*cos(z[2])*sin(z[3])*dz[30])-z[33]*(L2*cos(z[3])*sin(z[2])*dz[27]+L2*cos(z[3])*sin(z[2])*dz[30]+L2*sin(z[2])*sin(z[3])*dz[25]+L2*sin(z[2])*sin(z[3])*dz[28])+L2*cos(z[3])*sin(z[2])*dz[55]+L2*cos(z[3])*sin(z[2])*dz[58]-L2*sin(z[2])*sin(z[3])*dz[57]-L2*sin(z[2])*sin(z[3])*dz[60]
            res[34] = dz[34]-z[43]-z[34]*((L1*cos(z[4])*dz[26])*0.5-L1*sin(z[4])*dz[27]+(sqrt(3)*L1*cos(z[4])*dz[25])*0.5)-L1*cos(z[4])*dz[57]-(L1*sin(z[4])*dz[56])*0.5-(sqrt(3)*L1*sin(z[4])*dz[55])*0.5
            res[35] = dz[35]-z[44]+dz[55]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dz[56]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)+z[36]*((L2*cos(z[5])*cos(z[6])*dz[25])*0.5+L2*cos(z[5])*sin(z[6])*dz[27]-(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[26])*0.5)-z[35]*(dz[25]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[26]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-L2*cos(z[6])*sin(z[5])*dz[27])-L2*cos(z[5])*cos(z[6])*dz[57]
            res[36] = dz[36]-z[45]+z[35]*((L2*cos(z[5])*cos(z[6])*dz[25])*0.5+L2*cos(z[5])*sin(z[6])*dz[27]-(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[26])*0.5)+z[36]*(L2*cos(z[6])*sin(z[5])*dz[27]-(L2*sin(z[5])*sin(z[6])*dz[25])*0.5+(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[26])*0.5)+(L2*cos(z[6])*sin(z[5])*dz[55])*0.5+L2*sin(z[5])*sin(z[6])*dz[57]-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dz[56])*0.5
            res[37] = dz[37]-z[46]+z[37]*(L1*sin(z[7])*dz[30]-(L1*cos(z[7])*dz[29])*0.5+(sqrt(3)*L1*cos(z[7])*dz[28])*0.5)-L1*cos(z[7])*dz[60]-(L1*sin(z[7])*dz[59])*0.5+(sqrt(3)*L1*sin(z[7])*dz[58])*0.5
            res[38] = dz[38]-z[47]+dz[58]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dz[59]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+z[39]*((L2*cos(z[8])*cos(z[9])*dz[28])*0.5+L2*cos(z[8])*sin(z[9])*dz[30]+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[29])*0.5)+z[38]*(dz[28]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-dz[29]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)+L2*cos(z[9])*sin(z[8])*dz[30])-L2*cos(z[8])*cos(z[9])*dz[60]
            res[39] = dz[39]-z[48]+z[38]*((L2*cos(z[8])*cos(z[9])*dz[28])*0.5+L2*cos(z[8])*sin(z[9])*dz[30]+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[29])*0.5)-z[39]*((L2*sin(z[8])*sin(z[9])*dz[28])*0.5-L2*cos(z[9])*sin(z[8])*dz[30]+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[29])*0.5)+(L2*cos(z[9])*sin(z[8])*dz[58])*0.5+L2*sin(z[8])*sin(z[9])*dz[60]+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dz[59])*0.5
            res[40] = z[41]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+dz[40]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[42]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-z[33]*(L1*cos(z[1])*cos(z[2])*sin(z[3])*dz[11]*(L2*M3+LC2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*cos(z[3])*sin(z[2])*dz[12]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+z[31]*(0.0*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*dz[11]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+L1*sin(z[1])*sin(z[2])*sin(z[3])*dz[12]*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*z[40]-z[32]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))-L1*dz[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*cos(z[2])*sin(z[3])*dz[12]*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-L1*cos(z[1])*dz[51]-L1*cos(z[1])*dz[54]+L1*sin(z[1])*dz[50]+L1*sin(z[1])*dz[53]+L1*dz[41]*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))-L1*cos(z[1])*sin(z[2])*sin(z[3])*dz[42]*(L2*M3+LC2*M2)
            res[41] = z[31]*(L1*dz[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3])))+z[32]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+L1*dz[10]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))+0.0*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))+dz[41]*(J2+L2^2*M3+LC2^2*M2)+γ*z[41]+z[33]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+0.0*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*dz[10]*(L2*M3+LC2*M2))+L2*sin(z[2])*dz[50]+L2*sin(z[2])*dz[53]-L2*cos(z[2])*cos(z[3])*dz[51]-L2*cos(z[2])*cos(z[3])*dz[54]-L2*cos(z[2])*sin(z[3])*dz[49]-L2*cos(z[2])*sin(z[3])*dz[52]+L1*dz[40]*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))-2*cos(z[2])*sin(z[2])*z[42]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*z[40]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))
            res[42] = z[33]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+0.0*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*dz[10]*(L2*M3+LC2*M2))+z[32]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(z[2])*sin(z[2])*dz[12]*(J2+L2^2*M3+LC2^2*M2)+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*dz[10]*(L2*M3+LC2*M2))+z[42]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+z[31]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)+L1*sin(z[1])*sin(z[2])*sin(z[3])*dz[10]*(L2*M3+LC2*M2))+sin(z[2])^2*dz[42]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[3])*sin(z[2])*dz[49]-L2*cos(z[3])*sin(z[2])*dz[52]+L2*sin(z[2])*sin(z[3])*dz[51]+L2*sin(z[2])*sin(z[3])*dz[54]+sin(2*z[2])*z[41]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*dz[40]*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*z[40]*z[10]*(L2*M3+LC2*M2)
            res[43] = z[44]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+dz[43]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[45]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-z[36]*(L1*cos(z[4])*cos(z[5])*sin(z[6])*dz[14]*(L2*M3+LC2*M2)-L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*cos(z[6])*sin(z[5])*dz[15]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*z[43]-z[35]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))-L1*dz[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*cos(z[5])*sin(z[6])*dz[15]*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+z[34]*(0.0*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*dz[14]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+L1*sin(z[4])*sin(z[5])*sin(z[6])*dz[15]*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+L1*cos(z[4])*dz[51]+(L1*sin(z[4])*dz[50])*0.5+(sqrt(3)*L1*sin(z[4])*dz[49])*0.5+L1*dz[44]*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))-L1*cos(z[4])*sin(z[5])*sin(z[6])*dz[45]*(L2*M3+LC2*M2)
            res[44] = z[34]*(L1*dz[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6])))-z[36]*((L2*cos(z[5])*cos(z[6])*dz[19])*0.5+L2*cos(z[5])*sin(z[6])*dz[21]-0.0*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5-L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*cos(z[5])*sin(z[6])*dz[13]*(L2*M3+LC2*M2))-dz[49]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)+dz[50]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)+dz[44]*(J2+L2^2*M3+LC2^2*M2)+γ*z[44]+z[35]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+L1*dz[13]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))+0.0*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))+L2*cos(z[5])*cos(z[6])*dz[51]+L1*dz[43]*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))-2*cos(z[5])*sin(z[5])*z[45]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*z[43]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))
            res[45] = z[45]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))-z[36]*(L2*cos(z[6])*sin(z[5])*dz[21]-(L2*sin(z[5])*sin(z[6])*dz[19])*0.5-0.0*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5-L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*cos(z[6])*sin(z[5])*dz[13]*(L2*M3+LC2*M2))+z[35]*(2*cos(z[5])*sin(z[5])*dz[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*dz[13]*(L2*M3+LC2*M2))+z[34]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)+L1*sin(z[4])*sin(z[5])*sin(z[6])*dz[13]*(L2*M3+LC2*M2))+sin(z[5])^2*dz[45]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(z[6])*sin(z[5])*dz[49])*0.5-L2*sin(z[5])*sin(z[6])*dz[51]+sin(2*z[5])*z[44]*z[15]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[6])*sin(z[5])*dz[50])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*dz[43]*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*z[43]*z[13]*(L2*M3+LC2*M2)
            res[46] = z[47]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+dz[46]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[48]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-z[39]*(L1*cos(z[7])*cos(z[8])*sin(z[9])*dz[17]*(L2*M3+LC2*M2)-L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*cos(z[9])*sin(z[8])*dz[18]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*z[46]-z[38]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))-L1*dz[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*cos(z[8])*sin(z[9])*dz[18]*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+z[37]*(0.0*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*dz[17]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+L1*sin(z[7])*sin(z[8])*sin(z[9])*dz[18]*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+L1*cos(z[7])*dz[54]+(L1*sin(z[7])*dz[53])*0.5-(sqrt(3)*L1*sin(z[7])*dz[52])*0.5+L1*dz[47]*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))-L1*cos(z[7])*sin(z[8])*sin(z[9])*dz[48]*(L2*M3+LC2*M2)
            res[47] = z[37]*(L1*dz[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9])))-z[39]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-0.0*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*cos(z[8])*sin(z[9])*dz[16]*(L2*M3+LC2*M2))-dz[52]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)+dz[53]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+dz[47]*(J2+L2^2*M3+LC2^2*M2)+γ*z[47]+z[38]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+L1*dz[16]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))+0.0*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))+L2*cos(z[8])*cos(z[9])*dz[54]+L1*dz[46]*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))-2*cos(z[8])*sin(z[8])*z[48]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*z[46]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))
            res[48] = z[39]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+0.0*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*dz[16]*(L2*M3+LC2*M2))+z[48]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-z[38]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(z[8])*sin(z[8])*dz[18]*(J2+L2^2*M3+LC2^2*M2)-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*cos(z[8])*sin(z[9])*dz[16]*(L2*M3+LC2*M2))+z[37]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)+L1*sin(z[7])*sin(z[8])*sin(z[9])*dz[16]*(L2*M3+LC2*M2))+sin(z[8])^2*dz[48]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(z[9])*sin(z[8])*dz[52])*0.5-L2*sin(z[8])*sin(z[9])*dz[54]+sin(2*z[8])*z[47]*z[18]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[9])*sin(z[8])*dz[53])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*dz[46]*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*z[46]*z[16]*(L2*M3+LC2*M2)
            res[49] = z[35]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)+L2*cos(z[2])*sin(z[3])*z[32]+L2*cos(z[3])*sin(z[2])*z[33]+(L2*cos(z[6])*sin(z[5])*z[36])*0.5-(sqrt(3)*L1*sin(z[4])*z[34])*0.5
            res[50] = -z[35]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-L1*sin(z[1])*z[31]-L2*sin(z[2])*z[32]-(L1*sin(z[4])*z[34])*0.5-(sqrt(3)*L2*cos(z[6])*sin(z[5])*z[36])*0.5
            res[51] = L1*cos(z[1])*z[31]-L1*cos(z[4])*z[34]+L2*cos(z[2])*cos(z[3])*z[32]-L2*cos(z[5])*cos(z[6])*z[35]-L2*sin(z[2])*sin(z[3])*z[33]+L2*sin(z[5])*sin(z[6])*z[36]
            res[52] = z[38]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)+L2*cos(z[2])*sin(z[3])*z[32]+L2*cos(z[3])*sin(z[2])*z[33]+(L2*cos(z[9])*sin(z[8])*z[39])*0.5+(sqrt(3)*L1*sin(z[7])*z[37])*0.5
            res[53] = (sqrt(3)*L2*cos(z[9])*sin(z[8])*z[39])*0.5-L1*sin(z[1])*z[31]-L2*sin(z[2])*z[32]-(L1*sin(z[7])*z[37])*0.5-z[38]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)
            res[54] = L1*cos(z[1])*z[31]-L1*cos(z[7])*z[37]+L2*cos(z[2])*cos(z[3])*z[32]-L2*cos(z[8])*cos(z[9])*z[38]-L2*sin(z[2])*sin(z[3])*z[33]+L2*sin(z[8])*sin(z[9])*z[39]
            res[55] = z[32]*(L2*cos(z[2])*cos(z[3])*z[12]-L2*sin(z[2])*sin(z[3])*z[11])+z[33]*(L2*cos(z[2])*cos(z[3])*z[11]-L2*sin(z[2])*sin(z[3])*z[12])+z[36]*((L2*cos(z[5])*cos(z[6])*z[14])*0.5-(L2*sin(z[5])*sin(z[6])*z[15])*0.5)-z[35]*((sqrt(3)*L2*cos(z[5])*z[14])*0.5-(L2*cos(z[5])*cos(z[6])*z[15])*0.5+(L2*sin(z[5])*sin(z[6])*z[14])*0.5)+z[44]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)+L2*cos(z[2])*sin(z[3])*z[41]+L2*cos(z[3])*sin(z[2])*z[42]+(L2*cos(z[6])*sin(z[5])*z[45])*0.5-(sqrt(3)*L1*sin(z[4])*z[43])*0.5-(sqrt(3)*L1*cos(z[4])*z[34]*z[13])*0.5
            res[56] = -z[44]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-z[35]*((L2*cos(z[5])*z[14])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*z[15])*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6])*z[14])*0.5)-z[36]*((sqrt(3)*L2*cos(z[5])*cos(z[6])*z[14])*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6])*z[15])*0.5)-L1*sin(z[1])*z[40]-L2*sin(z[2])*z[41]-(L1*sin(z[4])*z[43])*0.5-L1*cos(z[1])*z[31]*z[10]-L2*cos(z[2])*z[32]*z[11]-(L1*cos(z[4])*z[34]*z[13])*0.5-(sqrt(3)*L2*cos(z[6])*sin(z[5])*z[45])*0.5
            res[57] = z[35]*(L2*cos(z[6])*sin(z[5])*z[14]+L2*cos(z[5])*sin(z[6])*z[15])-z[33]*(L2*cos(z[2])*sin(z[3])*z[11]+L2*cos(z[3])*sin(z[2])*z[12])-z[32]*(L2*cos(z[3])*sin(z[2])*z[11]+L2*cos(z[2])*sin(z[3])*z[12])+z[36]*(L2*cos(z[5])*sin(z[6])*z[14]+L2*cos(z[6])*sin(z[5])*z[15])+L1*cos(z[1])*z[40]-L1*cos(z[4])*z[43]+L2*cos(z[2])*cos(z[3])*z[41]-L2*cos(z[5])*cos(z[6])*z[44]-L2*sin(z[2])*sin(z[3])*z[42]+L2*sin(z[5])*sin(z[6])*z[45]-L1*sin(z[1])*z[31]*z[10]+L1*sin(z[4])*z[34]*z[13]
            res[58] = z[32]*(L2*cos(z[2])*cos(z[3])*z[12]-L2*sin(z[2])*sin(z[3])*z[11])+z[33]*(L2*cos(z[2])*cos(z[3])*z[11]-L2*sin(z[2])*sin(z[3])*z[12])+z[39]*((L2*cos(z[8])*cos(z[9])*z[17])*0.5-(L2*sin(z[8])*sin(z[9])*z[18])*0.5)+z[38]*((L2*cos(z[8])*cos(z[9])*z[18])*0.5+(sqrt(3)*L2*cos(z[8])*z[17])*0.5-(L2*sin(z[8])*sin(z[9])*z[17])*0.5)+z[47]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)+L2*cos(z[2])*sin(z[3])*z[41]+L2*cos(z[3])*sin(z[2])*z[42]+(L2*cos(z[9])*sin(z[8])*z[48])*0.5+(sqrt(3)*L1*sin(z[7])*z[46])*0.5+(sqrt(3)*L1*cos(z[7])*z[37]*z[16])*0.5
            res[59] = z[39]*((sqrt(3)*L2*cos(z[8])*cos(z[9])*z[17])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*z[18])*0.5)-z[38]*((L2*cos(z[8])*z[17])*0.5-(sqrt(3)*L2*cos(z[8])*cos(z[9])*z[18])*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9])*z[17])*0.5)-z[47]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)-L1*sin(z[1])*z[40]-L2*sin(z[2])*z[41]-(L1*sin(z[7])*z[46])*0.5-L1*cos(z[1])*z[31]*z[10]-L2*cos(z[2])*z[32]*z[11]-(L1*cos(z[7])*z[37]*z[16])*0.5+(sqrt(3)*L2*cos(z[9])*sin(z[8])*z[48])*0.5
            res[60] = z[38]*(L2*cos(z[9])*sin(z[8])*z[17]+L2*cos(z[8])*sin(z[9])*z[18])-z[33]*(L2*cos(z[2])*sin(z[3])*z[11]+L2*cos(z[3])*sin(z[2])*z[12])-z[32]*(L2*cos(z[3])*sin(z[2])*z[11]+L2*cos(z[2])*sin(z[3])*z[12])+z[39]*(L2*cos(z[8])*sin(z[9])*z[17]+L2*cos(z[9])*sin(z[8])*z[18])+L1*cos(z[1])*z[40]-L1*cos(z[7])*z[46]+L2*cos(z[2])*cos(z[3])*z[41]-L2*cos(z[8])*cos(z[9])*z[47]-L2*sin(z[2])*sin(z[3])*z[42]+L2*sin(z[8])*sin(z[9])*z[48]-L1*sin(z[1])*z[31]*z[10]+L1*sin(z[7])*z[37]*z[16]
            # Sensitivity equations, part specific to γ
            res[40] += z[10]
            res[41] += z[11]
            res[42] += z[12]
            res[43] += z[13]
            res[44] += z[14]
            res[45] += z[15]
            res[46] += z[16]
            res[47] += z[17]
            res[48] += z[18]

            nothing
        end
        
        z0dyn, dz0dyn, did = get_delta_initial_with_mats(pars, u(0.0), w(0.0))
        zγ, dzγ = get_delta_initial_γsens(pars, z0dyn, dz0dyn, did)
        z0 = vcat(z0dyn, zγ)
        dz0 = vcat(dz0dyn, dzγ)

        dvars = fill(true, 60)
        r0 = zeros(length(z0))
        f!(r0, dz0, z0, [], 0.0)
        # @info "r0 for delta robot is: $r0"

        # t -> 0.0 is just a dummy function, not to be used
        Model(f!, t -> 0.0, z0, dz0, dvars, r0)
    end
end

# NOTE: TODO: f! currently only for specific disturbance model! Make agnostic!
# Used to be called delta_robot_gc_allpar_alldist
function delta_forward_allpar_alldist(u::Function, w::Function, pars::Vector{Float64}, model_data::NamedTuple)::Model
    # g = 0 because this is the gravity-compensated model
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]

        # the residual function
        function f!(res, dz, z, _, t)
            wt = w(t)
            ut = u(t)
            # Dynamic Equations
            res[1] = dz[1]-z[10]+L1*cos(z[1])*dz[27]+L1*cos(z[1])*dz[30]-L1*sin(z[1])*dz[26]-L1*sin(z[1])*dz[29]
            res[2] = dz[2]-z[11]-L2*sin(z[2])*dz[26]-L2*sin(z[2])*dz[29]+L2*cos(z[2])*cos(z[3])*dz[27]+L2*cos(z[2])*cos(z[3])*dz[30]+L2*cos(z[2])*sin(z[3])*dz[25]+L2*cos(z[2])*sin(z[3])*dz[28]
            res[3] = dz[3]-z[12]+L2*cos(z[3])*sin(z[2])*dz[25]+L2*cos(z[3])*sin(z[2])*dz[28]-L2*sin(z[2])*sin(z[3])*dz[27]-L2*sin(z[2])*sin(z[3])*dz[30]
            res[4] = dz[4]-z[13]-L1*cos(z[4])*dz[27]-(L1*sin(z[4])*dz[26])*0.5-(sqrt(3)*L1*sin(z[4])*dz[25])*0.5
            res[5] = dz[5]-z[14]+dz[25]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dz[26]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-L2*cos(z[5])*cos(z[6])*dz[27]
            res[6] = dz[6]-z[15]+(L2*cos(z[6])*sin(z[5])*dz[25])*0.5+L2*sin(z[5])*sin(z[6])*dz[27]-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dz[26])*0.5
            res[7] = dz[7]-z[16]-L1*cos(z[7])*dz[30]-(L1*sin(z[7])*dz[29])*0.5+(sqrt(3)*L1*sin(z[7])*dz[28])*0.5
            res[8] = dz[8]-z[17]+dz[28]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dz[29]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)-L2*cos(z[8])*cos(z[9])*dz[30]
            res[9] = dz[9]-z[18]+(L2*cos(z[9])*sin(z[8])*dz[28])*0.5+L2*sin(z[8])*sin(z[9])*dz[30]+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dz[29])*0.5
            res[10] = dz[10]*(J1+L1^2*(M2+M3)+LC1^2*M1)-ut[1]-wt[1]^2+γ*z[10]-0.0*cos(z[1])*(L1*(M2+M3)+LC1*M1)-L1*cos(z[1])*dz[21]-L1*cos(z[1])*dz[24]+L1*sin(z[1])*dz[20]+L1*sin(z[1])*dz[23]+L1*dz[11]*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*dz[12]*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2)
            res[11] = dz[11]*(J2+L2^2*M3+LC2^2*M2)+γ*z[11]+L2*sin(z[2])*dz[20]+L2*sin(z[2])*dz[23]-L2*cos(z[2])*cos(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[24]-L2*cos(z[2])*sin(z[3])*dz[19]-L2*cos(z[2])*sin(z[3])*dz[22]+L1*dz[10]*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))-cos(z[2])*sin(z[2])*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(z[2])*cos(z[3])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))
            res[12] = γ*z[12]+sin(z[2])^2*dz[12]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[3])*sin(z[2])*dz[19]-L2*cos(z[3])*sin(z[2])*dz[22]+L2*sin(z[2])*sin(z[3])*dz[21]+L2*sin(z[2])*sin(z[3])*dz[24]+sin(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+0.0*sin(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*dz[10]*(L2*M3+LC2*M2)
            res[13] = dz[13]*(J1+L1^2*(M2+M3)+LC1^2*M1)-ut[2]-wt[2]^2+γ*z[13]-0.0*cos(z[4])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[4])*dz[21]+(L1*sin(z[4])*dz[20])*0.5+(sqrt(3)*L1*sin(z[4])*dz[19])*0.5+L1*dz[14]*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)-L1*cos(z[4])*sin(z[5])*sin(z[6])*dz[15]*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2)
            res[14] = dz[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-dz[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)+dz[14]*(J2+L2^2*M3+LC2^2*M2)+γ*z[14]+L2*cos(z[5])*cos(z[6])*dz[21]+L1*dz[13]*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))-cos(z[5])*sin(z[5])*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(z[5])*cos(z[6])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))
            res[15] = γ*z[15]+sin(z[5])^2*dz[15]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(z[6])*sin(z[5])*dz[19])*0.5-L2*sin(z[5])*sin(z[6])*dz[21]+sin(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+0.0*sin(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[6])*sin(z[5])*dz[20])*0.5+L1*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)-L1*cos(z[4])*sin(z[5])*sin(z[6])*dz[13]*(L2*M3+LC2*M2)
            res[16] = dz[16]*(J1+L1^2*(M2+M3)+LC1^2*M1)-ut[3]-wt[3]^2+γ*z[16]-0.0*cos(z[7])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[7])*dz[24]+(L1*sin(z[7])*dz[23])*0.5-(sqrt(3)*L1*sin(z[7])*dz[22])*0.5+L1*dz[17]*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)-L1*cos(z[7])*sin(z[8])*sin(z[9])*dz[18]*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2)
            res[17] = dz[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)-dz[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)+dz[17]*(J2+L2^2*M3+LC2^2*M2)+γ*z[17]+L2*cos(z[8])*cos(z[9])*dz[24]+L1*dz[16]*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))-cos(z[8])*sin(z[8])*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(z[8])*cos(z[9])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))
            res[18] = γ*z[18]+sin(z[8])^2*dz[18]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(z[9])*sin(z[8])*dz[22])*0.5-L2*sin(z[8])*sin(z[9])*dz[24]+sin(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+0.0*sin(z[8])*sin(z[9])*(L2*M3+LC2*M2)-(sqrt(3)*L2*cos(z[9])*sin(z[8])*dz[23])*0.5+L1*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)-L1*cos(z[7])*sin(z[8])*sin(z[9])*dz[16]*(L2*M3+LC2*M2)
            res[19] = (sqrt(3)*(L0-L3+L1*cos(z[4])+L2*cos(z[5])))*0.5+L2*sin(z[2])*sin(z[3])+(L2*sin(z[5])*sin(z[6]))*0.5
            res[20] = (3*L0)*0.5-(3*L3)*0.5+L1*cos(z[1])+L2*cos(z[2])+(L1*cos(z[4]))*0.5+(L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5
            res[21] = L1*sin(z[1])-L1*sin(z[4])+L2*cos(z[3])*sin(z[2])-L2*cos(z[6])*sin(z[5])
            res[22] = L2*sin(z[2])*sin(z[3])-(sqrt(3)*(L0-L3+L1*cos(z[7])+L2*cos(z[8])))*0.5+(L2*sin(z[8])*sin(z[9]))*0.5
            res[23] = (3*L0)*0.5-(3*L3)*0.5+L1*cos(z[1])+L2*cos(z[2])+(L1*cos(z[7]))*0.5+(L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5
            res[24] = L1*sin(z[1])-L1*sin(z[7])+L2*cos(z[3])*sin(z[2])-L2*cos(z[9])*sin(z[8])
            res[25] = L2*cos(z[2])*sin(z[3])*z[11]-(sqrt(3)*(L1*sin(z[4])*z[13]+L2*sin(z[5])*z[14]))*0.5+L2*cos(z[3])*sin(z[2])*z[12]+(L2*cos(z[5])*sin(z[6])*z[14])*0.5+(L2*cos(z[6])*sin(z[5])*z[15])*0.5
            res[26] = -L1*sin(z[1])*z[10]-L2*sin(z[2])*z[11]-(L1*sin(z[4])*z[13])*0.5-(L2*sin(z[5])*z[14])*0.5-(sqrt(3)*L2*cos(z[5])*sin(z[6])*z[14])*0.5-(sqrt(3)*L2*cos(z[6])*sin(z[5])*z[15])*0.5
            res[27] = L1*cos(z[1])*z[10]-L1*cos(z[4])*z[13]+L2*cos(z[2])*cos(z[3])*z[11]-L2*cos(z[5])*cos(z[6])*z[14]-L2*sin(z[2])*sin(z[3])*z[12]+L2*sin(z[5])*sin(z[6])*z[15]
            res[28] = (sqrt(3)*(L1*sin(z[7])*z[16]+L2*sin(z[8])*z[17]))*0.5+L2*cos(z[2])*sin(z[3])*z[11]+L2*cos(z[3])*sin(z[2])*z[12]+(L2*cos(z[8])*sin(z[9])*z[17])*0.5+(L2*cos(z[9])*sin(z[8])*z[18])*0.5
            res[29] = (sqrt(3)*L2*cos(z[8])*sin(z[9])*z[17])*0.5-L2*sin(z[2])*z[11]-(L1*sin(z[7])*z[16])*0.5-(L2*sin(z[8])*z[17])*0.5-L1*sin(z[1])*z[10]+(sqrt(3)*L2*cos(z[9])*sin(z[8])*z[18])*0.5
            res[30] = L1*cos(z[1])*z[10]-L1*cos(z[7])*z[16]+L2*cos(z[2])*cos(z[3])*z[11]-L2*cos(z[8])*cos(z[9])*z[17]-L2*sin(z[2])*sin(z[3])*z[12]+L2*sin(z[8])*sin(z[9])*z[18]
            
            # Sensitivity equations for the 24 parameters, parameter-agnostic part
            for ind = 1:24
                res[30*ind+1] = dz[30*ind+1]-z[30*ind+10]-z[30*ind+1]*(L1*cos(z[1])*dz[26]+L1*cos(z[1])*dz[29]+L1*sin(z[1])*dz[27]+L1*sin(z[1])*dz[30])+L1*cos(z[1])*dz[30*ind+27]+L1*cos(z[1])*dz[30*ind+30]-L1*sin(z[1])*dz[30*ind+26]-L1*sin(z[1])*dz[30*ind+29]
                res[30*ind+2] = dz[30*ind+2]-z[30*ind+11]+z[30*ind+3]*(L2*cos(z[2])*cos(z[3])*dz[25]+L2*cos(z[2])*cos(z[3])*dz[28]-L2*cos(z[2])*sin(z[3])*dz[27]-L2*cos(z[2])*sin(z[3])*dz[30])-z[30*ind+2]*(L2*cos(z[2])*dz[26]+L2*cos(z[2])*dz[29]+L2*cos(z[3])*sin(z[2])*dz[27]+L2*cos(z[3])*sin(z[2])*dz[30]+L2*sin(z[2])*sin(z[3])*dz[25]+L2*sin(z[2])*sin(z[3])*dz[28])-L2*sin(z[2])*dz[30*ind+26]-L2*sin(z[2])*dz[30*ind+29]+L2*cos(z[2])*cos(z[3])*dz[30*ind+27]+L2*cos(z[2])*cos(z[3])*dz[30*ind+30]+L2*cos(z[2])*sin(z[3])*dz[30*ind+25]+L2*cos(z[2])*sin(z[3])*dz[30*ind+28]
                res[30*ind+3] = dz[30*ind+3]-z[30*ind+12]+z[30*ind+2]*(L2*cos(z[2])*cos(z[3])*dz[25]+L2*cos(z[2])*cos(z[3])*dz[28]-L2*cos(z[2])*sin(z[3])*dz[27]-L2*cos(z[2])*sin(z[3])*dz[30])-z[30*ind+3]*(L2*cos(z[3])*sin(z[2])*dz[27]+L2*cos(z[3])*sin(z[2])*dz[30]+L2*sin(z[2])*sin(z[3])*dz[25]+L2*sin(z[2])*sin(z[3])*dz[28])+L2*cos(z[3])*sin(z[2])*dz[30*ind+25]+L2*cos(z[3])*sin(z[2])*dz[30*ind+28]-L2*sin(z[2])*sin(z[3])*dz[30*ind+27]-L2*sin(z[2])*sin(z[3])*dz[30*ind+30]
                res[30*ind+4] = dz[30*ind+4]-z[30*ind+13]-z[30*ind+4]*((L1*cos(z[4])*dz[26])*0.5-L1*sin(z[4])*dz[27]+(sqrt(3)*L1*cos(z[4])*dz[25])*0.5)-L1*cos(z[4])*dz[30*ind+27]-(L1*sin(z[4])*dz[30*ind+26])*0.5-(sqrt(3)*L1*sin(z[4])*dz[30*ind+25])*0.5
                res[30*ind+5] = dz[30*ind+5]-z[30*ind+14]+dz[30*ind+25]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dz[30*ind+26]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)+z[30*ind+6]*((L2*cos(z[5])*cos(z[6])*dz[25])*0.5+L2*cos(z[5])*sin(z[6])*dz[27]-(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[26])*0.5)-z[30*ind+5]*(dz[25]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[26]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-L2*cos(z[6])*sin(z[5])*dz[27])-L2*cos(z[5])*cos(z[6])*dz[30*ind+27]
                res[30*ind+6] = dz[30*ind+6]-z[30*ind+15]+z[30*ind+5]*((L2*cos(z[5])*cos(z[6])*dz[25])*0.5+L2*cos(z[5])*sin(z[6])*dz[27]-(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[26])*0.5)+z[30*ind+6]*(L2*cos(z[6])*sin(z[5])*dz[27]-(L2*sin(z[5])*sin(z[6])*dz[25])*0.5+(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[26])*0.5)+(L2*cos(z[6])*sin(z[5])*dz[30*ind+25])*0.5+L2*sin(z[5])*sin(z[6])*dz[30*ind+27]-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dz[30*ind+26])*0.5
                res[30*ind+7] = dz[30*ind+7]-z[30*ind+16]+z[30*ind+7]*(L1*sin(z[7])*dz[30]-(L1*cos(z[7])*dz[29])*0.5+(sqrt(3)*L1*cos(z[7])*dz[28])*0.5)-L1*cos(z[7])*dz[30*ind+30]-(L1*sin(z[7])*dz[30*ind+29])*0.5+(sqrt(3)*L1*sin(z[7])*dz[30*ind+28])*0.5
                res[30*ind+8] = dz[30*ind+8]-z[30*ind+17]+dz[30*ind+28]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dz[30*ind+29]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+z[30*ind+9]*((L2*cos(z[8])*cos(z[9])*dz[28])*0.5+L2*cos(z[8])*sin(z[9])*dz[30]+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[29])*0.5)+z[30*ind+8]*(dz[28]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-dz[29]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)+L2*cos(z[9])*sin(z[8])*dz[30])-L2*cos(z[8])*cos(z[9])*dz[30*ind+30]
                res[30*ind+9] = dz[30*ind+9]-z[30*ind+18]+z[30*ind+8]*((L2*cos(z[8])*cos(z[9])*dz[28])*0.5+L2*cos(z[8])*sin(z[9])*dz[30]+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[29])*0.5)-z[30*ind+9]*((L2*sin(z[8])*sin(z[9])*dz[28])*0.5-L2*cos(z[9])*sin(z[8])*dz[30]+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[29])*0.5)+(L2*cos(z[9])*sin(z[8])*dz[30*ind+28])*0.5+L2*sin(z[8])*sin(z[9])*dz[30*ind+30]+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dz[30*ind+29])*0.5
                res[30*ind+10] = z[30*ind+11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+dz[30*ind+10]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[30*ind+12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-z[30*ind+3]*(L1*cos(z[1])*cos(z[2])*sin(z[3])*dz[11]*(L2*M3+LC2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*cos(z[3])*sin(z[2])*dz[12]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+z[30*ind+1]*(0.0*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*dz[11]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+L1*sin(z[1])*sin(z[2])*sin(z[3])*dz[12]*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*z[30*ind+10]-z[30*ind+2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))-L1*dz[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*cos(z[2])*sin(z[3])*dz[12]*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-L1*cos(z[1])*dz[30*ind+21]-L1*cos(z[1])*dz[30*ind+24]+L1*sin(z[1])*dz[30*ind+20]+L1*sin(z[1])*dz[30*ind+23]+L1*dz[30*ind+11]*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))-L1*cos(z[1])*sin(z[2])*sin(z[3])*dz[30*ind+12]*(L2*M3+LC2*M2)
                res[30*ind+11] = z[30*ind+1]*(L1*dz[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3])))+z[30*ind+2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+L1*dz[10]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))+0.0*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))+dz[30*ind+11]*(J2+L2^2*M3+LC2^2*M2)+γ*z[30*ind+11]+z[30*ind+3]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+0.0*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*dz[10]*(L2*M3+LC2*M2))+L2*sin(z[2])*dz[30*ind+20]+L2*sin(z[2])*dz[30*ind+23]-L2*cos(z[2])*cos(z[3])*dz[30*ind+21]-L2*cos(z[2])*cos(z[3])*dz[30*ind+24]-L2*cos(z[2])*sin(z[3])*dz[30*ind+19]-L2*cos(z[2])*sin(z[3])*dz[30*ind+22]+L1*dz[30*ind+10]*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))-2*cos(z[2])*sin(z[2])*z[30*ind+12]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*z[30*ind+10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))
                res[30*ind+12] = z[30*ind+3]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+0.0*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*dz[10]*(L2*M3+LC2*M2))+z[30*ind+2]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(z[2])*sin(z[2])*dz[12]*(J2+L2^2*M3+LC2^2*M2)+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*dz[10]*(L2*M3+LC2*M2))+z[30*ind+12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+z[30*ind+1]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)+L1*sin(z[1])*sin(z[2])*sin(z[3])*dz[10]*(L2*M3+LC2*M2))+sin(z[2])^2*dz[30*ind+12]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[3])*sin(z[2])*dz[30*ind+19]-L2*cos(z[3])*sin(z[2])*dz[30*ind+22]+L2*sin(z[2])*sin(z[3])*dz[30*ind+21]+L2*sin(z[2])*sin(z[3])*dz[30*ind+24]+sin(2*z[2])*z[30*ind+11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*dz[30*ind+10]*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*z[30*ind+10]*z[10]*(L2*M3+LC2*M2)
                res[30*ind+13] = z[30*ind+14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+dz[30*ind+13]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[30*ind+15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-z[30*ind+6]*(L1*cos(z[4])*cos(z[5])*sin(z[6])*dz[14]*(L2*M3+LC2*M2)-L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*cos(z[6])*sin(z[5])*dz[15]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*z[30*ind+13]-z[30*ind+5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))-L1*dz[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*cos(z[5])*sin(z[6])*dz[15]*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+z[30*ind+4]*(0.0*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*dz[14]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+L1*sin(z[4])*sin(z[5])*sin(z[6])*dz[15]*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+L1*cos(z[4])*dz[30*ind+21]+(L1*sin(z[4])*dz[30*ind+20])*0.5+(sqrt(3)*L1*sin(z[4])*dz[30*ind+19])*0.5+L1*dz[30*ind+14]*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))-L1*cos(z[4])*sin(z[5])*sin(z[6])*dz[30*ind+15]*(L2*M3+LC2*M2)
                res[30*ind+14] = z[30*ind+4]*(L1*dz[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6])))-z[30*ind+6]*((L2*cos(z[5])*cos(z[6])*dz[19])*0.5+L2*cos(z[5])*sin(z[6])*dz[21]-0.0*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5-L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*cos(z[5])*sin(z[6])*dz[13]*(L2*M3+LC2*M2))-dz[30*ind+19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)+dz[30*ind+20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)+dz[30*ind+14]*(J2+L2^2*M3+LC2^2*M2)+γ*z[30*ind+14]+z[30*ind+5]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+L1*dz[13]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))+0.0*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))+L2*cos(z[5])*cos(z[6])*dz[30*ind+21]+L1*dz[30*ind+13]*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))-2*cos(z[5])*sin(z[5])*z[30*ind+15]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*z[30*ind+13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))
                res[30*ind+15] = z[30*ind+15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))-z[30*ind+6]*(L2*cos(z[6])*sin(z[5])*dz[21]-(L2*sin(z[5])*sin(z[6])*dz[19])*0.5-0.0*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5-L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*cos(z[6])*sin(z[5])*dz[13]*(L2*M3+LC2*M2))+z[30*ind+5]*(2*cos(z[5])*sin(z[5])*dz[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*dz[13]*(L2*M3+LC2*M2))+z[30*ind+4]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)+L1*sin(z[4])*sin(z[5])*sin(z[6])*dz[13]*(L2*M3+LC2*M2))+sin(z[5])^2*dz[30*ind+15]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(z[6])*sin(z[5])*dz[30*ind+19])*0.5-L2*sin(z[5])*sin(z[6])*dz[30*ind+21]+sin(2*z[5])*z[30*ind+14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[6])*sin(z[5])*dz[30*ind+20])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*dz[30*ind+13]*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*z[30*ind+13]*z[13]*(L2*M3+LC2*M2)
                res[30*ind+16] = z[30*ind+17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+dz[30*ind+16]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[30*ind+18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-z[30*ind+9]*(L1*cos(z[7])*cos(z[8])*sin(z[9])*dz[17]*(L2*M3+LC2*M2)-L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*cos(z[9])*sin(z[8])*dz[18]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*z[30*ind+16]-z[30*ind+8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))-L1*dz[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*cos(z[8])*sin(z[9])*dz[18]*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+z[30*ind+7]*(0.0*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*dz[17]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+L1*sin(z[7])*sin(z[8])*sin(z[9])*dz[18]*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+L1*cos(z[7])*dz[30*ind+24]+(L1*sin(z[7])*dz[30*ind+23])*0.5-(sqrt(3)*L1*sin(z[7])*dz[30*ind+22])*0.5+L1*dz[30*ind+17]*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))-L1*cos(z[7])*sin(z[8])*sin(z[9])*dz[30*ind+18]*(L2*M3+LC2*M2)
                res[30*ind+17] = z[30*ind+7]*(L1*dz[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9])))-z[30*ind+9]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-0.0*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*cos(z[8])*sin(z[9])*dz[16]*(L2*M3+LC2*M2))-dz[30*ind+22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)+dz[30*ind+23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+dz[30*ind+17]*(J2+L2^2*M3+LC2^2*M2)+γ*z[30*ind+17]+z[30*ind+8]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+L1*dz[16]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))+0.0*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))+L2*cos(z[8])*cos(z[9])*dz[30*ind+24]+L1*dz[30*ind+16]*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))-2*cos(z[8])*sin(z[8])*z[30*ind+18]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*z[30*ind+16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))
                res[30*ind+18] = z[30*ind+9]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+0.0*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*dz[16]*(L2*M3+LC2*M2))+z[30*ind+18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-z[30*ind+8]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(z[8])*sin(z[8])*dz[18]*(J2+L2^2*M3+LC2^2*M2)-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*cos(z[8])*sin(z[9])*dz[16]*(L2*M3+LC2*M2))+z[30*ind+7]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)+L1*sin(z[7])*sin(z[8])*sin(z[9])*dz[16]*(L2*M3+LC2*M2))+sin(z[8])^2*dz[30*ind+18]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(z[9])*sin(z[8])*dz[30*ind+22])*0.5-L2*sin(z[8])*sin(z[9])*dz[30*ind+24]+sin(2*z[8])*z[30*ind+17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[9])*sin(z[8])*dz[30*ind+23])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*dz[30*ind+16]*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*z[30*ind+16]*z[16]*(L2*M3+LC2*M2)
                res[30*ind+19] = z[30*ind+5]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)+L2*cos(z[2])*sin(z[3])*z[30*ind+2]+L2*cos(z[3])*sin(z[2])*z[30*ind+3]+(L2*cos(z[6])*sin(z[5])*z[30*ind+6])*0.5-(sqrt(3)*L1*sin(z[4])*z[30*ind+4])*0.5
                res[30*ind+20] = -z[30*ind+5]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-L1*sin(z[1])*z[30*ind+1]-L2*sin(z[2])*z[30*ind+2]-(L1*sin(z[4])*z[30*ind+4])*0.5-(sqrt(3)*L2*cos(z[6])*sin(z[5])*z[30*ind+6])*0.5
                res[30*ind+21] = L1*cos(z[1])*z[30*ind+1]-L1*cos(z[4])*z[30*ind+4]+L2*cos(z[2])*cos(z[3])*z[30*ind+2]-L2*cos(z[5])*cos(z[6])*z[30*ind+5]-L2*sin(z[2])*sin(z[3])*z[30*ind+3]+L2*sin(z[5])*sin(z[6])*z[30*ind+6]
                res[30*ind+22] = z[30*ind+8]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)+L2*cos(z[2])*sin(z[3])*z[30*ind+2]+L2*cos(z[3])*sin(z[2])*z[30*ind+3]+(L2*cos(z[9])*sin(z[8])*z[30*ind+9])*0.5+(sqrt(3)*L1*sin(z[7])*z[30*ind+7])*0.5
                res[30*ind+23] = (sqrt(3)*L2*cos(z[9])*sin(z[8])*z[30*ind+9])*0.5-L1*sin(z[1])*z[30*ind+1]-L2*sin(z[2])*z[30*ind+2]-(L1*sin(z[7])*z[30*ind+7])*0.5-z[30*ind+8]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)
                res[30*ind+24] = L1*cos(z[1])*z[30*ind+1]-L1*cos(z[7])*z[30*ind+7]+L2*cos(z[2])*cos(z[3])*z[30*ind+2]-L2*cos(z[8])*cos(z[9])*z[30*ind+8]-L2*sin(z[2])*sin(z[3])*z[30*ind+3]+L2*sin(z[8])*sin(z[9])*z[30*ind+9]
                res[30*ind+25] = z[30*ind+2]*(L2*cos(z[2])*cos(z[3])*z[12]-L2*sin(z[2])*sin(z[3])*z[11])+z[30*ind+3]*(L2*cos(z[2])*cos(z[3])*z[11]-L2*sin(z[2])*sin(z[3])*z[12])+z[30*ind+6]*((L2*cos(z[5])*cos(z[6])*z[14])*0.5-(L2*sin(z[5])*sin(z[6])*z[15])*0.5)-z[30*ind+5]*((sqrt(3)*L2*cos(z[5])*z[14])*0.5-(L2*cos(z[5])*cos(z[6])*z[15])*0.5+(L2*sin(z[5])*sin(z[6])*z[14])*0.5)+z[30*ind+14]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)+L2*cos(z[2])*sin(z[3])*z[30*ind+11]+L2*cos(z[3])*sin(z[2])*z[30*ind+12]+(L2*cos(z[6])*sin(z[5])*z[30*ind+15])*0.5-(sqrt(3)*L1*sin(z[4])*z[30*ind+13])*0.5-(sqrt(3)*L1*cos(z[4])*z[30*ind+4]*z[13])*0.5
                res[30*ind+26] = -z[30*ind+14]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-z[30*ind+5]*((L2*cos(z[5])*z[14])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*z[15])*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6])*z[14])*0.5)-z[30*ind+6]*((sqrt(3)*L2*cos(z[5])*cos(z[6])*z[14])*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6])*z[15])*0.5)-L1*sin(z[1])*z[30*ind+10]-L2*sin(z[2])*z[30*ind+11]-(L1*sin(z[4])*z[30*ind+13])*0.5-L1*cos(z[1])*z[30*ind+1]*z[10]-L2*cos(z[2])*z[30*ind+2]*z[11]-(L1*cos(z[4])*z[30*ind+4]*z[13])*0.5-(sqrt(3)*L2*cos(z[6])*sin(z[5])*z[30*ind+15])*0.5
                res[30*ind+27] = z[30*ind+5]*(L2*cos(z[6])*sin(z[5])*z[14]+L2*cos(z[5])*sin(z[6])*z[15])-z[30*ind+3]*(L2*cos(z[2])*sin(z[3])*z[11]+L2*cos(z[3])*sin(z[2])*z[12])-z[30*ind+2]*(L2*cos(z[3])*sin(z[2])*z[11]+L2*cos(z[2])*sin(z[3])*z[12])+z[30*ind+6]*(L2*cos(z[5])*sin(z[6])*z[14]+L2*cos(z[6])*sin(z[5])*z[15])+L1*cos(z[1])*z[30*ind+10]-L1*cos(z[4])*z[30*ind+13]+L2*cos(z[2])*cos(z[3])*z[30*ind+11]-L2*cos(z[5])*cos(z[6])*z[30*ind+14]-L2*sin(z[2])*sin(z[3])*z[30*ind+12]+L2*sin(z[5])*sin(z[6])*z[30*ind+15]-L1*sin(z[1])*z[30*ind+1]*z[10]+L1*sin(z[4])*z[30*ind+4]*z[13]
                res[30*ind+28] = z[30*ind+2]*(L2*cos(z[2])*cos(z[3])*z[12]-L2*sin(z[2])*sin(z[3])*z[11])+z[30*ind+3]*(L2*cos(z[2])*cos(z[3])*z[11]-L2*sin(z[2])*sin(z[3])*z[12])+z[30*ind+9]*((L2*cos(z[8])*cos(z[9])*z[17])*0.5-(L2*sin(z[8])*sin(z[9])*z[18])*0.5)+z[30*ind+8]*((L2*cos(z[8])*cos(z[9])*z[18])*0.5+(sqrt(3)*L2*cos(z[8])*z[17])*0.5-(L2*sin(z[8])*sin(z[9])*z[17])*0.5)+z[30*ind+17]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)+L2*cos(z[2])*sin(z[3])*z[30*ind+11]+L2*cos(z[3])*sin(z[2])*z[30*ind+12]+(L2*cos(z[9])*sin(z[8])*z[30*ind+18])*0.5+(sqrt(3)*L1*sin(z[7])*z[30*ind+16])*0.5+(sqrt(3)*L1*cos(z[7])*z[30*ind+7]*z[16])*0.5
                res[30*ind+29] = z[30*ind+9]*((sqrt(3)*L2*cos(z[8])*cos(z[9])*z[17])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*z[18])*0.5)-z[30*ind+8]*((L2*cos(z[8])*z[17])*0.5-(sqrt(3)*L2*cos(z[8])*cos(z[9])*z[18])*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9])*z[17])*0.5)-z[30*ind+17]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)-L1*sin(z[1])*z[30*ind+10]-L2*sin(z[2])*z[30*ind+11]-(L1*sin(z[7])*z[30*ind+16])*0.5-L1*cos(z[1])*z[30*ind+1]*z[10]-L2*cos(z[2])*z[30*ind+2]*z[11]-(L1*cos(z[7])*z[30*ind+7]*z[16])*0.5+(sqrt(3)*L2*cos(z[9])*sin(z[8])*z[30*ind+18])*0.5
                res[30*ind+30] = z[30*ind+8]*(L2*cos(z[9])*sin(z[8])*z[17]+L2*cos(z[8])*sin(z[9])*z[18])-z[30*ind+3]*(L2*cos(z[2])*sin(z[3])*z[11]+L2*cos(z[3])*sin(z[2])*z[12])-z[30*ind+2]*(L2*cos(z[3])*sin(z[2])*z[11]+L2*cos(z[2])*sin(z[3])*z[12])+z[30*ind+9]*(L2*cos(z[8])*sin(z[9])*z[17]+L2*cos(z[9])*sin(z[8])*z[18])+L1*cos(z[1])*z[30*ind+10]-L1*cos(z[7])*z[30*ind+16]+L2*cos(z[2])*cos(z[3])*z[30*ind+11]-L2*cos(z[8])*cos(z[9])*z[30*ind+17]-L2*sin(z[2])*sin(z[3])*z[30*ind+12]+L2*sin(z[8])*sin(z[9])*z[30*ind+18]-L1*sin(z[1])*z[30*ind+1]*z[10]+L1*sin(z[7])*z[30*ind+7]*z[16]
            end

            # ----------------------------------------------
            # Parameter-specific part for L0
            ind=1
            res[30ind+19] +=	sqrt(3)*0.5
            res[30ind+20] +=	3*0.5
            res[30ind+22] +=	-sqrt(3)*0.5
            res[30ind+23] +=	3*0.5
            # Parameter-specific part for L1
            ind=2
            res[30ind+1] +=	cos(z[1])*dz[27]+cos(z[1])*dz[30]-sin(z[1])*dz[26]-sin(z[1])*dz[29]
            res[30ind+4] +=	-cos(z[4])*dz[27]-(sin(z[4])*dz[26])*0.5-(sqrt(3)*sin(z[4])*dz[25])*0.5
            res[30ind+7] +=	(sqrt(3)*sin(z[7])*dz[28])*0.5-(sin(z[7])*dz[29])*0.5-cos(z[7])*dz[30]
            res[30ind+10] +=	sin(z[1])*dz[20]-cos(z[1])*dz[24]-cos(z[1])*dz[21]+sin(z[1])*dz[23]-0.0*cos(z[1])*(M2+M3)+dz[11]*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+2*L1*dz[10]*(M2+M3)+z[11]^2*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-cos(z[1])*sin(z[2])*sin(z[3])*dz[12]*(L2*M3+LC2*M2)-cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)-2*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2)
            res[30ind+11] +=	dz[10]*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))
            res[30ind+12] +=	sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)-cos(z[1])*sin(z[2])*sin(z[3])*dz[10]*(L2*M3+LC2*M2)
            res[30ind+13] +=	cos(z[4])*dz[21]+(sin(z[4])*dz[20])*0.5-0.0*cos(z[4])*(M2+M3)+dz[14]*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+2*L1*dz[13]*(M2+M3)+z[14]^2*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))+(sqrt(3)*sin(z[4])*dz[19])*0.5-cos(z[4])*sin(z[5])*sin(z[6])*dz[15]*(L2*M3+LC2*M2)-cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)-2*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2)
            res[30ind+14] +=	dz[13]*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))
            res[30ind+15] +=	sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)-cos(z[4])*sin(z[5])*sin(z[6])*dz[13]*(L2*M3+LC2*M2)
            res[30ind+16] +=	cos(z[7])*dz[24]+(sin(z[7])*dz[23])*0.5-0.0*cos(z[7])*(M2+M3)+dz[17]*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+2*L1*dz[16]*(M2+M3)+z[17]^2*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-(sqrt(3)*sin(z[7])*dz[22])*0.5-cos(z[7])*sin(z[8])*sin(z[9])*dz[18]*(L2*M3+LC2*M2)-cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)-2*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2)
            res[30ind+17] +=	dz[16]*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))
            res[30ind+18] +=	sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)-cos(z[7])*sin(z[8])*sin(z[9])*dz[16]*(L2*M3+LC2*M2)
            res[30ind+19] +=	(sqrt(3)*cos(z[4]))*0.5
            res[30ind+20] +=	cos(z[1])+cos(z[4])*0.5
            res[30ind+21] +=	sin(z[1])-sin(z[4])
            res[30ind+22] +=	-(sqrt(3)*cos(z[7]))*0.5
            res[30ind+23] +=	cos(z[1])+cos(z[7])*0.5
            res[30ind+24] +=	sin(z[1])-sin(z[7])
            res[30ind+25] +=	-(sqrt(3)*sin(z[4])*z[13])*0.5
            res[30ind+26] +=	-sin(z[1])*z[10]-(sin(z[4])*z[13])*0.5
            res[30ind+27] +=	cos(z[1])*z[10]-cos(z[4])*z[13]
            res[30ind+28] +=	(sqrt(3)*sin(z[7])*z[16])*0.5
            res[30ind+29] +=	-sin(z[1])*z[10]-(sin(z[7])*z[16])*0.5
            res[30ind+30] +=	cos(z[1])*z[10]-cos(z[7])*z[16]
            # Parameter-specific part for L2
            ind=3
            res[30ind+2] +=	cos(z[2])*cos(z[3])*dz[27]-sin(z[2])*dz[29]-sin(z[2])*dz[26]+cos(z[2])*cos(z[3])*dz[30]+cos(z[2])*sin(z[3])*dz[25]+cos(z[2])*sin(z[3])*dz[28]
            res[30ind+3] +=	cos(z[3])*sin(z[2])*dz[25]+cos(z[3])*sin(z[2])*dz[28]-sin(z[2])*sin(z[3])*dz[27]-sin(z[2])*sin(z[3])*dz[30]
            res[30ind+5] +=	dz[25]*((cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*sin(z[5]))*0.5)-dz[26]*(sin(z[5])*0.5+(sqrt(3)*cos(z[5])*sin(z[6]))*0.5)-cos(z[5])*cos(z[6])*dz[27]
            res[30ind+6] +=	(cos(z[6])*sin(z[5])*dz[25])*0.5+sin(z[5])*sin(z[6])*dz[27]-(sqrt(3)*cos(z[6])*sin(z[5])*dz[26])*0.5
            res[30ind+8] +=	dz[28]*((cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*sin(z[8]))*0.5)-dz[29]*(sin(z[8])*0.5-(sqrt(3)*cos(z[8])*sin(z[9]))*0.5)-cos(z[8])*cos(z[9])*dz[30]
            res[30ind+9] +=	(cos(z[9])*sin(z[8])*dz[28])*0.5+sin(z[8])*sin(z[9])*dz[30]+(sqrt(3)*cos(z[9])*sin(z[8])*dz[29])*0.5
            res[30ind+10] +=	L1*M3*dz[11]*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*M3*z[11]^2*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*M3*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2-L1*M3*cos(z[1])*sin(z[2])*sin(z[3])*dz[12]-2*L1*M3*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]
            res[30ind+11] +=	sin(z[2])*dz[20]+sin(z[2])*dz[23]-cos(z[2])*cos(z[3])*dz[21]-cos(z[2])*cos(z[3])*dz[24]+2*L2*M3*dz[11]-cos(z[2])*sin(z[3])*dz[19]-cos(z[2])*sin(z[3])*dz[22]+L1*M3*dz[10]*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))-M3*0.0*cos(z[2])*cos(z[3])+L1*M3*z[10]^2*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-2*L2*M3*cos(z[2])*sin(z[2])*z[12]^2
            res[30ind+12] +=	sin(z[2])*sin(z[3])*dz[21]-cos(z[3])*sin(z[2])*dz[22]-cos(z[3])*sin(z[2])*dz[19]+sin(z[2])*sin(z[3])*dz[24]+2*L2*M3*sin(z[2])^2*dz[12]+M3*0.0*sin(z[2])*sin(z[3])+2*L2*M3*sin(2*z[2])*z[11]*z[12]+L1*M3*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2-L1*M3*cos(z[1])*sin(z[2])*sin(z[3])*dz[10]
            res[30ind+13] +=	L1*M3*dz[14]*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*M3*z[14]^2*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*M3*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2-L1*M3*cos(z[4])*sin(z[5])*sin(z[6])*dz[15]-2*L1*M3*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]
            res[30ind+14] +=	dz[20]*(sin(z[5])*0.5+(sqrt(3)*cos(z[5])*sin(z[6]))*0.5)-dz[19]*((cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*sin(z[5]))*0.5)+cos(z[5])*cos(z[6])*dz[21]+2*L2*M3*dz[14]+L1*M3*dz[13]*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))-M3*0.0*cos(z[5])*cos(z[6])+L1*M3*z[13]^2*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-2*L2*M3*cos(z[5])*sin(z[5])*z[15]^2
            res[30ind+15] +=	(sqrt(3)*cos(z[6])*sin(z[5])*dz[20])*0.5-sin(z[5])*sin(z[6])*dz[21]-(cos(z[6])*sin(z[5])*dz[19])*0.5+2*L2*M3*sin(z[5])^2*dz[15]+M3*0.0*sin(z[5])*sin(z[6])+2*L2*M3*sin(2*z[5])*z[14]*z[15]+L1*M3*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2-L1*M3*cos(z[4])*sin(z[5])*sin(z[6])*dz[13]
            res[30ind+16] +=	L1*M3*dz[17]*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*M3*z[17]^2*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*M3*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2-L1*M3*cos(z[7])*sin(z[8])*sin(z[9])*dz[18]-2*L1*M3*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]
            res[30ind+17] +=	dz[23]*(sin(z[8])*0.5-(sqrt(3)*cos(z[8])*sin(z[9]))*0.5)-dz[22]*((cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*sin(z[8]))*0.5)+cos(z[8])*cos(z[9])*dz[24]+2*L2*M3*dz[17]+L1*M3*dz[16]*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))-M3*0.0*cos(z[8])*cos(z[9])+L1*M3*z[16]^2*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-2*L2*M3*cos(z[8])*sin(z[8])*z[18]^2
            res[30ind+18] +=	2*L2*M3*sin(z[8])^2*dz[18]-sin(z[8])*sin(z[9])*dz[24]-(sqrt(3)*cos(z[9])*sin(z[8])*dz[23])*0.5-(cos(z[9])*sin(z[8])*dz[22])*0.5+M3*0.0*sin(z[8])*sin(z[9])+2*L2*M3*sin(2*z[8])*z[17]*z[18]+L1*M3*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2-L1*M3*cos(z[7])*sin(z[8])*sin(z[9])*dz[16]
            res[30ind+19] +=	(sqrt(3)*cos(z[5]))*0.5+sin(z[2])*sin(z[3])+(sin(z[5])*sin(z[6]))*0.5
            res[30ind+20] +=	cos(z[2])+cos(z[5])*0.5-(sqrt(3)*sin(z[5])*sin(z[6]))*0.5
            res[30ind+21] +=	cos(z[3])*sin(z[2])-cos(z[6])*sin(z[5])
            res[30ind+22] +=	sin(z[2])*sin(z[3])-(sqrt(3)*cos(z[8]))*0.5+(sin(z[8])*sin(z[9]))*0.5
            res[30ind+23] +=	cos(z[2])+cos(z[8])*0.5+(sqrt(3)*sin(z[8])*sin(z[9]))*0.5
            res[30ind+24] +=	cos(z[3])*sin(z[2])-cos(z[9])*sin(z[8])
            res[30ind+25] +=	cos(z[2])*sin(z[3])*z[11]-(sqrt(3)*sin(z[5])*z[14])*0.5+cos(z[3])*sin(z[2])*z[12]+(cos(z[5])*sin(z[6])*z[14])*0.5+(cos(z[6])*sin(z[5])*z[15])*0.5
            res[30ind+26] +=	-sin(z[2])*z[11]-(sin(z[5])*z[14])*0.5-(sqrt(3)*cos(z[5])*sin(z[6])*z[14])*0.5-(sqrt(3)*cos(z[6])*sin(z[5])*z[15])*0.5
            res[30ind+27] +=	cos(z[2])*cos(z[3])*z[11]-cos(z[5])*cos(z[6])*z[14]-sin(z[2])*sin(z[3])*z[12]+sin(z[5])*sin(z[6])*z[15]
            res[30ind+28] +=	(sqrt(3)*sin(z[8])*z[17])*0.5+cos(z[2])*sin(z[3])*z[11]+cos(z[3])*sin(z[2])*z[12]+(cos(z[8])*sin(z[9])*z[17])*0.5+(cos(z[9])*sin(z[8])*z[18])*0.5
            res[30ind+29] +=	(sqrt(3)*cos(z[8])*sin(z[9])*z[17])*0.5-(sin(z[8])*z[17])*0.5-sin(z[2])*z[11]+(sqrt(3)*cos(z[9])*sin(z[8])*z[18])*0.5
            res[30ind+30] +=	cos(z[2])*cos(z[3])*z[11]-cos(z[8])*cos(z[9])*z[17]-sin(z[2])*sin(z[3])*z[12]+sin(z[8])*sin(z[9])*z[18]
            # Parameter-specific part for L3
            ind=4
            res[30ind+19] +=	-sqrt(3)*0.5
            res[30ind+20] +=	-1.5
            res[30ind+22] +=	sqrt(3)*0.5
            res[30ind+23] +=	-1.5
            # Parameter-specific part for LC1
            ind=5
            res[30ind+10] +=	2*LC1*M1*dz[10]-M1*0.0*cos(z[1])
            res[30ind+13] +=	2*LC1*M1*dz[13]-M1*0.0*cos(z[4])
            res[30ind+16] +=	2*LC1*M1*dz[16]-M1*0.0*cos(z[7])
            # Parameter-specific part for LC2
            ind=6
            res[30ind+10] +=	L1*M2*dz[11]*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*M2*z[11]^2*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*M2*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2-L1*M2*cos(z[1])*sin(z[2])*sin(z[3])*dz[12]-2*L1*M2*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]
            res[30ind+11] +=	2*LC2*M2*dz[11]+L1*M2*dz[10]*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))-M2*0.0*cos(z[2])*cos(z[3])+L1*M2*z[10]^2*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-2*LC2*M2*cos(z[2])*sin(z[2])*z[12]^2
            res[30ind+12] +=	2*LC2*M2*sin(z[2])^2*dz[12]+M2*0.0*sin(z[2])*sin(z[3])+2*LC2*M2*sin(2*z[2])*z[11]*z[12]+L1*M2*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2-L1*M2*cos(z[1])*sin(z[2])*sin(z[3])*dz[10]
            res[30ind+13] +=	L1*M2*dz[14]*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*M2*z[14]^2*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*M2*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2-L1*M2*cos(z[4])*sin(z[5])*sin(z[6])*dz[15]-2*L1*M2*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]
            res[30ind+14] +=	2*LC2*M2*dz[14]+L1*M2*dz[13]*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))-M2*0.0*cos(z[5])*cos(z[6])+L1*M2*z[13]^2*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-2*LC2*M2*cos(z[5])*sin(z[5])*z[15]^2
            res[30ind+15] +=	2*LC2*M2*sin(z[5])^2*dz[15]+M2*0.0*sin(z[5])*sin(z[6])+2*LC2*M2*sin(2*z[5])*z[14]*z[15]+L1*M2*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2-L1*M2*cos(z[4])*sin(z[5])*sin(z[6])*dz[13]
            res[30ind+16] +=	L1*M2*dz[17]*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*M2*z[17]^2*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*M2*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2-L1*M2*cos(z[7])*sin(z[8])*sin(z[9])*dz[18]-2*L1*M2*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]
            res[30ind+17] +=	2*LC2*M2*dz[17]+L1*M2*dz[16]*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))-M2*0.0*cos(z[8])*cos(z[9])+L1*M2*z[16]^2*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-2*LC2*M2*cos(z[8])*sin(z[8])*z[18]^2
            res[30ind+18] +=	2*LC2*M2*sin(z[8])^2*dz[18]+M2*0.0*sin(z[8])*sin(z[9])+2*LC2*M2*sin(2*z[8])*z[17]*z[18]+L1*M2*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2-L1*M2*cos(z[7])*sin(z[8])*sin(z[9])*dz[16]
            # Parameter-specific part for M1
            ind=7
            res[30ind+10] +=	LC1^2*dz[10]-LC1*0.0*cos(z[1])
            res[30ind+13] +=	LC1^2*dz[13]-LC1*0.0*cos(z[4])
            res[30ind+16] +=	LC1^2*dz[16]-LC1*0.0*cos(z[7])
            # Parameter-specific part for M2
            ind=8
            res[30ind+10] +=	L1^2*dz[10]-L1*0.0*cos(z[1])+L1*LC2*dz[11]*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*LC2*z[11]^2*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*LC2*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2-L1*LC2*cos(z[1])*sin(z[2])*sin(z[3])*dz[12]-2*L1*LC2*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]
            res[30ind+11] +=	LC2^2*dz[11]+L1*LC2*dz[10]*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))-LC2*0.0*cos(z[2])*cos(z[3])+L1*LC2*z[10]^2*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-LC2^2*cos(z[2])*sin(z[2])*z[12]^2
            res[30ind+12] +=	LC2^2*sin(z[2])^2*dz[12]+LC2^2*sin(2*z[2])*z[11]*z[12]+LC2*0.0*sin(z[2])*sin(z[3])+L1*LC2*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2-L1*LC2*cos(z[1])*sin(z[2])*sin(z[3])*dz[10]
            res[30ind+13] +=	L1^2*dz[13]-L1*0.0*cos(z[4])+L1*LC2*dz[14]*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*LC2*z[14]^2*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*LC2*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2-L1*LC2*cos(z[4])*sin(z[5])*sin(z[6])*dz[15]-2*L1*LC2*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]
            res[30ind+14] +=	LC2^2*dz[14]+L1*LC2*dz[13]*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))-LC2*0.0*cos(z[5])*cos(z[6])+L1*LC2*z[13]^2*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-LC2^2*cos(z[5])*sin(z[5])*z[15]^2
            res[30ind+15] +=	LC2^2*sin(z[5])^2*dz[15]+LC2^2*sin(2*z[5])*z[14]*z[15]+LC2*0.0*sin(z[5])*sin(z[6])+L1*LC2*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2-L1*LC2*cos(z[4])*sin(z[5])*sin(z[6])*dz[13]
            res[30ind+16] +=	L1^2*dz[16]-L1*0.0*cos(z[7])+L1*LC2*dz[17]*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*LC2*z[17]^2*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*LC2*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2-L1*LC2*cos(z[7])*sin(z[8])*sin(z[9])*dz[18]-2*L1*LC2*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]
            res[30ind+17] +=	LC2^2*dz[17]+L1*LC2*dz[16]*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))-LC2*0.0*cos(z[8])*cos(z[9])+L1*LC2*z[16]^2*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-LC2^2*cos(z[8])*sin(z[8])*z[18]^2
            res[30ind+18] +=	LC2^2*sin(z[8])^2*dz[18]+LC2^2*sin(2*z[8])*z[17]*z[18]+LC2*0.0*sin(z[8])*sin(z[9])+L1*LC2*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2-L1*LC2*cos(z[7])*sin(z[8])*sin(z[9])*dz[16]
            # Parameter-specific part for M3
            ind=9
            res[30ind+10] +=	L1^2*dz[10]-L1*0.0*cos(z[1])+L1*L2*dz[11]*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*L2*z[11]^2*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*L2*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2-L1*L2*cos(z[1])*sin(z[2])*sin(z[3])*dz[12]-2*L1*L2*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]
            res[30ind+11] +=	L2^2*dz[11]+L1*L2*dz[10]*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))-L2*0.0*cos(z[2])*cos(z[3])+L1*L2*z[10]^2*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L2^2*cos(z[2])*sin(z[2])*z[12]^2
            res[30ind+12] +=	L2^2*sin(z[2])^2*dz[12]+L2^2*sin(2*z[2])*z[11]*z[12]+L2*0.0*sin(z[2])*sin(z[3])+L1*L2*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2-L1*L2*cos(z[1])*sin(z[2])*sin(z[3])*dz[10]
            res[30ind+13] +=	L1^2*dz[13]-L1*0.0*cos(z[4])+L1*L2*dz[14]*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*L2*z[14]^2*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*L2*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2-L1*L2*cos(z[4])*sin(z[5])*sin(z[6])*dz[15]-2*L1*L2*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]
            res[30ind+14] +=	L2^2*dz[14]+L1*L2*dz[13]*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))-L2*0.0*cos(z[5])*cos(z[6])+L1*L2*z[13]^2*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L2^2*cos(z[5])*sin(z[5])*z[15]^2
            res[30ind+15] +=	L2^2*sin(z[5])^2*dz[15]+L2^2*sin(2*z[5])*z[14]*z[15]+L2*0.0*sin(z[5])*sin(z[6])+L1*L2*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2-L1*L2*cos(z[4])*sin(z[5])*sin(z[6])*dz[13]
            res[30ind+16] +=	L1^2*dz[16]-L1*0.0*cos(z[7])+L1*L2*dz[17]*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*L2*z[17]^2*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*L2*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2-L1*L2*cos(z[7])*sin(z[8])*sin(z[9])*dz[18]-2*L1*L2*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]
            res[30ind+17] +=	L2^2*dz[17]+L1*L2*dz[16]*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))-L2*0.0*cos(z[8])*cos(z[9])+L1*L2*z[16]^2*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L2^2*cos(z[8])*sin(z[8])*z[18]^2
            res[30ind+18] +=	L2^2*sin(z[8])^2*dz[18]+L2^2*sin(2*z[8])*z[17]*z[18]+L2*0.0*sin(z[8])*sin(z[9])+L1*L2*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2-L1*L2*cos(z[7])*sin(z[8])*sin(z[9])*dz[16]
            # Parameter-specific part for J1
            ind=10
            res[30ind+10] +=	dz[10]
            res[30ind+13] +=	dz[13]
            res[30ind+16] +=	dz[16]
            # Parameter-specific part for J2
            ind=11
            res[30ind+11] +=	dz[11]-cos(z[2])*sin(z[2])*z[12]^2
            res[30ind+12] +=	sin(z[2])^2*dz[12]+sin(2*z[2])*z[11]*z[12]
            res[30ind+14] +=	dz[14]-cos(z[5])*sin(z[5])*z[15]^2
            res[30ind+15] +=	sin(z[5])^2*dz[15]+sin(2*z[5])*z[14]*z[15]
            res[30ind+17] +=	dz[17]-cos(z[8])*sin(z[8])*z[18]^2
            res[30ind+18] +=	sin(z[8])^2*dz[18]+sin(2*z[8])*z[17]*z[18]
            # Parameter-specific part for γ
            ind=12
            res[30ind+10] +=	z[10]
            res[30ind+11] +=	z[11]
            res[30ind+12] +=	z[12]
            res[30ind+13] +=	z[13]
            res[30ind+14] +=	z[14]
            res[30ind+15] +=	z[15]
            res[30ind+16] +=	z[16]
            res[30ind+17] +=	z[17]
            res[30ind+18] +=	z[18]

            for ind = 13:24 # wt first contains the 3 elements of w, then derivative of w wrt to first parameter, then second parameter, etc...
                res[30ind + 10] += -2wt[1]*wt[3(ind-12) + 1]
                res[30ind + 13] += -2wt[2]*wt[3(ind-12) + 2]
                res[30ind + 16] += -2wt[3]*wt[3(ind-12) + 3]
            end

            nothing
        end
        
        z0dyn, dz0dyn, did = get_delta_initial_with_mats(pars, u(0.0), w(0.0))
        zL0, dzL0 = get_delta_initial_L0sens(pars, z0dyn, dz0dyn, did)
        zL1, dzL1 = get_delta_initial_L1sens(pars, z0dyn, dz0dyn, did)
        zL2, dzL2 = get_delta_initial_L2sens(pars, z0dyn, dz0dyn, did)
        zL3, dzL3 = get_delta_initial_L3sens(pars, z0dyn, dz0dyn, did)
        zLC1, dzLC1 = get_delta_initial_LC1sens(pars, z0dyn, dz0dyn, did)
        zLC2, dzLC2 = get_delta_initial_LC2sens(pars, z0dyn, dz0dyn, did)
        zM1, dzM1 = get_delta_initial_M1sens(pars, z0dyn, dz0dyn, did)
        zM2, dzM2 = get_delta_initial_M2sens(pars, z0dyn, dz0dyn, did)
        zM3, dzM3 = get_delta_initial_M3sens(pars, z0dyn, dz0dyn, did)
        zJ1, dzJ1 = get_delta_initial_J1sens(pars, z0dyn, dz0dyn, did)
        zJ2, dzJ2 = get_delta_initial_J2sens(pars, z0dyn, dz0dyn, did)
        zγ, dzγ = get_delta_initial_γsens(pars, z0dyn, dz0dyn, did)
        z0dist = zeros(30)  # Assuming parameter-independent initial value of w
        dz0dist = zeros(30) # Assuming parameter-independent initial value of w
        z0 = vcat(z0dyn, zL0, zL1, zL2, zL3, zLC1, zLC2, zM1, zM2, zM3, zJ1, zJ2, zγ, repeat(z0dist, 12))
        dz0 = vcat(dz0dyn, dzL0, dzL1, dzL2, dzL3, dzLC1, dzLC2, dzM1, dzM2, dzM3, dzJ1, dzJ2, dzγ, repeat(dz0dist, 12))

        dvars = fill(true, 30*(24+1))
        r0 = zeros(length(z0))
        f!(r0, dz0, z0, [], 0.0)
        # @info "r0 for delta robot is: $r0"

        # t -> 0.0 is just a dummy function, not to be used
        Model(f!, t -> 0.0, z0, dz0, dvars, r0)
    end
end

# -------------------- Adjoint sensitivity models ---------------------------

# Used to be called delta_robot_gc_adjoint_γonly_new
function delta_adjoint_γ(_::Function, pars::Vector{Float64}, T::Float64, x::func_type, x2::func_type, y::func_type, dy::func_type, xθ0::Matrix{Float64}, dx::func_type, dx2::func_type)::Tuple{Model,Function}
    # g = 0 because this is the gravity-compensated model
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]
        nx, nθ = size(xθ0)
        @assert (nθ == 1) "delta_adjoint_γ is hard-coded to only handle one parameter γ, make sure to pass correct xθ0. Currently passing $nθ parameters."
        @assert (nx == 33) "delta_adjoint_γ expects the DAE state to have 33 components, the passed state has $nx components instead"

        FxT = [-L1*cos(x(T,1))*dx(T,26)-L1*cos(x(T,1))*dx(T,29)-L1*sin(x(T,1))*dx(T,27)-L1*sin(x(T,1))*dx(T,30)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   -L2*cos(x(T,2))*dx(T,26)-L2*cos(x(T,2))*dx(T,29)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,27)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,30)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,25)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,28)   L2*cos(x(T,2))*cos(x(T,3))*dx(T,25)+L2*cos(x(T,2))*cos(x(T,3))*dx(T,28)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,27)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,30)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*cos(x(T,3))*dx(T,25)+L2*cos(x(T,2))*cos(x(T,3))*dx(T,28)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,27)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,30)   -L2*cos(x(T,3))*sin(x(T,2))*dx(T,27)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,30)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,25)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,28)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   L1*sin(x(T,4))*dx(T,27)-(L1*cos(x(T,4))*dx(T,26))*0.5-(sqrt(3)*L1*cos(x(T,4))*dx(T,25))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   L2*cos(x(T,6))*sin(x(T,5))*dx(T,27)-dx(T,26)*((L2*cos(x(T,5)))*0.5-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6)))*0.5)-dx(T,25)*((sqrt(3)*L2*cos(x(T,5)))*0.5+(L2*sin(x(T,5))*sin(x(T,6)))*0.5)   (L2*cos(x(T,5))*cos(x(T,6))*dx(T,25))*0.5+L2*cos(x(T,5))*sin(x(T,6))*dx(T,27)-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,26))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   (L2*cos(x(T,5))*cos(x(T,6))*dx(T,25))*0.5+L2*cos(x(T,5))*sin(x(T,6))*dx(T,27)-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,26))*0.5   L2*cos(x(T,6))*sin(x(T,5))*dx(T,27)-(L2*sin(x(T,5))*sin(x(T,6))*dx(T,25))*0.5+(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,26))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(T,7))*dx(T,30)-(L1*cos(x(T,7))*dx(T,29))*0.5+(sqrt(3)*L1*cos(x(T,7))*dx(T,28))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   dx(T,28)*((sqrt(3)*L2*cos(x(T,8)))*0.5-(L2*sin(x(T,8))*sin(x(T,9)))*0.5)-dx(T,29)*((L2*cos(x(T,8)))*0.5+(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9)))*0.5)+L2*cos(x(T,9))*sin(x(T,8))*dx(T,30)   (L2*cos(x(T,8))*cos(x(T,9))*dx(T,28))*0.5+L2*cos(x(T,8))*sin(x(T,9))*dx(T,30)+(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,29))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,8))*cos(x(T,9))*dx(T,28))*0.5+L2*cos(x(T,8))*sin(x(T,9))*dx(T,30)+(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,29))*0.5   L2*cos(x(T,9))*sin(x(T,8))*dx(T,30)-(L2*sin(x(T,8))*sin(x(T,9))*dx(T,28))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,29))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0*sin(x(T,1))*(L1*(M2+M3)+LC1*M1)+L1*cos(x(T,1))*dx(T,20)+L1*cos(x(T,1))*dx(T,23)+L1*sin(x(T,1))*dx(T,21)+L1*sin(x(T,1))*dx(T,24)+L1*dx(T,11)*(L2*M3+LC2*M2)*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))+L1*x(T,11)^2*(L2*M3+LC2*M2)*(cos(x(T,1))*cos(x(T,2))+cos(x(T,3))*sin(x(T,1))*sin(x(T,2)))+L1*cos(x(T,3))*sin(x(T,1))*sin(x(T,2))*x(T,12)^2*(L2*M3+LC2*M2)+L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,12)*(L2*M3+LC2*M2)+2*L1*cos(x(T,2))*sin(x(T,1))*sin(x(T,3))*x(T,11)*x(T,12)*(L2*M3+LC2*M2)   L1*dx(T,11)*(L2*M3+LC2*M2)*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-L1*x(T,11)^2*(L2*M3+LC2*M2)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))-L1*cos(x(T,1))*cos(x(T,2))*cos(x(T,3))*x(T,12)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,12)*(L2*M3+LC2*M2)+2*L1*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,11)*x(T,12)*(L2*M3+LC2*M2)   L1*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,11)^2*(L2*M3+LC2*M2)+L1*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,12)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,11)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,12)*(L2*M3+LC2*M2)-2*L1*cos(x(T,1))*cos(x(T,2))*cos(x(T,3))*x(T,11)*x(T,12)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   γ   2*L1*x(T,11)*(L2*M3+LC2*M2)*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-2*L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,12)*(L2*M3+LC2*M2)   -2*L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,11)*(L2*M3+LC2*M2)-2*L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*x(T,12)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            L1*dx(T,10)*(L2*M3+LC2*M2)*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))-L1*x(T,10)^2*(L2*M3+LC2*M2)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))   sin(x(T,2))^2*x(T,12)^2*(J2+L2^2*M3+LC2^2*M2)-cos(x(T,2))^2*x(T,12)^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(x(T,2))*dx(T,20)+L2*cos(x(T,2))*dx(T,23)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,21)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,24)+L2*sin(x(T,2))*sin(x(T,3))*dx(T,19)+L2*sin(x(T,2))*sin(x(T,3))*dx(T,22)+L1*dx(T,10)*(L2*M3+LC2*M2)*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))+0.0*cos(x(T,3))*sin(x(T,2))*(L2*M3+LC2*M2)+L1*x(T,10)^2*(L2*M3+LC2*M2)*(cos(x(T,1))*cos(x(T,2))+cos(x(T,3))*sin(x(T,1))*sin(x(T,2)))   L2*cos(x(T,2))*sin(x(T,3))*dx(T,21)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,22)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,19)+L2*cos(x(T,2))*sin(x(T,3))*dx(T,24)+0.0*cos(x(T,2))*sin(x(T,3))*(L2*M3+LC2*M2)+L1*cos(x(T,2))*sin(x(T,1))*sin(x(T,3))*x(T,10)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,10)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*x(T,10)*(L2*M3+LC2*M2)*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))   γ   -2*cos(x(T,2))*sin(x(T,2))*x(T,12)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            L1*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)^2*(L2*M3+LC2*M2)+L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,10)*(L2*M3+LC2*M2)   L2*cos(x(T,2))*sin(x(T,3))*dx(T,21)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,22)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,19)+L2*cos(x(T,2))*sin(x(T,3))*dx(T,24)+2*cos(x(T,2))*sin(x(T,2))*dx(T,12)*(J2+L2^2*M3+LC2^2*M2)+2*cos(2*x(T,2))*x(T,11)*x(T,12)*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(x(T,2))*sin(x(T,3))*(L2*M3+LC2*M2)+L1*cos(x(T,2))*sin(x(T,1))*sin(x(T,3))*x(T,10)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,10)*(L2*M3+LC2*M2)   L2*cos(x(T,3))*sin(x(T,2))*dx(T,21)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,24)+L2*sin(x(T,2))*sin(x(T,3))*dx(T,19)+L2*sin(x(T,2))*sin(x(T,3))*dx(T,22)+0.0*cos(x(T,3))*sin(x(T,2))*(L2*M3+LC2*M2)+L1*cos(x(T,3))*sin(x(T,1))*sin(x(T,2))*x(T,10)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,10)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)*(L2*M3+LC2*M2)   sin(2*x(T,2))*x(T,12)*(J2+L2^2*M3+LC2^2*M2)   γ+sin(2*x(T,2))*x(T,11)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0*sin(x(T,4))*(L1*(M2+M3)+LC1*M1)+(L1*cos(x(T,4))*dx(T,20))*0.5-L1*sin(x(T,4))*dx(T,21)+(sqrt(3)*L1*cos(x(T,4))*dx(T,19))*0.5+L1*dx(T,14)*(L2*M3+LC2*M2)*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))+L1*x(T,14)^2*(L2*M3+LC2*M2)*(cos(x(T,4))*cos(x(T,5))+cos(x(T,6))*sin(x(T,4))*sin(x(T,5)))+L1*cos(x(T,6))*sin(x(T,4))*sin(x(T,5))*x(T,15)^2*(L2*M3+LC2*M2)+L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,15)*(L2*M3+LC2*M2)+2*L1*cos(x(T,5))*sin(x(T,4))*sin(x(T,6))*x(T,14)*x(T,15)*(L2*M3+LC2*M2)   L1*dx(T,14)*(L2*M3+LC2*M2)*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-L1*x(T,14)^2*(L2*M3+LC2*M2)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))-L1*cos(x(T,4))*cos(x(T,5))*cos(x(T,6))*x(T,15)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,15)*(L2*M3+LC2*M2)+2*L1*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,14)*x(T,15)*(L2*M3+LC2*M2)   L1*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,14)^2*(L2*M3+LC2*M2)+L1*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,15)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,14)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,15)*(L2*M3+LC2*M2)-2*L1*cos(x(T,4))*cos(x(T,5))*cos(x(T,6))*x(T,14)*x(T,15)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   γ   2*L1*x(T,14)*(L2*M3+LC2*M2)*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-2*L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,15)*(L2*M3+LC2*M2)   -2*L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,14)*(L2*M3+LC2*M2)-2*L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*x(T,15)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   L1*dx(T,13)*(L2*M3+LC2*M2)*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))-L1*x(T,13)^2*(L2*M3+LC2*M2)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))   dx(T,19)*((sqrt(3)*L2*cos(x(T,5)))*0.5+(L2*sin(x(T,5))*sin(x(T,6)))*0.5)+dx(T,20)*((L2*cos(x(T,5)))*0.5-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6)))*0.5)-cos(x(T,5))^2*x(T,15)^2*(J2+L2^2*M3+LC2^2*M2)+sin(x(T,5))^2*x(T,15)^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(x(T,6))*sin(x(T,5))*dx(T,21)+L1*dx(T,13)*(L2*M3+LC2*M2)*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))+0.0*cos(x(T,6))*sin(x(T,5))*(L2*M3+LC2*M2)+L1*x(T,13)^2*(L2*M3+LC2*M2)*(cos(x(T,4))*cos(x(T,5))+cos(x(T,6))*sin(x(T,4))*sin(x(T,5)))   0.0*cos(x(T,5))*sin(x(T,6))*(L2*M3+LC2*M2)-L2*cos(x(T,5))*sin(x(T,6))*dx(T,21)-(L2*cos(x(T,5))*cos(x(T,6))*dx(T,19))*0.5+(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,20))*0.5+L1*cos(x(T,5))*sin(x(T,4))*sin(x(T,6))*x(T,13)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,13)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*x(T,13)*(L2*M3+LC2*M2)*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))   γ   -2*cos(x(T,5))*sin(x(T,5))*x(T,15)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   L1*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)^2*(L2*M3+LC2*M2)+L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,13)*(L2*M3+LC2*M2)   2*cos(x(T,5))*sin(x(T,5))*dx(T,15)*(J2+L2^2*M3+LC2^2*M2)-L2*cos(x(T,5))*sin(x(T,6))*dx(T,21)-(L2*cos(x(T,5))*cos(x(T,6))*dx(T,19))*0.5+2*cos(2*x(T,5))*x(T,14)*x(T,15)*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(x(T,5))*sin(x(T,6))*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,20))*0.5+L1*cos(x(T,5))*sin(x(T,4))*sin(x(T,6))*x(T,13)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,13)*(L2*M3+LC2*M2)   (L2*sin(x(T,5))*sin(x(T,6))*dx(T,19))*0.5-L2*cos(x(T,6))*sin(x(T,5))*dx(T,21)+0.0*cos(x(T,6))*sin(x(T,5))*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,20))*0.5+L1*cos(x(T,6))*sin(x(T,4))*sin(x(T,5))*x(T,13)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,13)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)*(L2*M3+LC2*M2)   sin(2*x(T,5))*x(T,15)*(J2+L2^2*M3+LC2^2*M2)   γ+sin(2*x(T,5))*x(T,14)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0*sin(x(T,7))*(L1*(M2+M3)+LC1*M1)+(L1*cos(x(T,7))*dx(T,23))*0.5-L1*sin(x(T,7))*dx(T,24)-(sqrt(3)*L1*cos(x(T,7))*dx(T,22))*0.5+L1*dx(T,17)*(L2*M3+LC2*M2)*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))+L1*x(T,17)^2*(L2*M3+LC2*M2)*(cos(x(T,7))*cos(x(T,8))+cos(x(T,9))*sin(x(T,7))*sin(x(T,8)))+L1*cos(x(T,9))*sin(x(T,7))*sin(x(T,8))*x(T,18)^2*(L2*M3+LC2*M2)+L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,18)*(L2*M3+LC2*M2)+2*L1*cos(x(T,8))*sin(x(T,7))*sin(x(T,9))*x(T,17)*x(T,18)*(L2*M3+LC2*M2)   L1*dx(T,17)*(L2*M3+LC2*M2)*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-L1*x(T,17)^2*(L2*M3+LC2*M2)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))-L1*cos(x(T,7))*cos(x(T,8))*cos(x(T,9))*x(T,18)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,18)*(L2*M3+LC2*M2)+2*L1*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,17)*x(T,18)*(L2*M3+LC2*M2)   L1*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,17)^2*(L2*M3+LC2*M2)+L1*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,18)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,17)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,18)*(L2*M3+LC2*M2)-2*L1*cos(x(T,7))*cos(x(T,8))*cos(x(T,9))*x(T,17)*x(T,18)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   γ   2*L1*x(T,17)*(L2*M3+LC2*M2)*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-2*L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,18)*(L2*M3+LC2*M2)   -2*L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,17)*(L2*M3+LC2*M2)-2*L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*x(T,18)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*dx(T,16)*(L2*M3+LC2*M2)*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))-L1*x(T,16)^2*(L2*M3+LC2*M2)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))   dx(T,23)*((L2*cos(x(T,8)))*0.5+(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9)))*0.5)-dx(T,22)*((sqrt(3)*L2*cos(x(T,8)))*0.5-(L2*sin(x(T,8))*sin(x(T,9)))*0.5)-cos(x(T,8))^2*x(T,18)^2*(J2+L2^2*M3+LC2^2*M2)+sin(x(T,8))^2*x(T,18)^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(x(T,9))*sin(x(T,8))*dx(T,24)+L1*dx(T,16)*(L2*M3+LC2*M2)*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))+0.0*cos(x(T,9))*sin(x(T,8))*(L2*M3+LC2*M2)+L1*x(T,16)^2*(L2*M3+LC2*M2)*(cos(x(T,7))*cos(x(T,8))+cos(x(T,9))*sin(x(T,7))*sin(x(T,8)))   0.0*cos(x(T,8))*sin(x(T,9))*(L2*M3+LC2*M2)-L2*cos(x(T,8))*sin(x(T,9))*dx(T,24)-(L2*cos(x(T,8))*cos(x(T,9))*dx(T,22))*0.5-(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,23))*0.5+L1*cos(x(T,8))*sin(x(T,7))*sin(x(T,9))*x(T,16)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,16)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*x(T,16)*(L2*M3+LC2*M2)*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))   γ   -2*cos(x(T,8))*sin(x(T,8))*x(T,18)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)^2*(L2*M3+LC2*M2)+L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,16)*(L2*M3+LC2*M2)   2*cos(x(T,8))*sin(x(T,8))*dx(T,18)*(J2+L2^2*M3+LC2^2*M2)-L2*cos(x(T,8))*sin(x(T,9))*dx(T,24)-(L2*cos(x(T,8))*cos(x(T,9))*dx(T,22))*0.5+2*cos(2*x(T,8))*x(T,17)*x(T,18)*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(x(T,8))*sin(x(T,9))*(L2*M3+LC2*M2)-(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,23))*0.5+L1*cos(x(T,8))*sin(x(T,7))*sin(x(T,9))*x(T,16)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,16)*(L2*M3+LC2*M2)   (L2*sin(x(T,8))*sin(x(T,9))*dx(T,22))*0.5-L2*cos(x(T,9))*sin(x(T,8))*dx(T,24)+0.0*cos(x(T,9))*sin(x(T,8))*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,23))*0.5+L1*cos(x(T,9))*sin(x(T,7))*sin(x(T,8))*x(T,16)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,16)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)*(L2*M3+LC2*M2)   sin(2*x(T,8))*x(T,18)*(J2+L2^2*M3+LC2^2*M2)   γ+sin(2*x(T,8))*x(T,17)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*sin(x(T,3))   L2*cos(x(T,3))*sin(x(T,2))   -(sqrt(3)*L1*sin(x(T,4)))*0.5   (L2*cos(x(T,5))*sin(x(T,6)))*0.5-(sqrt(3)*L2*sin(x(T,5)))*0.5   (L2*cos(x(T,6))*sin(x(T,5)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*sin(x(T,1))   -L2*sin(x(T,2))   0.0   -(L1*sin(x(T,4)))*0.5   -(L2*sin(x(T,5)))*0.5-(sqrt(3)*L2*cos(x(T,5))*sin(x(T,6)))*0.5   -(sqrt(3)*L2*cos(x(T,6))*sin(x(T,5)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            L1*cos(x(T,1))   L2*cos(x(T,2))*cos(x(T,3))   -L2*sin(x(T,2))*sin(x(T,3))   -L1*cos(x(T,4))   -L2*cos(x(T,5))*cos(x(T,6))   L2*sin(x(T,5))*sin(x(T,6))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*sin(x(T,3))   L2*cos(x(T,3))*sin(x(T,2))   0.0   0.0   0.0   (sqrt(3)*L1*sin(x(T,7)))*0.5   (L2*cos(x(T,8))*sin(x(T,9)))*0.5+(sqrt(3)*L2*sin(x(T,8)))*0.5   (L2*cos(x(T,9))*sin(x(T,8)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*sin(x(T,1))   -L2*sin(x(T,2))   0.0   0.0   0.0   0.0   -(L1*sin(x(T,7)))*0.5   (sqrt(3)*L2*cos(x(T,8))*sin(x(T,9)))*0.5-(L2*sin(x(T,8)))*0.5   (sqrt(3)*L2*cos(x(T,9))*sin(x(T,8)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            L1*cos(x(T,1))   L2*cos(x(T,2))*cos(x(T,3))   -L2*sin(x(T,2))*sin(x(T,3))   0.0   0.0   0.0   -L1*cos(x(T,7))   -L2*cos(x(T,8))*cos(x(T,9))   L2*sin(x(T,8))*sin(x(T,9))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*cos(x(T,3))*x(T,12)-L2*sin(x(T,2))*sin(x(T,3))*x(T,11)   L2*cos(x(T,2))*cos(x(T,3))*x(T,11)-L2*sin(x(T,2))*sin(x(T,3))*x(T,12)   -(sqrt(3)*L1*cos(x(T,4))*x(T,13))*0.5   (L2*cos(x(T,5))*cos(x(T,6))*x(T,15))*0.5-(sqrt(3)*L2*cos(x(T,5))*x(T,14))*0.5-(L2*sin(x(T,5))*sin(x(T,6))*x(T,14))*0.5   (L2*cos(x(T,5))*cos(x(T,6))*x(T,14))*0.5-(L2*sin(x(T,5))*sin(x(T,6))*x(T,15))*0.5   0.0   0.0   0.0   0.0   L2*cos(x(T,2))*sin(x(T,3))   L2*cos(x(T,3))*sin(x(T,2))   -(sqrt(3)*L1*sin(x(T,4)))*0.5   (L2*cos(x(T,5))*sin(x(T,6)))*0.5-(sqrt(3)*L2*sin(x(T,5)))*0.5   (L2*cos(x(T,6))*sin(x(T,5)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*cos(x(T,1))*x(T,10)   -L2*cos(x(T,2))*x(T,11)   0.0   -(L1*cos(x(T,4))*x(T,13))*0.5   (sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*x(T,14))*0.5-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*x(T,15))*0.5-(L2*cos(x(T,5))*x(T,14))*0.5   (sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*x(T,15))*0.5-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*x(T,14))*0.5   0.0   0.0   0.0   -L1*sin(x(T,1))   -L2*sin(x(T,2))   0.0   -(L1*sin(x(T,4)))*0.5   -(L2*sin(x(T,5)))*0.5-(sqrt(3)*L2*cos(x(T,5))*sin(x(T,6)))*0.5   -(sqrt(3)*L2*cos(x(T,6))*sin(x(T,5)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*sin(x(T,1))*x(T,10)   -L2*cos(x(T,3))*sin(x(T,2))*x(T,11)-L2*cos(x(T,2))*sin(x(T,3))*x(T,12)   -L2*cos(x(T,2))*sin(x(T,3))*x(T,11)-L2*cos(x(T,3))*sin(x(T,2))*x(T,12)   L1*sin(x(T,4))*x(T,13)   L2*cos(x(T,6))*sin(x(T,5))*x(T,14)+L2*cos(x(T,5))*sin(x(T,6))*x(T,15)   L2*cos(x(T,5))*sin(x(T,6))*x(T,14)+L2*cos(x(T,6))*sin(x(T,5))*x(T,15)   0.0   0.0   0.0   L1*cos(x(T,1))   L2*cos(x(T,2))*cos(x(T,3))   -L2*sin(x(T,2))*sin(x(T,3))   -L1*cos(x(T,4))   -L2*cos(x(T,5))*cos(x(T,6))   L2*sin(x(T,5))*sin(x(T,6))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*cos(x(T,3))*x(T,12)-L2*sin(x(T,2))*sin(x(T,3))*x(T,11)   L2*cos(x(T,2))*cos(x(T,3))*x(T,11)-L2*sin(x(T,2))*sin(x(T,3))*x(T,12)   0.0   0.0   0.0   (sqrt(3)*L1*cos(x(T,7))*x(T,16))*0.5   (L2*cos(x(T,8))*cos(x(T,9))*x(T,18))*0.5+(sqrt(3)*L2*cos(x(T,8))*x(T,17))*0.5-(L2*sin(x(T,8))*sin(x(T,9))*x(T,17))*0.5   (L2*cos(x(T,8))*cos(x(T,9))*x(T,17))*0.5-(L2*sin(x(T,8))*sin(x(T,9))*x(T,18))*0.5   0.0   L2*cos(x(T,2))*sin(x(T,3))   L2*cos(x(T,3))*sin(x(T,2))   0.0   0.0   0.0   (sqrt(3)*L1*sin(x(T,7)))*0.5   (L2*cos(x(T,8))*sin(x(T,9)))*0.5+(sqrt(3)*L2*sin(x(T,8)))*0.5   (L2*cos(x(T,9))*sin(x(T,8)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*cos(x(T,1))*x(T,10)   -L2*cos(x(T,2))*x(T,11)   0.0   0.0   0.0   0.0   -(L1*cos(x(T,7))*x(T,16))*0.5   (sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*x(T,18))*0.5-(L2*cos(x(T,8))*x(T,17))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*x(T,17))*0.5   (sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*x(T,17))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*x(T,18))*0.5   -L1*sin(x(T,1))   -L2*sin(x(T,2))   0.0   0.0   0.0   0.0   -(L1*sin(x(T,7)))*0.5   (sqrt(3)*L2*cos(x(T,8))*sin(x(T,9)))*0.5-(L2*sin(x(T,8)))*0.5   (sqrt(3)*L2*cos(x(T,9))*sin(x(T,8)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*sin(x(T,1))*x(T,10)   -L2*cos(x(T,3))*sin(x(T,2))*x(T,11)-L2*cos(x(T,2))*sin(x(T,3))*x(T,12)   -L2*cos(x(T,2))*sin(x(T,3))*x(T,11)-L2*cos(x(T,3))*sin(x(T,2))*x(T,12)   0.0   0.0   0.0   L1*sin(x(T,7))*x(T,16)   L2*cos(x(T,9))*sin(x(T,8))*x(T,17)+L2*cos(x(T,8))*sin(x(T,9))*x(T,18)   L2*cos(x(T,8))*sin(x(T,9))*x(T,17)+L2*cos(x(T,9))*sin(x(T,8))*x(T,18)   L1*cos(x(T,1))   L2*cos(x(T,2))*cos(x(T,3))   -L2*sin(x(T,2))*sin(x(T,3))   0.0   0.0   0.0   -L1*cos(x(T,7))   -L2*cos(x(T,8))*cos(x(T,9))   L2*sin(x(T,8))*sin(x(T,9))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   -L2*cos(x(T,2))*sin(x(T,3))   -L2*cos(x(T,3))*sin(x(T,2))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0
            L1*sin(x(T,1))   L2*sin(x(T,2))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0
            -L1*cos(x(T,1))   -L2*cos(x(T,2))*cos(x(T,3))   L2*sin(x(T,2))*sin(x(T,3))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0]
        Fdx = t -> [
            1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*sin(x(t,1))   L1*cos(x(t,1))   0.0   -L1*sin(x(t,1))   L1*cos(x(t,1))   0.0   0.0   0.0
            0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*cos(x(t,2))*sin(x(t,3))   -L2*sin(x(t,2))   L2*cos(x(t,2))*cos(x(t,3))   L2*cos(x(t,2))*sin(x(t,3))   -L2*sin(x(t,2))   L2*cos(x(t,2))*cos(x(t,3))   0.0   0.0   0.0
            0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*cos(x(t,3))*sin(x(t,2))   0.0   -L2*sin(x(t,2))*sin(x(t,3))   L2*cos(x(t,3))*sin(x(t,2))   0.0   -L2*sin(x(t,2))*sin(x(t,3))   0.0   0.0   0.0
            0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -(sqrt(3)*L1*sin(x(t,4)))*0.5   -(L1*sin(x(t,4)))*0.5   -L1*cos(x(t,4))   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(t,5))*sin(x(t,6)))*0.5-(sqrt(3)*L2*sin(x(t,5)))*0.5   -(L2*sin(x(t,5)))*0.5-(sqrt(3)*L2*cos(x(t,5))*sin(x(t,6)))*0.5   -L2*cos(x(t,5))*cos(x(t,6))   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(t,6))*sin(x(t,5)))*0.5   -(sqrt(3)*L2*cos(x(t,6))*sin(x(t,5)))*0.5   L2*sin(x(t,5))*sin(x(t,6))   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (sqrt(3)*L1*sin(x(t,7)))*0.5   -(L1*sin(x(t,7)))*0.5   -L1*cos(x(t,7))   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(t,8))*sin(x(t,9)))*0.5+(sqrt(3)*L2*sin(x(t,8)))*0.5   (sqrt(3)*L2*cos(x(t,8))*sin(x(t,9)))*0.5-(L2*sin(x(t,8)))*0.5   -L2*cos(x(t,8))*cos(x(t,9))   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(t,9))*sin(x(t,8)))*0.5   (sqrt(3)*L2*cos(x(t,9))*sin(x(t,8)))*0.5   L2*sin(x(t,8))*sin(x(t,9))   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   J1+L1^2*(M2+M3)+LC1^2*M1   L1*(L2*M3+LC2*M2)*(sin(x(t,1))*sin(x(t,2))+cos(x(t,1))*cos(x(t,2))*cos(x(t,3)))   -L1*cos(x(t,1))*sin(x(t,2))*sin(x(t,3))*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(t,1))   -L1*cos(x(t,1))   0.0   L1*sin(x(t,1))   -L1*cos(x(t,1))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*(L2*M3+LC2*M2)*(sin(x(t,1))*sin(x(t,2))+cos(x(t,1))*cos(x(t,2))*cos(x(t,3)))   J2+L2^2*M3+LC2^2*M2   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L2*cos(x(t,2))*sin(x(t,3))   L2*sin(x(t,2))   -L2*cos(x(t,2))*cos(x(t,3))   -L2*cos(x(t,2))*sin(x(t,3))   L2*sin(x(t,2))   -L2*cos(x(t,2))*cos(x(t,3))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*cos(x(t,1))*sin(x(t,2))*sin(x(t,3))*(L2*M3+LC2*M2)   0.0   sin(x(t,2))^2*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   -L2*cos(x(t,3))*sin(x(t,2))   0.0   L2*sin(x(t,2))*sin(x(t,3))   -L2*cos(x(t,3))*sin(x(t,2))   0.0   L2*sin(x(t,2))*sin(x(t,3))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   J1+L1^2*(M2+M3)+LC1^2*M1   L1*(L2*M3+LC2*M2)*(sin(x(t,4))*sin(x(t,5))+cos(x(t,4))*cos(x(t,5))*cos(x(t,6)))   -L1*cos(x(t,4))*sin(x(t,5))*sin(x(t,6))*(L2*M3+LC2*M2)   0.0   0.0   0.0   (sqrt(3)*L1*sin(x(t,4)))*0.5   (L1*sin(x(t,4)))*0.5   L1*cos(x(t,4))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*(L2*M3+LC2*M2)*(sin(x(t,4))*sin(x(t,5))+cos(x(t,4))*cos(x(t,5))*cos(x(t,6)))   J2+L2^2*M3+LC2^2*M2   0.0   0.0   0.0   0.0   (sqrt(3)*L2*sin(x(t,5)))*0.5-(L2*cos(x(t,5))*sin(x(t,6)))*0.5   (L2*sin(x(t,5)))*0.5+(sqrt(3)*L2*cos(x(t,5))*sin(x(t,6)))*0.5   L2*cos(x(t,5))*cos(x(t,6))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*cos(x(t,4))*sin(x(t,5))*sin(x(t,6))*(L2*M3+LC2*M2)   0.0   sin(x(t,5))^2*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   -(L2*cos(x(t,6))*sin(x(t,5)))*0.5   (sqrt(3)*L2*cos(x(t,6))*sin(x(t,5)))*0.5   -L2*sin(x(t,5))*sin(x(t,6))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   J1+L1^2*(M2+M3)+LC1^2*M1   L1*(L2*M3+LC2*M2)*(sin(x(t,7))*sin(x(t,8))+cos(x(t,7))*cos(x(t,8))*cos(x(t,9)))   -L1*cos(x(t,7))*sin(x(t,8))*sin(x(t,9))*(L2*M3+LC2*M2)   0.0   0.0   0.0   -(sqrt(3)*L1*sin(x(t,7)))*0.5   (L1*sin(x(t,7)))*0.5   L1*cos(x(t,7))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*(L2*M3+LC2*M2)*(sin(x(t,7))*sin(x(t,8))+cos(x(t,7))*cos(x(t,8))*cos(x(t,9)))   J2+L2^2*M3+LC2^2*M2   0.0   0.0   0.0   0.0   -(L2*cos(x(t,8))*sin(x(t,9)))*0.5-(sqrt(3)*L2*sin(x(t,8)))*0.5   (L2*sin(x(t,8)))*0.5-(sqrt(3)*L2*cos(x(t,8))*sin(x(t,9)))*0.5   L2*cos(x(t,8))*cos(x(t,9))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*cos(x(t,7))*sin(x(t,8))*sin(x(t,9))*(L2*M3+LC2*M2)   0.0   sin(x(t,8))^2*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   -(L2*cos(x(t,9))*sin(x(t,8)))*0.5   -(sqrt(3)*L2*cos(x(t,9))*sin(x(t,8)))*0.5   -L2*sin(x(t,8))*sin(x(t,9))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0]
        dFdxT = [
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*cos(x(T,1))*dx(T,1)   -L1*sin(x(T,1))*dx(T,1)   0.0   -L1*cos(x(T,1))*dx(T,1)   -L1*sin(x(T,1))*dx(T,1)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*cos(x(T,2))*cos(x(T,3))*dx(T,3)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,2)   -L2*cos(x(T,2))*dx(T,2)   -L2*cos(x(T,3))*sin(x(T,2))*dx(T,2)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,3)   L2*cos(x(T,2))*cos(x(T,3))*dx(T,3)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,2)   -L2*cos(x(T,2))*dx(T,2)   -L2*cos(x(T,3))*sin(x(T,2))*dx(T,2)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,3)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*cos(x(T,2))*cos(x(T,3))*dx(T,2)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,3)   0.0   -L2*cos(x(T,2))*sin(x(T,3))*dx(T,2)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,3)   L2*cos(x(T,2))*cos(x(T,3))*dx(T,2)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,3)   0.0   -L2*cos(x(T,2))*sin(x(T,3))*dx(T,2)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,3)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -(sqrt(3)*L1*cos(x(T,4))*dx(T,4))*0.5   -(L1*cos(x(T,4))*dx(T,4))*0.5   L1*sin(x(T,4))*dx(T,4)   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,5))*cos(x(T,6))*dx(T,6))*0.5-(sqrt(3)*L2*cos(x(T,5))*dx(T,5))*0.5-(L2*sin(x(T,5))*sin(x(T,6))*dx(T,5))*0.5   (sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,5))*0.5-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,6))*0.5-(L2*cos(x(T,5))*dx(T,5))*0.5   L2*cos(x(T,6))*sin(x(T,5))*dx(T,5)+L2*cos(x(T,5))*sin(x(T,6))*dx(T,6)   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,5))*cos(x(T,6))*dx(T,5))*0.5-(L2*sin(x(T,5))*sin(x(T,6))*dx(T,6))*0.5   (sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,6))*0.5-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,5))*0.5   L2*cos(x(T,5))*sin(x(T,6))*dx(T,5)+L2*cos(x(T,6))*sin(x(T,5))*dx(T,6)   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (sqrt(3)*L1*cos(x(T,7))*dx(T,7))*0.5   -(L1*cos(x(T,7))*dx(T,7))*0.5   L1*sin(x(T,7))*dx(T,7)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,8))*cos(x(T,9))*dx(T,9))*0.5+(sqrt(3)*L2*cos(x(T,8))*dx(T,8))*0.5-(L2*sin(x(T,8))*sin(x(T,9))*dx(T,8))*0.5   (sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,9))*0.5-(L2*cos(x(T,8))*dx(T,8))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,8))*0.5   L2*cos(x(T,9))*sin(x(T,8))*dx(T,8)+L2*cos(x(T,8))*sin(x(T,9))*dx(T,9)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,8))*cos(x(T,9))*dx(T,8))*0.5-(L2*sin(x(T,8))*sin(x(T,9))*dx(T,9))*0.5   (sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,8))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,9))*0.5   L2*cos(x(T,8))*sin(x(T,9))*dx(T,8)+L2*cos(x(T,9))*sin(x(T,8))*dx(T,9)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,2))*cos(x(T,3))*sin(x(T,1))*dx(T,1)-cos(x(T,2))*sin(x(T,1))*dx(T,2)-cos(x(T,1))*sin(x(T,2))*dx(T,1)+cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,2)+cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,3))   L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,1)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,3)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,2)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*cos(x(T,1))*dx(T,1)   L1*sin(x(T,1))*dx(T,1)   0.0   L1*cos(x(T,1))*dx(T,1)   L1*sin(x(T,1))*dx(T,1)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,2))*cos(x(T,3))*sin(x(T,1))*dx(T,1)-cos(x(T,2))*sin(x(T,1))*dx(T,2)-cos(x(T,1))*sin(x(T,2))*dx(T,1)+cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,2)+cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,3))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*sin(x(T,2))*sin(x(T,3))*dx(T,2)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,3)   L2*cos(x(T,2))*dx(T,2)   L2*cos(x(T,3))*sin(x(T,2))*dx(T,2)+L2*cos(x(T,2))*sin(x(T,3))*dx(T,3)   L2*sin(x(T,2))*sin(x(T,3))*dx(T,2)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,3)   L2*cos(x(T,2))*dx(T,2)   L2*cos(x(T,3))*sin(x(T,2))*dx(T,2)+L2*cos(x(T,2))*sin(x(T,3))*dx(T,3)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,1)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,3)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,2)*(L2*M3+LC2*M2)   0.0   2*cos(x(T,2))*sin(x(T,2))*dx(T,2)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   L2*sin(x(T,2))*sin(x(T,3))*dx(T,3)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,2)   0.0   L2*cos(x(T,2))*sin(x(T,3))*dx(T,2)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,3)   L2*sin(x(T,2))*sin(x(T,3))*dx(T,3)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,2)   0.0   L2*cos(x(T,2))*sin(x(T,3))*dx(T,2)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,3)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,5))*cos(x(T,6))*sin(x(T,4))*dx(T,4)-cos(x(T,5))*sin(x(T,4))*dx(T,5)-cos(x(T,4))*sin(x(T,5))*dx(T,4)+cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,5)+cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,6))   L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,4)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,6)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,5)*(L2*M3+LC2*M2)   0.0   0.0   0.0   (sqrt(3)*L1*cos(x(T,4))*dx(T,4))*0.5   (L1*cos(x(T,4))*dx(T,4))*0.5   -L1*sin(x(T,4))*dx(T,4)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,5))*cos(x(T,6))*sin(x(T,4))*dx(T,4)-cos(x(T,5))*sin(x(T,4))*dx(T,5)-cos(x(T,4))*sin(x(T,5))*dx(T,4)+cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,5)+cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,6))   0.0   0.0   0.0   0.0   0.0   (sqrt(3)*L2*cos(x(T,5))*dx(T,5))*0.5-(L2*cos(x(T,5))*cos(x(T,6))*dx(T,6))*0.5+(L2*sin(x(T,5))*sin(x(T,6))*dx(T,5))*0.5   (L2*cos(x(T,5))*dx(T,5))*0.5+(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,6))*0.5-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,5))*0.5   -L2*cos(x(T,6))*sin(x(T,5))*dx(T,5)-L2*cos(x(T,5))*sin(x(T,6))*dx(T,6)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,4)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,6)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,5)*(L2*M3+LC2*M2)   0.0   2*cos(x(T,5))*sin(x(T,5))*dx(T,5)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   (L2*sin(x(T,5))*sin(x(T,6))*dx(T,6))*0.5-(L2*cos(x(T,5))*cos(x(T,6))*dx(T,5))*0.5   (sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,5))*0.5-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,6))*0.5   -L2*cos(x(T,5))*sin(x(T,6))*dx(T,5)-L2*cos(x(T,6))*sin(x(T,5))*dx(T,6)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,8))*cos(x(T,9))*sin(x(T,7))*dx(T,7)-cos(x(T,8))*sin(x(T,7))*dx(T,8)-cos(x(T,7))*sin(x(T,8))*dx(T,7)+cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,8)+cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,9))   L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,7)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,9)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,8)*(L2*M3+LC2*M2)   0.0   0.0   0.0   -(sqrt(3)*L1*cos(x(T,7))*dx(T,7))*0.5   (L1*cos(x(T,7))*dx(T,7))*0.5   -L1*sin(x(T,7))*dx(T,7)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,8))*cos(x(T,9))*sin(x(T,7))*dx(T,7)-cos(x(T,8))*sin(x(T,7))*dx(T,8)-cos(x(T,7))*sin(x(T,8))*dx(T,7)+cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,8)+cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,9))   0.0   0.0   0.0   0.0   0.0   (L2*sin(x(T,8))*sin(x(T,9))*dx(T,8))*0.5-(sqrt(3)*L2*cos(x(T,8))*dx(T,8))*0.5-(L2*cos(x(T,8))*cos(x(T,9))*dx(T,9))*0.5   (L2*cos(x(T,8))*dx(T,8))*0.5-(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,9))*0.5+(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,8))*0.5   -L2*cos(x(T,9))*sin(x(T,8))*dx(T,8)-L2*cos(x(T,8))*sin(x(T,9))*dx(T,9)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,7)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,9)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,8)*(L2*M3+LC2*M2)   0.0   2*cos(x(T,8))*sin(x(T,8))*dx(T,8)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   (L2*sin(x(T,8))*sin(x(T,9))*dx(T,9))*0.5-(L2*cos(x(T,8))*cos(x(T,9))*dx(T,8))*0.5   (sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,9))*0.5-(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,8))*0.5   -L2*cos(x(T,8))*sin(x(T,9))*dx(T,8)-L2*cos(x(T,9))*sin(x(T,8))*dx(T,9)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0]
        FθT = [0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; x(T,10); x(T,11); x(T,12); x(T,13); x(T,14); x(T,15); x(T,16); x(T,17); x(T,18); 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0; 0.0 ;;]
        gₓT = [0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -2(y(T,1)-x2(T,31))/T   -2(y(T,2)-x2(T,32))/T   -2(y(T,3)-x2(T,33))/T]
        dgₓT = [0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -2(dy(T,1)-dx2(T,31))/T   -2(dy(T,2)-dx2(T,32))/T   -2(dy(T,3)-dx2(T,33))/T]

        # The residual function
        function f!(res, dz, z, _, t)
            xt = x(t,1:33)
            dxt = dx(t,1:33)
            yt = y(t,1:3)
            # ---------- Adjoint system ----------
            # 0 = dλᵀ Fdx + λᵀ(dFdx - Fx) + gₓ                      # Analytical adjoint system
            # 0 = (dz')*Fdx(t) + (z')*(dFdx(t) - Fx(t)) + gₓ(t)     # Matrix form adjoint system
            # Expanded adjoint system residual equations:
            res[1] = dz[1]-z[11]*(L1*dxt[10]*(L2*M3+LC2*M2)*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))-L1*xt[10]^2*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3])))-z[10]*(0.0*sin(xt[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(xt[1])*dxt[20]+L1*cos(xt[1])*dxt[23]+L1*sin(xt[1])*dxt[21]+L1*sin(xt[1])*dxt[24]+L1*dxt[11]*(L2*M3+LC2*M2)*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))+L1*xt[11]^2*(L2*M3+LC2*M2)*(cos(xt[1])*cos(xt[2])+cos(xt[3])*sin(xt[1])*sin(xt[2]))+L1*cos(xt[3])*sin(xt[1])*sin(xt[2])*xt[12]^2*(L2*M3+LC2*M2)+L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*dxt[12]*(L2*M3+LC2*M2)+2*L1*cos(xt[2])*sin(xt[1])*sin(xt[3])*xt[11]*xt[12]*(L2*M3+LC2*M2))-z[12]*(L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]^2*(L2*M3+LC2*M2)+L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*dxt[10]*(L2*M3+LC2*M2))+z[1]*(L1*cos(xt[1])*dxt[26]+L1*cos(xt[1])*dxt[29]+L1*sin(xt[1])*dxt[27]+L1*sin(xt[1])*dxt[30])-L1*cos(xt[1])*z[21]-L1*cos(xt[1])*z[24]+L1*cos(xt[1])*z[33]+L1*sin(xt[1])*z[20]+L1*sin(xt[1])*z[23]-L1*sin(xt[1])*z[32]+L1*cos(xt[1])*z[26]*xt[10]+L1*cos(xt[1])*z[29]*xt[10]+L1*sin(xt[1])*z[27]*xt[10]+L1*sin(xt[1])*z[30]*xt[10]
            res[2] = dz[2]-z[25]*(L2*cos(xt[2])*cos(xt[3])*xt[12]-L2*sin(xt[2])*sin(xt[3])*xt[11])+z[27]*(L2*cos(xt[3])*sin(xt[2])*xt[11]+L2*cos(xt[2])*sin(xt[3])*xt[12])-z[28]*(L2*cos(xt[2])*cos(xt[3])*xt[12]-L2*sin(xt[2])*sin(xt[3])*xt[11])+z[30]*(L2*cos(xt[3])*sin(xt[2])*xt[11]+L2*cos(xt[2])*sin(xt[3])*xt[12])-z[3]*(L2*cos(xt[2])*cos(xt[3])*dxt[25]+L2*cos(xt[2])*cos(xt[3])*dxt[28]-L2*cos(xt[2])*sin(xt[3])*dxt[27]-L2*cos(xt[2])*sin(xt[3])*dxt[30])-z[12]*(L2*cos(xt[2])*sin(xt[3])*dxt[21]-L2*cos(xt[2])*cos(xt[3])*dxt[22]-L2*cos(xt[2])*cos(xt[3])*dxt[19]+L2*cos(xt[2])*sin(xt[3])*dxt[24]+2*cos(xt[2])*sin(xt[2])*dxt[12]*(J2+L2^2*M3+LC2^2*M2)+2*cos(2*xt[2])*xt[11]*xt[12]*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(xt[2])*sin(xt[3])*(L2*M3+LC2*M2)+L1*cos(xt[2])*sin(xt[1])*sin(xt[3])*xt[10]^2*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[10]*(L2*M3+LC2*M2))-z[11]*(sin(xt[2])^2*xt[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(xt[2])^2*xt[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(xt[2])*dxt[20]+L2*cos(xt[2])*dxt[23]+L2*cos(xt[3])*sin(xt[2])*dxt[21]+L2*cos(xt[3])*sin(xt[2])*dxt[24]+L2*sin(xt[2])*sin(xt[3])*dxt[19]+L2*sin(xt[2])*sin(xt[3])*dxt[22]+L1*dxt[10]*(L2*M3+LC2*M2)*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))+0.0*cos(xt[3])*sin(xt[2])*(L2*M3+LC2*M2)+L1*xt[10]^2*(L2*M3+LC2*M2)*(cos(xt[1])*cos(xt[2])+cos(xt[3])*sin(xt[1])*sin(xt[2])))+z[10]*(L1*xt[11]^2*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-L1*dxt[11]*(L2*M3+LC2*M2)*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))+L1*cos(xt[1])*cos(xt[2])*cos(xt[3])*xt[12]^2*(L2*M3+LC2*M2)+L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[12]*(L2*M3+LC2*M2)-2*L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*xt[11]*xt[12]*(L2*M3+LC2*M2))+z[2]*(L2*cos(xt[2])*dxt[26]+L2*cos(xt[2])*dxt[29]+L2*cos(xt[3])*sin(xt[2])*dxt[27]+L2*cos(xt[3])*sin(xt[2])*dxt[30]+L2*sin(xt[2])*sin(xt[3])*dxt[25]+L2*sin(xt[2])*sin(xt[3])*dxt[28])+L2*sin(xt[2])*z[20]+L2*sin(xt[2])*z[23]-L2*sin(xt[2])*z[32]-L2*cos(xt[2])*cos(xt[3])*z[21]-L2*cos(xt[2])*cos(xt[3])*z[24]+L2*cos(xt[2])*cos(xt[3])*z[33]-L2*cos(xt[2])*sin(xt[3])*z[19]-L2*cos(xt[2])*sin(xt[3])*z[22]+L2*cos(xt[2])*sin(xt[3])*z[31]+L2*cos(xt[2])*z[26]*xt[11]+L2*cos(xt[2])*z[29]*xt[11]
            res[3] = dz[3]-z[12]*(L2*cos(xt[3])*sin(xt[2])*dxt[21]+L2*cos(xt[3])*sin(xt[2])*dxt[24]+L2*sin(xt[2])*sin(xt[3])*dxt[19]+L2*sin(xt[2])*sin(xt[3])*dxt[22]+0.0*cos(xt[3])*sin(xt[2])*(L2*M3+LC2*M2)+L1*cos(xt[3])*sin(xt[1])*sin(xt[2])*xt[10]^2*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[10]*(L2*M3+LC2*M2))-z[25]*(L2*cos(xt[2])*cos(xt[3])*xt[11]-L2*sin(xt[2])*sin(xt[3])*xt[12])+z[27]*(L2*cos(xt[2])*sin(xt[3])*xt[11]+L2*cos(xt[3])*sin(xt[2])*xt[12])-z[28]*(L2*cos(xt[2])*cos(xt[3])*xt[11]-L2*sin(xt[2])*sin(xt[3])*xt[12])+z[30]*(L2*cos(xt[2])*sin(xt[3])*xt[11]+L2*cos(xt[3])*sin(xt[2])*xt[12])-z[2]*(L2*cos(xt[2])*cos(xt[3])*dxt[25]+L2*cos(xt[2])*cos(xt[3])*dxt[28]-L2*cos(xt[2])*sin(xt[3])*dxt[27]-L2*cos(xt[2])*sin(xt[3])*dxt[30])+z[10]*(L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[11]*(L2*M3+LC2*M2)-L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*xt[12]^2*(L2*M3+LC2*M2)-L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*xt[11]^2*(L2*M3+LC2*M2)+L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[12]*(L2*M3+LC2*M2)+2*L1*cos(xt[1])*cos(xt[2])*cos(xt[3])*xt[11]*xt[12]*(L2*M3+LC2*M2))+z[3]*(L2*cos(xt[3])*sin(xt[2])*dxt[27]+L2*cos(xt[3])*sin(xt[2])*dxt[30]+L2*sin(xt[2])*sin(xt[3])*dxt[25]+L2*sin(xt[2])*sin(xt[3])*dxt[28])-z[11]*(L2*cos(xt[2])*sin(xt[3])*dxt[21]-L2*cos(xt[2])*cos(xt[3])*dxt[22]-L2*cos(xt[2])*cos(xt[3])*dxt[19]+L2*cos(xt[2])*sin(xt[3])*dxt[24]+0.0*cos(xt[2])*sin(xt[3])*(L2*M3+LC2*M2)+L1*cos(xt[2])*sin(xt[1])*sin(xt[3])*xt[10]^2*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[10]*(L2*M3+LC2*M2))-L2*cos(xt[3])*sin(xt[2])*z[19]-L2*cos(xt[3])*sin(xt[2])*z[22]+L2*cos(xt[3])*sin(xt[2])*z[31]+L2*sin(xt[2])*sin(xt[3])*z[21]+L2*sin(xt[2])*sin(xt[3])*z[24]-L2*sin(xt[2])*sin(xt[3])*z[33]
            res[4] = dz[4]-z[14]*(L1*dxt[13]*(L2*M3+LC2*M2)*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))-L1*xt[13]^2*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6])))+z[4]*((L1*cos(xt[4])*dxt[26])*0.5-L1*sin(xt[4])*dxt[27]+(sqrt(3)*L1*cos(xt[4])*dxt[25])*0.5)-z[15]*(L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]^2*(L2*M3+LC2*M2)+L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*dxt[13]*(L2*M3+LC2*M2))-z[13]*(0.0*sin(xt[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(xt[4])*dxt[20])*0.5-L1*sin(xt[4])*dxt[21]+(sqrt(3)*L1*cos(xt[4])*dxt[19])*0.5+L1*dxt[14]*(L2*M3+LC2*M2)*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))+L1*xt[14]^2*(L2*M3+LC2*M2)*(cos(xt[4])*cos(xt[5])+cos(xt[6])*sin(xt[4])*sin(xt[5]))+L1*cos(xt[6])*sin(xt[4])*sin(xt[5])*xt[15]^2*(L2*M3+LC2*M2)+L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*dxt[15]*(L2*M3+LC2*M2)+2*L1*cos(xt[5])*sin(xt[4])*sin(xt[6])*xt[14]*xt[15]*(L2*M3+LC2*M2))+L1*cos(xt[4])*z[21]+(L1*sin(xt[4])*z[20])*0.5+(sqrt(3)*L1*sin(xt[4])*z[19])*0.5+(L1*cos(xt[4])*z[26]*xt[13])*0.5-L1*sin(xt[4])*z[27]*xt[13]+(sqrt(3)*L1*cos(xt[4])*z[25]*xt[13])*0.5
            res[5] = dz[5]-z[27]*(L2*cos(xt[6])*sin(xt[5])*xt[14]+L2*cos(xt[5])*sin(xt[6])*xt[15])+z[25]*((sqrt(3)*L2*cos(xt[5])*xt[14])*0.5-(L2*cos(xt[5])*cos(xt[6])*xt[15])*0.5+(L2*sin(xt[5])*sin(xt[6])*xt[14])*0.5)-z[6]*((L2*cos(xt[5])*cos(xt[6])*dxt[25])*0.5+L2*cos(xt[5])*sin(xt[6])*dxt[27]-(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[26])*0.5)-z[19]*((L2*cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*L2*sin(xt[5]))*0.5)+z[20]*((L2*sin(xt[5]))*0.5+(sqrt(3)*L2*cos(xt[5])*sin(xt[6]))*0.5)+z[5]*(dxt[25]*((sqrt(3)*L2*cos(xt[5]))*0.5+(L2*sin(xt[5])*sin(xt[6]))*0.5)+dxt[26]*((L2*cos(xt[5]))*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6]))*0.5)-L2*cos(xt[6])*sin(xt[5])*dxt[27])-z[15]*(2*cos(xt[5])*sin(xt[5])*dxt[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(xt[5])*sin(xt[6])*dxt[21]-(L2*cos(xt[5])*cos(xt[6])*dxt[19])*0.5+2*cos(2*xt[5])*xt[14]*xt[15]*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(xt[5])*sin(xt[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[20])*0.5+L1*cos(xt[5])*sin(xt[4])*sin(xt[6])*xt[13]^2*(L2*M3+LC2*M2)-L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[13]*(L2*M3+LC2*M2))+z[26]*((L2*cos(xt[5])*xt[14])*0.5+(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*xt[15])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*xt[14])*0.5)+z[13]*(L1*xt[14]^2*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-L1*dxt[14]*(L2*M3+LC2*M2)*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))+L1*cos(xt[4])*cos(xt[5])*cos(xt[6])*xt[15]^2*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[15]*(L2*M3+LC2*M2)-2*L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*xt[14]*xt[15]*(L2*M3+LC2*M2))-z[14]*(dxt[19]*((sqrt(3)*L2*cos(xt[5]))*0.5+(L2*sin(xt[5])*sin(xt[6]))*0.5)+dxt[20]*((L2*cos(xt[5]))*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6]))*0.5)-cos(xt[5])^2*xt[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(xt[5])^2*xt[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(xt[6])*sin(xt[5])*dxt[21]+L1*dxt[13]*(L2*M3+LC2*M2)*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))+0.0*cos(xt[6])*sin(xt[5])*(L2*M3+LC2*M2)+L1*xt[13]^2*(L2*M3+LC2*M2)*(cos(xt[4])*cos(xt[5])+cos(xt[6])*sin(xt[4])*sin(xt[5])))+L2*cos(xt[5])*cos(xt[6])*z[21]
            res[6] = dz[6]+z[14]*((L2*cos(xt[5])*cos(xt[6])*dxt[19])*0.5+L2*cos(xt[5])*sin(xt[6])*dxt[21]-0.0*cos(xt[5])*sin(xt[6])*(L2*M3+LC2*M2)-(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[20])*0.5-L1*cos(xt[5])*sin(xt[4])*sin(xt[6])*xt[13]^2*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[13]*(L2*M3+LC2*M2))-z[27]*(L2*cos(xt[5])*sin(xt[6])*xt[14]+L2*cos(xt[6])*sin(xt[5])*xt[15])-z[25]*((L2*cos(xt[5])*cos(xt[6])*xt[14])*0.5-(L2*sin(xt[5])*sin(xt[6])*xt[15])*0.5)+z[15]*(L2*cos(xt[6])*sin(xt[5])*dxt[21]-(L2*sin(xt[5])*sin(xt[6])*dxt[19])*0.5-0.0*cos(xt[6])*sin(xt[5])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[20])*0.5-L1*cos(xt[6])*sin(xt[4])*sin(xt[5])*xt[13]^2*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[13]*(L2*M3+LC2*M2))+z[13]*(L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[14]*(L2*M3+LC2*M2)-L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*xt[15]^2*(L2*M3+LC2*M2)-L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*xt[14]^2*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[15]*(L2*M3+LC2*M2)+2*L1*cos(xt[4])*cos(xt[5])*cos(xt[6])*xt[14]*xt[15]*(L2*M3+LC2*M2))-z[5]*((L2*cos(xt[5])*cos(xt[6])*dxt[25])*0.5+L2*cos(xt[5])*sin(xt[6])*dxt[27]-(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[26])*0.5)-z[6]*(L2*cos(xt[6])*sin(xt[5])*dxt[27]-(L2*sin(xt[5])*sin(xt[6])*dxt[25])*0.5+(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[26])*0.5)+z[26]*((sqrt(3)*L2*cos(xt[5])*cos(xt[6])*xt[14])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*xt[15])*0.5)-(L2*cos(xt[6])*sin(xt[5])*z[19])*0.5-L2*sin(xt[5])*sin(xt[6])*z[21]+(sqrt(3)*L2*cos(xt[6])*sin(xt[5])*z[20])*0.5
            res[7] = dz[7]-z[17]*(L1*dxt[16]*(L2*M3+LC2*M2)*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))-L1*xt[16]^2*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9])))-z[7]*(L1*sin(xt[7])*dxt[30]-(L1*cos(xt[7])*dxt[29])*0.5+(sqrt(3)*L1*cos(xt[7])*dxt[28])*0.5)-z[18]*(L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]^2*(L2*M3+LC2*M2)+L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*dxt[16]*(L2*M3+LC2*M2))-z[16]*(0.0*sin(xt[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(xt[7])*dxt[23])*0.5-L1*sin(xt[7])*dxt[24]-(sqrt(3)*L1*cos(xt[7])*dxt[22])*0.5+L1*dxt[17]*(L2*M3+LC2*M2)*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))+L1*xt[17]^2*(L2*M3+LC2*M2)*(cos(xt[7])*cos(xt[8])+cos(xt[9])*sin(xt[7])*sin(xt[8]))+L1*cos(xt[9])*sin(xt[7])*sin(xt[8])*xt[18]^2*(L2*M3+LC2*M2)+L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*dxt[18]*(L2*M3+LC2*M2)+2*L1*cos(xt[8])*sin(xt[7])*sin(xt[9])*xt[17]*xt[18]*(L2*M3+LC2*M2))+L1*cos(xt[7])*z[24]+(L1*sin(xt[7])*z[23])*0.5-(sqrt(3)*L1*sin(xt[7])*z[22])*0.5+(L1*cos(xt[7])*z[29]*xt[16])*0.5-L1*sin(xt[7])*z[30]*xt[16]-(sqrt(3)*L1*cos(xt[7])*z[28]*xt[16])*0.5
            res[8] = dz[8]-z[30]*(L2*cos(xt[9])*sin(xt[8])*xt[17]+L2*cos(xt[8])*sin(xt[9])*xt[18])-z[28]*((L2*cos(xt[8])*cos(xt[9])*xt[18])*0.5+(sqrt(3)*L2*cos(xt[8])*xt[17])*0.5-(L2*sin(xt[8])*sin(xt[9])*xt[17])*0.5)-z[9]*((L2*cos(xt[8])*cos(xt[9])*dxt[28])*0.5+L2*cos(xt[8])*sin(xt[9])*dxt[30]+(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[29])*0.5)-z[22]*((L2*cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*L2*sin(xt[8]))*0.5)+z[23]*((L2*sin(xt[8]))*0.5-(sqrt(3)*L2*cos(xt[8])*sin(xt[9]))*0.5)-z[8]*(dxt[28]*((sqrt(3)*L2*cos(xt[8]))*0.5-(L2*sin(xt[8])*sin(xt[9]))*0.5)-dxt[29]*((L2*cos(xt[8]))*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9]))*0.5)+L2*cos(xt[9])*sin(xt[8])*dxt[30])+z[18]*((L2*cos(xt[8])*cos(xt[9])*dxt[22])*0.5+L2*cos(xt[8])*sin(xt[9])*dxt[24]-2*cos(xt[8])*sin(xt[8])*dxt[18]*(J2+L2^2*M3+LC2^2*M2)-2*cos(2*xt[8])*xt[17]*xt[18]*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(xt[8])*sin(xt[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[23])*0.5-L1*cos(xt[8])*sin(xt[7])*sin(xt[9])*xt[16]^2*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[16]*(L2*M3+LC2*M2))+z[29]*((L2*cos(xt[8])*xt[17])*0.5-(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*xt[18])*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*xt[17])*0.5)+z[16]*(L1*xt[17]^2*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-L1*dxt[17]*(L2*M3+LC2*M2)*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))+L1*cos(xt[7])*cos(xt[8])*cos(xt[9])*xt[18]^2*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[18]*(L2*M3+LC2*M2)-2*L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*xt[17]*xt[18]*(L2*M3+LC2*M2))-z[17]*(dxt[23]*((L2*cos(xt[8]))*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9]))*0.5)-dxt[22]*((sqrt(3)*L2*cos(xt[8]))*0.5-(L2*sin(xt[8])*sin(xt[9]))*0.5)-cos(xt[8])^2*xt[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(xt[8])^2*xt[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(xt[9])*sin(xt[8])*dxt[24]+L1*dxt[16]*(L2*M3+LC2*M2)*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))+0.0*cos(xt[9])*sin(xt[8])*(L2*M3+LC2*M2)+L1*xt[16]^2*(L2*M3+LC2*M2)*(cos(xt[7])*cos(xt[8])+cos(xt[9])*sin(xt[7])*sin(xt[8])))+L2*cos(xt[8])*cos(xt[9])*z[24]
            res[9] = dz[9]+z[17]*((L2*cos(xt[8])*cos(xt[9])*dxt[22])*0.5+L2*cos(xt[8])*sin(xt[9])*dxt[24]-0.0*cos(xt[8])*sin(xt[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[23])*0.5-L1*cos(xt[8])*sin(xt[7])*sin(xt[9])*xt[16]^2*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[16]*(L2*M3+LC2*M2))-z[30]*(L2*cos(xt[8])*sin(xt[9])*xt[17]+L2*cos(xt[9])*sin(xt[8])*xt[18])-z[28]*((L2*cos(xt[8])*cos(xt[9])*xt[17])*0.5-(L2*sin(xt[8])*sin(xt[9])*xt[18])*0.5)-z[18]*((L2*sin(xt[8])*sin(xt[9])*dxt[22])*0.5-L2*cos(xt[9])*sin(xt[8])*dxt[24]+0.0*cos(xt[9])*sin(xt[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[23])*0.5+L1*cos(xt[9])*sin(xt[7])*sin(xt[8])*xt[16]^2*(L2*M3+LC2*M2)-L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[16]*(L2*M3+LC2*M2))+z[16]*(L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[17]*(L2*M3+LC2*M2)-L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*xt[18]^2*(L2*M3+LC2*M2)-L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*xt[17]^2*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[18]*(L2*M3+LC2*M2)+2*L1*cos(xt[7])*cos(xt[8])*cos(xt[9])*xt[17]*xt[18]*(L2*M3+LC2*M2))-z[8]*((L2*cos(xt[8])*cos(xt[9])*dxt[28])*0.5+L2*cos(xt[8])*sin(xt[9])*dxt[30]+(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[29])*0.5)+z[9]*((L2*sin(xt[8])*sin(xt[9])*dxt[28])*0.5-L2*cos(xt[9])*sin(xt[8])*dxt[30]+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[29])*0.5)-z[29]*((sqrt(3)*L2*cos(xt[8])*cos(xt[9])*xt[17])*0.5-(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*xt[18])*0.5)-(L2*cos(xt[9])*sin(xt[8])*z[22])*0.5-L2*sin(xt[8])*sin(xt[9])*z[24]-(sqrt(3)*L2*cos(xt[9])*sin(xt[8])*z[23])*0.5
            res[10] = z[1]+dz[10]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[11]*(L1*(L2*M3+LC2*M2)*(cos(xt[2])*cos(xt[3])*sin(xt[1])*dxt[1]-cos(xt[2])*sin(xt[1])*dxt[2]-cos(xt[1])*sin(xt[2])*dxt[1]+cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[2]+cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[3])+2*L1*xt[10]*(L2*M3+LC2*M2)*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1])))-γ*z[10]-z[12]*(L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[2]*(L2*M3+LC2*M2)+L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[3]*(L2*M3+LC2*M2)-L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*dxt[1]*(L2*M3+LC2*M2)+2*L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]*(L2*M3+LC2*M2))-L1*cos(xt[1])*z[27]-L1*cos(xt[1])*z[30]+L1*sin(xt[1])*z[26]+L1*sin(xt[1])*z[29]+L1*dz[11]*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*dz[12]*(L2*M3+LC2*M2)
            res[11] = z[2]-z[10]*(L1*(L2*M3+LC2*M2)*(cos(xt[2])*cos(xt[3])*sin(xt[1])*dxt[1]-cos(xt[2])*sin(xt[1])*dxt[2]-cos(xt[1])*sin(xt[2])*dxt[1]+cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[2]+cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[3])+2*L1*xt[11]*(L2*M3+LC2*M2)*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))-2*L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[12]*(L2*M3+LC2*M2))+dz[11]*(J2+L2^2*M3+LC2^2*M2)-γ*z[11]+L2*sin(xt[2])*z[26]+L2*sin(xt[2])*z[29]-L2*cos(xt[2])*cos(xt[3])*z[27]-L2*cos(xt[2])*cos(xt[3])*z[30]-L2*cos(xt[2])*sin(xt[3])*z[25]-L2*cos(xt[2])*sin(xt[3])*z[28]-sin(2*xt[2])*z[12]*xt[12]*(J2+L2^2*M3+LC2^2*M2)+L1*dz[10]*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))
            res[12] = z[3]-z[12]*(γ+sin(2*xt[2])*xt[11]*(J2+L2^2*M3+LC2^2*M2)-2*cos(xt[2])*sin(xt[2])*dxt[2]*(J2+L2^2*M3+LC2^2*M2))+z[10]*(2*L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[11]*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[3]*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[2]*(L2*M3+LC2*M2)+2*L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*xt[12]*(L2*M3+LC2*M2)+L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*dxt[1]*(L2*M3+LC2*M2))+sin(xt[2])^2*dz[12]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(xt[3])*sin(xt[2])*z[25]-L2*cos(xt[3])*sin(xt[2])*z[28]+L2*sin(xt[2])*sin(xt[3])*z[27]+L2*sin(xt[2])*sin(xt[3])*z[30]+2*cos(xt[2])*sin(xt[2])*z[11]*xt[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*dz[10]*(L2*M3+LC2*M2)
            res[13] = z[4]+dz[13]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[14]*(L1*(L2*M3+LC2*M2)*(cos(xt[5])*cos(xt[6])*sin(xt[4])*dxt[4]-cos(xt[5])*sin(xt[4])*dxt[5]-cos(xt[4])*sin(xt[5])*dxt[4]+cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[5]+cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[6])+2*L1*xt[13]*(L2*M3+LC2*M2)*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4])))-γ*z[13]-z[15]*(L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[5]*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[6]*(L2*M3+LC2*M2)-L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*dxt[4]*(L2*M3+LC2*M2)+2*L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]*(L2*M3+LC2*M2))+L1*cos(xt[4])*z[27]+(L1*sin(xt[4])*z[26])*0.5+(sqrt(3)*L1*sin(xt[4])*z[25])*0.5+L1*dz[14]*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*dz[15]*(L2*M3+LC2*M2)
            res[14] = z[5]-z[25]*((L2*cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*L2*sin(xt[5]))*0.5)+z[26]*((L2*sin(xt[5]))*0.5+(sqrt(3)*L2*cos(xt[5])*sin(xt[6]))*0.5)-z[13]*(L1*(L2*M3+LC2*M2)*(cos(xt[5])*cos(xt[6])*sin(xt[4])*dxt[4]-cos(xt[5])*sin(xt[4])*dxt[5]-cos(xt[4])*sin(xt[5])*dxt[4]+cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[5]+cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[6])+2*L1*xt[14]*(L2*M3+LC2*M2)*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))-2*L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[15]*(L2*M3+LC2*M2))+dz[14]*(J2+L2^2*M3+LC2^2*M2)-γ*z[14]+L2*cos(xt[5])*cos(xt[6])*z[27]-sin(2*xt[5])*z[15]*xt[15]*(J2+L2^2*M3+LC2^2*M2)+L1*dz[13]*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))
            res[15] = z[6]-z[15]*(γ+sin(2*xt[5])*xt[14]*(J2+L2^2*M3+LC2^2*M2)-2*cos(xt[5])*sin(xt[5])*dxt[5]*(J2+L2^2*M3+LC2^2*M2))+z[13]*(2*L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[14]*(L2*M3+LC2*M2)-L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[6]*(L2*M3+LC2*M2)-L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[5]*(L2*M3+LC2*M2)+2*L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*xt[15]*(L2*M3+LC2*M2)+L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*dxt[4]*(L2*M3+LC2*M2))+sin(xt[5])^2*dz[15]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(xt[6])*sin(xt[5])*z[25])*0.5-L2*sin(xt[5])*sin(xt[6])*z[27]+2*cos(xt[5])*sin(xt[5])*z[14]*xt[15]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(xt[6])*sin(xt[5])*z[26])*0.5-L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*dz[13]*(L2*M3+LC2*M2)
            res[16] = z[7]+dz[16]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[17]*(L1*(L2*M3+LC2*M2)*(cos(xt[8])*cos(xt[9])*sin(xt[7])*dxt[7]-cos(xt[8])*sin(xt[7])*dxt[8]-cos(xt[7])*sin(xt[8])*dxt[7]+cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[8]+cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[9])+2*L1*xt[16]*(L2*M3+LC2*M2)*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7])))-γ*z[16]-z[18]*(L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[8]*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[9]*(L2*M3+LC2*M2)-L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*dxt[7]*(L2*M3+LC2*M2)+2*L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]*(L2*M3+LC2*M2))+L1*cos(xt[7])*z[30]+(L1*sin(xt[7])*z[29])*0.5-(sqrt(3)*L1*sin(xt[7])*z[28])*0.5+L1*dz[17]*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*dz[18]*(L2*M3+LC2*M2)
            res[17] = z[8]-z[28]*((L2*cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*L2*sin(xt[8]))*0.5)+z[29]*((L2*sin(xt[8]))*0.5-(sqrt(3)*L2*cos(xt[8])*sin(xt[9]))*0.5)-z[16]*(L1*(L2*M3+LC2*M2)*(cos(xt[8])*cos(xt[9])*sin(xt[7])*dxt[7]-cos(xt[8])*sin(xt[7])*dxt[8]-cos(xt[7])*sin(xt[8])*dxt[7]+cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[8]+cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[9])+2*L1*xt[17]*(L2*M3+LC2*M2)*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))-2*L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[18]*(L2*M3+LC2*M2))+dz[17]*(J2+L2^2*M3+LC2^2*M2)-γ*z[17]+L2*cos(xt[8])*cos(xt[9])*z[30]-sin(2*xt[8])*z[18]*xt[18]*(J2+L2^2*M3+LC2^2*M2)+L1*dz[16]*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))
            res[18] = z[9]-z[18]*(γ+sin(2*xt[8])*xt[17]*(J2+L2^2*M3+LC2^2*M2)-2*cos(xt[8])*sin(xt[8])*dxt[8]*(J2+L2^2*M3+LC2^2*M2))+z[16]*(2*L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[17]*(L2*M3+LC2*M2)-L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[9]*(L2*M3+LC2*M2)-L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[8]*(L2*M3+LC2*M2)+2*L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*xt[18]*(L2*M3+LC2*M2)+L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*dxt[7]*(L2*M3+LC2*M2))+sin(xt[8])^2*dz[18]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(xt[9])*sin(xt[8])*z[28])*0.5-L2*sin(xt[8])*sin(xt[9])*z[30]+2*cos(xt[8])*sin(xt[8])*z[17]*xt[18]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(xt[9])*sin(xt[8])*z[29])*0.5-L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*dz[16]*(L2*M3+LC2*M2)
            res[19] = z[14]*((sqrt(3)*L2*cos(xt[5])*dxt[5])*0.5-(L2*cos(xt[5])*cos(xt[6])*dxt[6])*0.5+(L2*sin(xt[5])*sin(xt[6])*dxt[5])*0.5)-dz[14]*((L2*cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*L2*sin(xt[5]))*0.5)-z[11]*(L2*cos(xt[2])*cos(xt[3])*dxt[3]-L2*sin(xt[2])*sin(xt[3])*dxt[2])-z[12]*(L2*cos(xt[2])*cos(xt[3])*dxt[2]-L2*sin(xt[2])*sin(xt[3])*dxt[3])-z[15]*((L2*cos(xt[5])*cos(xt[6])*dxt[5])*0.5-(L2*sin(xt[5])*sin(xt[6])*dxt[6])*0.5)-L2*cos(xt[2])*sin(xt[3])*dz[11]-L2*cos(xt[3])*sin(xt[2])*dz[12]-(L2*cos(xt[6])*sin(xt[5])*dz[15])*0.5+(sqrt(3)*L1*sin(xt[4])*dz[13])*0.5+(sqrt(3)*L1*cos(xt[4])*dxt[4]*z[13])*0.5
            res[20] = dz[14]*((L2*sin(xt[5]))*0.5+(sqrt(3)*L2*cos(xt[5])*sin(xt[6]))*0.5)+z[14]*((L2*cos(xt[5])*dxt[5])*0.5+(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[6])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[5])*0.5)+z[15]*((sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[5])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[6])*0.5)+L1*sin(xt[1])*dz[10]+L2*sin(xt[2])*dz[11]+(L1*sin(xt[4])*dz[13])*0.5+L1*cos(xt[1])*dxt[1]*z[10]+L2*cos(xt[2])*dxt[2]*z[11]+(L1*cos(xt[4])*dxt[4]*z[13])*0.5+(sqrt(3)*L2*cos(xt[6])*sin(xt[5])*dz[15])*0.5
            res[21] = z[11]*(L2*cos(xt[3])*sin(xt[2])*dxt[2]+L2*cos(xt[2])*sin(xt[3])*dxt[3])+z[12]*(L2*cos(xt[2])*sin(xt[3])*dxt[2]+L2*cos(xt[3])*sin(xt[2])*dxt[3])-z[14]*(L2*cos(xt[6])*sin(xt[5])*dxt[5]+L2*cos(xt[5])*sin(xt[6])*dxt[6])-z[15]*(L2*cos(xt[5])*sin(xt[6])*dxt[5]+L2*cos(xt[6])*sin(xt[5])*dxt[6])-L1*cos(xt[1])*dz[10]+L1*cos(xt[4])*dz[13]-L2*cos(xt[2])*cos(xt[3])*dz[11]+L2*cos(xt[5])*cos(xt[6])*dz[14]+L2*sin(xt[2])*sin(xt[3])*dz[12]-L2*sin(xt[5])*sin(xt[6])*dz[15]+L1*sin(xt[1])*dxt[1]*z[10]-L1*sin(xt[4])*dxt[4]*z[13]
            res[22] = -z[17]*((L2*cos(xt[8])*cos(xt[9])*dxt[9])*0.5+(sqrt(3)*L2*cos(xt[8])*dxt[8])*0.5-(L2*sin(xt[8])*sin(xt[9])*dxt[8])*0.5)-dz[17]*((L2*cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*L2*sin(xt[8]))*0.5)-z[11]*(L2*cos(xt[2])*cos(xt[3])*dxt[3]-L2*sin(xt[2])*sin(xt[3])*dxt[2])-z[12]*(L2*cos(xt[2])*cos(xt[3])*dxt[2]-L2*sin(xt[2])*sin(xt[3])*dxt[3])-z[18]*((L2*cos(xt[8])*cos(xt[9])*dxt[8])*0.5-(L2*sin(xt[8])*sin(xt[9])*dxt[9])*0.5)-L2*cos(xt[2])*sin(xt[3])*dz[11]-L2*cos(xt[3])*sin(xt[2])*dz[12]-(L2*cos(xt[9])*sin(xt[8])*dz[18])*0.5-(sqrt(3)*L1*sin(xt[7])*dz[16])*0.5-(sqrt(3)*L1*cos(xt[7])*dxt[7]*z[16])*0.5
            res[23] = dz[17]*((L2*sin(xt[8]))*0.5-(sqrt(3)*L2*cos(xt[8])*sin(xt[9]))*0.5)+z[17]*((L2*cos(xt[8])*dxt[8])*0.5-(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[9])*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[8])*0.5)-z[18]*((sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[8])*0.5-(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[9])*0.5)+L1*sin(xt[1])*dz[10]+L2*sin(xt[2])*dz[11]+(L1*sin(xt[7])*dz[16])*0.5+L1*cos(xt[1])*dxt[1]*z[10]+L2*cos(xt[2])*dxt[2]*z[11]+(L1*cos(xt[7])*dxt[7]*z[16])*0.5-(sqrt(3)*L2*cos(xt[9])*sin(xt[8])*dz[18])*0.5
            res[24] = z[11]*(L2*cos(xt[3])*sin(xt[2])*dxt[2]+L2*cos(xt[2])*sin(xt[3])*dxt[3])+z[12]*(L2*cos(xt[2])*sin(xt[3])*dxt[2]+L2*cos(xt[3])*sin(xt[2])*dxt[3])-z[17]*(L2*cos(xt[9])*sin(xt[8])*dxt[8]+L2*cos(xt[8])*sin(xt[9])*dxt[9])-z[18]*(L2*cos(xt[8])*sin(xt[9])*dxt[8]+L2*cos(xt[9])*sin(xt[8])*dxt[9])-L1*cos(xt[1])*dz[10]+L1*cos(xt[7])*dz[16]-L2*cos(xt[2])*cos(xt[3])*dz[11]+L2*cos(xt[8])*cos(xt[9])*dz[17]+L2*sin(xt[2])*sin(xt[3])*dz[12]-L2*sin(xt[8])*sin(xt[9])*dz[18]+L1*sin(xt[1])*dxt[1]*z[10]-L1*sin(xt[7])*dxt[7]*z[16]
            res[25] = dz[5]*((L2*cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*L2*sin(xt[5]))*0.5)-z[5]*((sqrt(3)*L2*cos(xt[5])*dxt[5])*0.5-(L2*cos(xt[5])*cos(xt[6])*dxt[6])*0.5+(L2*sin(xt[5])*sin(xt[6])*dxt[5])*0.5)+z[2]*(L2*cos(xt[2])*cos(xt[3])*dxt[3]-L2*sin(xt[2])*sin(xt[3])*dxt[2])+z[3]*(L2*cos(xt[2])*cos(xt[3])*dxt[2]-L2*sin(xt[2])*sin(xt[3])*dxt[3])+z[6]*((L2*cos(xt[5])*cos(xt[6])*dxt[5])*0.5-(L2*sin(xt[5])*sin(xt[6])*dxt[6])*0.5)+L2*cos(xt[2])*sin(xt[3])*dz[2]+L2*cos(xt[3])*sin(xt[2])*dz[3]+(L2*cos(xt[6])*sin(xt[5])*dz[6])*0.5-(sqrt(3)*L1*sin(xt[4])*dz[4])*0.5-(sqrt(3)*L1*cos(xt[4])*dxt[4]*z[4])*0.5
            res[26] = -dz[5]*((L2*sin(xt[5]))*0.5+(sqrt(3)*L2*cos(xt[5])*sin(xt[6]))*0.5)-z[5]*((L2*cos(xt[5])*dxt[5])*0.5+(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[6])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[5])*0.5)-z[6]*((sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[5])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[6])*0.5)-L1*sin(xt[1])*dz[1]-L2*sin(xt[2])*dz[2]-(L1*sin(xt[4])*dz[4])*0.5-L1*cos(xt[1])*dxt[1]*z[1]-L2*cos(xt[2])*dxt[2]*z[2]-(L1*cos(xt[4])*dxt[4]*z[4])*0.5-(sqrt(3)*L2*cos(xt[6])*sin(xt[5])*dz[6])*0.5
            res[27] = z[5]*(L2*cos(xt[6])*sin(xt[5])*dxt[5]+L2*cos(xt[5])*sin(xt[6])*dxt[6])-z[3]*(L2*cos(xt[2])*sin(xt[3])*dxt[2]+L2*cos(xt[3])*sin(xt[2])*dxt[3])-z[2]*(L2*cos(xt[3])*sin(xt[2])*dxt[2]+L2*cos(xt[2])*sin(xt[3])*dxt[3])+z[6]*(L2*cos(xt[5])*sin(xt[6])*dxt[5]+L2*cos(xt[6])*sin(xt[5])*dxt[6])+L1*cos(xt[1])*dz[1]-L1*cos(xt[4])*dz[4]+L2*cos(xt[2])*cos(xt[3])*dz[2]-L2*cos(xt[5])*cos(xt[6])*dz[5]-L2*sin(xt[2])*sin(xt[3])*dz[3]+L2*sin(xt[5])*sin(xt[6])*dz[6]-L1*sin(xt[1])*dxt[1]*z[1]+L1*sin(xt[4])*dxt[4]*z[4]
            res[28] = z[8]*((L2*cos(xt[8])*cos(xt[9])*dxt[9])*0.5+(sqrt(3)*L2*cos(xt[8])*dxt[8])*0.5-(L2*sin(xt[8])*sin(xt[9])*dxt[8])*0.5)+dz[8]*((L2*cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*L2*sin(xt[8]))*0.5)+z[2]*(L2*cos(xt[2])*cos(xt[3])*dxt[3]-L2*sin(xt[2])*sin(xt[3])*dxt[2])+z[3]*(L2*cos(xt[2])*cos(xt[3])*dxt[2]-L2*sin(xt[2])*sin(xt[3])*dxt[3])+z[9]*((L2*cos(xt[8])*cos(xt[9])*dxt[8])*0.5-(L2*sin(xt[8])*sin(xt[9])*dxt[9])*0.5)+L2*cos(xt[2])*sin(xt[3])*dz[2]+L2*cos(xt[3])*sin(xt[2])*dz[3]+(L2*cos(xt[9])*sin(xt[8])*dz[9])*0.5+(sqrt(3)*L1*sin(xt[7])*dz[7])*0.5+(sqrt(3)*L1*cos(xt[7])*dxt[7]*z[7])*0.5
            res[29] = z[9]*((sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[8])*0.5-(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[9])*0.5)-z[8]*((L2*cos(xt[8])*dxt[8])*0.5-(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[9])*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[8])*0.5)-dz[8]*((L2*sin(xt[8]))*0.5-(sqrt(3)*L2*cos(xt[8])*sin(xt[9]))*0.5)-L1*sin(xt[1])*dz[1]-L2*sin(xt[2])*dz[2]-(L1*sin(xt[7])*dz[7])*0.5-L1*cos(xt[1])*dxt[1]*z[1]-L2*cos(xt[2])*dxt[2]*z[2]-(L1*cos(xt[7])*dxt[7]*z[7])*0.5+(sqrt(3)*L2*cos(xt[9])*sin(xt[8])*dz[9])*0.5
            res[30] = z[8]*(L2*cos(xt[9])*sin(xt[8])*dxt[8]+L2*cos(xt[8])*sin(xt[9])*dxt[9])-z[3]*(L2*cos(xt[2])*sin(xt[3])*dxt[2]+L2*cos(xt[3])*sin(xt[2])*dxt[3])-z[2]*(L2*cos(xt[3])*sin(xt[2])*dxt[2]+L2*cos(xt[2])*sin(xt[3])*dxt[3])+z[9]*(L2*cos(xt[8])*sin(xt[9])*dxt[8]+L2*cos(xt[9])*sin(xt[8])*dxt[9])+L1*cos(xt[1])*dz[1]-L1*cos(xt[7])*dz[7]+L2*cos(xt[2])*cos(xt[3])*dz[2]-L2*cos(xt[8])*cos(xt[9])*dz[8]-L2*sin(xt[2])*sin(xt[3])*dz[3]+L2*sin(xt[8])*sin(xt[9])*dz[9]-L1*sin(xt[1])*dxt[1]*z[1]+L1*sin(xt[7])*dxt[7]*z[7]
            # TODO: Do we really need to simulate with these three equations or could we remove them somehow since they are quite trivial?
            res[31] = -z[31]-2*(yt[1]-xt[31])/T
            res[32] = -z[32]-2*(yt[2]-xt[32])/T
            res[33] = -z[33]-2*(yt[3]-xt[33])/T
            # ---------- β-equations ----------
            # 0 = dβᵢ - gθᵢ + λᵀ(Fθᵢ + Fw wθᵢ)   
            res[34] = dz[34] - (z[10]*xt[10]+z[11]*xt[11]+z[12]*xt[12]+z[13]*xt[13]+z[14]*xt[14]+z[15]*xt[15]+z[16]*xt[16]+z[17]*xt[17]+z[18]*xt[18])       # For parameter γ, only dβᵢ - λᵀFθᵢ
            nothing
        end

        # At least for the two forms of index 1 DAEs in my licentiate thesis, λd are always differential and λa are always algebraic.
        # λd always correspond to the differential equations in F, which are equations 1,....,18, from which we get the following dinds and ainds
        # The delta robot is an index 1 DAE exactly on one of these forms
        dinds  = 1:18  # Indices of differential variables
        ainds  = 19:33 # Indices of algebraic variables

        ######################## INITIALIZING ADJOINT SYSTEM (Computing terminal values) ####################
        # Using special initialization function for delta robot, it improves the accuracy of the initial values (values at t=T that is)
        λT, dλT = get_initial_adjoint_deltaversion(dinds, ainds, gₓT, dgₓT, FxT, Fdx(T), dFdxT, x(T,1:33), y(T,1:3), T)
        βT, dβT = get_initial_adjoint_beta(λT, FθT, zeros(nθ))
        z0 = vcat(λT, βT)
        dz0 = vcat(dλT, dβT)

        # Function returning Gθ given adjoint solution
        function get_Gθ(adj_sol::DAESolution)
            # Because the problem is solved backwards in time, the end of the solution corresponds to t=0
            # Gθᵢ = βᵢ(0) + (λᵀFdx xθᵢ)(0)
            adj_sol.u[end][nx+1:nx+nθ] .+ (((adj_sol.u[end][1:nx]')*Fdx(0.0))*xθ0)
        end

        dvars = fill(false, nx+nθ)
        dvars[dinds] .= true
        dvars[end-nθ:end] .= true

        r0 = zeros(length(z0))
        f!(r0, dz0, z0, [], T)
        # @info "r0 is: $r0"

        # t -> 0.0 is just a dummy function, not to be used
        return Model(f!, t -> 0.0, z0, dz0, dvars, r0), get_Gθ
    end
end

# NOTE: TODO: f! currently only for specific disturbance model! Make agnostic!
# Used to be called delta_robot_gc_foradj_alldist
function delta_adjoint_allpar_alldist(w::Function, pars::Vector{Float64}, T::Float64, x::func_type, x2::func_type, y::func_type, dy::func_type, xθ0::Matrix{Float64}, dx::func_type, dx2::func_type)::Tuple{Model,Function}
    # g = 0 because this is the gravity-compensated model
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]
        nx, nθ = size(xθ0)
        @assert (nθ == 24) "delta_adjoint_allpar_alldist is hard-coded to handle 24 parameters (12 dynamical and 12 disturbance), make sure to pass correct xθ0. Currently passing $nθ parameters."
        @assert (nx == 33) "delta_adjoint_allpar_alldist expects the DAE state to have 33 components, the passed state has $nx components instead"

        FxT = [-L1*cos(x(T,1))*dx(T,26)-L1*cos(x(T,1))*dx(T,29)-L1*sin(x(T,1))*dx(T,27)-L1*sin(x(T,1))*dx(T,30)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   -L2*cos(x(T,2))*dx(T,26)-L2*cos(x(T,2))*dx(T,29)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,27)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,30)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,25)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,28)   L2*cos(x(T,2))*cos(x(T,3))*dx(T,25)+L2*cos(x(T,2))*cos(x(T,3))*dx(T,28)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,27)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,30)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*cos(x(T,3))*dx(T,25)+L2*cos(x(T,2))*cos(x(T,3))*dx(T,28)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,27)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,30)   -L2*cos(x(T,3))*sin(x(T,2))*dx(T,27)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,30)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,25)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,28)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   L1*sin(x(T,4))*dx(T,27)-(L1*cos(x(T,4))*dx(T,26))*0.5-(sqrt(3)*L1*cos(x(T,4))*dx(T,25))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   L2*cos(x(T,6))*sin(x(T,5))*dx(T,27)-dx(T,26)*((L2*cos(x(T,5)))*0.5-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6)))*0.5)-dx(T,25)*((sqrt(3)*L2*cos(x(T,5)))*0.5+(L2*sin(x(T,5))*sin(x(T,6)))*0.5)   (L2*cos(x(T,5))*cos(x(T,6))*dx(T,25))*0.5+L2*cos(x(T,5))*sin(x(T,6))*dx(T,27)-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,26))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   (L2*cos(x(T,5))*cos(x(T,6))*dx(T,25))*0.5+L2*cos(x(T,5))*sin(x(T,6))*dx(T,27)-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,26))*0.5   L2*cos(x(T,6))*sin(x(T,5))*dx(T,27)-(L2*sin(x(T,5))*sin(x(T,6))*dx(T,25))*0.5+(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,26))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(T,7))*dx(T,30)-(L1*cos(x(T,7))*dx(T,29))*0.5+(sqrt(3)*L1*cos(x(T,7))*dx(T,28))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   dx(T,28)*((sqrt(3)*L2*cos(x(T,8)))*0.5-(L2*sin(x(T,8))*sin(x(T,9)))*0.5)-dx(T,29)*((L2*cos(x(T,8)))*0.5+(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9)))*0.5)+L2*cos(x(T,9))*sin(x(T,8))*dx(T,30)   (L2*cos(x(T,8))*cos(x(T,9))*dx(T,28))*0.5+L2*cos(x(T,8))*sin(x(T,9))*dx(T,30)+(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,29))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,8))*cos(x(T,9))*dx(T,28))*0.5+L2*cos(x(T,8))*sin(x(T,9))*dx(T,30)+(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,29))*0.5   L2*cos(x(T,9))*sin(x(T,8))*dx(T,30)-(L2*sin(x(T,8))*sin(x(T,9))*dx(T,28))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,29))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0*sin(x(T,1))*(L1*(M2+M3)+LC1*M1)+L1*cos(x(T,1))*dx(T,20)+L1*cos(x(T,1))*dx(T,23)+L1*sin(x(T,1))*dx(T,21)+L1*sin(x(T,1))*dx(T,24)+L1*dx(T,11)*(L2*M3+LC2*M2)*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))+L1*x(T,11)^2*(L2*M3+LC2*M2)*(cos(x(T,1))*cos(x(T,2))+cos(x(T,3))*sin(x(T,1))*sin(x(T,2)))+L1*cos(x(T,3))*sin(x(T,1))*sin(x(T,2))*x(T,12)^2*(L2*M3+LC2*M2)+L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,12)*(L2*M3+LC2*M2)+2*L1*cos(x(T,2))*sin(x(T,1))*sin(x(T,3))*x(T,11)*x(T,12)*(L2*M3+LC2*M2)   L1*dx(T,11)*(L2*M3+LC2*M2)*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-L1*x(T,11)^2*(L2*M3+LC2*M2)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))-L1*cos(x(T,1))*cos(x(T,2))*cos(x(T,3))*x(T,12)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,12)*(L2*M3+LC2*M2)+2*L1*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,11)*x(T,12)*(L2*M3+LC2*M2)   L1*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,11)^2*(L2*M3+LC2*M2)+L1*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,12)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,11)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,12)*(L2*M3+LC2*M2)-2*L1*cos(x(T,1))*cos(x(T,2))*cos(x(T,3))*x(T,11)*x(T,12)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   γ   2*L1*x(T,11)*(L2*M3+LC2*M2)*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-2*L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,12)*(L2*M3+LC2*M2)   -2*L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,11)*(L2*M3+LC2*M2)-2*L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*x(T,12)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            L1*dx(T,10)*(L2*M3+LC2*M2)*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))-L1*x(T,10)^2*(L2*M3+LC2*M2)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))   sin(x(T,2))^2*x(T,12)^2*(J2+L2^2*M3+LC2^2*M2)-cos(x(T,2))^2*x(T,12)^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(x(T,2))*dx(T,20)+L2*cos(x(T,2))*dx(T,23)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,21)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,24)+L2*sin(x(T,2))*sin(x(T,3))*dx(T,19)+L2*sin(x(T,2))*sin(x(T,3))*dx(T,22)+L1*dx(T,10)*(L2*M3+LC2*M2)*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))+0.0*cos(x(T,3))*sin(x(T,2))*(L2*M3+LC2*M2)+L1*x(T,10)^2*(L2*M3+LC2*M2)*(cos(x(T,1))*cos(x(T,2))+cos(x(T,3))*sin(x(T,1))*sin(x(T,2)))   L2*cos(x(T,2))*sin(x(T,3))*dx(T,21)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,22)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,19)+L2*cos(x(T,2))*sin(x(T,3))*dx(T,24)+0.0*cos(x(T,2))*sin(x(T,3))*(L2*M3+LC2*M2)+L1*cos(x(T,2))*sin(x(T,1))*sin(x(T,3))*x(T,10)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,10)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*x(T,10)*(L2*M3+LC2*M2)*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))   γ   -2*cos(x(T,2))*sin(x(T,2))*x(T,12)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            L1*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)^2*(L2*M3+LC2*M2)+L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,10)*(L2*M3+LC2*M2)   L2*cos(x(T,2))*sin(x(T,3))*dx(T,21)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,22)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,19)+L2*cos(x(T,2))*sin(x(T,3))*dx(T,24)+2*cos(x(T,2))*sin(x(T,2))*dx(T,12)*(J2+L2^2*M3+LC2^2*M2)+2*cos(2*x(T,2))*x(T,11)*x(T,12)*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(x(T,2))*sin(x(T,3))*(L2*M3+LC2*M2)+L1*cos(x(T,2))*sin(x(T,1))*sin(x(T,3))*x(T,10)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,10)*(L2*M3+LC2*M2)   L2*cos(x(T,3))*sin(x(T,2))*dx(T,21)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,24)+L2*sin(x(T,2))*sin(x(T,3))*dx(T,19)+L2*sin(x(T,2))*sin(x(T,3))*dx(T,22)+0.0*cos(x(T,3))*sin(x(T,2))*(L2*M3+LC2*M2)+L1*cos(x(T,3))*sin(x(T,1))*sin(x(T,2))*x(T,10)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,10)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)*(L2*M3+LC2*M2)   sin(2*x(T,2))*x(T,12)*(J2+L2^2*M3+LC2^2*M2)   γ+sin(2*x(T,2))*x(T,11)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0*sin(x(T,4))*(L1*(M2+M3)+LC1*M1)+(L1*cos(x(T,4))*dx(T,20))*0.5-L1*sin(x(T,4))*dx(T,21)+(sqrt(3)*L1*cos(x(T,4))*dx(T,19))*0.5+L1*dx(T,14)*(L2*M3+LC2*M2)*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))+L1*x(T,14)^2*(L2*M3+LC2*M2)*(cos(x(T,4))*cos(x(T,5))+cos(x(T,6))*sin(x(T,4))*sin(x(T,5)))+L1*cos(x(T,6))*sin(x(T,4))*sin(x(T,5))*x(T,15)^2*(L2*M3+LC2*M2)+L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,15)*(L2*M3+LC2*M2)+2*L1*cos(x(T,5))*sin(x(T,4))*sin(x(T,6))*x(T,14)*x(T,15)*(L2*M3+LC2*M2)   L1*dx(T,14)*(L2*M3+LC2*M2)*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-L1*x(T,14)^2*(L2*M3+LC2*M2)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))-L1*cos(x(T,4))*cos(x(T,5))*cos(x(T,6))*x(T,15)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,15)*(L2*M3+LC2*M2)+2*L1*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,14)*x(T,15)*(L2*M3+LC2*M2)   L1*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,14)^2*(L2*M3+LC2*M2)+L1*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,15)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,14)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,15)*(L2*M3+LC2*M2)-2*L1*cos(x(T,4))*cos(x(T,5))*cos(x(T,6))*x(T,14)*x(T,15)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   γ   2*L1*x(T,14)*(L2*M3+LC2*M2)*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-2*L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,15)*(L2*M3+LC2*M2)   -2*L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,14)*(L2*M3+LC2*M2)-2*L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*x(T,15)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   L1*dx(T,13)*(L2*M3+LC2*M2)*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))-L1*x(T,13)^2*(L2*M3+LC2*M2)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))   dx(T,19)*((sqrt(3)*L2*cos(x(T,5)))*0.5+(L2*sin(x(T,5))*sin(x(T,6)))*0.5)+dx(T,20)*((L2*cos(x(T,5)))*0.5-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6)))*0.5)-cos(x(T,5))^2*x(T,15)^2*(J2+L2^2*M3+LC2^2*M2)+sin(x(T,5))^2*x(T,15)^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(x(T,6))*sin(x(T,5))*dx(T,21)+L1*dx(T,13)*(L2*M3+LC2*M2)*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))+0.0*cos(x(T,6))*sin(x(T,5))*(L2*M3+LC2*M2)+L1*x(T,13)^2*(L2*M3+LC2*M2)*(cos(x(T,4))*cos(x(T,5))+cos(x(T,6))*sin(x(T,4))*sin(x(T,5)))   0.0*cos(x(T,5))*sin(x(T,6))*(L2*M3+LC2*M2)-L2*cos(x(T,5))*sin(x(T,6))*dx(T,21)-(L2*cos(x(T,5))*cos(x(T,6))*dx(T,19))*0.5+(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,20))*0.5+L1*cos(x(T,5))*sin(x(T,4))*sin(x(T,6))*x(T,13)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,13)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*x(T,13)*(L2*M3+LC2*M2)*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))   γ   -2*cos(x(T,5))*sin(x(T,5))*x(T,15)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   L1*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)^2*(L2*M3+LC2*M2)+L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,13)*(L2*M3+LC2*M2)   2*cos(x(T,5))*sin(x(T,5))*dx(T,15)*(J2+L2^2*M3+LC2^2*M2)-L2*cos(x(T,5))*sin(x(T,6))*dx(T,21)-(L2*cos(x(T,5))*cos(x(T,6))*dx(T,19))*0.5+2*cos(2*x(T,5))*x(T,14)*x(T,15)*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(x(T,5))*sin(x(T,6))*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,20))*0.5+L1*cos(x(T,5))*sin(x(T,4))*sin(x(T,6))*x(T,13)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,13)*(L2*M3+LC2*M2)   (L2*sin(x(T,5))*sin(x(T,6))*dx(T,19))*0.5-L2*cos(x(T,6))*sin(x(T,5))*dx(T,21)+0.0*cos(x(T,6))*sin(x(T,5))*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,20))*0.5+L1*cos(x(T,6))*sin(x(T,4))*sin(x(T,5))*x(T,13)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,13)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)*(L2*M3+LC2*M2)   sin(2*x(T,5))*x(T,15)*(J2+L2^2*M3+LC2^2*M2)   γ+sin(2*x(T,5))*x(T,14)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0*sin(x(T,7))*(L1*(M2+M3)+LC1*M1)+(L1*cos(x(T,7))*dx(T,23))*0.5-L1*sin(x(T,7))*dx(T,24)-(sqrt(3)*L1*cos(x(T,7))*dx(T,22))*0.5+L1*dx(T,17)*(L2*M3+LC2*M2)*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))+L1*x(T,17)^2*(L2*M3+LC2*M2)*(cos(x(T,7))*cos(x(T,8))+cos(x(T,9))*sin(x(T,7))*sin(x(T,8)))+L1*cos(x(T,9))*sin(x(T,7))*sin(x(T,8))*x(T,18)^2*(L2*M3+LC2*M2)+L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,18)*(L2*M3+LC2*M2)+2*L1*cos(x(T,8))*sin(x(T,7))*sin(x(T,9))*x(T,17)*x(T,18)*(L2*M3+LC2*M2)   L1*dx(T,17)*(L2*M3+LC2*M2)*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-L1*x(T,17)^2*(L2*M3+LC2*M2)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))-L1*cos(x(T,7))*cos(x(T,8))*cos(x(T,9))*x(T,18)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,18)*(L2*M3+LC2*M2)+2*L1*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,17)*x(T,18)*(L2*M3+LC2*M2)   L1*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,17)^2*(L2*M3+LC2*M2)+L1*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,18)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,17)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,18)*(L2*M3+LC2*M2)-2*L1*cos(x(T,7))*cos(x(T,8))*cos(x(T,9))*x(T,17)*x(T,18)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   γ   2*L1*x(T,17)*(L2*M3+LC2*M2)*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-2*L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,18)*(L2*M3+LC2*M2)   -2*L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,17)*(L2*M3+LC2*M2)-2*L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*x(T,18)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*dx(T,16)*(L2*M3+LC2*M2)*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))-L1*x(T,16)^2*(L2*M3+LC2*M2)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))   dx(T,23)*((L2*cos(x(T,8)))*0.5+(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9)))*0.5)-dx(T,22)*((sqrt(3)*L2*cos(x(T,8)))*0.5-(L2*sin(x(T,8))*sin(x(T,9)))*0.5)-cos(x(T,8))^2*x(T,18)^2*(J2+L2^2*M3+LC2^2*M2)+sin(x(T,8))^2*x(T,18)^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(x(T,9))*sin(x(T,8))*dx(T,24)+L1*dx(T,16)*(L2*M3+LC2*M2)*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))+0.0*cos(x(T,9))*sin(x(T,8))*(L2*M3+LC2*M2)+L1*x(T,16)^2*(L2*M3+LC2*M2)*(cos(x(T,7))*cos(x(T,8))+cos(x(T,9))*sin(x(T,7))*sin(x(T,8)))   0.0*cos(x(T,8))*sin(x(T,9))*(L2*M3+LC2*M2)-L2*cos(x(T,8))*sin(x(T,9))*dx(T,24)-(L2*cos(x(T,8))*cos(x(T,9))*dx(T,22))*0.5-(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,23))*0.5+L1*cos(x(T,8))*sin(x(T,7))*sin(x(T,9))*x(T,16)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,16)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*x(T,16)*(L2*M3+LC2*M2)*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))   γ   -2*cos(x(T,8))*sin(x(T,8))*x(T,18)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)^2*(L2*M3+LC2*M2)+L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,16)*(L2*M3+LC2*M2)   2*cos(x(T,8))*sin(x(T,8))*dx(T,18)*(J2+L2^2*M3+LC2^2*M2)-L2*cos(x(T,8))*sin(x(T,9))*dx(T,24)-(L2*cos(x(T,8))*cos(x(T,9))*dx(T,22))*0.5+2*cos(2*x(T,8))*x(T,17)*x(T,18)*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(x(T,8))*sin(x(T,9))*(L2*M3+LC2*M2)-(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,23))*0.5+L1*cos(x(T,8))*sin(x(T,7))*sin(x(T,9))*x(T,16)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,16)*(L2*M3+LC2*M2)   (L2*sin(x(T,8))*sin(x(T,9))*dx(T,22))*0.5-L2*cos(x(T,9))*sin(x(T,8))*dx(T,24)+0.0*cos(x(T,9))*sin(x(T,8))*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,23))*0.5+L1*cos(x(T,9))*sin(x(T,7))*sin(x(T,8))*x(T,16)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,16)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)*(L2*M3+LC2*M2)   sin(2*x(T,8))*x(T,18)*(J2+L2^2*M3+LC2^2*M2)   γ+sin(2*x(T,8))*x(T,17)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*sin(x(T,3))   L2*cos(x(T,3))*sin(x(T,2))   -(sqrt(3)*L1*sin(x(T,4)))*0.5   (L2*cos(x(T,5))*sin(x(T,6)))*0.5-(sqrt(3)*L2*sin(x(T,5)))*0.5   (L2*cos(x(T,6))*sin(x(T,5)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*sin(x(T,1))   -L2*sin(x(T,2))   0.0   -(L1*sin(x(T,4)))*0.5   -(L2*sin(x(T,5)))*0.5-(sqrt(3)*L2*cos(x(T,5))*sin(x(T,6)))*0.5   -(sqrt(3)*L2*cos(x(T,6))*sin(x(T,5)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            L1*cos(x(T,1))   L2*cos(x(T,2))*cos(x(T,3))   -L2*sin(x(T,2))*sin(x(T,3))   -L1*cos(x(T,4))   -L2*cos(x(T,5))*cos(x(T,6))   L2*sin(x(T,5))*sin(x(T,6))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*sin(x(T,3))   L2*cos(x(T,3))*sin(x(T,2))   0.0   0.0   0.0   (sqrt(3)*L1*sin(x(T,7)))*0.5   (L2*cos(x(T,8))*sin(x(T,9)))*0.5+(sqrt(3)*L2*sin(x(T,8)))*0.5   (L2*cos(x(T,9))*sin(x(T,8)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*sin(x(T,1))   -L2*sin(x(T,2))   0.0   0.0   0.0   0.0   -(L1*sin(x(T,7)))*0.5   (sqrt(3)*L2*cos(x(T,8))*sin(x(T,9)))*0.5-(L2*sin(x(T,8)))*0.5   (sqrt(3)*L2*cos(x(T,9))*sin(x(T,8)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            L1*cos(x(T,1))   L2*cos(x(T,2))*cos(x(T,3))   -L2*sin(x(T,2))*sin(x(T,3))   0.0   0.0   0.0   -L1*cos(x(T,7))   -L2*cos(x(T,8))*cos(x(T,9))   L2*sin(x(T,8))*sin(x(T,9))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*cos(x(T,3))*x(T,12)-L2*sin(x(T,2))*sin(x(T,3))*x(T,11)   L2*cos(x(T,2))*cos(x(T,3))*x(T,11)-L2*sin(x(T,2))*sin(x(T,3))*x(T,12)   -(sqrt(3)*L1*cos(x(T,4))*x(T,13))*0.5   (L2*cos(x(T,5))*cos(x(T,6))*x(T,15))*0.5-(sqrt(3)*L2*cos(x(T,5))*x(T,14))*0.5-(L2*sin(x(T,5))*sin(x(T,6))*x(T,14))*0.5   (L2*cos(x(T,5))*cos(x(T,6))*x(T,14))*0.5-(L2*sin(x(T,5))*sin(x(T,6))*x(T,15))*0.5   0.0   0.0   0.0   0.0   L2*cos(x(T,2))*sin(x(T,3))   L2*cos(x(T,3))*sin(x(T,2))   -(sqrt(3)*L1*sin(x(T,4)))*0.5   (L2*cos(x(T,5))*sin(x(T,6)))*0.5-(sqrt(3)*L2*sin(x(T,5)))*0.5   (L2*cos(x(T,6))*sin(x(T,5)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*cos(x(T,1))*x(T,10)   -L2*cos(x(T,2))*x(T,11)   0.0   -(L1*cos(x(T,4))*x(T,13))*0.5   (sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*x(T,14))*0.5-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*x(T,15))*0.5-(L2*cos(x(T,5))*x(T,14))*0.5   (sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*x(T,15))*0.5-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*x(T,14))*0.5   0.0   0.0   0.0   -L1*sin(x(T,1))   -L2*sin(x(T,2))   0.0   -(L1*sin(x(T,4)))*0.5   -(L2*sin(x(T,5)))*0.5-(sqrt(3)*L2*cos(x(T,5))*sin(x(T,6)))*0.5   -(sqrt(3)*L2*cos(x(T,6))*sin(x(T,5)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*sin(x(T,1))*x(T,10)   -L2*cos(x(T,3))*sin(x(T,2))*x(T,11)-L2*cos(x(T,2))*sin(x(T,3))*x(T,12)   -L2*cos(x(T,2))*sin(x(T,3))*x(T,11)-L2*cos(x(T,3))*sin(x(T,2))*x(T,12)   L1*sin(x(T,4))*x(T,13)   L2*cos(x(T,6))*sin(x(T,5))*x(T,14)+L2*cos(x(T,5))*sin(x(T,6))*x(T,15)   L2*cos(x(T,5))*sin(x(T,6))*x(T,14)+L2*cos(x(T,6))*sin(x(T,5))*x(T,15)   0.0   0.0   0.0   L1*cos(x(T,1))   L2*cos(x(T,2))*cos(x(T,3))   -L2*sin(x(T,2))*sin(x(T,3))   -L1*cos(x(T,4))   -L2*cos(x(T,5))*cos(x(T,6))   L2*sin(x(T,5))*sin(x(T,6))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*cos(x(T,3))*x(T,12)-L2*sin(x(T,2))*sin(x(T,3))*x(T,11)   L2*cos(x(T,2))*cos(x(T,3))*x(T,11)-L2*sin(x(T,2))*sin(x(T,3))*x(T,12)   0.0   0.0   0.0   (sqrt(3)*L1*cos(x(T,7))*x(T,16))*0.5   (L2*cos(x(T,8))*cos(x(T,9))*x(T,18))*0.5+(sqrt(3)*L2*cos(x(T,8))*x(T,17))*0.5-(L2*sin(x(T,8))*sin(x(T,9))*x(T,17))*0.5   (L2*cos(x(T,8))*cos(x(T,9))*x(T,17))*0.5-(L2*sin(x(T,8))*sin(x(T,9))*x(T,18))*0.5   0.0   L2*cos(x(T,2))*sin(x(T,3))   L2*cos(x(T,3))*sin(x(T,2))   0.0   0.0   0.0   (sqrt(3)*L1*sin(x(T,7)))*0.5   (L2*cos(x(T,8))*sin(x(T,9)))*0.5+(sqrt(3)*L2*sin(x(T,8)))*0.5   (L2*cos(x(T,9))*sin(x(T,8)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*cos(x(T,1))*x(T,10)   -L2*cos(x(T,2))*x(T,11)   0.0   0.0   0.0   0.0   -(L1*cos(x(T,7))*x(T,16))*0.5   (sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*x(T,18))*0.5-(L2*cos(x(T,8))*x(T,17))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*x(T,17))*0.5   (sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*x(T,17))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*x(T,18))*0.5   -L1*sin(x(T,1))   -L2*sin(x(T,2))   0.0   0.0   0.0   0.0   -(L1*sin(x(T,7)))*0.5   (sqrt(3)*L2*cos(x(T,8))*sin(x(T,9)))*0.5-(L2*sin(x(T,8)))*0.5   (sqrt(3)*L2*cos(x(T,9))*sin(x(T,8)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*sin(x(T,1))*x(T,10)   -L2*cos(x(T,3))*sin(x(T,2))*x(T,11)-L2*cos(x(T,2))*sin(x(T,3))*x(T,12)   -L2*cos(x(T,2))*sin(x(T,3))*x(T,11)-L2*cos(x(T,3))*sin(x(T,2))*x(T,12)   0.0   0.0   0.0   L1*sin(x(T,7))*x(T,16)   L2*cos(x(T,9))*sin(x(T,8))*x(T,17)+L2*cos(x(T,8))*sin(x(T,9))*x(T,18)   L2*cos(x(T,8))*sin(x(T,9))*x(T,17)+L2*cos(x(T,9))*sin(x(T,8))*x(T,18)   L1*cos(x(T,1))   L2*cos(x(T,2))*cos(x(T,3))   -L2*sin(x(T,2))*sin(x(T,3))   0.0   0.0   0.0   -L1*cos(x(T,7))   -L2*cos(x(T,8))*cos(x(T,9))   L2*sin(x(T,8))*sin(x(T,9))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   -L2*cos(x(T,2))*sin(x(T,3))   -L2*cos(x(T,3))*sin(x(T,2))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0
            L1*sin(x(T,1))   L2*sin(x(T,2))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0
            -L1*cos(x(T,1))   -L2*cos(x(T,2))*cos(x(T,3))   L2*sin(x(T,2))*sin(x(T,3))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0]
        Fdx = t -> [
            1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*sin(x(t,1))   L1*cos(x(t,1))   0.0   -L1*sin(x(t,1))   L1*cos(x(t,1))   0.0   0.0   0.0
            0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*cos(x(t,2))*sin(x(t,3))   -L2*sin(x(t,2))   L2*cos(x(t,2))*cos(x(t,3))   L2*cos(x(t,2))*sin(x(t,3))   -L2*sin(x(t,2))   L2*cos(x(t,2))*cos(x(t,3))   0.0   0.0   0.0
            0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*cos(x(t,3))*sin(x(t,2))   0.0   -L2*sin(x(t,2))*sin(x(t,3))   L2*cos(x(t,3))*sin(x(t,2))   0.0   -L2*sin(x(t,2))*sin(x(t,3))   0.0   0.0   0.0
            0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -(sqrt(3)*L1*sin(x(t,4)))*0.5   -(L1*sin(x(t,4)))*0.5   -L1*cos(x(t,4))   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(t,5))*sin(x(t,6)))*0.5-(sqrt(3)*L2*sin(x(t,5)))*0.5   -(L2*sin(x(t,5)))*0.5-(sqrt(3)*L2*cos(x(t,5))*sin(x(t,6)))*0.5   -L2*cos(x(t,5))*cos(x(t,6))   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(t,6))*sin(x(t,5)))*0.5   -(sqrt(3)*L2*cos(x(t,6))*sin(x(t,5)))*0.5   L2*sin(x(t,5))*sin(x(t,6))   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (sqrt(3)*L1*sin(x(t,7)))*0.5   -(L1*sin(x(t,7)))*0.5   -L1*cos(x(t,7))   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(t,8))*sin(x(t,9)))*0.5+(sqrt(3)*L2*sin(x(t,8)))*0.5   (sqrt(3)*L2*cos(x(t,8))*sin(x(t,9)))*0.5-(L2*sin(x(t,8)))*0.5   -L2*cos(x(t,8))*cos(x(t,9))   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(t,9))*sin(x(t,8)))*0.5   (sqrt(3)*L2*cos(x(t,9))*sin(x(t,8)))*0.5   L2*sin(x(t,8))*sin(x(t,9))   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   J1+L1^2*(M2+M3)+LC1^2*M1   L1*(L2*M3+LC2*M2)*(sin(x(t,1))*sin(x(t,2))+cos(x(t,1))*cos(x(t,2))*cos(x(t,3)))   -L1*cos(x(t,1))*sin(x(t,2))*sin(x(t,3))*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(t,1))   -L1*cos(x(t,1))   0.0   L1*sin(x(t,1))   -L1*cos(x(t,1))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*(L2*M3+LC2*M2)*(sin(x(t,1))*sin(x(t,2))+cos(x(t,1))*cos(x(t,2))*cos(x(t,3)))   J2+L2^2*M3+LC2^2*M2   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L2*cos(x(t,2))*sin(x(t,3))   L2*sin(x(t,2))   -L2*cos(x(t,2))*cos(x(t,3))   -L2*cos(x(t,2))*sin(x(t,3))   L2*sin(x(t,2))   -L2*cos(x(t,2))*cos(x(t,3))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*cos(x(t,1))*sin(x(t,2))*sin(x(t,3))*(L2*M3+LC2*M2)   0.0   sin(x(t,2))^2*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   -L2*cos(x(t,3))*sin(x(t,2))   0.0   L2*sin(x(t,2))*sin(x(t,3))   -L2*cos(x(t,3))*sin(x(t,2))   0.0   L2*sin(x(t,2))*sin(x(t,3))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   J1+L1^2*(M2+M3)+LC1^2*M1   L1*(L2*M3+LC2*M2)*(sin(x(t,4))*sin(x(t,5))+cos(x(t,4))*cos(x(t,5))*cos(x(t,6)))   -L1*cos(x(t,4))*sin(x(t,5))*sin(x(t,6))*(L2*M3+LC2*M2)   0.0   0.0   0.0   (sqrt(3)*L1*sin(x(t,4)))*0.5   (L1*sin(x(t,4)))*0.5   L1*cos(x(t,4))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*(L2*M3+LC2*M2)*(sin(x(t,4))*sin(x(t,5))+cos(x(t,4))*cos(x(t,5))*cos(x(t,6)))   J2+L2^2*M3+LC2^2*M2   0.0   0.0   0.0   0.0   (sqrt(3)*L2*sin(x(t,5)))*0.5-(L2*cos(x(t,5))*sin(x(t,6)))*0.5   (L2*sin(x(t,5)))*0.5+(sqrt(3)*L2*cos(x(t,5))*sin(x(t,6)))*0.5   L2*cos(x(t,5))*cos(x(t,6))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*cos(x(t,4))*sin(x(t,5))*sin(x(t,6))*(L2*M3+LC2*M2)   0.0   sin(x(t,5))^2*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   -(L2*cos(x(t,6))*sin(x(t,5)))*0.5   (sqrt(3)*L2*cos(x(t,6))*sin(x(t,5)))*0.5   -L2*sin(x(t,5))*sin(x(t,6))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   J1+L1^2*(M2+M3)+LC1^2*M1   L1*(L2*M3+LC2*M2)*(sin(x(t,7))*sin(x(t,8))+cos(x(t,7))*cos(x(t,8))*cos(x(t,9)))   -L1*cos(x(t,7))*sin(x(t,8))*sin(x(t,9))*(L2*M3+LC2*M2)   0.0   0.0   0.0   -(sqrt(3)*L1*sin(x(t,7)))*0.5   (L1*sin(x(t,7)))*0.5   L1*cos(x(t,7))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*(L2*M3+LC2*M2)*(sin(x(t,7))*sin(x(t,8))+cos(x(t,7))*cos(x(t,8))*cos(x(t,9)))   J2+L2^2*M3+LC2^2*M2   0.0   0.0   0.0   0.0   -(L2*cos(x(t,8))*sin(x(t,9)))*0.5-(sqrt(3)*L2*sin(x(t,8)))*0.5   (L2*sin(x(t,8)))*0.5-(sqrt(3)*L2*cos(x(t,8))*sin(x(t,9)))*0.5   L2*cos(x(t,8))*cos(x(t,9))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*cos(x(t,7))*sin(x(t,8))*sin(x(t,9))*(L2*M3+LC2*M2)   0.0   sin(x(t,8))^2*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   -(L2*cos(x(t,9))*sin(x(t,8)))*0.5   -(sqrt(3)*L2*cos(x(t,9))*sin(x(t,8)))*0.5   -L2*sin(x(t,8))*sin(x(t,9))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0]
        dFdxT = [
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*cos(x(T,1))*dx(T,1)   -L1*sin(x(T,1))*dx(T,1)   0.0   -L1*cos(x(T,1))*dx(T,1)   -L1*sin(x(T,1))*dx(T,1)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*cos(x(T,2))*cos(x(T,3))*dx(T,3)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,2)   -L2*cos(x(T,2))*dx(T,2)   -L2*cos(x(T,3))*sin(x(T,2))*dx(T,2)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,3)   L2*cos(x(T,2))*cos(x(T,3))*dx(T,3)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,2)   -L2*cos(x(T,2))*dx(T,2)   -L2*cos(x(T,3))*sin(x(T,2))*dx(T,2)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,3)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*cos(x(T,2))*cos(x(T,3))*dx(T,2)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,3)   0.0   -L2*cos(x(T,2))*sin(x(T,3))*dx(T,2)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,3)   L2*cos(x(T,2))*cos(x(T,3))*dx(T,2)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,3)   0.0   -L2*cos(x(T,2))*sin(x(T,3))*dx(T,2)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,3)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -(sqrt(3)*L1*cos(x(T,4))*dx(T,4))*0.5   -(L1*cos(x(T,4))*dx(T,4))*0.5   L1*sin(x(T,4))*dx(T,4)   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,5))*cos(x(T,6))*dx(T,6))*0.5-(sqrt(3)*L2*cos(x(T,5))*dx(T,5))*0.5-(L2*sin(x(T,5))*sin(x(T,6))*dx(T,5))*0.5   (sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,5))*0.5-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,6))*0.5-(L2*cos(x(T,5))*dx(T,5))*0.5   L2*cos(x(T,6))*sin(x(T,5))*dx(T,5)+L2*cos(x(T,5))*sin(x(T,6))*dx(T,6)   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,5))*cos(x(T,6))*dx(T,5))*0.5-(L2*sin(x(T,5))*sin(x(T,6))*dx(T,6))*0.5   (sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,6))*0.5-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,5))*0.5   L2*cos(x(T,5))*sin(x(T,6))*dx(T,5)+L2*cos(x(T,6))*sin(x(T,5))*dx(T,6)   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (sqrt(3)*L1*cos(x(T,7))*dx(T,7))*0.5   -(L1*cos(x(T,7))*dx(T,7))*0.5   L1*sin(x(T,7))*dx(T,7)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,8))*cos(x(T,9))*dx(T,9))*0.5+(sqrt(3)*L2*cos(x(T,8))*dx(T,8))*0.5-(L2*sin(x(T,8))*sin(x(T,9))*dx(T,8))*0.5   (sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,9))*0.5-(L2*cos(x(T,8))*dx(T,8))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,8))*0.5   L2*cos(x(T,9))*sin(x(T,8))*dx(T,8)+L2*cos(x(T,8))*sin(x(T,9))*dx(T,9)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,8))*cos(x(T,9))*dx(T,8))*0.5-(L2*sin(x(T,8))*sin(x(T,9))*dx(T,9))*0.5   (sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,8))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,9))*0.5   L2*cos(x(T,8))*sin(x(T,9))*dx(T,8)+L2*cos(x(T,9))*sin(x(T,8))*dx(T,9)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,2))*cos(x(T,3))*sin(x(T,1))*dx(T,1)-cos(x(T,2))*sin(x(T,1))*dx(T,2)-cos(x(T,1))*sin(x(T,2))*dx(T,1)+cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,2)+cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,3))   L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,1)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,3)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,2)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*cos(x(T,1))*dx(T,1)   L1*sin(x(T,1))*dx(T,1)   0.0   L1*cos(x(T,1))*dx(T,1)   L1*sin(x(T,1))*dx(T,1)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,2))*cos(x(T,3))*sin(x(T,1))*dx(T,1)-cos(x(T,2))*sin(x(T,1))*dx(T,2)-cos(x(T,1))*sin(x(T,2))*dx(T,1)+cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,2)+cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,3))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*sin(x(T,2))*sin(x(T,3))*dx(T,2)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,3)   L2*cos(x(T,2))*dx(T,2)   L2*cos(x(T,3))*sin(x(T,2))*dx(T,2)+L2*cos(x(T,2))*sin(x(T,3))*dx(T,3)   L2*sin(x(T,2))*sin(x(T,3))*dx(T,2)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,3)   L2*cos(x(T,2))*dx(T,2)   L2*cos(x(T,3))*sin(x(T,2))*dx(T,2)+L2*cos(x(T,2))*sin(x(T,3))*dx(T,3)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,1)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,3)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,2)*(L2*M3+LC2*M2)   0.0   2*cos(x(T,2))*sin(x(T,2))*dx(T,2)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   L2*sin(x(T,2))*sin(x(T,3))*dx(T,3)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,2)   0.0   L2*cos(x(T,2))*sin(x(T,3))*dx(T,2)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,3)   L2*sin(x(T,2))*sin(x(T,3))*dx(T,3)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,2)   0.0   L2*cos(x(T,2))*sin(x(T,3))*dx(T,2)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,3)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,5))*cos(x(T,6))*sin(x(T,4))*dx(T,4)-cos(x(T,5))*sin(x(T,4))*dx(T,5)-cos(x(T,4))*sin(x(T,5))*dx(T,4)+cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,5)+cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,6))   L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,4)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,6)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,5)*(L2*M3+LC2*M2)   0.0   0.0   0.0   (sqrt(3)*L1*cos(x(T,4))*dx(T,4))*0.5   (L1*cos(x(T,4))*dx(T,4))*0.5   -L1*sin(x(T,4))*dx(T,4)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,5))*cos(x(T,6))*sin(x(T,4))*dx(T,4)-cos(x(T,5))*sin(x(T,4))*dx(T,5)-cos(x(T,4))*sin(x(T,5))*dx(T,4)+cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,5)+cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,6))   0.0   0.0   0.0   0.0   0.0   (sqrt(3)*L2*cos(x(T,5))*dx(T,5))*0.5-(L2*cos(x(T,5))*cos(x(T,6))*dx(T,6))*0.5+(L2*sin(x(T,5))*sin(x(T,6))*dx(T,5))*0.5   (L2*cos(x(T,5))*dx(T,5))*0.5+(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,6))*0.5-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,5))*0.5   -L2*cos(x(T,6))*sin(x(T,5))*dx(T,5)-L2*cos(x(T,5))*sin(x(T,6))*dx(T,6)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,4)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,6)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,5)*(L2*M3+LC2*M2)   0.0   2*cos(x(T,5))*sin(x(T,5))*dx(T,5)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   (L2*sin(x(T,5))*sin(x(T,6))*dx(T,6))*0.5-(L2*cos(x(T,5))*cos(x(T,6))*dx(T,5))*0.5   (sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,5))*0.5-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,6))*0.5   -L2*cos(x(T,5))*sin(x(T,6))*dx(T,5)-L2*cos(x(T,6))*sin(x(T,5))*dx(T,6)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,8))*cos(x(T,9))*sin(x(T,7))*dx(T,7)-cos(x(T,8))*sin(x(T,7))*dx(T,8)-cos(x(T,7))*sin(x(T,8))*dx(T,7)+cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,8)+cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,9))   L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,7)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,9)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,8)*(L2*M3+LC2*M2)   0.0   0.0   0.0   -(sqrt(3)*L1*cos(x(T,7))*dx(T,7))*0.5   (L1*cos(x(T,7))*dx(T,7))*0.5   -L1*sin(x(T,7))*dx(T,7)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,8))*cos(x(T,9))*sin(x(T,7))*dx(T,7)-cos(x(T,8))*sin(x(T,7))*dx(T,8)-cos(x(T,7))*sin(x(T,8))*dx(T,7)+cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,8)+cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,9))   0.0   0.0   0.0   0.0   0.0   (L2*sin(x(T,8))*sin(x(T,9))*dx(T,8))*0.5-(sqrt(3)*L2*cos(x(T,8))*dx(T,8))*0.5-(L2*cos(x(T,8))*cos(x(T,9))*dx(T,9))*0.5   (L2*cos(x(T,8))*dx(T,8))*0.5-(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,9))*0.5+(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,8))*0.5   -L2*cos(x(T,9))*sin(x(T,8))*dx(T,8)-L2*cos(x(T,8))*sin(x(T,9))*dx(T,9)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,7)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,9)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,8)*(L2*M3+LC2*M2)   0.0   2*cos(x(T,8))*sin(x(T,8))*dx(T,8)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   (L2*sin(x(T,8))*sin(x(T,9))*dx(T,9))*0.5-(L2*cos(x(T,8))*cos(x(T,9))*dx(T,8))*0.5   (sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,9))*0.5-(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,8))*0.5   -L2*cos(x(T,8))*sin(x(T,9))*dx(T,8)-L2*cos(x(T,9))*sin(x(T,8))*dx(T,9)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0]
        # 3 is hard-coded value for nw. TODO: Maybe make disturbance model agnostic???
        FwT = vcat(zeros(9,3), [
            -2w(T)[1]   0.0     0.0
            0.0         0.0     0.0
            0.0         0.0     0.0
            0.0     -2w(T)[2]   0.0
            0.0         0.0     0.0
            0.0         0.0     -2w(T)[3]
            0.0         0.0     0.0
            0.0         0.0     0.0
            0.0         0.0     0.0
        ], zeros(15,3))
        FθT = [ 0.0	cos(x(T,1))*dx(T,27)+cos(x(T,1))*dx(T,30)-sin(x(T,1))*dx(T,26)-sin(x(T,1))*dx(T,29)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	cos(x(T,2))*cos(x(T,3))*dx(T,27)-sin(x(T,2))*dx(T,29)-sin(x(T,2))*dx(T,26)+cos(x(T,2))*cos(x(T,3))*dx(T,30)+cos(x(T,2))*sin(x(T,3))*dx(T,25)+cos(x(T,2))*sin(x(T,3))*dx(T,28)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	cos(x(T,3))*sin(x(T,2))*dx(T,25)+cos(x(T,3))*sin(x(T,2))*dx(T,28)-sin(x(T,2))*sin(x(T,3))*dx(T,27)-sin(x(T,2))*sin(x(T,3))*dx(T,30)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	-cos(x(T,4))*dx(T,27)-(sin(x(T,4))*dx(T,26))*0.5-(sqrt(3)*sin(x(T,4))*dx(T,25))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	dx(T,25)*((cos(x(T,5))*sin(x(T,6)))*0.5-(sqrt(3)*sin(x(T,5)))*0.5)-dx(T,26)*(sin(x(T,5))*0.5+(sqrt(3)*cos(x(T,5))*sin(x(T,6)))*0.5)-cos(x(T,5))*cos(x(T,6))*dx(T,27)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	(cos(x(T,6))*sin(x(T,5))*dx(T,25))*0.5+sin(x(T,5))*sin(x(T,6))*dx(T,27)-(sqrt(3)*cos(x(T,6))*sin(x(T,5))*dx(T,26))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	(sqrt(3)*sin(x(T,7))*dx(T,28))*0.5-(sin(x(T,7))*dx(T,29))*0.5-cos(x(T,7))*dx(T,30)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	dx(T,28)*((cos(x(T,8))*sin(x(T,9)))*0.5+(sqrt(3)*sin(x(T,8)))*0.5)-dx(T,29)*(sin(x(T,8))*0.5-(sqrt(3)*cos(x(T,8))*sin(x(T,9)))*0.5)-cos(x(T,8))*cos(x(T,9))*dx(T,30)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	(cos(x(T,9))*sin(x(T,8))*dx(T,28))*0.5+sin(x(T,8))*sin(x(T,9))*dx(T,30)+(sqrt(3)*cos(x(T,9))*sin(x(T,8))*dx(T,29))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	sin(x(T,1))*dx(T,20)-cos(x(T,1))*dx(T,24)-cos(x(T,1))*dx(T,21)+sin(x(T,1))*dx(T,23)-g*cos(x(T,1))*(M2+M3)+dx(T,11)*(L2*M3+LC2*M2)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))+2*L1*dx(T,10)*(M2+M3)+x(T,11)^2*(L2*M3+LC2*M2)*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,12)*(L2*M3+LC2*M2)-cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*x(T,12)^2*(L2*M3+LC2*M2)-2*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,11)*x(T,12)*(L2*M3+LC2*M2)	L1*M3*dx(T,11)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))+L1*M3*x(T,11)^2*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-L1*M3*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*x(T,12)^2-L1*M3*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,12)-2*L1*M3*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,11)*x(T,12)	0.0	2*LC1*M1*dx(T,10)-M1*g*cos(x(T,1))	L1*M2*dx(T,11)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))+L1*M2*x(T,11)^2*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-L1*M2*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*x(T,12)^2-L1*M2*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,12)-2*L1*M2*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,11)*x(T,12)	LC1^2*dx(T,10)-LC1*g*cos(x(T,1))	L1^2*dx(T,10)-L1*g*cos(x(T,1))+L1*LC2*dx(T,11)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))+L1*LC2*x(T,11)^2*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-L1*LC2*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*x(T,12)^2-L1*LC2*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,12)-2*L1*LC2*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,11)*x(T,12)	L1^2*dx(T,10)-L1*g*cos(x(T,1))+L1*L2*dx(T,11)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))+L1*L2*x(T,11)^2*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-L1*L2*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*x(T,12)^2-L1*L2*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,12)-2*L1*L2*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,11)*x(T,12)	dx(T,10)	0.0	x(T,10)
                0.0	dx(T,10)*(L2*M3+LC2*M2)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))+x(T,10)^2*(L2*M3+LC2*M2)*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))	sin(x(T,2))*dx(T,20)+sin(x(T,2))*dx(T,23)-cos(x(T,2))*cos(x(T,3))*dx(T,21)-cos(x(T,2))*cos(x(T,3))*dx(T,24)+2*L2*M3*dx(T,11)-cos(x(T,2))*sin(x(T,3))*dx(T,19)-cos(x(T,2))*sin(x(T,3))*dx(T,22)+L1*M3*dx(T,10)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))-M3*g*cos(x(T,2))*cos(x(T,3))+L1*M3*x(T,10)^2*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))-2*L2*M3*cos(x(T,2))*sin(x(T,2))*x(T,12)^2	0.0	0.0	2*LC2*M2*dx(T,11)+L1*M2*dx(T,10)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))-M2*g*cos(x(T,2))*cos(x(T,3))+L1*M2*x(T,10)^2*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))-2*LC2*M2*cos(x(T,2))*sin(x(T,2))*x(T,12)^2	0.0	LC2^2*dx(T,11)+L1*LC2*dx(T,10)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))-LC2*g*cos(x(T,2))*cos(x(T,3))+L1*LC2*x(T,10)^2*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))-LC2^2*cos(x(T,2))*sin(x(T,2))*x(T,12)^2	L2^2*dx(T,11)+L1*L2*dx(T,10)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))-L2*g*cos(x(T,2))*cos(x(T,3))+L1*L2*x(T,10)^2*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))-L2^2*cos(x(T,2))*sin(x(T,2))*x(T,12)^2	0.0	dx(T,11)-cos(x(T,2))*sin(x(T,2))*x(T,12)^2	x(T,11)
                0.0	sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)^2*(L2*M3+LC2*M2)-cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,10)*(L2*M3+LC2*M2)	sin(x(T,2))*sin(x(T,3))*dx(T,21)-cos(x(T,3))*sin(x(T,2))*dx(T,22)-cos(x(T,3))*sin(x(T,2))*dx(T,19)+sin(x(T,2))*sin(x(T,3))*dx(T,24)+2*L2*M3*sin(x(T,2))^2*dx(T,12)+M3*g*sin(x(T,2))*sin(x(T,3))+2*L2*M3*sin(2*x(T,2))*x(T,11)*x(T,12)+L1*M3*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)^2-L1*M3*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,10)	0.0	0.0	2*LC2*M2*sin(x(T,2))^2*dx(T,12)+M2*g*sin(x(T,2))*sin(x(T,3))+2*LC2*M2*sin(2*x(T,2))*x(T,11)*x(T,12)+L1*M2*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)^2-L1*M2*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,10)	0.0	LC2^2*sin(x(T,2))^2*dx(T,12)+LC2^2*sin(2*x(T,2))*x(T,11)*x(T,12)+LC2*g*sin(x(T,2))*sin(x(T,3))+L1*LC2*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)^2-L1*LC2*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,10)	L2^2*sin(x(T,2))^2*dx(T,12)+L2^2*sin(2*x(T,2))*x(T,11)*x(T,12)+L2*g*sin(x(T,2))*sin(x(T,3))+L1*L2*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)^2-L1*L2*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,10)	0.0	sin(x(T,2))^2*dx(T,12)+sin(2*x(T,2))*x(T,11)*x(T,12)	x(T,12)
                0.0	cos(x(T,4))*dx(T,21)+(sin(x(T,4))*dx(T,20))*0.5-g*cos(x(T,4))*(M2+M3)+dx(T,14)*(L2*M3+LC2*M2)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))+2*L1*dx(T,13)*(M2+M3)+x(T,14)^2*(L2*M3+LC2*M2)*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))+(sqrt(3)*sin(x(T,4))*dx(T,19))*0.5-cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,15)*(L2*M3+LC2*M2)-cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*x(T,15)^2*(L2*M3+LC2*M2)-2*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,14)*x(T,15)*(L2*M3+LC2*M2)	L1*M3*dx(T,14)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))+L1*M3*x(T,14)^2*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-L1*M3*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*x(T,15)^2-L1*M3*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,15)-2*L1*M3*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,14)*x(T,15)	0.0	2*LC1*M1*dx(T,13)-M1*g*cos(x(T,4))	L1*M2*dx(T,14)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))+L1*M2*x(T,14)^2*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-L1*M2*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*x(T,15)^2-L1*M2*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,15)-2*L1*M2*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,14)*x(T,15)	LC1^2*dx(T,13)-LC1*g*cos(x(T,4))	L1^2*dx(T,13)-L1*g*cos(x(T,4))+L1*LC2*dx(T,14)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))+L1*LC2*x(T,14)^2*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-L1*LC2*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*x(T,15)^2-L1*LC2*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,15)-2*L1*LC2*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,14)*x(T,15)	L1^2*dx(T,13)-L1*g*cos(x(T,4))+L1*L2*dx(T,14)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))+L1*L2*x(T,14)^2*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-L1*L2*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*x(T,15)^2-L1*L2*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,15)-2*L1*L2*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,14)*x(T,15)	dx(T,13)	0.0	x(T,13)
                0.0	dx(T,13)*(L2*M3+LC2*M2)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))+x(T,13)^2*(L2*M3+LC2*M2)*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))	dx(T,20)*(sin(x(T,5))*0.5+(sqrt(3)*cos(x(T,5))*sin(x(T,6)))*0.5)-dx(T,19)*((cos(x(T,5))*sin(x(T,6)))*0.5-(sqrt(3)*sin(x(T,5)))*0.5)+cos(x(T,5))*cos(x(T,6))*dx(T,21)+2*L2*M3*dx(T,14)+L1*M3*dx(T,13)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))-M3*g*cos(x(T,5))*cos(x(T,6))+L1*M3*x(T,13)^2*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))-2*L2*M3*cos(x(T,5))*sin(x(T,5))*x(T,15)^2	0.0	0.0	2*LC2*M2*dx(T,14)+L1*M2*dx(T,13)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))-M2*g*cos(x(T,5))*cos(x(T,6))+L1*M2*x(T,13)^2*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))-2*LC2*M2*cos(x(T,5))*sin(x(T,5))*x(T,15)^2	0.0	LC2^2*dx(T,14)+L1*LC2*dx(T,13)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))-LC2*g*cos(x(T,5))*cos(x(T,6))+L1*LC2*x(T,13)^2*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))-LC2^2*cos(x(T,5))*sin(x(T,5))*x(T,15)^2	L2^2*dx(T,14)+L1*L2*dx(T,13)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))-L2*g*cos(x(T,5))*cos(x(T,6))+L1*L2*x(T,13)^2*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))-L2^2*cos(x(T,5))*sin(x(T,5))*x(T,15)^2	0.0	dx(T,14)-cos(x(T,5))*sin(x(T,5))*x(T,15)^2	x(T,14)
                0.0	sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)^2*(L2*M3+LC2*M2)-cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,13)*(L2*M3+LC2*M2)	(sqrt(3)*cos(x(T,6))*sin(x(T,5))*dx(T,20))*0.5-sin(x(T,5))*sin(x(T,6))*dx(T,21)-(cos(x(T,6))*sin(x(T,5))*dx(T,19))*0.5+2*L2*M3*sin(x(T,5))^2*dx(T,15)+M3*g*sin(x(T,5))*sin(x(T,6))+2*L2*M3*sin(2*x(T,5))*x(T,14)*x(T,15)+L1*M3*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)^2-L1*M3*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,13)	0.0	0.0	2*LC2*M2*sin(x(T,5))^2*dx(T,15)+M2*g*sin(x(T,5))*sin(x(T,6))+2*LC2*M2*sin(2*x(T,5))*x(T,14)*x(T,15)+L1*M2*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)^2-L1*M2*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,13)	0.0	LC2^2*sin(x(T,5))^2*dx(T,15)+LC2^2*sin(2*x(T,5))*x(T,14)*x(T,15)+LC2*g*sin(x(T,5))*sin(x(T,6))+L1*LC2*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)^2-L1*LC2*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,13)	L2^2*sin(x(T,5))^2*dx(T,15)+L2^2*sin(2*x(T,5))*x(T,14)*x(T,15)+L2*g*sin(x(T,5))*sin(x(T,6))+L1*L2*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)^2-L1*L2*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,13)	0.0	sin(x(T,5))^2*dx(T,15)+sin(2*x(T,5))*x(T,14)*x(T,15)	x(T,15)
                0.0	cos(x(T,7))*dx(T,24)+(sin(x(T,7))*dx(T,23))*0.5-g*cos(x(T,7))*(M2+M3)+dx(T,17)*(L2*M3+LC2*M2)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))+2*L1*dx(T,16)*(M2+M3)+x(T,17)^2*(L2*M3+LC2*M2)*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-(sqrt(3)*sin(x(T,7))*dx(T,22))*0.5-cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,18)*(L2*M3+LC2*M2)-cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*x(T,18)^2*(L2*M3+LC2*M2)-2*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,17)*x(T,18)*(L2*M3+LC2*M2)	L1*M3*dx(T,17)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))+L1*M3*x(T,17)^2*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-L1*M3*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*x(T,18)^2-L1*M3*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,18)-2*L1*M3*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,17)*x(T,18)	0.0	2*LC1*M1*dx(T,16)-M1*g*cos(x(T,7))	L1*M2*dx(T,17)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))+L1*M2*x(T,17)^2*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-L1*M2*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*x(T,18)^2-L1*M2*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,18)-2*L1*M2*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,17)*x(T,18)	LC1^2*dx(T,16)-LC1*g*cos(x(T,7))	L1^2*dx(T,16)-L1*g*cos(x(T,7))+L1*LC2*dx(T,17)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))+L1*LC2*x(T,17)^2*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-L1*LC2*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*x(T,18)^2-L1*LC2*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,18)-2*L1*LC2*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,17)*x(T,18)	L1^2*dx(T,16)-L1*g*cos(x(T,7))+L1*L2*dx(T,17)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))+L1*L2*x(T,17)^2*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-L1*L2*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*x(T,18)^2-L1*L2*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,18)-2*L1*L2*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,17)*x(T,18)	dx(T,16)	0.0	x(T,16)
                0.0	dx(T,16)*(L2*M3+LC2*M2)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))+x(T,16)^2*(L2*M3+LC2*M2)*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))	dx(T,23)*(sin(x(T,8))*0.5-(sqrt(3)*cos(x(T,8))*sin(x(T,9)))*0.5)-dx(T,22)*((cos(x(T,8))*sin(x(T,9)))*0.5+(sqrt(3)*sin(x(T,8)))*0.5)+cos(x(T,8))*cos(x(T,9))*dx(T,24)+2*L2*M3*dx(T,17)+L1*M3*dx(T,16)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))-M3*g*cos(x(T,8))*cos(x(T,9))+L1*M3*x(T,16)^2*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))-2*L2*M3*cos(x(T,8))*sin(x(T,8))*x(T,18)^2	0.0	0.0	2*LC2*M2*dx(T,17)+L1*M2*dx(T,16)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))-M2*g*cos(x(T,8))*cos(x(T,9))+L1*M2*x(T,16)^2*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))-2*LC2*M2*cos(x(T,8))*sin(x(T,8))*x(T,18)^2	0.0	LC2^2*dx(T,17)+L1*LC2*dx(T,16)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))-LC2*g*cos(x(T,8))*cos(x(T,9))+L1*LC2*x(T,16)^2*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))-LC2^2*cos(x(T,8))*sin(x(T,8))*x(T,18)^2	L2^2*dx(T,17)+L1*L2*dx(T,16)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))-L2*g*cos(x(T,8))*cos(x(T,9))+L1*L2*x(T,16)^2*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))-L2^2*cos(x(T,8))*sin(x(T,8))*x(T,18)^2	0.0	dx(T,17)-cos(x(T,8))*sin(x(T,8))*x(T,18)^2	x(T,17)
                0.0	sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)^2*(L2*M3+LC2*M2)-cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,16)*(L2*M3+LC2*M2)	2*L2*M3*sin(x(T,8))^2*dx(T,18)-sin(x(T,8))*sin(x(T,9))*dx(T,24)-(sqrt(3)*cos(x(T,9))*sin(x(T,8))*dx(T,23))*0.5-(cos(x(T,9))*sin(x(T,8))*dx(T,22))*0.5+M3*g*sin(x(T,8))*sin(x(T,9))+2*L2*M3*sin(2*x(T,8))*x(T,17)*x(T,18)+L1*M3*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)^2-L1*M3*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,16)	0.0	0.0	2*LC2*M2*sin(x(T,8))^2*dx(T,18)+M2*g*sin(x(T,8))*sin(x(T,9))+2*LC2*M2*sin(2*x(T,8))*x(T,17)*x(T,18)+L1*M2*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)^2-L1*M2*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,16)	0.0	LC2^2*sin(x(T,8))^2*dx(T,18)+LC2^2*sin(2*x(T,8))*x(T,17)*x(T,18)+LC2*g*sin(x(T,8))*sin(x(T,9))+L1*LC2*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)^2-L1*LC2*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,16)	L2^2*sin(x(T,8))^2*dx(T,18)+L2^2*sin(2*x(T,8))*x(T,17)*x(T,18)+L2*g*sin(x(T,8))*sin(x(T,9))+L1*L2*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)^2-L1*L2*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,16)	0.0	sin(x(T,8))^2*dx(T,18)+sin(2*x(T,8))*x(T,17)*x(T,18)	x(T,18)
                sqrt(3)*0.5	(sqrt(3)*cos(x(T,4)))*0.5	(sqrt(3)*cos(x(T,5)))*0.5+sin(x(T,2))*sin(x(T,3))+(sin(x(T,5))*sin(x(T,6)))*0.5	-sqrt(3)*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                3*0.5	cos(x(T,1))+cos(x(T,4))*0.5	cos(x(T,2))+cos(x(T,5))*0.5-(sqrt(3)*sin(x(T,5))*sin(x(T,6)))*0.5	-1.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	sin(x(T,1))-sin(x(T,4))	cos(x(T,3))*sin(x(T,2))-cos(x(T,6))*sin(x(T,5))	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                -sqrt(3)*0.5	-(sqrt(3)*cos(x(T,7)))*0.5	sin(x(T,2))*sin(x(T,3))-(sqrt(3)*cos(x(T,8)))*0.5+(sin(x(T,8))*sin(x(T,9)))*0.5	sqrt(3)*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                3*0.5	cos(x(T,1))+cos(x(T,7))*0.5	cos(x(T,2))+cos(x(T,8))*0.5+(sqrt(3)*sin(x(T,8))*sin(x(T,9)))*0.5	-1.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	sin(x(T,1))-sin(x(T,7))	cos(x(T,3))*sin(x(T,2))-cos(x(T,9))*sin(x(T,8))	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	-(sqrt(3)*sin(x(T,4))*x(T,13))*0.5	cos(x(T,2))*sin(x(T,3))*x(T,11)-(sqrt(3)*sin(x(T,5))*x(T,14))*0.5+cos(x(T,3))*sin(x(T,2))*x(T,12)+(cos(x(T,5))*sin(x(T,6))*x(T,14))*0.5+(cos(x(T,6))*sin(x(T,5))*x(T,15))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	-sin(x(T,1))*x(T,10)-(sin(x(T,4))*x(T,13))*0.5	-sin(x(T,2))*x(T,11)-(sin(x(T,5))*x(T,14))*0.5-(sqrt(3)*cos(x(T,5))*sin(x(T,6))*x(T,14))*0.5-(sqrt(3)*cos(x(T,6))*sin(x(T,5))*x(T,15))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	cos(x(T,1))*x(T,10)-cos(x(T,4))*x(T,13)	cos(x(T,2))*cos(x(T,3))*x(T,11)-cos(x(T,5))*cos(x(T,6))*x(T,14)-sin(x(T,2))*sin(x(T,3))*x(T,12)+sin(x(T,5))*sin(x(T,6))*x(T,15)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	(sqrt(3)*sin(x(T,7))*x(T,16))*0.5	(sqrt(3)*sin(x(T,8))*x(T,17))*0.5+cos(x(T,2))*sin(x(T,3))*x(T,11)+cos(x(T,3))*sin(x(T,2))*x(T,12)+(cos(x(T,8))*sin(x(T,9))*x(T,17))*0.5+(cos(x(T,9))*sin(x(T,8))*x(T,18))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	-sin(x(T,1))*x(T,10)-(sin(x(T,7))*x(T,16))*0.5	(sqrt(3)*cos(x(T,8))*sin(x(T,9))*x(T,17))*0.5-(sin(x(T,8))*x(T,17))*0.5-sin(x(T,2))*x(T,11)+(sqrt(3)*cos(x(T,9))*sin(x(T,8))*x(T,18))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	cos(x(T,1))*x(T,10)-cos(x(T,7))*x(T,16)	cos(x(T,2))*cos(x(T,3))*x(T,11)-cos(x(T,8))*cos(x(T,9))*x(T,17)-sin(x(T,2))*sin(x(T,3))*x(T,12)+sin(x(T,8))*sin(x(T,9))*x(T,18)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	-sin(x(T,2))*sin(x(T,3))	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                -1.0	-cos(x(T,1))	-cos(x(T,2))	1.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	-sin(x(T,1))	-cos(x(T,3))*sin(x(T,2))	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0]
        gₓT = [0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -2(y(T,1)-x2(T,31))/T   -2(y(T,2)-x2(T,32))/T   -2(y(T,3)-x2(T,33))/T]
        dgₓT = [0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -2(dy(T,1)-dx2(T,31))/T   -2(dy(T,2)-dx2(T,32))/T   -2(dy(T,3)-dx2(T,33))/T]

        # The residual function
        function f!(res, dz, z, _, t)
            xt = x(t,1:33)
            dxt = dx(t,1:33)
            yt = y(t,1:3)
            # ---------- Adjoint system ----------
            # 0 = dλᵀ Fdx + λᵀ(dFdx - Fx) + gₓ                      # Analytical adjoint system
            # 0 = (dz')*Fdx(t) + (z')*(dFdx(t) - Fx(t)) + gₓ(t)     # Matrix form adjoint system
            # Expanded adjoint system residual equations:
            res[1] = dz[1]-z[11]*(L1*dxt[10]*(L2*M3+LC2*M2)*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))-L1*xt[10]^2*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3])))-z[10]*(0.0*sin(xt[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(xt[1])*dxt[20]+L1*cos(xt[1])*dxt[23]+L1*sin(xt[1])*dxt[21]+L1*sin(xt[1])*dxt[24]+L1*dxt[11]*(L2*M3+LC2*M2)*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))+L1*xt[11]^2*(L2*M3+LC2*M2)*(cos(xt[1])*cos(xt[2])+cos(xt[3])*sin(xt[1])*sin(xt[2]))+L1*cos(xt[3])*sin(xt[1])*sin(xt[2])*xt[12]^2*(L2*M3+LC2*M2)+L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*dxt[12]*(L2*M3+LC2*M2)+2*L1*cos(xt[2])*sin(xt[1])*sin(xt[3])*xt[11]*xt[12]*(L2*M3+LC2*M2))-z[12]*(L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]^2*(L2*M3+LC2*M2)+L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*dxt[10]*(L2*M3+LC2*M2))+z[1]*(L1*cos(xt[1])*dxt[26]+L1*cos(xt[1])*dxt[29]+L1*sin(xt[1])*dxt[27]+L1*sin(xt[1])*dxt[30])-L1*cos(xt[1])*z[21]-L1*cos(xt[1])*z[24]+L1*cos(xt[1])*z[33]+L1*sin(xt[1])*z[20]+L1*sin(xt[1])*z[23]-L1*sin(xt[1])*z[32]+L1*cos(xt[1])*z[26]*xt[10]+L1*cos(xt[1])*z[29]*xt[10]+L1*sin(xt[1])*z[27]*xt[10]+L1*sin(xt[1])*z[30]*xt[10]
            res[2] = dz[2]-z[25]*(L2*cos(xt[2])*cos(xt[3])*xt[12]-L2*sin(xt[2])*sin(xt[3])*xt[11])+z[27]*(L2*cos(xt[3])*sin(xt[2])*xt[11]+L2*cos(xt[2])*sin(xt[3])*xt[12])-z[28]*(L2*cos(xt[2])*cos(xt[3])*xt[12]-L2*sin(xt[2])*sin(xt[3])*xt[11])+z[30]*(L2*cos(xt[3])*sin(xt[2])*xt[11]+L2*cos(xt[2])*sin(xt[3])*xt[12])-z[3]*(L2*cos(xt[2])*cos(xt[3])*dxt[25]+L2*cos(xt[2])*cos(xt[3])*dxt[28]-L2*cos(xt[2])*sin(xt[3])*dxt[27]-L2*cos(xt[2])*sin(xt[3])*dxt[30])-z[12]*(L2*cos(xt[2])*sin(xt[3])*dxt[21]-L2*cos(xt[2])*cos(xt[3])*dxt[22]-L2*cos(xt[2])*cos(xt[3])*dxt[19]+L2*cos(xt[2])*sin(xt[3])*dxt[24]+2*cos(xt[2])*sin(xt[2])*dxt[12]*(J2+L2^2*M3+LC2^2*M2)+2*cos(2*xt[2])*xt[11]*xt[12]*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(xt[2])*sin(xt[3])*(L2*M3+LC2*M2)+L1*cos(xt[2])*sin(xt[1])*sin(xt[3])*xt[10]^2*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[10]*(L2*M3+LC2*M2))-z[11]*(sin(xt[2])^2*xt[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(xt[2])^2*xt[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(xt[2])*dxt[20]+L2*cos(xt[2])*dxt[23]+L2*cos(xt[3])*sin(xt[2])*dxt[21]+L2*cos(xt[3])*sin(xt[2])*dxt[24]+L2*sin(xt[2])*sin(xt[3])*dxt[19]+L2*sin(xt[2])*sin(xt[3])*dxt[22]+L1*dxt[10]*(L2*M3+LC2*M2)*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))+0.0*cos(xt[3])*sin(xt[2])*(L2*M3+LC2*M2)+L1*xt[10]^2*(L2*M3+LC2*M2)*(cos(xt[1])*cos(xt[2])+cos(xt[3])*sin(xt[1])*sin(xt[2])))+z[10]*(L1*xt[11]^2*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-L1*dxt[11]*(L2*M3+LC2*M2)*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))+L1*cos(xt[1])*cos(xt[2])*cos(xt[3])*xt[12]^2*(L2*M3+LC2*M2)+L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[12]*(L2*M3+LC2*M2)-2*L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*xt[11]*xt[12]*(L2*M3+LC2*M2))+z[2]*(L2*cos(xt[2])*dxt[26]+L2*cos(xt[2])*dxt[29]+L2*cos(xt[3])*sin(xt[2])*dxt[27]+L2*cos(xt[3])*sin(xt[2])*dxt[30]+L2*sin(xt[2])*sin(xt[3])*dxt[25]+L2*sin(xt[2])*sin(xt[3])*dxt[28])+L2*sin(xt[2])*z[20]+L2*sin(xt[2])*z[23]-L2*sin(xt[2])*z[32]-L2*cos(xt[2])*cos(xt[3])*z[21]-L2*cos(xt[2])*cos(xt[3])*z[24]+L2*cos(xt[2])*cos(xt[3])*z[33]-L2*cos(xt[2])*sin(xt[3])*z[19]-L2*cos(xt[2])*sin(xt[3])*z[22]+L2*cos(xt[2])*sin(xt[3])*z[31]+L2*cos(xt[2])*z[26]*xt[11]+L2*cos(xt[2])*z[29]*xt[11]
            res[3] = dz[3]-z[12]*(L2*cos(xt[3])*sin(xt[2])*dxt[21]+L2*cos(xt[3])*sin(xt[2])*dxt[24]+L2*sin(xt[2])*sin(xt[3])*dxt[19]+L2*sin(xt[2])*sin(xt[3])*dxt[22]+0.0*cos(xt[3])*sin(xt[2])*(L2*M3+LC2*M2)+L1*cos(xt[3])*sin(xt[1])*sin(xt[2])*xt[10]^2*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[10]*(L2*M3+LC2*M2))-z[25]*(L2*cos(xt[2])*cos(xt[3])*xt[11]-L2*sin(xt[2])*sin(xt[3])*xt[12])+z[27]*(L2*cos(xt[2])*sin(xt[3])*xt[11]+L2*cos(xt[3])*sin(xt[2])*xt[12])-z[28]*(L2*cos(xt[2])*cos(xt[3])*xt[11]-L2*sin(xt[2])*sin(xt[3])*xt[12])+z[30]*(L2*cos(xt[2])*sin(xt[3])*xt[11]+L2*cos(xt[3])*sin(xt[2])*xt[12])-z[2]*(L2*cos(xt[2])*cos(xt[3])*dxt[25]+L2*cos(xt[2])*cos(xt[3])*dxt[28]-L2*cos(xt[2])*sin(xt[3])*dxt[27]-L2*cos(xt[2])*sin(xt[3])*dxt[30])+z[10]*(L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[11]*(L2*M3+LC2*M2)-L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*xt[12]^2*(L2*M3+LC2*M2)-L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*xt[11]^2*(L2*M3+LC2*M2)+L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[12]*(L2*M3+LC2*M2)+2*L1*cos(xt[1])*cos(xt[2])*cos(xt[3])*xt[11]*xt[12]*(L2*M3+LC2*M2))+z[3]*(L2*cos(xt[3])*sin(xt[2])*dxt[27]+L2*cos(xt[3])*sin(xt[2])*dxt[30]+L2*sin(xt[2])*sin(xt[3])*dxt[25]+L2*sin(xt[2])*sin(xt[3])*dxt[28])-z[11]*(L2*cos(xt[2])*sin(xt[3])*dxt[21]-L2*cos(xt[2])*cos(xt[3])*dxt[22]-L2*cos(xt[2])*cos(xt[3])*dxt[19]+L2*cos(xt[2])*sin(xt[3])*dxt[24]+0.0*cos(xt[2])*sin(xt[3])*(L2*M3+LC2*M2)+L1*cos(xt[2])*sin(xt[1])*sin(xt[3])*xt[10]^2*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[10]*(L2*M3+LC2*M2))-L2*cos(xt[3])*sin(xt[2])*z[19]-L2*cos(xt[3])*sin(xt[2])*z[22]+L2*cos(xt[3])*sin(xt[2])*z[31]+L2*sin(xt[2])*sin(xt[3])*z[21]+L2*sin(xt[2])*sin(xt[3])*z[24]-L2*sin(xt[2])*sin(xt[3])*z[33]
            res[4] = dz[4]-z[14]*(L1*dxt[13]*(L2*M3+LC2*M2)*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))-L1*xt[13]^2*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6])))+z[4]*((L1*cos(xt[4])*dxt[26])*0.5-L1*sin(xt[4])*dxt[27]+(sqrt(3)*L1*cos(xt[4])*dxt[25])*0.5)-z[15]*(L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]^2*(L2*M3+LC2*M2)+L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*dxt[13]*(L2*M3+LC2*M2))-z[13]*(0.0*sin(xt[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(xt[4])*dxt[20])*0.5-L1*sin(xt[4])*dxt[21]+(sqrt(3)*L1*cos(xt[4])*dxt[19])*0.5+L1*dxt[14]*(L2*M3+LC2*M2)*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))+L1*xt[14]^2*(L2*M3+LC2*M2)*(cos(xt[4])*cos(xt[5])+cos(xt[6])*sin(xt[4])*sin(xt[5]))+L1*cos(xt[6])*sin(xt[4])*sin(xt[5])*xt[15]^2*(L2*M3+LC2*M2)+L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*dxt[15]*(L2*M3+LC2*M2)+2*L1*cos(xt[5])*sin(xt[4])*sin(xt[6])*xt[14]*xt[15]*(L2*M3+LC2*M2))+L1*cos(xt[4])*z[21]+(L1*sin(xt[4])*z[20])*0.5+(sqrt(3)*L1*sin(xt[4])*z[19])*0.5+(L1*cos(xt[4])*z[26]*xt[13])*0.5-L1*sin(xt[4])*z[27]*xt[13]+(sqrt(3)*L1*cos(xt[4])*z[25]*xt[13])*0.5
            res[5] = dz[5]-z[27]*(L2*cos(xt[6])*sin(xt[5])*xt[14]+L2*cos(xt[5])*sin(xt[6])*xt[15])+z[25]*((sqrt(3)*L2*cos(xt[5])*xt[14])*0.5-(L2*cos(xt[5])*cos(xt[6])*xt[15])*0.5+(L2*sin(xt[5])*sin(xt[6])*xt[14])*0.5)-z[6]*((L2*cos(xt[5])*cos(xt[6])*dxt[25])*0.5+L2*cos(xt[5])*sin(xt[6])*dxt[27]-(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[26])*0.5)-z[19]*((L2*cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*L2*sin(xt[5]))*0.5)+z[20]*((L2*sin(xt[5]))*0.5+(sqrt(3)*L2*cos(xt[5])*sin(xt[6]))*0.5)+z[5]*(dxt[25]*((sqrt(3)*L2*cos(xt[5]))*0.5+(L2*sin(xt[5])*sin(xt[6]))*0.5)+dxt[26]*((L2*cos(xt[5]))*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6]))*0.5)-L2*cos(xt[6])*sin(xt[5])*dxt[27])-z[15]*(2*cos(xt[5])*sin(xt[5])*dxt[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(xt[5])*sin(xt[6])*dxt[21]-(L2*cos(xt[5])*cos(xt[6])*dxt[19])*0.5+2*cos(2*xt[5])*xt[14]*xt[15]*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(xt[5])*sin(xt[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[20])*0.5+L1*cos(xt[5])*sin(xt[4])*sin(xt[6])*xt[13]^2*(L2*M3+LC2*M2)-L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[13]*(L2*M3+LC2*M2))+z[26]*((L2*cos(xt[5])*xt[14])*0.5+(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*xt[15])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*xt[14])*0.5)+z[13]*(L1*xt[14]^2*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-L1*dxt[14]*(L2*M3+LC2*M2)*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))+L1*cos(xt[4])*cos(xt[5])*cos(xt[6])*xt[15]^2*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[15]*(L2*M3+LC2*M2)-2*L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*xt[14]*xt[15]*(L2*M3+LC2*M2))-z[14]*(dxt[19]*((sqrt(3)*L2*cos(xt[5]))*0.5+(L2*sin(xt[5])*sin(xt[6]))*0.5)+dxt[20]*((L2*cos(xt[5]))*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6]))*0.5)-cos(xt[5])^2*xt[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(xt[5])^2*xt[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(xt[6])*sin(xt[5])*dxt[21]+L1*dxt[13]*(L2*M3+LC2*M2)*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))+0.0*cos(xt[6])*sin(xt[5])*(L2*M3+LC2*M2)+L1*xt[13]^2*(L2*M3+LC2*M2)*(cos(xt[4])*cos(xt[5])+cos(xt[6])*sin(xt[4])*sin(xt[5])))+L2*cos(xt[5])*cos(xt[6])*z[21]
            res[6] = dz[6]+z[14]*((L2*cos(xt[5])*cos(xt[6])*dxt[19])*0.5+L2*cos(xt[5])*sin(xt[6])*dxt[21]-0.0*cos(xt[5])*sin(xt[6])*(L2*M3+LC2*M2)-(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[20])*0.5-L1*cos(xt[5])*sin(xt[4])*sin(xt[6])*xt[13]^2*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[13]*(L2*M3+LC2*M2))-z[27]*(L2*cos(xt[5])*sin(xt[6])*xt[14]+L2*cos(xt[6])*sin(xt[5])*xt[15])-z[25]*((L2*cos(xt[5])*cos(xt[6])*xt[14])*0.5-(L2*sin(xt[5])*sin(xt[6])*xt[15])*0.5)+z[15]*(L2*cos(xt[6])*sin(xt[5])*dxt[21]-(L2*sin(xt[5])*sin(xt[6])*dxt[19])*0.5-0.0*cos(xt[6])*sin(xt[5])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[20])*0.5-L1*cos(xt[6])*sin(xt[4])*sin(xt[5])*xt[13]^2*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[13]*(L2*M3+LC2*M2))+z[13]*(L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[14]*(L2*M3+LC2*M2)-L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*xt[15]^2*(L2*M3+LC2*M2)-L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*xt[14]^2*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[15]*(L2*M3+LC2*M2)+2*L1*cos(xt[4])*cos(xt[5])*cos(xt[6])*xt[14]*xt[15]*(L2*M3+LC2*M2))-z[5]*((L2*cos(xt[5])*cos(xt[6])*dxt[25])*0.5+L2*cos(xt[5])*sin(xt[6])*dxt[27]-(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[26])*0.5)-z[6]*(L2*cos(xt[6])*sin(xt[5])*dxt[27]-(L2*sin(xt[5])*sin(xt[6])*dxt[25])*0.5+(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[26])*0.5)+z[26]*((sqrt(3)*L2*cos(xt[5])*cos(xt[6])*xt[14])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*xt[15])*0.5)-(L2*cos(xt[6])*sin(xt[5])*z[19])*0.5-L2*sin(xt[5])*sin(xt[6])*z[21]+(sqrt(3)*L2*cos(xt[6])*sin(xt[5])*z[20])*0.5
            res[7] = dz[7]-z[17]*(L1*dxt[16]*(L2*M3+LC2*M2)*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))-L1*xt[16]^2*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9])))-z[7]*(L1*sin(xt[7])*dxt[30]-(L1*cos(xt[7])*dxt[29])*0.5+(sqrt(3)*L1*cos(xt[7])*dxt[28])*0.5)-z[18]*(L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]^2*(L2*M3+LC2*M2)+L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*dxt[16]*(L2*M3+LC2*M2))-z[16]*(0.0*sin(xt[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(xt[7])*dxt[23])*0.5-L1*sin(xt[7])*dxt[24]-(sqrt(3)*L1*cos(xt[7])*dxt[22])*0.5+L1*dxt[17]*(L2*M3+LC2*M2)*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))+L1*xt[17]^2*(L2*M3+LC2*M2)*(cos(xt[7])*cos(xt[8])+cos(xt[9])*sin(xt[7])*sin(xt[8]))+L1*cos(xt[9])*sin(xt[7])*sin(xt[8])*xt[18]^2*(L2*M3+LC2*M2)+L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*dxt[18]*(L2*M3+LC2*M2)+2*L1*cos(xt[8])*sin(xt[7])*sin(xt[9])*xt[17]*xt[18]*(L2*M3+LC2*M2))+L1*cos(xt[7])*z[24]+(L1*sin(xt[7])*z[23])*0.5-(sqrt(3)*L1*sin(xt[7])*z[22])*0.5+(L1*cos(xt[7])*z[29]*xt[16])*0.5-L1*sin(xt[7])*z[30]*xt[16]-(sqrt(3)*L1*cos(xt[7])*z[28]*xt[16])*0.5
            res[8] = dz[8]-z[30]*(L2*cos(xt[9])*sin(xt[8])*xt[17]+L2*cos(xt[8])*sin(xt[9])*xt[18])-z[28]*((L2*cos(xt[8])*cos(xt[9])*xt[18])*0.5+(sqrt(3)*L2*cos(xt[8])*xt[17])*0.5-(L2*sin(xt[8])*sin(xt[9])*xt[17])*0.5)-z[9]*((L2*cos(xt[8])*cos(xt[9])*dxt[28])*0.5+L2*cos(xt[8])*sin(xt[9])*dxt[30]+(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[29])*0.5)-z[22]*((L2*cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*L2*sin(xt[8]))*0.5)+z[23]*((L2*sin(xt[8]))*0.5-(sqrt(3)*L2*cos(xt[8])*sin(xt[9]))*0.5)-z[8]*(dxt[28]*((sqrt(3)*L2*cos(xt[8]))*0.5-(L2*sin(xt[8])*sin(xt[9]))*0.5)-dxt[29]*((L2*cos(xt[8]))*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9]))*0.5)+L2*cos(xt[9])*sin(xt[8])*dxt[30])+z[18]*((L2*cos(xt[8])*cos(xt[9])*dxt[22])*0.5+L2*cos(xt[8])*sin(xt[9])*dxt[24]-2*cos(xt[8])*sin(xt[8])*dxt[18]*(J2+L2^2*M3+LC2^2*M2)-2*cos(2*xt[8])*xt[17]*xt[18]*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(xt[8])*sin(xt[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[23])*0.5-L1*cos(xt[8])*sin(xt[7])*sin(xt[9])*xt[16]^2*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[16]*(L2*M3+LC2*M2))+z[29]*((L2*cos(xt[8])*xt[17])*0.5-(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*xt[18])*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*xt[17])*0.5)+z[16]*(L1*xt[17]^2*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-L1*dxt[17]*(L2*M3+LC2*M2)*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))+L1*cos(xt[7])*cos(xt[8])*cos(xt[9])*xt[18]^2*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[18]*(L2*M3+LC2*M2)-2*L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*xt[17]*xt[18]*(L2*M3+LC2*M2))-z[17]*(dxt[23]*((L2*cos(xt[8]))*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9]))*0.5)-dxt[22]*((sqrt(3)*L2*cos(xt[8]))*0.5-(L2*sin(xt[8])*sin(xt[9]))*0.5)-cos(xt[8])^2*xt[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(xt[8])^2*xt[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(xt[9])*sin(xt[8])*dxt[24]+L1*dxt[16]*(L2*M3+LC2*M2)*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))+0.0*cos(xt[9])*sin(xt[8])*(L2*M3+LC2*M2)+L1*xt[16]^2*(L2*M3+LC2*M2)*(cos(xt[7])*cos(xt[8])+cos(xt[9])*sin(xt[7])*sin(xt[8])))+L2*cos(xt[8])*cos(xt[9])*z[24]
            res[9] = dz[9]+z[17]*((L2*cos(xt[8])*cos(xt[9])*dxt[22])*0.5+L2*cos(xt[8])*sin(xt[9])*dxt[24]-0.0*cos(xt[8])*sin(xt[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[23])*0.5-L1*cos(xt[8])*sin(xt[7])*sin(xt[9])*xt[16]^2*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[16]*(L2*M3+LC2*M2))-z[30]*(L2*cos(xt[8])*sin(xt[9])*xt[17]+L2*cos(xt[9])*sin(xt[8])*xt[18])-z[28]*((L2*cos(xt[8])*cos(xt[9])*xt[17])*0.5-(L2*sin(xt[8])*sin(xt[9])*xt[18])*0.5)-z[18]*((L2*sin(xt[8])*sin(xt[9])*dxt[22])*0.5-L2*cos(xt[9])*sin(xt[8])*dxt[24]+0.0*cos(xt[9])*sin(xt[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[23])*0.5+L1*cos(xt[9])*sin(xt[7])*sin(xt[8])*xt[16]^2*(L2*M3+LC2*M2)-L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[16]*(L2*M3+LC2*M2))+z[16]*(L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[17]*(L2*M3+LC2*M2)-L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*xt[18]^2*(L2*M3+LC2*M2)-L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*xt[17]^2*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[18]*(L2*M3+LC2*M2)+2*L1*cos(xt[7])*cos(xt[8])*cos(xt[9])*xt[17]*xt[18]*(L2*M3+LC2*M2))-z[8]*((L2*cos(xt[8])*cos(xt[9])*dxt[28])*0.5+L2*cos(xt[8])*sin(xt[9])*dxt[30]+(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[29])*0.5)+z[9]*((L2*sin(xt[8])*sin(xt[9])*dxt[28])*0.5-L2*cos(xt[9])*sin(xt[8])*dxt[30]+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[29])*0.5)-z[29]*((sqrt(3)*L2*cos(xt[8])*cos(xt[9])*xt[17])*0.5-(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*xt[18])*0.5)-(L2*cos(xt[9])*sin(xt[8])*z[22])*0.5-L2*sin(xt[8])*sin(xt[9])*z[24]-(sqrt(3)*L2*cos(xt[9])*sin(xt[8])*z[23])*0.5
            res[10] = z[1]+dz[10]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[11]*(L1*(L2*M3+LC2*M2)*(cos(xt[2])*cos(xt[3])*sin(xt[1])*dxt[1]-cos(xt[2])*sin(xt[1])*dxt[2]-cos(xt[1])*sin(xt[2])*dxt[1]+cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[2]+cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[3])+2*L1*xt[10]*(L2*M3+LC2*M2)*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1])))-γ*z[10]-z[12]*(L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[2]*(L2*M3+LC2*M2)+L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[3]*(L2*M3+LC2*M2)-L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*dxt[1]*(L2*M3+LC2*M2)+2*L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]*(L2*M3+LC2*M2))-L1*cos(xt[1])*z[27]-L1*cos(xt[1])*z[30]+L1*sin(xt[1])*z[26]+L1*sin(xt[1])*z[29]+L1*dz[11]*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*dz[12]*(L2*M3+LC2*M2)
            res[11] = z[2]-z[10]*(L1*(L2*M3+LC2*M2)*(cos(xt[2])*cos(xt[3])*sin(xt[1])*dxt[1]-cos(xt[2])*sin(xt[1])*dxt[2]-cos(xt[1])*sin(xt[2])*dxt[1]+cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[2]+cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[3])+2*L1*xt[11]*(L2*M3+LC2*M2)*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))-2*L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[12]*(L2*M3+LC2*M2))+dz[11]*(J2+L2^2*M3+LC2^2*M2)-γ*z[11]+L2*sin(xt[2])*z[26]+L2*sin(xt[2])*z[29]-L2*cos(xt[2])*cos(xt[3])*z[27]-L2*cos(xt[2])*cos(xt[3])*z[30]-L2*cos(xt[2])*sin(xt[3])*z[25]-L2*cos(xt[2])*sin(xt[3])*z[28]-sin(2*xt[2])*z[12]*xt[12]*(J2+L2^2*M3+LC2^2*M2)+L1*dz[10]*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))
            res[12] = z[3]-z[12]*(γ+sin(2*xt[2])*xt[11]*(J2+L2^2*M3+LC2^2*M2)-2*cos(xt[2])*sin(xt[2])*dxt[2]*(J2+L2^2*M3+LC2^2*M2))+z[10]*(2*L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[11]*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[3]*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[2]*(L2*M3+LC2*M2)+2*L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*xt[12]*(L2*M3+LC2*M2)+L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*dxt[1]*(L2*M3+LC2*M2))+sin(xt[2])^2*dz[12]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(xt[3])*sin(xt[2])*z[25]-L2*cos(xt[3])*sin(xt[2])*z[28]+L2*sin(xt[2])*sin(xt[3])*z[27]+L2*sin(xt[2])*sin(xt[3])*z[30]+2*cos(xt[2])*sin(xt[2])*z[11]*xt[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*dz[10]*(L2*M3+LC2*M2)
            res[13] = z[4]+dz[13]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[14]*(L1*(L2*M3+LC2*M2)*(cos(xt[5])*cos(xt[6])*sin(xt[4])*dxt[4]-cos(xt[5])*sin(xt[4])*dxt[5]-cos(xt[4])*sin(xt[5])*dxt[4]+cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[5]+cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[6])+2*L1*xt[13]*(L2*M3+LC2*M2)*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4])))-γ*z[13]-z[15]*(L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[5]*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[6]*(L2*M3+LC2*M2)-L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*dxt[4]*(L2*M3+LC2*M2)+2*L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]*(L2*M3+LC2*M2))+L1*cos(xt[4])*z[27]+(L1*sin(xt[4])*z[26])*0.5+(sqrt(3)*L1*sin(xt[4])*z[25])*0.5+L1*dz[14]*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*dz[15]*(L2*M3+LC2*M2)
            res[14] = z[5]-z[25]*((L2*cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*L2*sin(xt[5]))*0.5)+z[26]*((L2*sin(xt[5]))*0.5+(sqrt(3)*L2*cos(xt[5])*sin(xt[6]))*0.5)-z[13]*(L1*(L2*M3+LC2*M2)*(cos(xt[5])*cos(xt[6])*sin(xt[4])*dxt[4]-cos(xt[5])*sin(xt[4])*dxt[5]-cos(xt[4])*sin(xt[5])*dxt[4]+cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[5]+cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[6])+2*L1*xt[14]*(L2*M3+LC2*M2)*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))-2*L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[15]*(L2*M3+LC2*M2))+dz[14]*(J2+L2^2*M3+LC2^2*M2)-γ*z[14]+L2*cos(xt[5])*cos(xt[6])*z[27]-sin(2*xt[5])*z[15]*xt[15]*(J2+L2^2*M3+LC2^2*M2)+L1*dz[13]*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))
            res[15] = z[6]-z[15]*(γ+sin(2*xt[5])*xt[14]*(J2+L2^2*M3+LC2^2*M2)-2*cos(xt[5])*sin(xt[5])*dxt[5]*(J2+L2^2*M3+LC2^2*M2))+z[13]*(2*L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[14]*(L2*M3+LC2*M2)-L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[6]*(L2*M3+LC2*M2)-L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[5]*(L2*M3+LC2*M2)+2*L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*xt[15]*(L2*M3+LC2*M2)+L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*dxt[4]*(L2*M3+LC2*M2))+sin(xt[5])^2*dz[15]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(xt[6])*sin(xt[5])*z[25])*0.5-L2*sin(xt[5])*sin(xt[6])*z[27]+2*cos(xt[5])*sin(xt[5])*z[14]*xt[15]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(xt[6])*sin(xt[5])*z[26])*0.5-L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*dz[13]*(L2*M3+LC2*M2)
            res[16] = z[7]+dz[16]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[17]*(L1*(L2*M3+LC2*M2)*(cos(xt[8])*cos(xt[9])*sin(xt[7])*dxt[7]-cos(xt[8])*sin(xt[7])*dxt[8]-cos(xt[7])*sin(xt[8])*dxt[7]+cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[8]+cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[9])+2*L1*xt[16]*(L2*M3+LC2*M2)*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7])))-γ*z[16]-z[18]*(L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[8]*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[9]*(L2*M3+LC2*M2)-L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*dxt[7]*(L2*M3+LC2*M2)+2*L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]*(L2*M3+LC2*M2))+L1*cos(xt[7])*z[30]+(L1*sin(xt[7])*z[29])*0.5-(sqrt(3)*L1*sin(xt[7])*z[28])*0.5+L1*dz[17]*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*dz[18]*(L2*M3+LC2*M2)
            res[17] = z[8]-z[28]*((L2*cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*L2*sin(xt[8]))*0.5)+z[29]*((L2*sin(xt[8]))*0.5-(sqrt(3)*L2*cos(xt[8])*sin(xt[9]))*0.5)-z[16]*(L1*(L2*M3+LC2*M2)*(cos(xt[8])*cos(xt[9])*sin(xt[7])*dxt[7]-cos(xt[8])*sin(xt[7])*dxt[8]-cos(xt[7])*sin(xt[8])*dxt[7]+cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[8]+cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[9])+2*L1*xt[17]*(L2*M3+LC2*M2)*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))-2*L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[18]*(L2*M3+LC2*M2))+dz[17]*(J2+L2^2*M3+LC2^2*M2)-γ*z[17]+L2*cos(xt[8])*cos(xt[9])*z[30]-sin(2*xt[8])*z[18]*xt[18]*(J2+L2^2*M3+LC2^2*M2)+L1*dz[16]*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))
            res[18] = z[9]-z[18]*(γ+sin(2*xt[8])*xt[17]*(J2+L2^2*M3+LC2^2*M2)-2*cos(xt[8])*sin(xt[8])*dxt[8]*(J2+L2^2*M3+LC2^2*M2))+z[16]*(2*L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[17]*(L2*M3+LC2*M2)-L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[9]*(L2*M3+LC2*M2)-L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[8]*(L2*M3+LC2*M2)+2*L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*xt[18]*(L2*M3+LC2*M2)+L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*dxt[7]*(L2*M3+LC2*M2))+sin(xt[8])^2*dz[18]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(xt[9])*sin(xt[8])*z[28])*0.5-L2*sin(xt[8])*sin(xt[9])*z[30]+2*cos(xt[8])*sin(xt[8])*z[17]*xt[18]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(xt[9])*sin(xt[8])*z[29])*0.5-L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*dz[16]*(L2*M3+LC2*M2)
            res[19] = z[14]*((sqrt(3)*L2*cos(xt[5])*dxt[5])*0.5-(L2*cos(xt[5])*cos(xt[6])*dxt[6])*0.5+(L2*sin(xt[5])*sin(xt[6])*dxt[5])*0.5)-dz[14]*((L2*cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*L2*sin(xt[5]))*0.5)-z[11]*(L2*cos(xt[2])*cos(xt[3])*dxt[3]-L2*sin(xt[2])*sin(xt[3])*dxt[2])-z[12]*(L2*cos(xt[2])*cos(xt[3])*dxt[2]-L2*sin(xt[2])*sin(xt[3])*dxt[3])-z[15]*((L2*cos(xt[5])*cos(xt[6])*dxt[5])*0.5-(L2*sin(xt[5])*sin(xt[6])*dxt[6])*0.5)-L2*cos(xt[2])*sin(xt[3])*dz[11]-L2*cos(xt[3])*sin(xt[2])*dz[12]-(L2*cos(xt[6])*sin(xt[5])*dz[15])*0.5+(sqrt(3)*L1*sin(xt[4])*dz[13])*0.5+(sqrt(3)*L1*cos(xt[4])*dxt[4]*z[13])*0.5
            res[20] = dz[14]*((L2*sin(xt[5]))*0.5+(sqrt(3)*L2*cos(xt[5])*sin(xt[6]))*0.5)+z[14]*((L2*cos(xt[5])*dxt[5])*0.5+(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[6])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[5])*0.5)+z[15]*((sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[5])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[6])*0.5)+L1*sin(xt[1])*dz[10]+L2*sin(xt[2])*dz[11]+(L1*sin(xt[4])*dz[13])*0.5+L1*cos(xt[1])*dxt[1]*z[10]+L2*cos(xt[2])*dxt[2]*z[11]+(L1*cos(xt[4])*dxt[4]*z[13])*0.5+(sqrt(3)*L2*cos(xt[6])*sin(xt[5])*dz[15])*0.5
            res[21] = z[11]*(L2*cos(xt[3])*sin(xt[2])*dxt[2]+L2*cos(xt[2])*sin(xt[3])*dxt[3])+z[12]*(L2*cos(xt[2])*sin(xt[3])*dxt[2]+L2*cos(xt[3])*sin(xt[2])*dxt[3])-z[14]*(L2*cos(xt[6])*sin(xt[5])*dxt[5]+L2*cos(xt[5])*sin(xt[6])*dxt[6])-z[15]*(L2*cos(xt[5])*sin(xt[6])*dxt[5]+L2*cos(xt[6])*sin(xt[5])*dxt[6])-L1*cos(xt[1])*dz[10]+L1*cos(xt[4])*dz[13]-L2*cos(xt[2])*cos(xt[3])*dz[11]+L2*cos(xt[5])*cos(xt[6])*dz[14]+L2*sin(xt[2])*sin(xt[3])*dz[12]-L2*sin(xt[5])*sin(xt[6])*dz[15]+L1*sin(xt[1])*dxt[1]*z[10]-L1*sin(xt[4])*dxt[4]*z[13]
            res[22] = -z[17]*((L2*cos(xt[8])*cos(xt[9])*dxt[9])*0.5+(sqrt(3)*L2*cos(xt[8])*dxt[8])*0.5-(L2*sin(xt[8])*sin(xt[9])*dxt[8])*0.5)-dz[17]*((L2*cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*L2*sin(xt[8]))*0.5)-z[11]*(L2*cos(xt[2])*cos(xt[3])*dxt[3]-L2*sin(xt[2])*sin(xt[3])*dxt[2])-z[12]*(L2*cos(xt[2])*cos(xt[3])*dxt[2]-L2*sin(xt[2])*sin(xt[3])*dxt[3])-z[18]*((L2*cos(xt[8])*cos(xt[9])*dxt[8])*0.5-(L2*sin(xt[8])*sin(xt[9])*dxt[9])*0.5)-L2*cos(xt[2])*sin(xt[3])*dz[11]-L2*cos(xt[3])*sin(xt[2])*dz[12]-(L2*cos(xt[9])*sin(xt[8])*dz[18])*0.5-(sqrt(3)*L1*sin(xt[7])*dz[16])*0.5-(sqrt(3)*L1*cos(xt[7])*dxt[7]*z[16])*0.5
            res[23] = dz[17]*((L2*sin(xt[8]))*0.5-(sqrt(3)*L2*cos(xt[8])*sin(xt[9]))*0.5)+z[17]*((L2*cos(xt[8])*dxt[8])*0.5-(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[9])*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[8])*0.5)-z[18]*((sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[8])*0.5-(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[9])*0.5)+L1*sin(xt[1])*dz[10]+L2*sin(xt[2])*dz[11]+(L1*sin(xt[7])*dz[16])*0.5+L1*cos(xt[1])*dxt[1]*z[10]+L2*cos(xt[2])*dxt[2]*z[11]+(L1*cos(xt[7])*dxt[7]*z[16])*0.5-(sqrt(3)*L2*cos(xt[9])*sin(xt[8])*dz[18])*0.5
            res[24] = z[11]*(L2*cos(xt[3])*sin(xt[2])*dxt[2]+L2*cos(xt[2])*sin(xt[3])*dxt[3])+z[12]*(L2*cos(xt[2])*sin(xt[3])*dxt[2]+L2*cos(xt[3])*sin(xt[2])*dxt[3])-z[17]*(L2*cos(xt[9])*sin(xt[8])*dxt[8]+L2*cos(xt[8])*sin(xt[9])*dxt[9])-z[18]*(L2*cos(xt[8])*sin(xt[9])*dxt[8]+L2*cos(xt[9])*sin(xt[8])*dxt[9])-L1*cos(xt[1])*dz[10]+L1*cos(xt[7])*dz[16]-L2*cos(xt[2])*cos(xt[3])*dz[11]+L2*cos(xt[8])*cos(xt[9])*dz[17]+L2*sin(xt[2])*sin(xt[3])*dz[12]-L2*sin(xt[8])*sin(xt[9])*dz[18]+L1*sin(xt[1])*dxt[1]*z[10]-L1*sin(xt[7])*dxt[7]*z[16]
            res[25] = dz[5]*((L2*cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*L2*sin(xt[5]))*0.5)-z[5]*((sqrt(3)*L2*cos(xt[5])*dxt[5])*0.5-(L2*cos(xt[5])*cos(xt[6])*dxt[6])*0.5+(L2*sin(xt[5])*sin(xt[6])*dxt[5])*0.5)+z[2]*(L2*cos(xt[2])*cos(xt[3])*dxt[3]-L2*sin(xt[2])*sin(xt[3])*dxt[2])+z[3]*(L2*cos(xt[2])*cos(xt[3])*dxt[2]-L2*sin(xt[2])*sin(xt[3])*dxt[3])+z[6]*((L2*cos(xt[5])*cos(xt[6])*dxt[5])*0.5-(L2*sin(xt[5])*sin(xt[6])*dxt[6])*0.5)+L2*cos(xt[2])*sin(xt[3])*dz[2]+L2*cos(xt[3])*sin(xt[2])*dz[3]+(L2*cos(xt[6])*sin(xt[5])*dz[6])*0.5-(sqrt(3)*L1*sin(xt[4])*dz[4])*0.5-(sqrt(3)*L1*cos(xt[4])*dxt[4]*z[4])*0.5
            res[26] = -dz[5]*((L2*sin(xt[5]))*0.5+(sqrt(3)*L2*cos(xt[5])*sin(xt[6]))*0.5)-z[5]*((L2*cos(xt[5])*dxt[5])*0.5+(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[6])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[5])*0.5)-z[6]*((sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[5])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[6])*0.5)-L1*sin(xt[1])*dz[1]-L2*sin(xt[2])*dz[2]-(L1*sin(xt[4])*dz[4])*0.5-L1*cos(xt[1])*dxt[1]*z[1]-L2*cos(xt[2])*dxt[2]*z[2]-(L1*cos(xt[4])*dxt[4]*z[4])*0.5-(sqrt(3)*L2*cos(xt[6])*sin(xt[5])*dz[6])*0.5
            res[27] = z[5]*(L2*cos(xt[6])*sin(xt[5])*dxt[5]+L2*cos(xt[5])*sin(xt[6])*dxt[6])-z[3]*(L2*cos(xt[2])*sin(xt[3])*dxt[2]+L2*cos(xt[3])*sin(xt[2])*dxt[3])-z[2]*(L2*cos(xt[3])*sin(xt[2])*dxt[2]+L2*cos(xt[2])*sin(xt[3])*dxt[3])+z[6]*(L2*cos(xt[5])*sin(xt[6])*dxt[5]+L2*cos(xt[6])*sin(xt[5])*dxt[6])+L1*cos(xt[1])*dz[1]-L1*cos(xt[4])*dz[4]+L2*cos(xt[2])*cos(xt[3])*dz[2]-L2*cos(xt[5])*cos(xt[6])*dz[5]-L2*sin(xt[2])*sin(xt[3])*dz[3]+L2*sin(xt[5])*sin(xt[6])*dz[6]-L1*sin(xt[1])*dxt[1]*z[1]+L1*sin(xt[4])*dxt[4]*z[4]
            res[28] = z[8]*((L2*cos(xt[8])*cos(xt[9])*dxt[9])*0.5+(sqrt(3)*L2*cos(xt[8])*dxt[8])*0.5-(L2*sin(xt[8])*sin(xt[9])*dxt[8])*0.5)+dz[8]*((L2*cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*L2*sin(xt[8]))*0.5)+z[2]*(L2*cos(xt[2])*cos(xt[3])*dxt[3]-L2*sin(xt[2])*sin(xt[3])*dxt[2])+z[3]*(L2*cos(xt[2])*cos(xt[3])*dxt[2]-L2*sin(xt[2])*sin(xt[3])*dxt[3])+z[9]*((L2*cos(xt[8])*cos(xt[9])*dxt[8])*0.5-(L2*sin(xt[8])*sin(xt[9])*dxt[9])*0.5)+L2*cos(xt[2])*sin(xt[3])*dz[2]+L2*cos(xt[3])*sin(xt[2])*dz[3]+(L2*cos(xt[9])*sin(xt[8])*dz[9])*0.5+(sqrt(3)*L1*sin(xt[7])*dz[7])*0.5+(sqrt(3)*L1*cos(xt[7])*dxt[7]*z[7])*0.5
            res[29] = z[9]*((sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[8])*0.5-(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[9])*0.5)-z[8]*((L2*cos(xt[8])*dxt[8])*0.5-(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[9])*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[8])*0.5)-dz[8]*((L2*sin(xt[8]))*0.5-(sqrt(3)*L2*cos(xt[8])*sin(xt[9]))*0.5)-L1*sin(xt[1])*dz[1]-L2*sin(xt[2])*dz[2]-(L1*sin(xt[7])*dz[7])*0.5-L1*cos(xt[1])*dxt[1]*z[1]-L2*cos(xt[2])*dxt[2]*z[2]-(L1*cos(xt[7])*dxt[7]*z[7])*0.5+(sqrt(3)*L2*cos(xt[9])*sin(xt[8])*dz[9])*0.5
            res[30] = z[8]*(L2*cos(xt[9])*sin(xt[8])*dxt[8]+L2*cos(xt[8])*sin(xt[9])*dxt[9])-z[3]*(L2*cos(xt[2])*sin(xt[3])*dxt[2]+L2*cos(xt[3])*sin(xt[2])*dxt[3])-z[2]*(L2*cos(xt[3])*sin(xt[2])*dxt[2]+L2*cos(xt[2])*sin(xt[3])*dxt[3])+z[9]*(L2*cos(xt[8])*sin(xt[9])*dxt[8]+L2*cos(xt[9])*sin(xt[8])*dxt[9])+L1*cos(xt[1])*dz[1]-L1*cos(xt[7])*dz[7]+L2*cos(xt[2])*cos(xt[3])*dz[2]-L2*cos(xt[8])*cos(xt[9])*dz[8]-L2*sin(xt[2])*sin(xt[3])*dz[3]+L2*sin(xt[8])*sin(xt[9])*dz[9]-L1*sin(xt[1])*dxt[1]*z[1]+L1*sin(xt[7])*dxt[7]*z[7]
            # TODO: Do we really need to simulate with these three equations or could we remove them somehow since they are quite trivial?
            res[31] = -z[31]-2*(yt[1]-xt[31])/T
            res[32] = -z[32]-2*(yt[2]-xt[32])/T
            res[33] = -z[33]-2*(yt[3]-xt[33])/T
            # ---------- β-equations ----------
            # 0 = dβᵢ - gθᵢ + λᵀ(Fθᵢ + Fw wθᵢ)

            # For dynamical parameters, only dβᵢ - λᵀFθᵢ
            res[34] = dz[34] - ((3*z[20])*0.5+(3*z[23])*0.5-z[32]+(sqrt(3)*z[19])*0.5-(sqrt(3)*z[22])*0.5)
            res[35] = dz[35] - (z[12]*(sin(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]^2*(L2*M3+LC2*M2)-cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[10]*(L2*M3+LC2*M2))+z[15]*(sin(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]^2*(L2*M3+LC2*M2)-cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[13]*(L2*M3+LC2*M2))+z[18]*(sin(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]^2*(L2*M3+LC2*M2)-cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[16]*(L2*M3+LC2*M2))+z[11]*(dxt[10]*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))+xt[10]^2*(L2*M3+LC2*M2)*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1])))+z[14]*(dxt[13]*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))+xt[13]^2*(L2*M3+LC2*M2)*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4])))+z[17]*(dxt[16]*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))+xt[16]^2*(L2*M3+LC2*M2)*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7])))-cos(xt[1])*z[32]+z[20]*(cos(xt[1])+cos(xt[4])*0.5)+z[23]*(cos(xt[1])+cos(xt[7])*0.5)-sin(xt[1])*z[33]-z[4]*(cos(xt[4])*dxt[27]+(sin(xt[4])*dxt[26])*0.5+(sqrt(3)*sin(xt[4])*dxt[25])*0.5)-z[7]*(cos(xt[7])*dxt[30]+(sin(xt[7])*dxt[29])*0.5-(sqrt(3)*sin(xt[7])*dxt[28])*0.5)+z[21]*(sin(xt[1])-sin(xt[4]))+z[24]*(sin(xt[1])-sin(xt[7]))+z[1]*(cos(xt[1])*dxt[27]+cos(xt[1])*dxt[30]-sin(xt[1])*dxt[26]-sin(xt[1])*dxt[29])+z[27]*(cos(xt[1])*xt[10]-cos(xt[4])*xt[13])+z[30]*(cos(xt[1])*xt[10]-cos(xt[7])*xt[16])+z[13]*(cos(xt[4])*dxt[21]+(sin(xt[4])*dxt[20])*0.5-0.0*cos(xt[4])*(M2+M3)+dxt[14]*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))+2*L1*dxt[13]*(M2+M3)+xt[14]^2*(L2*M3+LC2*M2)*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))+(sqrt(3)*sin(xt[4])*dxt[19])*0.5-cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[15]*(L2*M3+LC2*M2)-cos(xt[4])*cos(xt[6])*sin(xt[5])*xt[15]^2*(L2*M3+LC2*M2)-2*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[14]*xt[15]*(L2*M3+LC2*M2))+z[16]*(cos(xt[7])*dxt[24]+(sin(xt[7])*dxt[23])*0.5-0.0*cos(xt[7])*(M2+M3)+dxt[17]*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))+2*L1*dxt[16]*(M2+M3)+xt[17]^2*(L2*M3+LC2*M2)*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))-(sqrt(3)*sin(xt[7])*dxt[22])*0.5-cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[18]*(L2*M3+LC2*M2)-cos(xt[7])*cos(xt[9])*sin(xt[8])*xt[18]^2*(L2*M3+LC2*M2)-2*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[17]*xt[18]*(L2*M3+LC2*M2))-z[26]*(sin(xt[1])*xt[10]+(sin(xt[4])*xt[13])*0.5)-z[29]*(sin(xt[1])*xt[10]+(sin(xt[7])*xt[16])*0.5)-z[10]*(cos(xt[1])*dxt[21]+cos(xt[1])*dxt[24]-sin(xt[1])*dxt[20]-sin(xt[1])*dxt[23]+0.0*cos(xt[1])*(M2+M3)-dxt[11]*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-2*L1*dxt[10]*(M2+M3)-xt[11]^2*(L2*M3+LC2*M2)*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))+cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[12]*(L2*M3+LC2*M2)+cos(xt[1])*cos(xt[3])*sin(xt[2])*xt[12]^2*(L2*M3+LC2*M2)+2*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[11]*xt[12]*(L2*M3+LC2*M2))+(sqrt(3)*cos(xt[4])*z[19])*0.5-(sqrt(3)*cos(xt[7])*z[22])*0.5-(sqrt(3)*sin(xt[4])*z[25]*xt[13])*0.5+(sqrt(3)*sin(xt[7])*z[28]*xt[16])*0.5)
            res[36] = dz[36] - (z[2]*(cos(xt[2])*cos(xt[3])*dxt[27]-sin(xt[2])*dxt[29]-sin(xt[2])*dxt[26]+cos(xt[2])*cos(xt[3])*dxt[30]+cos(xt[2])*sin(xt[3])*dxt[25]+cos(xt[2])*sin(xt[3])*dxt[28])+z[12]*(sin(xt[2])*sin(xt[3])*dxt[21]-cos(xt[3])*sin(xt[2])*dxt[22]-cos(xt[3])*sin(xt[2])*dxt[19]+sin(xt[2])*sin(xt[3])*dxt[24]+2*L2*M3*sin(xt[2])^2*dxt[12]+M3*0.0*sin(xt[2])*sin(xt[3])+2*L2*M3*sin(2*xt[2])*xt[11]*xt[12]+L1*M3*sin(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]^2-L1*M3*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[10])+z[3]*(cos(xt[3])*sin(xt[2])*dxt[25]+cos(xt[3])*sin(xt[2])*dxt[28]-sin(xt[2])*sin(xt[3])*dxt[27]-sin(xt[2])*sin(xt[3])*dxt[30])+z[27]*(cos(xt[2])*cos(xt[3])*xt[11]-cos(xt[5])*cos(xt[6])*xt[14]-sin(xt[2])*sin(xt[3])*xt[12]+sin(xt[5])*sin(xt[6])*xt[15])+z[30]*(cos(xt[2])*cos(xt[3])*xt[11]-cos(xt[8])*cos(xt[9])*xt[17]-sin(xt[2])*sin(xt[3])*xt[12]+sin(xt[8])*sin(xt[9])*xt[18])+z[25]*(cos(xt[2])*sin(xt[3])*xt[11]-(sqrt(3)*sin(xt[5])*xt[14])*0.5+cos(xt[3])*sin(xt[2])*xt[12]+(cos(xt[5])*sin(xt[6])*xt[14])*0.5+(cos(xt[6])*sin(xt[5])*xt[15])*0.5)+z[28]*((sqrt(3)*sin(xt[8])*xt[17])*0.5+cos(xt[2])*sin(xt[3])*xt[11]+cos(xt[3])*sin(xt[2])*xt[12]+(cos(xt[8])*sin(xt[9])*xt[17])*0.5+(cos(xt[9])*sin(xt[8])*xt[18])*0.5)-z[26]*(sin(xt[2])*xt[11]+(sin(xt[5])*xt[14])*0.5+(sqrt(3)*cos(xt[5])*sin(xt[6])*xt[14])*0.5+(sqrt(3)*cos(xt[6])*sin(xt[5])*xt[15])*0.5)-z[29]*(sin(xt[2])*xt[11]+(sin(xt[8])*xt[17])*0.5-(sqrt(3)*cos(xt[8])*sin(xt[9])*xt[17])*0.5-(sqrt(3)*cos(xt[9])*sin(xt[8])*xt[18])*0.5)+z[15]*((sqrt(3)*cos(xt[6])*sin(xt[5])*dxt[20])*0.5-sin(xt[5])*sin(xt[6])*dxt[21]-(cos(xt[6])*sin(xt[5])*dxt[19])*0.5+2*L2*M3*sin(xt[5])^2*dxt[15]+M3*0.0*sin(xt[5])*sin(xt[6])+2*L2*M3*sin(2*xt[5])*xt[14]*xt[15]+L1*M3*sin(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]^2-L1*M3*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[13])-z[18]*((cos(xt[9])*sin(xt[8])*dxt[22])*0.5+sin(xt[8])*sin(xt[9])*dxt[24]+(sqrt(3)*cos(xt[9])*sin(xt[8])*dxt[23])*0.5-2*L2*M3*sin(xt[8])^2*dxt[18]-M3*0.0*sin(xt[8])*sin(xt[9])-2*L2*M3*sin(2*xt[8])*xt[17]*xt[18]-L1*M3*sin(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]^2+L1*M3*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[16])+z[14]*(dxt[20]*(sin(xt[5])*0.5+(sqrt(3)*cos(xt[5])*sin(xt[6]))*0.5)-dxt[19]*((cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*sin(xt[5]))*0.5)+cos(xt[5])*cos(xt[6])*dxt[21]+2*L2*M3*dxt[14]+L1*M3*dxt[13]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-M3*0.0*cos(xt[5])*cos(xt[6])+L1*M3*xt[13]^2*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))-2*L2*M3*cos(xt[5])*sin(xt[5])*xt[15]^2)+z[17]*(dxt[23]*(sin(xt[8])*0.5-(sqrt(3)*cos(xt[8])*sin(xt[9]))*0.5)-dxt[22]*((cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*sin(xt[8]))*0.5)+cos(xt[8])*cos(xt[9])*dxt[24]+2*L2*M3*dxt[17]+L1*M3*dxt[16]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-M3*0.0*cos(xt[8])*cos(xt[9])+L1*M3*xt[16]^2*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))-2*L2*M3*cos(xt[8])*sin(xt[8])*xt[18]^2)-cos(xt[2])*z[32]+z[6]*((cos(xt[6])*sin(xt[5])*dxt[25])*0.5+sin(xt[5])*sin(xt[6])*dxt[27]-(sqrt(3)*cos(xt[6])*sin(xt[5])*dxt[26])*0.5)+z[9]*((cos(xt[9])*sin(xt[8])*dxt[28])*0.5+sin(xt[8])*sin(xt[9])*dxt[30]+(sqrt(3)*cos(xt[9])*sin(xt[8])*dxt[29])*0.5)+z[21]*(cos(xt[3])*sin(xt[2])-cos(xt[6])*sin(xt[5]))+z[24]*(cos(xt[3])*sin(xt[2])-cos(xt[9])*sin(xt[8]))-z[10]*(L1*M3*cos(xt[1])*cos(xt[3])*sin(xt[2])*xt[12]^2-L1*M3*xt[11]^2*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))-L1*M3*dxt[11]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))+L1*M3*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[12]+2*L1*M3*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[11]*xt[12])-z[13]*(L1*M3*cos(xt[4])*cos(xt[6])*sin(xt[5])*xt[15]^2-L1*M3*xt[14]^2*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))-L1*M3*dxt[14]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))+L1*M3*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[15]+2*L1*M3*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[14]*xt[15])-z[16]*(L1*M3*cos(xt[7])*cos(xt[9])*sin(xt[8])*xt[18]^2-L1*M3*xt[17]^2*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))-L1*M3*dxt[17]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))+L1*M3*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[18]+2*L1*M3*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[17]*xt[18])-z[11]*(cos(xt[2])*cos(xt[3])*dxt[21]-sin(xt[2])*dxt[23]-sin(xt[2])*dxt[20]+cos(xt[2])*cos(xt[3])*dxt[24]-2*L2*M3*dxt[11]+cos(xt[2])*sin(xt[3])*dxt[19]+cos(xt[2])*sin(xt[3])*dxt[22]-L1*M3*dxt[10]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))+M3*0.0*cos(xt[2])*cos(xt[3])-L1*M3*xt[10]^2*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))+2*L2*M3*cos(xt[2])*sin(xt[2])*xt[12]^2)-z[5]*(dxt[26]*(sin(xt[5])*0.5+(sqrt(3)*cos(xt[5])*sin(xt[6]))*0.5)-dxt[25]*((cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*sin(xt[5]))*0.5)+cos(xt[5])*cos(xt[6])*dxt[27])-z[8]*(dxt[29]*(sin(xt[8])*0.5-(sqrt(3)*cos(xt[8])*sin(xt[9]))*0.5)-dxt[28]*((cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*sin(xt[8]))*0.5)+cos(xt[8])*cos(xt[9])*dxt[30])+z[19]*((sqrt(3)*cos(xt[5]))*0.5+sin(xt[2])*sin(xt[3])+(sin(xt[5])*sin(xt[6]))*0.5)+z[22]*(sin(xt[2])*sin(xt[3])-(sqrt(3)*cos(xt[8]))*0.5+(sin(xt[8])*sin(xt[9]))*0.5)+z[20]*(cos(xt[2])+cos(xt[5])*0.5-(sqrt(3)*sin(xt[5])*sin(xt[6]))*0.5)+z[23]*(cos(xt[2])+cos(xt[8])*0.5+(sqrt(3)*sin(xt[8])*sin(xt[9]))*0.5)-cos(xt[3])*sin(xt[2])*z[33]-sin(xt[2])*sin(xt[3])*z[31])
            res[37] = dz[37] - (z[32]-(3*z[23])*0.5-(3*z[20])*0.5-(sqrt(3)*z[19])*0.5+(sqrt(3)*z[22])*0.5)
            res[38] = dz[38] - (-z[10]*(M1*0.0*cos(xt[1])-2*LC1*M1*dxt[10])-z[13]*(M1*0.0*cos(xt[4])-2*LC1*M1*dxt[13])-z[16]*(M1*0.0*cos(xt[7])-2*LC1*M1*dxt[16]))
            res[39] = dz[39] - (z[11]*(2*LC2*M2*dxt[11]+L1*M2*dxt[10]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-M2*0.0*cos(xt[2])*cos(xt[3])+L1*M2*xt[10]^2*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))-2*LC2*M2*cos(xt[2])*sin(xt[2])*xt[12]^2)+z[14]*(2*LC2*M2*dxt[14]+L1*M2*dxt[13]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-M2*0.0*cos(xt[5])*cos(xt[6])+L1*M2*xt[13]^2*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))-2*LC2*M2*cos(xt[5])*sin(xt[5])*xt[15]^2)+z[17]*(2*LC2*M2*dxt[17]+L1*M2*dxt[16]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-M2*0.0*cos(xt[8])*cos(xt[9])+L1*M2*xt[16]^2*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))-2*LC2*M2*cos(xt[8])*sin(xt[8])*xt[18]^2)+z[12]*(2*LC2*M2*sin(xt[2])^2*dxt[12]+M2*0.0*sin(xt[2])*sin(xt[3])+2*LC2*M2*sin(2*xt[2])*xt[11]*xt[12]+L1*M2*sin(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]^2-L1*M2*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[10])+z[15]*(2*LC2*M2*sin(xt[5])^2*dxt[15]+M2*0.0*sin(xt[5])*sin(xt[6])+2*LC2*M2*sin(2*xt[5])*xt[14]*xt[15]+L1*M2*sin(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]^2-L1*M2*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[13])+z[18]*(2*LC2*M2*sin(xt[8])^2*dxt[18]+M2*0.0*sin(xt[8])*sin(xt[9])+2*LC2*M2*sin(2*xt[8])*xt[17]*xt[18]+L1*M2*sin(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]^2-L1*M2*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[16])-z[10]*(L1*M2*cos(xt[1])*cos(xt[3])*sin(xt[2])*xt[12]^2-L1*M2*xt[11]^2*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))-L1*M2*dxt[11]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))+L1*M2*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[12]+2*L1*M2*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[11]*xt[12])-z[13]*(L1*M2*cos(xt[4])*cos(xt[6])*sin(xt[5])*xt[15]^2-L1*M2*xt[14]^2*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))-L1*M2*dxt[14]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))+L1*M2*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[15]+2*L1*M2*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[14]*xt[15])-z[16]*(L1*M2*cos(xt[7])*cos(xt[9])*sin(xt[8])*xt[18]^2-L1*M2*xt[17]^2*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))-L1*M2*dxt[17]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))+L1*M2*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[18]+2*L1*M2*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[17]*xt[18]))
            res[40] = dz[40] - (z[10]*(LC1^2*dxt[10]-LC1*0.0*cos(xt[1]))+z[13]*(LC1^2*dxt[13]-LC1*0.0*cos(xt[4]))+z[16]*(LC1^2*dxt[16]-LC1*0.0*cos(xt[7])))
            res[41] = dz[41] - (z[11]*(LC2^2*dxt[11]+L1*LC2*dxt[10]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-LC2*0.0*cos(xt[2])*cos(xt[3])+L1*LC2*xt[10]^2*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))-LC2^2*cos(xt[2])*sin(xt[2])*xt[12]^2)+z[14]*(LC2^2*dxt[14]+L1*LC2*dxt[13]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-LC2*0.0*cos(xt[5])*cos(xt[6])+L1*LC2*xt[13]^2*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))-LC2^2*cos(xt[5])*sin(xt[5])*xt[15]^2)+z[17]*(LC2^2*dxt[17]+L1*LC2*dxt[16]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-LC2*0.0*cos(xt[8])*cos(xt[9])+L1*LC2*xt[16]^2*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))-LC2^2*cos(xt[8])*sin(xt[8])*xt[18]^2)+z[12]*(LC2^2*sin(xt[2])^2*dxt[12]+LC2^2*sin(2*xt[2])*xt[11]*xt[12]+LC2*0.0*sin(xt[2])*sin(xt[3])+L1*LC2*sin(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]^2-L1*LC2*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[10])+z[15]*(LC2^2*sin(xt[5])^2*dxt[15]+LC2^2*sin(2*xt[5])*xt[14]*xt[15]+LC2*0.0*sin(xt[5])*sin(xt[6])+L1*LC2*sin(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]^2-L1*LC2*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[13])+z[18]*(LC2^2*sin(xt[8])^2*dxt[18]+LC2^2*sin(2*xt[8])*xt[17]*xt[18]+LC2*0.0*sin(xt[8])*sin(xt[9])+L1*LC2*sin(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]^2-L1*LC2*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[16])-z[10]*(L1*0.0*cos(xt[1])-L1^2*dxt[10]-L1*LC2*dxt[11]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-L1*LC2*xt[11]^2*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))+L1*LC2*cos(xt[1])*cos(xt[3])*sin(xt[2])*xt[12]^2+L1*LC2*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[12]+2*L1*LC2*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[11]*xt[12])-z[13]*(L1*0.0*cos(xt[4])-L1^2*dxt[13]-L1*LC2*dxt[14]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-L1*LC2*xt[14]^2*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))+L1*LC2*cos(xt[4])*cos(xt[6])*sin(xt[5])*xt[15]^2+L1*LC2*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[15]+2*L1*LC2*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[14]*xt[15])-z[16]*(L1*0.0*cos(xt[7])-L1^2*dxt[16]-L1*LC2*dxt[17]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-L1*LC2*xt[17]^2*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))+L1*LC2*cos(xt[7])*cos(xt[9])*sin(xt[8])*xt[18]^2+L1*LC2*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[18]+2*L1*LC2*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[17]*xt[18]))
            res[42] = dz[42] - (z[11]*(L2^2*dxt[11]+L1*L2*dxt[10]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-L2*0.0*cos(xt[2])*cos(xt[3])+L1*L2*xt[10]^2*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))-L2^2*cos(xt[2])*sin(xt[2])*xt[12]^2)+z[14]*(L2^2*dxt[14]+L1*L2*dxt[13]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-L2*0.0*cos(xt[5])*cos(xt[6])+L1*L2*xt[13]^2*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))-L2^2*cos(xt[5])*sin(xt[5])*xt[15]^2)+z[17]*(L2^2*dxt[17]+L1*L2*dxt[16]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-L2*0.0*cos(xt[8])*cos(xt[9])+L1*L2*xt[16]^2*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))-L2^2*cos(xt[8])*sin(xt[8])*xt[18]^2)+z[12]*(L2^2*sin(xt[2])^2*dxt[12]+L2^2*sin(2*xt[2])*xt[11]*xt[12]+L2*0.0*sin(xt[2])*sin(xt[3])+L1*L2*sin(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]^2-L1*L2*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[10])+z[15]*(L2^2*sin(xt[5])^2*dxt[15]+L2^2*sin(2*xt[5])*xt[14]*xt[15]+L2*0.0*sin(xt[5])*sin(xt[6])+L1*L2*sin(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]^2-L1*L2*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[13])+z[18]*(L2^2*sin(xt[8])^2*dxt[18]+L2^2*sin(2*xt[8])*xt[17]*xt[18]+L2*0.0*sin(xt[8])*sin(xt[9])+L1*L2*sin(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]^2-L1*L2*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[16])-z[10]*(L1*0.0*cos(xt[1])-L1^2*dxt[10]-L1*L2*dxt[11]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-L1*L2*xt[11]^2*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))+L1*L2*cos(xt[1])*cos(xt[3])*sin(xt[2])*xt[12]^2+L1*L2*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[12]+2*L1*L2*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[11]*xt[12])-z[13]*(L1*0.0*cos(xt[4])-L1^2*dxt[13]-L1*L2*dxt[14]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-L1*L2*xt[14]^2*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))+L1*L2*cos(xt[4])*cos(xt[6])*sin(xt[5])*xt[15]^2+L1*L2*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[15]+2*L1*L2*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[14]*xt[15])-z[16]*(L1*0.0*cos(xt[7])-L1^2*dxt[16]-L1*L2*dxt[17]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-L1*L2*xt[17]^2*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))+L1*L2*cos(xt[7])*cos(xt[9])*sin(xt[8])*xt[18]^2+L1*L2*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[18]+2*L1*L2*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[17]*xt[18]))
            res[43] = dz[43] - (dxt[10]*z[10]+dxt[13]*z[13]+dxt[16]*z[16])
            res[44] = dz[44] - (z[12]*(sin(xt[2])^2*dxt[12]+sin(2*xt[2])*xt[11]*xt[12])+z[15]*(sin(xt[5])^2*dxt[15]+sin(2*xt[5])*xt[14]*xt[15])+z[18]*(sin(xt[8])^2*dxt[18]+sin(2*xt[8])*xt[17]*xt[18])+z[11]*(dxt[11]-cos(xt[2])*sin(xt[2])*xt[12]^2)+z[14]*(dxt[14]-cos(xt[5])*sin(xt[5])*xt[15]^2)+z[17]*(dxt[17]-cos(xt[8])*sin(xt[8])*xt[18]^2))
            res[45] = dz[45] - (z[10]*xt[10]+z[11]*xt[11]+z[12]*xt[12]+z[13]*xt[13]+z[14]*xt[14]+z[15]*xt[15]+z[16]*xt[16]+z[17]*xt[17]+z[18]*xt[18])
            
            # For disturbance parameters, only dβᵢ + λᵀ Fw wθᵢ
            for ind = 1:12
                res[45+ind] = dz[45+ind] + (2z[10]*w(t)[1]w(t)[3ind+1] + 2z[13]*w(t)[2]w(t)[3ind+2] + 2z[16]*w(t)[3]w(t)[3ind+3])
            end

            nothing
        end

        # At least for the two forms of index 1 DAEs in my licentiate thesis, λd are always differential and λa are always algebraic.
        # λd always correspond to the differential equations in F, which are equations 1,....,18, from which we get the following dinds and ainds
        # The delta robot is an index 1 DAE exactly on one of these forms
        dinds  = 1:18  # Indices of differential variables
        ainds  = 19:33 # Indices of algebraic variables

        ######################## INITIALIZING ADJOINT SYSTEM (Computing terminal values) ####################
        # Using special initialization function for delta robot, it improves the accuracy of the initial values (values at t=T that is)
        λT, dλT = get_initial_adjoint_deltaversion(dinds, ainds, gₓT, dgₓT, FxT, Fdx(T), dFdxT, x(T,1:33), y(T,1:3), T) # TODO: Shouldn't we use nx instead of 33 here????
        βT, dβT = get_initial_adjoint_beta(λT, FθT, zeros(12))  # TODO: 12 because n\theta - n\eta, any way to not hard-code it?
        # NOTE: Specific for disturbance model, TODO: make agnostic!!!
        βdistT, dβdistT = get_initial_adjoint_beta_dist(λT, FwT, w(T)[4:end], 12)   # TODO: Make n\eta  not hard-coded!
        z0 = vcat(λT, βT, βdistT)
        dz0 = vcat(dλT, dβT, dβdistT)

        # Function returning Gθ given adjoint solution
        function get_Gθ(adj_sol::DAESolution)
            # Because the problem is solved backwards in time, the end of the solution corresponds to t=0
            # Gθᵢ = βᵢ(0) + (λᵀFdx xθᵢ)(0)
            adj_sol.u[end][nx+1:nx+nθ] .+ (((adj_sol.u[end][1:nx]')*Fdx(0.0))*xθ0)[:]
        end

        dvars = fill(false, nx+nθ)
        dvars[dinds] .= true
        dvars[end-nθ:end] .= true

        r0 = zeros(length(z0))
        f!(r0, dz0, z0, [], T)
        # @info "r0 is: $r0"

        # t -> 0.0 is just a dummy function, not to be used
        return Model(f!, t -> 0.0, z0, dz0, dvars, r0), get_Gθ
    end
end

# -------------------- Adjoint sensitivity models with ODE disturbance model ---------------------------

function delta_adjoint_allpar_alldist_ODEdist(w::Function, pars::Vector{Float64}, T::Float64, x::func_type, x2::func_type, y::func_type, dy::func_type, xθ0::Matrix{Float64}, dx::func_type, dx2::func_type, ad::AdjointSDEApproxData)::Tuple{Model,Function}
    # g = 0 because this is the gravity-compensated model
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13], nxw = ad.nxw, nw = ad.nw
        nx, nθ = size(xθ0)
        ndist = nxw + nw
        @assert (nθ == 24) "delta_adjoint_allpar_alldist_ODEdist is hard-coded to handle 24 parameters (12 dynamical and 12 disturbance), make sure to pass correct xθ0. Currently passing $nθ parameters."
        @assert (nx == 33) "delta_adjoint_allpar_alldist_ODEdist expects the DAE state to have 33 components, the passed state has $nx components instead"
        @assert (nw == 3) "delta_adjoint_allpar_alldist_ODEdist expects a 3-dimensional disturbance signal, got $nw dimensions instead"

        # Most matrices need only to be evaluated at t=T, because inside f!() we hardcode the equations and don't use these matrices
        FxT = [-L1*cos(x(T,1))*dx(T,26)-L1*cos(x(T,1))*dx(T,29)-L1*sin(x(T,1))*dx(T,27)-L1*sin(x(T,1))*dx(T,30)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   -L2*cos(x(T,2))*dx(T,26)-L2*cos(x(T,2))*dx(T,29)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,27)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,30)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,25)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,28)   L2*cos(x(T,2))*cos(x(T,3))*dx(T,25)+L2*cos(x(T,2))*cos(x(T,3))*dx(T,28)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,27)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,30)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*cos(x(T,3))*dx(T,25)+L2*cos(x(T,2))*cos(x(T,3))*dx(T,28)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,27)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,30)   -L2*cos(x(T,3))*sin(x(T,2))*dx(T,27)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,30)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,25)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,28)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   L1*sin(x(T,4))*dx(T,27)-(L1*cos(x(T,4))*dx(T,26))*0.5-(sqrt(3)*L1*cos(x(T,4))*dx(T,25))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   L2*cos(x(T,6))*sin(x(T,5))*dx(T,27)-dx(T,26)*((L2*cos(x(T,5)))*0.5-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6)))*0.5)-dx(T,25)*((sqrt(3)*L2*cos(x(T,5)))*0.5+(L2*sin(x(T,5))*sin(x(T,6)))*0.5)   (L2*cos(x(T,5))*cos(x(T,6))*dx(T,25))*0.5+L2*cos(x(T,5))*sin(x(T,6))*dx(T,27)-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,26))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   (L2*cos(x(T,5))*cos(x(T,6))*dx(T,25))*0.5+L2*cos(x(T,5))*sin(x(T,6))*dx(T,27)-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,26))*0.5   L2*cos(x(T,6))*sin(x(T,5))*dx(T,27)-(L2*sin(x(T,5))*sin(x(T,6))*dx(T,25))*0.5+(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,26))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(T,7))*dx(T,30)-(L1*cos(x(T,7))*dx(T,29))*0.5+(sqrt(3)*L1*cos(x(T,7))*dx(T,28))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   dx(T,28)*((sqrt(3)*L2*cos(x(T,8)))*0.5-(L2*sin(x(T,8))*sin(x(T,9)))*0.5)-dx(T,29)*((L2*cos(x(T,8)))*0.5+(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9)))*0.5)+L2*cos(x(T,9))*sin(x(T,8))*dx(T,30)   (L2*cos(x(T,8))*cos(x(T,9))*dx(T,28))*0.5+L2*cos(x(T,8))*sin(x(T,9))*dx(T,30)+(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,29))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,8))*cos(x(T,9))*dx(T,28))*0.5+L2*cos(x(T,8))*sin(x(T,9))*dx(T,30)+(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,29))*0.5   L2*cos(x(T,9))*sin(x(T,8))*dx(T,30)-(L2*sin(x(T,8))*sin(x(T,9))*dx(T,28))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,29))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0*sin(x(T,1))*(L1*(M2+M3)+LC1*M1)+L1*cos(x(T,1))*dx(T,20)+L1*cos(x(T,1))*dx(T,23)+L1*sin(x(T,1))*dx(T,21)+L1*sin(x(T,1))*dx(T,24)+L1*dx(T,11)*(L2*M3+LC2*M2)*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))+L1*x(T,11)^2*(L2*M3+LC2*M2)*(cos(x(T,1))*cos(x(T,2))+cos(x(T,3))*sin(x(T,1))*sin(x(T,2)))+L1*cos(x(T,3))*sin(x(T,1))*sin(x(T,2))*x(T,12)^2*(L2*M3+LC2*M2)+L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,12)*(L2*M3+LC2*M2)+2*L1*cos(x(T,2))*sin(x(T,1))*sin(x(T,3))*x(T,11)*x(T,12)*(L2*M3+LC2*M2)   L1*dx(T,11)*(L2*M3+LC2*M2)*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-L1*x(T,11)^2*(L2*M3+LC2*M2)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))-L1*cos(x(T,1))*cos(x(T,2))*cos(x(T,3))*x(T,12)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,12)*(L2*M3+LC2*M2)+2*L1*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,11)*x(T,12)*(L2*M3+LC2*M2)   L1*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,11)^2*(L2*M3+LC2*M2)+L1*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,12)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,11)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,12)*(L2*M3+LC2*M2)-2*L1*cos(x(T,1))*cos(x(T,2))*cos(x(T,3))*x(T,11)*x(T,12)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   γ   2*L1*x(T,11)*(L2*M3+LC2*M2)*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-2*L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,12)*(L2*M3+LC2*M2)   -2*L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,11)*(L2*M3+LC2*M2)-2*L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*x(T,12)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            L1*dx(T,10)*(L2*M3+LC2*M2)*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))-L1*x(T,10)^2*(L2*M3+LC2*M2)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))   sin(x(T,2))^2*x(T,12)^2*(J2+L2^2*M3+LC2^2*M2)-cos(x(T,2))^2*x(T,12)^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(x(T,2))*dx(T,20)+L2*cos(x(T,2))*dx(T,23)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,21)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,24)+L2*sin(x(T,2))*sin(x(T,3))*dx(T,19)+L2*sin(x(T,2))*sin(x(T,3))*dx(T,22)+L1*dx(T,10)*(L2*M3+LC2*M2)*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))+0.0*cos(x(T,3))*sin(x(T,2))*(L2*M3+LC2*M2)+L1*x(T,10)^2*(L2*M3+LC2*M2)*(cos(x(T,1))*cos(x(T,2))+cos(x(T,3))*sin(x(T,1))*sin(x(T,2)))   L2*cos(x(T,2))*sin(x(T,3))*dx(T,21)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,22)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,19)+L2*cos(x(T,2))*sin(x(T,3))*dx(T,24)+0.0*cos(x(T,2))*sin(x(T,3))*(L2*M3+LC2*M2)+L1*cos(x(T,2))*sin(x(T,1))*sin(x(T,3))*x(T,10)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,10)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*x(T,10)*(L2*M3+LC2*M2)*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))   γ   -2*cos(x(T,2))*sin(x(T,2))*x(T,12)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            L1*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)^2*(L2*M3+LC2*M2)+L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,10)*(L2*M3+LC2*M2)   L2*cos(x(T,2))*sin(x(T,3))*dx(T,21)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,22)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,19)+L2*cos(x(T,2))*sin(x(T,3))*dx(T,24)+2*cos(x(T,2))*sin(x(T,2))*dx(T,12)*(J2+L2^2*M3+LC2^2*M2)+2*cos(2*x(T,2))*x(T,11)*x(T,12)*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(x(T,2))*sin(x(T,3))*(L2*M3+LC2*M2)+L1*cos(x(T,2))*sin(x(T,1))*sin(x(T,3))*x(T,10)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,10)*(L2*M3+LC2*M2)   L2*cos(x(T,3))*sin(x(T,2))*dx(T,21)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,24)+L2*sin(x(T,2))*sin(x(T,3))*dx(T,19)+L2*sin(x(T,2))*sin(x(T,3))*dx(T,22)+0.0*cos(x(T,3))*sin(x(T,2))*(L2*M3+LC2*M2)+L1*cos(x(T,3))*sin(x(T,1))*sin(x(T,2))*x(T,10)^2*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,10)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)*(L2*M3+LC2*M2)   sin(2*x(T,2))*x(T,12)*(J2+L2^2*M3+LC2^2*M2)   γ+sin(2*x(T,2))*x(T,11)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0*sin(x(T,4))*(L1*(M2+M3)+LC1*M1)+(L1*cos(x(T,4))*dx(T,20))*0.5-L1*sin(x(T,4))*dx(T,21)+(sqrt(3)*L1*cos(x(T,4))*dx(T,19))*0.5+L1*dx(T,14)*(L2*M3+LC2*M2)*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))+L1*x(T,14)^2*(L2*M3+LC2*M2)*(cos(x(T,4))*cos(x(T,5))+cos(x(T,6))*sin(x(T,4))*sin(x(T,5)))+L1*cos(x(T,6))*sin(x(T,4))*sin(x(T,5))*x(T,15)^2*(L2*M3+LC2*M2)+L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,15)*(L2*M3+LC2*M2)+2*L1*cos(x(T,5))*sin(x(T,4))*sin(x(T,6))*x(T,14)*x(T,15)*(L2*M3+LC2*M2)   L1*dx(T,14)*(L2*M3+LC2*M2)*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-L1*x(T,14)^2*(L2*M3+LC2*M2)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))-L1*cos(x(T,4))*cos(x(T,5))*cos(x(T,6))*x(T,15)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,15)*(L2*M3+LC2*M2)+2*L1*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,14)*x(T,15)*(L2*M3+LC2*M2)   L1*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,14)^2*(L2*M3+LC2*M2)+L1*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,15)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,14)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,15)*(L2*M3+LC2*M2)-2*L1*cos(x(T,4))*cos(x(T,5))*cos(x(T,6))*x(T,14)*x(T,15)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   γ   2*L1*x(T,14)*(L2*M3+LC2*M2)*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-2*L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,15)*(L2*M3+LC2*M2)   -2*L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,14)*(L2*M3+LC2*M2)-2*L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*x(T,15)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   L1*dx(T,13)*(L2*M3+LC2*M2)*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))-L1*x(T,13)^2*(L2*M3+LC2*M2)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))   dx(T,19)*((sqrt(3)*L2*cos(x(T,5)))*0.5+(L2*sin(x(T,5))*sin(x(T,6)))*0.5)+dx(T,20)*((L2*cos(x(T,5)))*0.5-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6)))*0.5)-cos(x(T,5))^2*x(T,15)^2*(J2+L2^2*M3+LC2^2*M2)+sin(x(T,5))^2*x(T,15)^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(x(T,6))*sin(x(T,5))*dx(T,21)+L1*dx(T,13)*(L2*M3+LC2*M2)*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))+0.0*cos(x(T,6))*sin(x(T,5))*(L2*M3+LC2*M2)+L1*x(T,13)^2*(L2*M3+LC2*M2)*(cos(x(T,4))*cos(x(T,5))+cos(x(T,6))*sin(x(T,4))*sin(x(T,5)))   0.0*cos(x(T,5))*sin(x(T,6))*(L2*M3+LC2*M2)-L2*cos(x(T,5))*sin(x(T,6))*dx(T,21)-(L2*cos(x(T,5))*cos(x(T,6))*dx(T,19))*0.5+(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,20))*0.5+L1*cos(x(T,5))*sin(x(T,4))*sin(x(T,6))*x(T,13)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,13)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*x(T,13)*(L2*M3+LC2*M2)*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))   γ   -2*cos(x(T,5))*sin(x(T,5))*x(T,15)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   L1*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)^2*(L2*M3+LC2*M2)+L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,13)*(L2*M3+LC2*M2)   2*cos(x(T,5))*sin(x(T,5))*dx(T,15)*(J2+L2^2*M3+LC2^2*M2)-L2*cos(x(T,5))*sin(x(T,6))*dx(T,21)-(L2*cos(x(T,5))*cos(x(T,6))*dx(T,19))*0.5+2*cos(2*x(T,5))*x(T,14)*x(T,15)*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(x(T,5))*sin(x(T,6))*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,20))*0.5+L1*cos(x(T,5))*sin(x(T,4))*sin(x(T,6))*x(T,13)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,13)*(L2*M3+LC2*M2)   (L2*sin(x(T,5))*sin(x(T,6))*dx(T,19))*0.5-L2*cos(x(T,6))*sin(x(T,5))*dx(T,21)+0.0*cos(x(T,6))*sin(x(T,5))*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,20))*0.5+L1*cos(x(T,6))*sin(x(T,4))*sin(x(T,5))*x(T,13)^2*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,13)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)*(L2*M3+LC2*M2)   sin(2*x(T,5))*x(T,15)*(J2+L2^2*M3+LC2^2*M2)   γ+sin(2*x(T,5))*x(T,14)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0*sin(x(T,7))*(L1*(M2+M3)+LC1*M1)+(L1*cos(x(T,7))*dx(T,23))*0.5-L1*sin(x(T,7))*dx(T,24)-(sqrt(3)*L1*cos(x(T,7))*dx(T,22))*0.5+L1*dx(T,17)*(L2*M3+LC2*M2)*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))+L1*x(T,17)^2*(L2*M3+LC2*M2)*(cos(x(T,7))*cos(x(T,8))+cos(x(T,9))*sin(x(T,7))*sin(x(T,8)))+L1*cos(x(T,9))*sin(x(T,7))*sin(x(T,8))*x(T,18)^2*(L2*M3+LC2*M2)+L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,18)*(L2*M3+LC2*M2)+2*L1*cos(x(T,8))*sin(x(T,7))*sin(x(T,9))*x(T,17)*x(T,18)*(L2*M3+LC2*M2)   L1*dx(T,17)*(L2*M3+LC2*M2)*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-L1*x(T,17)^2*(L2*M3+LC2*M2)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))-L1*cos(x(T,7))*cos(x(T,8))*cos(x(T,9))*x(T,18)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,18)*(L2*M3+LC2*M2)+2*L1*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,17)*x(T,18)*(L2*M3+LC2*M2)   L1*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,17)^2*(L2*M3+LC2*M2)+L1*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,18)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,17)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,18)*(L2*M3+LC2*M2)-2*L1*cos(x(T,7))*cos(x(T,8))*cos(x(T,9))*x(T,17)*x(T,18)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   γ   2*L1*x(T,17)*(L2*M3+LC2*M2)*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-2*L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,18)*(L2*M3+LC2*M2)   -2*L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,17)*(L2*M3+LC2*M2)-2*L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*x(T,18)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*dx(T,16)*(L2*M3+LC2*M2)*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))-L1*x(T,16)^2*(L2*M3+LC2*M2)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))   dx(T,23)*((L2*cos(x(T,8)))*0.5+(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9)))*0.5)-dx(T,22)*((sqrt(3)*L2*cos(x(T,8)))*0.5-(L2*sin(x(T,8))*sin(x(T,9)))*0.5)-cos(x(T,8))^2*x(T,18)^2*(J2+L2^2*M3+LC2^2*M2)+sin(x(T,8))^2*x(T,18)^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(x(T,9))*sin(x(T,8))*dx(T,24)+L1*dx(T,16)*(L2*M3+LC2*M2)*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))+0.0*cos(x(T,9))*sin(x(T,8))*(L2*M3+LC2*M2)+L1*x(T,16)^2*(L2*M3+LC2*M2)*(cos(x(T,7))*cos(x(T,8))+cos(x(T,9))*sin(x(T,7))*sin(x(T,8)))   0.0*cos(x(T,8))*sin(x(T,9))*(L2*M3+LC2*M2)-L2*cos(x(T,8))*sin(x(T,9))*dx(T,24)-(L2*cos(x(T,8))*cos(x(T,9))*dx(T,22))*0.5-(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,23))*0.5+L1*cos(x(T,8))*sin(x(T,7))*sin(x(T,9))*x(T,16)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,16)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*x(T,16)*(L2*M3+LC2*M2)*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))   γ   -2*cos(x(T,8))*sin(x(T,8))*x(T,18)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)^2*(L2*M3+LC2*M2)+L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,16)*(L2*M3+LC2*M2)   2*cos(x(T,8))*sin(x(T,8))*dx(T,18)*(J2+L2^2*M3+LC2^2*M2)-L2*cos(x(T,8))*sin(x(T,9))*dx(T,24)-(L2*cos(x(T,8))*cos(x(T,9))*dx(T,22))*0.5+2*cos(2*x(T,8))*x(T,17)*x(T,18)*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(x(T,8))*sin(x(T,9))*(L2*M3+LC2*M2)-(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,23))*0.5+L1*cos(x(T,8))*sin(x(T,7))*sin(x(T,9))*x(T,16)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,16)*(L2*M3+LC2*M2)   (L2*sin(x(T,8))*sin(x(T,9))*dx(T,22))*0.5-L2*cos(x(T,9))*sin(x(T,8))*dx(T,24)+0.0*cos(x(T,9))*sin(x(T,8))*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,23))*0.5+L1*cos(x(T,9))*sin(x(T,7))*sin(x(T,8))*x(T,16)^2*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,16)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   2*L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)*(L2*M3+LC2*M2)   sin(2*x(T,8))*x(T,18)*(J2+L2^2*M3+LC2^2*M2)   γ+sin(2*x(T,8))*x(T,17)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*sin(x(T,3))   L2*cos(x(T,3))*sin(x(T,2))   -(sqrt(3)*L1*sin(x(T,4)))*0.5   (L2*cos(x(T,5))*sin(x(T,6)))*0.5-(sqrt(3)*L2*sin(x(T,5)))*0.5   (L2*cos(x(T,6))*sin(x(T,5)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*sin(x(T,1))   -L2*sin(x(T,2))   0.0   -(L1*sin(x(T,4)))*0.5   -(L2*sin(x(T,5)))*0.5-(sqrt(3)*L2*cos(x(T,5))*sin(x(T,6)))*0.5   -(sqrt(3)*L2*cos(x(T,6))*sin(x(T,5)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            L1*cos(x(T,1))   L2*cos(x(T,2))*cos(x(T,3))   -L2*sin(x(T,2))*sin(x(T,3))   -L1*cos(x(T,4))   -L2*cos(x(T,5))*cos(x(T,6))   L2*sin(x(T,5))*sin(x(T,6))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*sin(x(T,3))   L2*cos(x(T,3))*sin(x(T,2))   0.0   0.0   0.0   (sqrt(3)*L1*sin(x(T,7)))*0.5   (L2*cos(x(T,8))*sin(x(T,9)))*0.5+(sqrt(3)*L2*sin(x(T,8)))*0.5   (L2*cos(x(T,9))*sin(x(T,8)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*sin(x(T,1))   -L2*sin(x(T,2))   0.0   0.0   0.0   0.0   -(L1*sin(x(T,7)))*0.5   (sqrt(3)*L2*cos(x(T,8))*sin(x(T,9)))*0.5-(L2*sin(x(T,8)))*0.5   (sqrt(3)*L2*cos(x(T,9))*sin(x(T,8)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            L1*cos(x(T,1))   L2*cos(x(T,2))*cos(x(T,3))   -L2*sin(x(T,2))*sin(x(T,3))   0.0   0.0   0.0   -L1*cos(x(T,7))   -L2*cos(x(T,8))*cos(x(T,9))   L2*sin(x(T,8))*sin(x(T,9))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*cos(x(T,3))*x(T,12)-L2*sin(x(T,2))*sin(x(T,3))*x(T,11)   L2*cos(x(T,2))*cos(x(T,3))*x(T,11)-L2*sin(x(T,2))*sin(x(T,3))*x(T,12)   -(sqrt(3)*L1*cos(x(T,4))*x(T,13))*0.5   (L2*cos(x(T,5))*cos(x(T,6))*x(T,15))*0.5-(sqrt(3)*L2*cos(x(T,5))*x(T,14))*0.5-(L2*sin(x(T,5))*sin(x(T,6))*x(T,14))*0.5   (L2*cos(x(T,5))*cos(x(T,6))*x(T,14))*0.5-(L2*sin(x(T,5))*sin(x(T,6))*x(T,15))*0.5   0.0   0.0   0.0   0.0   L2*cos(x(T,2))*sin(x(T,3))   L2*cos(x(T,3))*sin(x(T,2))   -(sqrt(3)*L1*sin(x(T,4)))*0.5   (L2*cos(x(T,5))*sin(x(T,6)))*0.5-(sqrt(3)*L2*sin(x(T,5)))*0.5   (L2*cos(x(T,6))*sin(x(T,5)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*cos(x(T,1))*x(T,10)   -L2*cos(x(T,2))*x(T,11)   0.0   -(L1*cos(x(T,4))*x(T,13))*0.5   (sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*x(T,14))*0.5-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*x(T,15))*0.5-(L2*cos(x(T,5))*x(T,14))*0.5   (sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*x(T,15))*0.5-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*x(T,14))*0.5   0.0   0.0   0.0   -L1*sin(x(T,1))   -L2*sin(x(T,2))   0.0   -(L1*sin(x(T,4)))*0.5   -(L2*sin(x(T,5)))*0.5-(sqrt(3)*L2*cos(x(T,5))*sin(x(T,6)))*0.5   -(sqrt(3)*L2*cos(x(T,6))*sin(x(T,5)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*sin(x(T,1))*x(T,10)   -L2*cos(x(T,3))*sin(x(T,2))*x(T,11)-L2*cos(x(T,2))*sin(x(T,3))*x(T,12)   -L2*cos(x(T,2))*sin(x(T,3))*x(T,11)-L2*cos(x(T,3))*sin(x(T,2))*x(T,12)   L1*sin(x(T,4))*x(T,13)   L2*cos(x(T,6))*sin(x(T,5))*x(T,14)+L2*cos(x(T,5))*sin(x(T,6))*x(T,15)   L2*cos(x(T,5))*sin(x(T,6))*x(T,14)+L2*cos(x(T,6))*sin(x(T,5))*x(T,15)   0.0   0.0   0.0   L1*cos(x(T,1))   L2*cos(x(T,2))*cos(x(T,3))   -L2*sin(x(T,2))*sin(x(T,3))   -L1*cos(x(T,4))   -L2*cos(x(T,5))*cos(x(T,6))   L2*sin(x(T,5))*sin(x(T,6))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   L2*cos(x(T,2))*cos(x(T,3))*x(T,12)-L2*sin(x(T,2))*sin(x(T,3))*x(T,11)   L2*cos(x(T,2))*cos(x(T,3))*x(T,11)-L2*sin(x(T,2))*sin(x(T,3))*x(T,12)   0.0   0.0   0.0   (sqrt(3)*L1*cos(x(T,7))*x(T,16))*0.5   (L2*cos(x(T,8))*cos(x(T,9))*x(T,18))*0.5+(sqrt(3)*L2*cos(x(T,8))*x(T,17))*0.5-(L2*sin(x(T,8))*sin(x(T,9))*x(T,17))*0.5   (L2*cos(x(T,8))*cos(x(T,9))*x(T,17))*0.5-(L2*sin(x(T,8))*sin(x(T,9))*x(T,18))*0.5   0.0   L2*cos(x(T,2))*sin(x(T,3))   L2*cos(x(T,3))*sin(x(T,2))   0.0   0.0   0.0   (sqrt(3)*L1*sin(x(T,7)))*0.5   (L2*cos(x(T,8))*sin(x(T,9)))*0.5+(sqrt(3)*L2*sin(x(T,8)))*0.5   (L2*cos(x(T,9))*sin(x(T,8)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*cos(x(T,1))*x(T,10)   -L2*cos(x(T,2))*x(T,11)   0.0   0.0   0.0   0.0   -(L1*cos(x(T,7))*x(T,16))*0.5   (sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*x(T,18))*0.5-(L2*cos(x(T,8))*x(T,17))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*x(T,17))*0.5   (sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*x(T,17))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*x(T,18))*0.5   -L1*sin(x(T,1))   -L2*sin(x(T,2))   0.0   0.0   0.0   0.0   -(L1*sin(x(T,7)))*0.5   (sqrt(3)*L2*cos(x(T,8))*sin(x(T,9)))*0.5-(L2*sin(x(T,8)))*0.5   (sqrt(3)*L2*cos(x(T,9))*sin(x(T,8)))*0.5   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            -L1*sin(x(T,1))*x(T,10)   -L2*cos(x(T,3))*sin(x(T,2))*x(T,11)-L2*cos(x(T,2))*sin(x(T,3))*x(T,12)   -L2*cos(x(T,2))*sin(x(T,3))*x(T,11)-L2*cos(x(T,3))*sin(x(T,2))*x(T,12)   0.0   0.0   0.0   L1*sin(x(T,7))*x(T,16)   L2*cos(x(T,9))*sin(x(T,8))*x(T,17)+L2*cos(x(T,8))*sin(x(T,9))*x(T,18)   L2*cos(x(T,8))*sin(x(T,9))*x(T,17)+L2*cos(x(T,9))*sin(x(T,8))*x(T,18)   L1*cos(x(T,1))   L2*cos(x(T,2))*cos(x(T,3))   -L2*sin(x(T,2))*sin(x(T,3))   0.0   0.0   0.0   -L1*cos(x(T,7))   -L2*cos(x(T,8))*cos(x(T,9))   L2*sin(x(T,8))*sin(x(T,9))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   -L2*cos(x(T,2))*sin(x(T,3))   -L2*cos(x(T,3))*sin(x(T,2))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0
            L1*sin(x(T,1))   L2*sin(x(T,2))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0
            -L1*cos(x(T,1))   -L2*cos(x(T,2))*cos(x(T,3))   L2*sin(x(T,2))*sin(x(T,3))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0]
        Fdx = t -> [
            1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*sin(x(t,1))   L1*cos(x(t,1))   0.0   -L1*sin(x(t,1))   L1*cos(x(t,1))   0.0   0.0   0.0
            0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*cos(x(t,2))*sin(x(t,3))   -L2*sin(x(t,2))   L2*cos(x(t,2))*cos(x(t,3))   L2*cos(x(t,2))*sin(x(t,3))   -L2*sin(x(t,2))   L2*cos(x(t,2))*cos(x(t,3))   0.0   0.0   0.0
            0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*cos(x(t,3))*sin(x(t,2))   0.0   -L2*sin(x(t,2))*sin(x(t,3))   L2*cos(x(t,3))*sin(x(t,2))   0.0   -L2*sin(x(t,2))*sin(x(t,3))   0.0   0.0   0.0
            0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -(sqrt(3)*L1*sin(x(t,4)))*0.5   -(L1*sin(x(t,4)))*0.5   -L1*cos(x(t,4))   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(t,5))*sin(x(t,6)))*0.5-(sqrt(3)*L2*sin(x(t,5)))*0.5   -(L2*sin(x(t,5)))*0.5-(sqrt(3)*L2*cos(x(t,5))*sin(x(t,6)))*0.5   -L2*cos(x(t,5))*cos(x(t,6))   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(t,6))*sin(x(t,5)))*0.5   -(sqrt(3)*L2*cos(x(t,6))*sin(x(t,5)))*0.5   L2*sin(x(t,5))*sin(x(t,6))   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (sqrt(3)*L1*sin(x(t,7)))*0.5   -(L1*sin(x(t,7)))*0.5   -L1*cos(x(t,7))   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(t,8))*sin(x(t,9)))*0.5+(sqrt(3)*L2*sin(x(t,8)))*0.5   (sqrt(3)*L2*cos(x(t,8))*sin(x(t,9)))*0.5-(L2*sin(x(t,8)))*0.5   -L2*cos(x(t,8))*cos(x(t,9))   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   1.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(t,9))*sin(x(t,8)))*0.5   (sqrt(3)*L2*cos(x(t,9))*sin(x(t,8)))*0.5   L2*sin(x(t,8))*sin(x(t,9))   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   J1+L1^2*(M2+M3)+LC1^2*M1   L1*(L2*M3+LC2*M2)*(sin(x(t,1))*sin(x(t,2))+cos(x(t,1))*cos(x(t,2))*cos(x(t,3)))   -L1*cos(x(t,1))*sin(x(t,2))*sin(x(t,3))*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(t,1))   -L1*cos(x(t,1))   0.0   L1*sin(x(t,1))   -L1*cos(x(t,1))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*(L2*M3+LC2*M2)*(sin(x(t,1))*sin(x(t,2))+cos(x(t,1))*cos(x(t,2))*cos(x(t,3)))   J2+L2^2*M3+LC2^2*M2   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L2*cos(x(t,2))*sin(x(t,3))   L2*sin(x(t,2))   -L2*cos(x(t,2))*cos(x(t,3))   -L2*cos(x(t,2))*sin(x(t,3))   L2*sin(x(t,2))   -L2*cos(x(t,2))*cos(x(t,3))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*cos(x(t,1))*sin(x(t,2))*sin(x(t,3))*(L2*M3+LC2*M2)   0.0   sin(x(t,2))^2*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   -L2*cos(x(t,3))*sin(x(t,2))   0.0   L2*sin(x(t,2))*sin(x(t,3))   -L2*cos(x(t,3))*sin(x(t,2))   0.0   L2*sin(x(t,2))*sin(x(t,3))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   J1+L1^2*(M2+M3)+LC1^2*M1   L1*(L2*M3+LC2*M2)*(sin(x(t,4))*sin(x(t,5))+cos(x(t,4))*cos(x(t,5))*cos(x(t,6)))   -L1*cos(x(t,4))*sin(x(t,5))*sin(x(t,6))*(L2*M3+LC2*M2)   0.0   0.0   0.0   (sqrt(3)*L1*sin(x(t,4)))*0.5   (L1*sin(x(t,4)))*0.5   L1*cos(x(t,4))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*(L2*M3+LC2*M2)*(sin(x(t,4))*sin(x(t,5))+cos(x(t,4))*cos(x(t,5))*cos(x(t,6)))   J2+L2^2*M3+LC2^2*M2   0.0   0.0   0.0   0.0   (sqrt(3)*L2*sin(x(t,5)))*0.5-(L2*cos(x(t,5))*sin(x(t,6)))*0.5   (L2*sin(x(t,5)))*0.5+(sqrt(3)*L2*cos(x(t,5))*sin(x(t,6)))*0.5   L2*cos(x(t,5))*cos(x(t,6))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*cos(x(t,4))*sin(x(t,5))*sin(x(t,6))*(L2*M3+LC2*M2)   0.0   sin(x(t,5))^2*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   -(L2*cos(x(t,6))*sin(x(t,5)))*0.5   (sqrt(3)*L2*cos(x(t,6))*sin(x(t,5)))*0.5   -L2*sin(x(t,5))*sin(x(t,6))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   J1+L1^2*(M2+M3)+LC1^2*M1   L1*(L2*M3+LC2*M2)*(sin(x(t,7))*sin(x(t,8))+cos(x(t,7))*cos(x(t,8))*cos(x(t,9)))   -L1*cos(x(t,7))*sin(x(t,8))*sin(x(t,9))*(L2*M3+LC2*M2)   0.0   0.0   0.0   -(sqrt(3)*L1*sin(x(t,7)))*0.5   (L1*sin(x(t,7)))*0.5   L1*cos(x(t,7))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*(L2*M3+LC2*M2)*(sin(x(t,7))*sin(x(t,8))+cos(x(t,7))*cos(x(t,8))*cos(x(t,9)))   J2+L2^2*M3+LC2^2*M2   0.0   0.0   0.0   0.0   -(L2*cos(x(t,8))*sin(x(t,9)))*0.5-(sqrt(3)*L2*sin(x(t,8)))*0.5   (L2*sin(x(t,8)))*0.5-(sqrt(3)*L2*cos(x(t,8))*sin(x(t,9)))*0.5   L2*cos(x(t,8))*cos(x(t,9))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*cos(x(t,7))*sin(x(t,8))*sin(x(t,9))*(L2*M3+LC2*M2)   0.0   sin(x(t,8))^2*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   -(L2*cos(x(t,9))*sin(x(t,8)))*0.5   -(sqrt(3)*L2*cos(x(t,9))*sin(x(t,8)))*0.5   -L2*sin(x(t,8))*sin(x(t,9))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0]
        dFdxT = [
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*cos(x(T,1))*dx(T,1)   -L1*sin(x(T,1))*dx(T,1)   0.0   -L1*cos(x(T,1))*dx(T,1)   -L1*sin(x(T,1))*dx(T,1)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*cos(x(T,2))*cos(x(T,3))*dx(T,3)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,2)   -L2*cos(x(T,2))*dx(T,2)   -L2*cos(x(T,3))*sin(x(T,2))*dx(T,2)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,3)   L2*cos(x(T,2))*cos(x(T,3))*dx(T,3)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,2)   -L2*cos(x(T,2))*dx(T,2)   -L2*cos(x(T,3))*sin(x(T,2))*dx(T,2)-L2*cos(x(T,2))*sin(x(T,3))*dx(T,3)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*cos(x(T,2))*cos(x(T,3))*dx(T,2)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,3)   0.0   -L2*cos(x(T,2))*sin(x(T,3))*dx(T,2)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,3)   L2*cos(x(T,2))*cos(x(T,3))*dx(T,2)-L2*sin(x(T,2))*sin(x(T,3))*dx(T,3)   0.0   -L2*cos(x(T,2))*sin(x(T,3))*dx(T,2)-L2*cos(x(T,3))*sin(x(T,2))*dx(T,3)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -(sqrt(3)*L1*cos(x(T,4))*dx(T,4))*0.5   -(L1*cos(x(T,4))*dx(T,4))*0.5   L1*sin(x(T,4))*dx(T,4)   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,5))*cos(x(T,6))*dx(T,6))*0.5-(sqrt(3)*L2*cos(x(T,5))*dx(T,5))*0.5-(L2*sin(x(T,5))*sin(x(T,6))*dx(T,5))*0.5   (sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,5))*0.5-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,6))*0.5-(L2*cos(x(T,5))*dx(T,5))*0.5   L2*cos(x(T,6))*sin(x(T,5))*dx(T,5)+L2*cos(x(T,5))*sin(x(T,6))*dx(T,6)   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,5))*cos(x(T,6))*dx(T,5))*0.5-(L2*sin(x(T,5))*sin(x(T,6))*dx(T,6))*0.5   (sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,6))*0.5-(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,5))*0.5   L2*cos(x(T,5))*sin(x(T,6))*dx(T,5)+L2*cos(x(T,6))*sin(x(T,5))*dx(T,6)   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (sqrt(3)*L1*cos(x(T,7))*dx(T,7))*0.5   -(L1*cos(x(T,7))*dx(T,7))*0.5   L1*sin(x(T,7))*dx(T,7)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,8))*cos(x(T,9))*dx(T,9))*0.5+(sqrt(3)*L2*cos(x(T,8))*dx(T,8))*0.5-(L2*sin(x(T,8))*sin(x(T,9))*dx(T,8))*0.5   (sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,9))*0.5-(L2*cos(x(T,8))*dx(T,8))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,8))*0.5   L2*cos(x(T,9))*sin(x(T,8))*dx(T,8)+L2*cos(x(T,8))*sin(x(T,9))*dx(T,9)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   (L2*cos(x(T,8))*cos(x(T,9))*dx(T,8))*0.5-(L2*sin(x(T,8))*sin(x(T,9))*dx(T,9))*0.5   (sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,8))*0.5-(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,9))*0.5   L2*cos(x(T,8))*sin(x(T,9))*dx(T,8)+L2*cos(x(T,9))*sin(x(T,8))*dx(T,9)   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,2))*cos(x(T,3))*sin(x(T,1))*dx(T,1)-cos(x(T,2))*sin(x(T,1))*dx(T,2)-cos(x(T,1))*sin(x(T,2))*dx(T,1)+cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,2)+cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,3))   L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,1)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,3)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,2)*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*cos(x(T,1))*dx(T,1)   L1*sin(x(T,1))*dx(T,1)   0.0   L1*cos(x(T,1))*dx(T,1)   L1*sin(x(T,1))*dx(T,1)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,2))*cos(x(T,3))*sin(x(T,1))*dx(T,1)-cos(x(T,2))*sin(x(T,1))*dx(T,2)-cos(x(T,1))*sin(x(T,2))*dx(T,1)+cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,2)+cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,3))   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L2*sin(x(T,2))*sin(x(T,3))*dx(T,2)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,3)   L2*cos(x(T,2))*dx(T,2)   L2*cos(x(T,3))*sin(x(T,2))*dx(T,2)+L2*cos(x(T,2))*sin(x(T,3))*dx(T,3)   L2*sin(x(T,2))*sin(x(T,3))*dx(T,2)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,3)   L2*cos(x(T,2))*dx(T,2)   L2*cos(x(T,3))*sin(x(T,2))*dx(T,2)+L2*cos(x(T,2))*sin(x(T,3))*dx(T,3)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,1)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*dx(T,3)*(L2*M3+LC2*M2)-L1*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*dx(T,2)*(L2*M3+LC2*M2)   0.0   2*cos(x(T,2))*sin(x(T,2))*dx(T,2)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   L2*sin(x(T,2))*sin(x(T,3))*dx(T,3)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,2)   0.0   L2*cos(x(T,2))*sin(x(T,3))*dx(T,2)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,3)   L2*sin(x(T,2))*sin(x(T,3))*dx(T,3)-L2*cos(x(T,2))*cos(x(T,3))*dx(T,2)   0.0   L2*cos(x(T,2))*sin(x(T,3))*dx(T,2)+L2*cos(x(T,3))*sin(x(T,2))*dx(T,3)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,5))*cos(x(T,6))*sin(x(T,4))*dx(T,4)-cos(x(T,5))*sin(x(T,4))*dx(T,5)-cos(x(T,4))*sin(x(T,5))*dx(T,4)+cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,5)+cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,6))   L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,4)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,6)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,5)*(L2*M3+LC2*M2)   0.0   0.0   0.0   (sqrt(3)*L1*cos(x(T,4))*dx(T,4))*0.5   (L1*cos(x(T,4))*dx(T,4))*0.5   -L1*sin(x(T,4))*dx(T,4)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,5))*cos(x(T,6))*sin(x(T,4))*dx(T,4)-cos(x(T,5))*sin(x(T,4))*dx(T,5)-cos(x(T,4))*sin(x(T,5))*dx(T,4)+cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,5)+cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,6))   0.0   0.0   0.0   0.0   0.0   (sqrt(3)*L2*cos(x(T,5))*dx(T,5))*0.5-(L2*cos(x(T,5))*cos(x(T,6))*dx(T,6))*0.5+(L2*sin(x(T,5))*sin(x(T,6))*dx(T,5))*0.5   (L2*cos(x(T,5))*dx(T,5))*0.5+(sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,6))*0.5-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,5))*0.5   -L2*cos(x(T,6))*sin(x(T,5))*dx(T,5)-L2*cos(x(T,5))*sin(x(T,6))*dx(T,6)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,4)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*dx(T,6)*(L2*M3+LC2*M2)-L1*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*dx(T,5)*(L2*M3+LC2*M2)   0.0   2*cos(x(T,5))*sin(x(T,5))*dx(T,5)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   (L2*sin(x(T,5))*sin(x(T,6))*dx(T,6))*0.5-(L2*cos(x(T,5))*cos(x(T,6))*dx(T,5))*0.5   (sqrt(3)*L2*cos(x(T,5))*cos(x(T,6))*dx(T,5))*0.5-(sqrt(3)*L2*sin(x(T,5))*sin(x(T,6))*dx(T,6))*0.5   -L2*cos(x(T,5))*sin(x(T,6))*dx(T,5)-L2*cos(x(T,6))*sin(x(T,5))*dx(T,6)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,8))*cos(x(T,9))*sin(x(T,7))*dx(T,7)-cos(x(T,8))*sin(x(T,7))*dx(T,8)-cos(x(T,7))*sin(x(T,8))*dx(T,7)+cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,8)+cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,9))   L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,7)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,9)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,8)*(L2*M3+LC2*M2)   0.0   0.0   0.0   -(sqrt(3)*L1*cos(x(T,7))*dx(T,7))*0.5   (L1*cos(x(T,7))*dx(T,7))*0.5   -L1*sin(x(T,7))*dx(T,7)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -L1*(L2*M3+LC2*M2)*(cos(x(T,8))*cos(x(T,9))*sin(x(T,7))*dx(T,7)-cos(x(T,8))*sin(x(T,7))*dx(T,8)-cos(x(T,7))*sin(x(T,8))*dx(T,7)+cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,8)+cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,9))   0.0   0.0   0.0   0.0   0.0   (L2*sin(x(T,8))*sin(x(T,9))*dx(T,8))*0.5-(sqrt(3)*L2*cos(x(T,8))*dx(T,8))*0.5-(L2*cos(x(T,8))*cos(x(T,9))*dx(T,9))*0.5   (L2*cos(x(T,8))*dx(T,8))*0.5-(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,9))*0.5+(sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,8))*0.5   -L2*cos(x(T,9))*sin(x(T,8))*dx(T,8)-L2*cos(x(T,8))*sin(x(T,9))*dx(T,9)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,7)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*dx(T,9)*(L2*M3+LC2*M2)-L1*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*dx(T,8)*(L2*M3+LC2*M2)   0.0   2*cos(x(T,8))*sin(x(T,8))*dx(T,8)*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   (L2*sin(x(T,8))*sin(x(T,9))*dx(T,9))*0.5-(L2*cos(x(T,8))*cos(x(T,9))*dx(T,8))*0.5   (sqrt(3)*L2*sin(x(T,8))*sin(x(T,9))*dx(T,9))*0.5-(sqrt(3)*L2*cos(x(T,8))*cos(x(T,9))*dx(T,8))*0.5   -L2*cos(x(T,8))*sin(x(T,9))*dx(T,8)-L2*cos(x(T,9))*sin(x(T,8))*dx(T,9)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0]
        Fw(t) = begin
            wt = w(t)
            vcat(zeros(9,3), [
                -2wt[1]   0.0     0.0
                0.0         0.0     0.0
                0.0         0.0     0.0
                0.0     -2wt[2]   0.0
                0.0         0.0     0.0
                0.0         0.0     -2wt[3]
                0.0         0.0     0.0
                0.0         0.0     0.0
                0.0         0.0     0.0
            ], zeros(15,3))
        end
        FθT = [ 0.0	cos(x(T,1))*dx(T,27)+cos(x(T,1))*dx(T,30)-sin(x(T,1))*dx(T,26)-sin(x(T,1))*dx(T,29)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	cos(x(T,2))*cos(x(T,3))*dx(T,27)-sin(x(T,2))*dx(T,29)-sin(x(T,2))*dx(T,26)+cos(x(T,2))*cos(x(T,3))*dx(T,30)+cos(x(T,2))*sin(x(T,3))*dx(T,25)+cos(x(T,2))*sin(x(T,3))*dx(T,28)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	cos(x(T,3))*sin(x(T,2))*dx(T,25)+cos(x(T,3))*sin(x(T,2))*dx(T,28)-sin(x(T,2))*sin(x(T,3))*dx(T,27)-sin(x(T,2))*sin(x(T,3))*dx(T,30)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	-cos(x(T,4))*dx(T,27)-(sin(x(T,4))*dx(T,26))*0.5-(sqrt(3)*sin(x(T,4))*dx(T,25))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	dx(T,25)*((cos(x(T,5))*sin(x(T,6)))*0.5-(sqrt(3)*sin(x(T,5)))*0.5)-dx(T,26)*(sin(x(T,5))*0.5+(sqrt(3)*cos(x(T,5))*sin(x(T,6)))*0.5)-cos(x(T,5))*cos(x(T,6))*dx(T,27)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	(cos(x(T,6))*sin(x(T,5))*dx(T,25))*0.5+sin(x(T,5))*sin(x(T,6))*dx(T,27)-(sqrt(3)*cos(x(T,6))*sin(x(T,5))*dx(T,26))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	(sqrt(3)*sin(x(T,7))*dx(T,28))*0.5-(sin(x(T,7))*dx(T,29))*0.5-cos(x(T,7))*dx(T,30)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	dx(T,28)*((cos(x(T,8))*sin(x(T,9)))*0.5+(sqrt(3)*sin(x(T,8)))*0.5)-dx(T,29)*(sin(x(T,8))*0.5-(sqrt(3)*cos(x(T,8))*sin(x(T,9)))*0.5)-cos(x(T,8))*cos(x(T,9))*dx(T,30)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	(cos(x(T,9))*sin(x(T,8))*dx(T,28))*0.5+sin(x(T,8))*sin(x(T,9))*dx(T,30)+(sqrt(3)*cos(x(T,9))*sin(x(T,8))*dx(T,29))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	sin(x(T,1))*dx(T,20)-cos(x(T,1))*dx(T,24)-cos(x(T,1))*dx(T,21)+sin(x(T,1))*dx(T,23)-g*cos(x(T,1))*(M2+M3)+dx(T,11)*(L2*M3+LC2*M2)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))+2*L1*dx(T,10)*(M2+M3)+x(T,11)^2*(L2*M3+LC2*M2)*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,12)*(L2*M3+LC2*M2)-cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*x(T,12)^2*(L2*M3+LC2*M2)-2*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,11)*x(T,12)*(L2*M3+LC2*M2)	L1*M3*dx(T,11)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))+L1*M3*x(T,11)^2*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-L1*M3*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*x(T,12)^2-L1*M3*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,12)-2*L1*M3*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,11)*x(T,12)	0.0	2*LC1*M1*dx(T,10)-M1*g*cos(x(T,1))	L1*M2*dx(T,11)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))+L1*M2*x(T,11)^2*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-L1*M2*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*x(T,12)^2-L1*M2*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,12)-2*L1*M2*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,11)*x(T,12)	LC1^2*dx(T,10)-LC1*g*cos(x(T,1))	L1^2*dx(T,10)-L1*g*cos(x(T,1))+L1*LC2*dx(T,11)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))+L1*LC2*x(T,11)^2*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-L1*LC2*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*x(T,12)^2-L1*LC2*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,12)-2*L1*LC2*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,11)*x(T,12)	L1^2*dx(T,10)-L1*g*cos(x(T,1))+L1*L2*dx(T,11)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))+L1*L2*x(T,11)^2*(cos(x(T,2))*sin(x(T,1))-cos(x(T,1))*cos(x(T,3))*sin(x(T,2)))-L1*L2*cos(x(T,1))*cos(x(T,3))*sin(x(T,2))*x(T,12)^2-L1*L2*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,12)-2*L1*L2*cos(x(T,1))*cos(x(T,2))*sin(x(T,3))*x(T,11)*x(T,12)	dx(T,10)	0.0	x(T,10)
                0.0	dx(T,10)*(L2*M3+LC2*M2)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))+x(T,10)^2*(L2*M3+LC2*M2)*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))	sin(x(T,2))*dx(T,20)+sin(x(T,2))*dx(T,23)-cos(x(T,2))*cos(x(T,3))*dx(T,21)-cos(x(T,2))*cos(x(T,3))*dx(T,24)+2*L2*M3*dx(T,11)-cos(x(T,2))*sin(x(T,3))*dx(T,19)-cos(x(T,2))*sin(x(T,3))*dx(T,22)+L1*M3*dx(T,10)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))-M3*g*cos(x(T,2))*cos(x(T,3))+L1*M3*x(T,10)^2*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))-2*L2*M3*cos(x(T,2))*sin(x(T,2))*x(T,12)^2	0.0	0.0	2*LC2*M2*dx(T,11)+L1*M2*dx(T,10)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))-M2*g*cos(x(T,2))*cos(x(T,3))+L1*M2*x(T,10)^2*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))-2*LC2*M2*cos(x(T,2))*sin(x(T,2))*x(T,12)^2	0.0	LC2^2*dx(T,11)+L1*LC2*dx(T,10)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))-LC2*g*cos(x(T,2))*cos(x(T,3))+L1*LC2*x(T,10)^2*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))-LC2^2*cos(x(T,2))*sin(x(T,2))*x(T,12)^2	L2^2*dx(T,11)+L1*L2*dx(T,10)*(sin(x(T,1))*sin(x(T,2))+cos(x(T,1))*cos(x(T,2))*cos(x(T,3)))-L2*g*cos(x(T,2))*cos(x(T,3))+L1*L2*x(T,10)^2*(cos(x(T,1))*sin(x(T,2))-cos(x(T,2))*cos(x(T,3))*sin(x(T,1)))-L2^2*cos(x(T,2))*sin(x(T,2))*x(T,12)^2	0.0	dx(T,11)-cos(x(T,2))*sin(x(T,2))*x(T,12)^2	x(T,11)
                0.0	sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)^2*(L2*M3+LC2*M2)-cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,10)*(L2*M3+LC2*M2)	sin(x(T,2))*sin(x(T,3))*dx(T,21)-cos(x(T,3))*sin(x(T,2))*dx(T,22)-cos(x(T,3))*sin(x(T,2))*dx(T,19)+sin(x(T,2))*sin(x(T,3))*dx(T,24)+2*L2*M3*sin(x(T,2))^2*dx(T,12)+M3*g*sin(x(T,2))*sin(x(T,3))+2*L2*M3*sin(2*x(T,2))*x(T,11)*x(T,12)+L1*M3*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)^2-L1*M3*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,10)	0.0	0.0	2*LC2*M2*sin(x(T,2))^2*dx(T,12)+M2*g*sin(x(T,2))*sin(x(T,3))+2*LC2*M2*sin(2*x(T,2))*x(T,11)*x(T,12)+L1*M2*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)^2-L1*M2*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,10)	0.0	LC2^2*sin(x(T,2))^2*dx(T,12)+LC2^2*sin(2*x(T,2))*x(T,11)*x(T,12)+LC2*g*sin(x(T,2))*sin(x(T,3))+L1*LC2*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)^2-L1*LC2*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,10)	L2^2*sin(x(T,2))^2*dx(T,12)+L2^2*sin(2*x(T,2))*x(T,11)*x(T,12)+L2*g*sin(x(T,2))*sin(x(T,3))+L1*L2*sin(x(T,1))*sin(x(T,2))*sin(x(T,3))*x(T,10)^2-L1*L2*cos(x(T,1))*sin(x(T,2))*sin(x(T,3))*dx(T,10)	0.0	sin(x(T,2))^2*dx(T,12)+sin(2*x(T,2))*x(T,11)*x(T,12)	x(T,12)
                0.0	cos(x(T,4))*dx(T,21)+(sin(x(T,4))*dx(T,20))*0.5-g*cos(x(T,4))*(M2+M3)+dx(T,14)*(L2*M3+LC2*M2)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))+2*L1*dx(T,13)*(M2+M3)+x(T,14)^2*(L2*M3+LC2*M2)*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))+(sqrt(3)*sin(x(T,4))*dx(T,19))*0.5-cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,15)*(L2*M3+LC2*M2)-cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*x(T,15)^2*(L2*M3+LC2*M2)-2*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,14)*x(T,15)*(L2*M3+LC2*M2)	L1*M3*dx(T,14)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))+L1*M3*x(T,14)^2*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-L1*M3*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*x(T,15)^2-L1*M3*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,15)-2*L1*M3*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,14)*x(T,15)	0.0	2*LC1*M1*dx(T,13)-M1*g*cos(x(T,4))	L1*M2*dx(T,14)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))+L1*M2*x(T,14)^2*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-L1*M2*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*x(T,15)^2-L1*M2*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,15)-2*L1*M2*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,14)*x(T,15)	LC1^2*dx(T,13)-LC1*g*cos(x(T,4))	L1^2*dx(T,13)-L1*g*cos(x(T,4))+L1*LC2*dx(T,14)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))+L1*LC2*x(T,14)^2*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-L1*LC2*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*x(T,15)^2-L1*LC2*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,15)-2*L1*LC2*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,14)*x(T,15)	L1^2*dx(T,13)-L1*g*cos(x(T,4))+L1*L2*dx(T,14)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))+L1*L2*x(T,14)^2*(cos(x(T,5))*sin(x(T,4))-cos(x(T,4))*cos(x(T,6))*sin(x(T,5)))-L1*L2*cos(x(T,4))*cos(x(T,6))*sin(x(T,5))*x(T,15)^2-L1*L2*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,15)-2*L1*L2*cos(x(T,4))*cos(x(T,5))*sin(x(T,6))*x(T,14)*x(T,15)	dx(T,13)	0.0	x(T,13)
                0.0	dx(T,13)*(L2*M3+LC2*M2)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))+x(T,13)^2*(L2*M3+LC2*M2)*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))	dx(T,20)*(sin(x(T,5))*0.5+(sqrt(3)*cos(x(T,5))*sin(x(T,6)))*0.5)-dx(T,19)*((cos(x(T,5))*sin(x(T,6)))*0.5-(sqrt(3)*sin(x(T,5)))*0.5)+cos(x(T,5))*cos(x(T,6))*dx(T,21)+2*L2*M3*dx(T,14)+L1*M3*dx(T,13)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))-M3*g*cos(x(T,5))*cos(x(T,6))+L1*M3*x(T,13)^2*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))-2*L2*M3*cos(x(T,5))*sin(x(T,5))*x(T,15)^2	0.0	0.0	2*LC2*M2*dx(T,14)+L1*M2*dx(T,13)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))-M2*g*cos(x(T,5))*cos(x(T,6))+L1*M2*x(T,13)^2*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))-2*LC2*M2*cos(x(T,5))*sin(x(T,5))*x(T,15)^2	0.0	LC2^2*dx(T,14)+L1*LC2*dx(T,13)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))-LC2*g*cos(x(T,5))*cos(x(T,6))+L1*LC2*x(T,13)^2*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))-LC2^2*cos(x(T,5))*sin(x(T,5))*x(T,15)^2	L2^2*dx(T,14)+L1*L2*dx(T,13)*(sin(x(T,4))*sin(x(T,5))+cos(x(T,4))*cos(x(T,5))*cos(x(T,6)))-L2*g*cos(x(T,5))*cos(x(T,6))+L1*L2*x(T,13)^2*(cos(x(T,4))*sin(x(T,5))-cos(x(T,5))*cos(x(T,6))*sin(x(T,4)))-L2^2*cos(x(T,5))*sin(x(T,5))*x(T,15)^2	0.0	dx(T,14)-cos(x(T,5))*sin(x(T,5))*x(T,15)^2	x(T,14)
                0.0	sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)^2*(L2*M3+LC2*M2)-cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,13)*(L2*M3+LC2*M2)	(sqrt(3)*cos(x(T,6))*sin(x(T,5))*dx(T,20))*0.5-sin(x(T,5))*sin(x(T,6))*dx(T,21)-(cos(x(T,6))*sin(x(T,5))*dx(T,19))*0.5+2*L2*M3*sin(x(T,5))^2*dx(T,15)+M3*g*sin(x(T,5))*sin(x(T,6))+2*L2*M3*sin(2*x(T,5))*x(T,14)*x(T,15)+L1*M3*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)^2-L1*M3*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,13)	0.0	0.0	2*LC2*M2*sin(x(T,5))^2*dx(T,15)+M2*g*sin(x(T,5))*sin(x(T,6))+2*LC2*M2*sin(2*x(T,5))*x(T,14)*x(T,15)+L1*M2*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)^2-L1*M2*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,13)	0.0	LC2^2*sin(x(T,5))^2*dx(T,15)+LC2^2*sin(2*x(T,5))*x(T,14)*x(T,15)+LC2*g*sin(x(T,5))*sin(x(T,6))+L1*LC2*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)^2-L1*LC2*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,13)	L2^2*sin(x(T,5))^2*dx(T,15)+L2^2*sin(2*x(T,5))*x(T,14)*x(T,15)+L2*g*sin(x(T,5))*sin(x(T,6))+L1*L2*sin(x(T,4))*sin(x(T,5))*sin(x(T,6))*x(T,13)^2-L1*L2*cos(x(T,4))*sin(x(T,5))*sin(x(T,6))*dx(T,13)	0.0	sin(x(T,5))^2*dx(T,15)+sin(2*x(T,5))*x(T,14)*x(T,15)	x(T,15)
                0.0	cos(x(T,7))*dx(T,24)+(sin(x(T,7))*dx(T,23))*0.5-g*cos(x(T,7))*(M2+M3)+dx(T,17)*(L2*M3+LC2*M2)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))+2*L1*dx(T,16)*(M2+M3)+x(T,17)^2*(L2*M3+LC2*M2)*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-(sqrt(3)*sin(x(T,7))*dx(T,22))*0.5-cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,18)*(L2*M3+LC2*M2)-cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*x(T,18)^2*(L2*M3+LC2*M2)-2*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,17)*x(T,18)*(L2*M3+LC2*M2)	L1*M3*dx(T,17)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))+L1*M3*x(T,17)^2*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-L1*M3*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*x(T,18)^2-L1*M3*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,18)-2*L1*M3*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,17)*x(T,18)	0.0	2*LC1*M1*dx(T,16)-M1*g*cos(x(T,7))	L1*M2*dx(T,17)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))+L1*M2*x(T,17)^2*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-L1*M2*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*x(T,18)^2-L1*M2*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,18)-2*L1*M2*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,17)*x(T,18)	LC1^2*dx(T,16)-LC1*g*cos(x(T,7))	L1^2*dx(T,16)-L1*g*cos(x(T,7))+L1*LC2*dx(T,17)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))+L1*LC2*x(T,17)^2*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-L1*LC2*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*x(T,18)^2-L1*LC2*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,18)-2*L1*LC2*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,17)*x(T,18)	L1^2*dx(T,16)-L1*g*cos(x(T,7))+L1*L2*dx(T,17)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))+L1*L2*x(T,17)^2*(cos(x(T,8))*sin(x(T,7))-cos(x(T,7))*cos(x(T,9))*sin(x(T,8)))-L1*L2*cos(x(T,7))*cos(x(T,9))*sin(x(T,8))*x(T,18)^2-L1*L2*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,18)-2*L1*L2*cos(x(T,7))*cos(x(T,8))*sin(x(T,9))*x(T,17)*x(T,18)	dx(T,16)	0.0	x(T,16)
                0.0	dx(T,16)*(L2*M3+LC2*M2)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))+x(T,16)^2*(L2*M3+LC2*M2)*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))	dx(T,23)*(sin(x(T,8))*0.5-(sqrt(3)*cos(x(T,8))*sin(x(T,9)))*0.5)-dx(T,22)*((cos(x(T,8))*sin(x(T,9)))*0.5+(sqrt(3)*sin(x(T,8)))*0.5)+cos(x(T,8))*cos(x(T,9))*dx(T,24)+2*L2*M3*dx(T,17)+L1*M3*dx(T,16)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))-M3*g*cos(x(T,8))*cos(x(T,9))+L1*M3*x(T,16)^2*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))-2*L2*M3*cos(x(T,8))*sin(x(T,8))*x(T,18)^2	0.0	0.0	2*LC2*M2*dx(T,17)+L1*M2*dx(T,16)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))-M2*g*cos(x(T,8))*cos(x(T,9))+L1*M2*x(T,16)^2*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))-2*LC2*M2*cos(x(T,8))*sin(x(T,8))*x(T,18)^2	0.0	LC2^2*dx(T,17)+L1*LC2*dx(T,16)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))-LC2*g*cos(x(T,8))*cos(x(T,9))+L1*LC2*x(T,16)^2*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))-LC2^2*cos(x(T,8))*sin(x(T,8))*x(T,18)^2	L2^2*dx(T,17)+L1*L2*dx(T,16)*(sin(x(T,7))*sin(x(T,8))+cos(x(T,7))*cos(x(T,8))*cos(x(T,9)))-L2*g*cos(x(T,8))*cos(x(T,9))+L1*L2*x(T,16)^2*(cos(x(T,7))*sin(x(T,8))-cos(x(T,8))*cos(x(T,9))*sin(x(T,7)))-L2^2*cos(x(T,8))*sin(x(T,8))*x(T,18)^2	0.0	dx(T,17)-cos(x(T,8))*sin(x(T,8))*x(T,18)^2	x(T,17)
                0.0	sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)^2*(L2*M3+LC2*M2)-cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,16)*(L2*M3+LC2*M2)	2*L2*M3*sin(x(T,8))^2*dx(T,18)-sin(x(T,8))*sin(x(T,9))*dx(T,24)-(sqrt(3)*cos(x(T,9))*sin(x(T,8))*dx(T,23))*0.5-(cos(x(T,9))*sin(x(T,8))*dx(T,22))*0.5+M3*g*sin(x(T,8))*sin(x(T,9))+2*L2*M3*sin(2*x(T,8))*x(T,17)*x(T,18)+L1*M3*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)^2-L1*M3*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,16)	0.0	0.0	2*LC2*M2*sin(x(T,8))^2*dx(T,18)+M2*g*sin(x(T,8))*sin(x(T,9))+2*LC2*M2*sin(2*x(T,8))*x(T,17)*x(T,18)+L1*M2*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)^2-L1*M2*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,16)	0.0	LC2^2*sin(x(T,8))^2*dx(T,18)+LC2^2*sin(2*x(T,8))*x(T,17)*x(T,18)+LC2*g*sin(x(T,8))*sin(x(T,9))+L1*LC2*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)^2-L1*LC2*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,16)	L2^2*sin(x(T,8))^2*dx(T,18)+L2^2*sin(2*x(T,8))*x(T,17)*x(T,18)+L2*g*sin(x(T,8))*sin(x(T,9))+L1*L2*sin(x(T,7))*sin(x(T,8))*sin(x(T,9))*x(T,16)^2-L1*L2*cos(x(T,7))*sin(x(T,8))*sin(x(T,9))*dx(T,16)	0.0	sin(x(T,8))^2*dx(T,18)+sin(2*x(T,8))*x(T,17)*x(T,18)	x(T,18)
                sqrt(3)*0.5	(sqrt(3)*cos(x(T,4)))*0.5	(sqrt(3)*cos(x(T,5)))*0.5+sin(x(T,2))*sin(x(T,3))+(sin(x(T,5))*sin(x(T,6)))*0.5	-sqrt(3)*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                3*0.5	cos(x(T,1))+cos(x(T,4))*0.5	cos(x(T,2))+cos(x(T,5))*0.5-(sqrt(3)*sin(x(T,5))*sin(x(T,6)))*0.5	-1.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	sin(x(T,1))-sin(x(T,4))	cos(x(T,3))*sin(x(T,2))-cos(x(T,6))*sin(x(T,5))	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                -sqrt(3)*0.5	-(sqrt(3)*cos(x(T,7)))*0.5	sin(x(T,2))*sin(x(T,3))-(sqrt(3)*cos(x(T,8)))*0.5+(sin(x(T,8))*sin(x(T,9)))*0.5	sqrt(3)*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                3*0.5	cos(x(T,1))+cos(x(T,7))*0.5	cos(x(T,2))+cos(x(T,8))*0.5+(sqrt(3)*sin(x(T,8))*sin(x(T,9)))*0.5	-1.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	sin(x(T,1))-sin(x(T,7))	cos(x(T,3))*sin(x(T,2))-cos(x(T,9))*sin(x(T,8))	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	-(sqrt(3)*sin(x(T,4))*x(T,13))*0.5	cos(x(T,2))*sin(x(T,3))*x(T,11)-(sqrt(3)*sin(x(T,5))*x(T,14))*0.5+cos(x(T,3))*sin(x(T,2))*x(T,12)+(cos(x(T,5))*sin(x(T,6))*x(T,14))*0.5+(cos(x(T,6))*sin(x(T,5))*x(T,15))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	-sin(x(T,1))*x(T,10)-(sin(x(T,4))*x(T,13))*0.5	-sin(x(T,2))*x(T,11)-(sin(x(T,5))*x(T,14))*0.5-(sqrt(3)*cos(x(T,5))*sin(x(T,6))*x(T,14))*0.5-(sqrt(3)*cos(x(T,6))*sin(x(T,5))*x(T,15))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	cos(x(T,1))*x(T,10)-cos(x(T,4))*x(T,13)	cos(x(T,2))*cos(x(T,3))*x(T,11)-cos(x(T,5))*cos(x(T,6))*x(T,14)-sin(x(T,2))*sin(x(T,3))*x(T,12)+sin(x(T,5))*sin(x(T,6))*x(T,15)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	(sqrt(3)*sin(x(T,7))*x(T,16))*0.5	(sqrt(3)*sin(x(T,8))*x(T,17))*0.5+cos(x(T,2))*sin(x(T,3))*x(T,11)+cos(x(T,3))*sin(x(T,2))*x(T,12)+(cos(x(T,8))*sin(x(T,9))*x(T,17))*0.5+(cos(x(T,9))*sin(x(T,8))*x(T,18))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	-sin(x(T,1))*x(T,10)-(sin(x(T,7))*x(T,16))*0.5	(sqrt(3)*cos(x(T,8))*sin(x(T,9))*x(T,17))*0.5-(sin(x(T,8))*x(T,17))*0.5-sin(x(T,2))*x(T,11)+(sqrt(3)*cos(x(T,9))*sin(x(T,8))*x(T,18))*0.5	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	cos(x(T,1))*x(T,10)-cos(x(T,7))*x(T,16)	cos(x(T,2))*cos(x(T,3))*x(T,11)-cos(x(T,8))*cos(x(T,9))*x(T,17)-sin(x(T,2))*sin(x(T,3))*x(T,12)+sin(x(T,8))*sin(x(T,9))*x(T,18)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	0.0	-sin(x(T,2))*sin(x(T,3))	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                -1.0	-cos(x(T,1))	-cos(x(T,2))	1.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
                0.0	-sin(x(T,1))	-cos(x(T,3))*sin(x(T,2))	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0]
        gₓT = [0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -2(y(T,1)-x2(T,31))/T   -2(y(T,2)-x2(T,32))/T   -2(y(T,3)-x2(T,33))/T]
        dgₓT = [0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0.0   -2(dy(T,1)-dx2(T,31))/T   -2(dy(T,2)-dx2(T,32))/T   -2(dy(T,3)-dx2(T,33))/T]

        # The residual function
        # Note, everything except the residual function is independent of which disturbance model is used.
        # This residual function assumes that the disturbance model has nxw = 3, nw = 3
        function f!(res, dz, z, _, t)
            xt = x(t,1:33)
            dxt = dx(t,1:33)
            yt = y(t,1:3)
            # ---------- Nominal adjoint system ----------
            # 0 = dλ̇ᵀ Fdx + λᵀ(dFdx - Fx) + gₓ                      # Analytical adjoint system
            # 0 = (dz')*Fdx(t) + (z')*(dFdx(t) - Fx(t)) + gₓ(t)     # Matrix form adjoint system
            # Expanded adjoint system residual equations:
            res[1] = dz[1]-z[11]*(L1*dxt[10]*(L2*M3+LC2*M2)*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))-L1*xt[10]^2*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3])))-z[10]*(0.0*sin(xt[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(xt[1])*dxt[20]+L1*cos(xt[1])*dxt[23]+L1*sin(xt[1])*dxt[21]+L1*sin(xt[1])*dxt[24]+L1*dxt[11]*(L2*M3+LC2*M2)*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))+L1*xt[11]^2*(L2*M3+LC2*M2)*(cos(xt[1])*cos(xt[2])+cos(xt[3])*sin(xt[1])*sin(xt[2]))+L1*cos(xt[3])*sin(xt[1])*sin(xt[2])*xt[12]^2*(L2*M3+LC2*M2)+L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*dxt[12]*(L2*M3+LC2*M2)+2*L1*cos(xt[2])*sin(xt[1])*sin(xt[3])*xt[11]*xt[12]*(L2*M3+LC2*M2))-z[12]*(L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]^2*(L2*M3+LC2*M2)+L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*dxt[10]*(L2*M3+LC2*M2))+z[1]*(L1*cos(xt[1])*dxt[26]+L1*cos(xt[1])*dxt[29]+L1*sin(xt[1])*dxt[27]+L1*sin(xt[1])*dxt[30])-L1*cos(xt[1])*z[21]-L1*cos(xt[1])*z[24]+L1*cos(xt[1])*z[33]+L1*sin(xt[1])*z[20]+L1*sin(xt[1])*z[23]-L1*sin(xt[1])*z[32]+L1*cos(xt[1])*z[26]*xt[10]+L1*cos(xt[1])*z[29]*xt[10]+L1*sin(xt[1])*z[27]*xt[10]+L1*sin(xt[1])*z[30]*xt[10]
            res[2] = dz[2]-z[25]*(L2*cos(xt[2])*cos(xt[3])*xt[12]-L2*sin(xt[2])*sin(xt[3])*xt[11])+z[27]*(L2*cos(xt[3])*sin(xt[2])*xt[11]+L2*cos(xt[2])*sin(xt[3])*xt[12])-z[28]*(L2*cos(xt[2])*cos(xt[3])*xt[12]-L2*sin(xt[2])*sin(xt[3])*xt[11])+z[30]*(L2*cos(xt[3])*sin(xt[2])*xt[11]+L2*cos(xt[2])*sin(xt[3])*xt[12])-z[3]*(L2*cos(xt[2])*cos(xt[3])*dxt[25]+L2*cos(xt[2])*cos(xt[3])*dxt[28]-L2*cos(xt[2])*sin(xt[3])*dxt[27]-L2*cos(xt[2])*sin(xt[3])*dxt[30])-z[12]*(L2*cos(xt[2])*sin(xt[3])*dxt[21]-L2*cos(xt[2])*cos(xt[3])*dxt[22]-L2*cos(xt[2])*cos(xt[3])*dxt[19]+L2*cos(xt[2])*sin(xt[3])*dxt[24]+2*cos(xt[2])*sin(xt[2])*dxt[12]*(J2+L2^2*M3+LC2^2*M2)+2*cos(2*xt[2])*xt[11]*xt[12]*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(xt[2])*sin(xt[3])*(L2*M3+LC2*M2)+L1*cos(xt[2])*sin(xt[1])*sin(xt[3])*xt[10]^2*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[10]*(L2*M3+LC2*M2))-z[11]*(sin(xt[2])^2*xt[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(xt[2])^2*xt[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(xt[2])*dxt[20]+L2*cos(xt[2])*dxt[23]+L2*cos(xt[3])*sin(xt[2])*dxt[21]+L2*cos(xt[3])*sin(xt[2])*dxt[24]+L2*sin(xt[2])*sin(xt[3])*dxt[19]+L2*sin(xt[2])*sin(xt[3])*dxt[22]+L1*dxt[10]*(L2*M3+LC2*M2)*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))+0.0*cos(xt[3])*sin(xt[2])*(L2*M3+LC2*M2)+L1*xt[10]^2*(L2*M3+LC2*M2)*(cos(xt[1])*cos(xt[2])+cos(xt[3])*sin(xt[1])*sin(xt[2])))+z[10]*(L1*xt[11]^2*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-L1*dxt[11]*(L2*M3+LC2*M2)*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))+L1*cos(xt[1])*cos(xt[2])*cos(xt[3])*xt[12]^2*(L2*M3+LC2*M2)+L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[12]*(L2*M3+LC2*M2)-2*L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*xt[11]*xt[12]*(L2*M3+LC2*M2))+z[2]*(L2*cos(xt[2])*dxt[26]+L2*cos(xt[2])*dxt[29]+L2*cos(xt[3])*sin(xt[2])*dxt[27]+L2*cos(xt[3])*sin(xt[2])*dxt[30]+L2*sin(xt[2])*sin(xt[3])*dxt[25]+L2*sin(xt[2])*sin(xt[3])*dxt[28])+L2*sin(xt[2])*z[20]+L2*sin(xt[2])*z[23]-L2*sin(xt[2])*z[32]-L2*cos(xt[2])*cos(xt[3])*z[21]-L2*cos(xt[2])*cos(xt[3])*z[24]+L2*cos(xt[2])*cos(xt[3])*z[33]-L2*cos(xt[2])*sin(xt[3])*z[19]-L2*cos(xt[2])*sin(xt[3])*z[22]+L2*cos(xt[2])*sin(xt[3])*z[31]+L2*cos(xt[2])*z[26]*xt[11]+L2*cos(xt[2])*z[29]*xt[11]
            res[3] = dz[3]-z[12]*(L2*cos(xt[3])*sin(xt[2])*dxt[21]+L2*cos(xt[3])*sin(xt[2])*dxt[24]+L2*sin(xt[2])*sin(xt[3])*dxt[19]+L2*sin(xt[2])*sin(xt[3])*dxt[22]+0.0*cos(xt[3])*sin(xt[2])*(L2*M3+LC2*M2)+L1*cos(xt[3])*sin(xt[1])*sin(xt[2])*xt[10]^2*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[10]*(L2*M3+LC2*M2))-z[25]*(L2*cos(xt[2])*cos(xt[3])*xt[11]-L2*sin(xt[2])*sin(xt[3])*xt[12])+z[27]*(L2*cos(xt[2])*sin(xt[3])*xt[11]+L2*cos(xt[3])*sin(xt[2])*xt[12])-z[28]*(L2*cos(xt[2])*cos(xt[3])*xt[11]-L2*sin(xt[2])*sin(xt[3])*xt[12])+z[30]*(L2*cos(xt[2])*sin(xt[3])*xt[11]+L2*cos(xt[3])*sin(xt[2])*xt[12])-z[2]*(L2*cos(xt[2])*cos(xt[3])*dxt[25]+L2*cos(xt[2])*cos(xt[3])*dxt[28]-L2*cos(xt[2])*sin(xt[3])*dxt[27]-L2*cos(xt[2])*sin(xt[3])*dxt[30])+z[10]*(L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[11]*(L2*M3+LC2*M2)-L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*xt[12]^2*(L2*M3+LC2*M2)-L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*xt[11]^2*(L2*M3+LC2*M2)+L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[12]*(L2*M3+LC2*M2)+2*L1*cos(xt[1])*cos(xt[2])*cos(xt[3])*xt[11]*xt[12]*(L2*M3+LC2*M2))+z[3]*(L2*cos(xt[3])*sin(xt[2])*dxt[27]+L2*cos(xt[3])*sin(xt[2])*dxt[30]+L2*sin(xt[2])*sin(xt[3])*dxt[25]+L2*sin(xt[2])*sin(xt[3])*dxt[28])-z[11]*(L2*cos(xt[2])*sin(xt[3])*dxt[21]-L2*cos(xt[2])*cos(xt[3])*dxt[22]-L2*cos(xt[2])*cos(xt[3])*dxt[19]+L2*cos(xt[2])*sin(xt[3])*dxt[24]+0.0*cos(xt[2])*sin(xt[3])*(L2*M3+LC2*M2)+L1*cos(xt[2])*sin(xt[1])*sin(xt[3])*xt[10]^2*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[10]*(L2*M3+LC2*M2))-L2*cos(xt[3])*sin(xt[2])*z[19]-L2*cos(xt[3])*sin(xt[2])*z[22]+L2*cos(xt[3])*sin(xt[2])*z[31]+L2*sin(xt[2])*sin(xt[3])*z[21]+L2*sin(xt[2])*sin(xt[3])*z[24]-L2*sin(xt[2])*sin(xt[3])*z[33]
            res[4] = dz[4]-z[14]*(L1*dxt[13]*(L2*M3+LC2*M2)*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))-L1*xt[13]^2*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6])))+z[4]*((L1*cos(xt[4])*dxt[26])*0.5-L1*sin(xt[4])*dxt[27]+(sqrt(3)*L1*cos(xt[4])*dxt[25])*0.5)-z[15]*(L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]^2*(L2*M3+LC2*M2)+L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*dxt[13]*(L2*M3+LC2*M2))-z[13]*(0.0*sin(xt[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(xt[4])*dxt[20])*0.5-L1*sin(xt[4])*dxt[21]+(sqrt(3)*L1*cos(xt[4])*dxt[19])*0.5+L1*dxt[14]*(L2*M3+LC2*M2)*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))+L1*xt[14]^2*(L2*M3+LC2*M2)*(cos(xt[4])*cos(xt[5])+cos(xt[6])*sin(xt[4])*sin(xt[5]))+L1*cos(xt[6])*sin(xt[4])*sin(xt[5])*xt[15]^2*(L2*M3+LC2*M2)+L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*dxt[15]*(L2*M3+LC2*M2)+2*L1*cos(xt[5])*sin(xt[4])*sin(xt[6])*xt[14]*xt[15]*(L2*M3+LC2*M2))+L1*cos(xt[4])*z[21]+(L1*sin(xt[4])*z[20])*0.5+(sqrt(3)*L1*sin(xt[4])*z[19])*0.5+(L1*cos(xt[4])*z[26]*xt[13])*0.5-L1*sin(xt[4])*z[27]*xt[13]+(sqrt(3)*L1*cos(xt[4])*z[25]*xt[13])*0.5
            res[5] = dz[5]-z[27]*(L2*cos(xt[6])*sin(xt[5])*xt[14]+L2*cos(xt[5])*sin(xt[6])*xt[15])+z[25]*((sqrt(3)*L2*cos(xt[5])*xt[14])*0.5-(L2*cos(xt[5])*cos(xt[6])*xt[15])*0.5+(L2*sin(xt[5])*sin(xt[6])*xt[14])*0.5)-z[6]*((L2*cos(xt[5])*cos(xt[6])*dxt[25])*0.5+L2*cos(xt[5])*sin(xt[6])*dxt[27]-(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[26])*0.5)-z[19]*((L2*cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*L2*sin(xt[5]))*0.5)+z[20]*((L2*sin(xt[5]))*0.5+(sqrt(3)*L2*cos(xt[5])*sin(xt[6]))*0.5)+z[5]*(dxt[25]*((sqrt(3)*L2*cos(xt[5]))*0.5+(L2*sin(xt[5])*sin(xt[6]))*0.5)+dxt[26]*((L2*cos(xt[5]))*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6]))*0.5)-L2*cos(xt[6])*sin(xt[5])*dxt[27])-z[15]*(2*cos(xt[5])*sin(xt[5])*dxt[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(xt[5])*sin(xt[6])*dxt[21]-(L2*cos(xt[5])*cos(xt[6])*dxt[19])*0.5+2*cos(2*xt[5])*xt[14]*xt[15]*(J2+L2^2*M3+LC2^2*M2)+0.0*cos(xt[5])*sin(xt[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[20])*0.5+L1*cos(xt[5])*sin(xt[4])*sin(xt[6])*xt[13]^2*(L2*M3+LC2*M2)-L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[13]*(L2*M3+LC2*M2))+z[26]*((L2*cos(xt[5])*xt[14])*0.5+(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*xt[15])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*xt[14])*0.5)+z[13]*(L1*xt[14]^2*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-L1*dxt[14]*(L2*M3+LC2*M2)*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))+L1*cos(xt[4])*cos(xt[5])*cos(xt[6])*xt[15]^2*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[15]*(L2*M3+LC2*M2)-2*L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*xt[14]*xt[15]*(L2*M3+LC2*M2))-z[14]*(dxt[19]*((sqrt(3)*L2*cos(xt[5]))*0.5+(L2*sin(xt[5])*sin(xt[6]))*0.5)+dxt[20]*((L2*cos(xt[5]))*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6]))*0.5)-cos(xt[5])^2*xt[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(xt[5])^2*xt[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(xt[6])*sin(xt[5])*dxt[21]+L1*dxt[13]*(L2*M3+LC2*M2)*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))+0.0*cos(xt[6])*sin(xt[5])*(L2*M3+LC2*M2)+L1*xt[13]^2*(L2*M3+LC2*M2)*(cos(xt[4])*cos(xt[5])+cos(xt[6])*sin(xt[4])*sin(xt[5])))+L2*cos(xt[5])*cos(xt[6])*z[21]
            res[6] = dz[6]+z[14]*((L2*cos(xt[5])*cos(xt[6])*dxt[19])*0.5+L2*cos(xt[5])*sin(xt[6])*dxt[21]-0.0*cos(xt[5])*sin(xt[6])*(L2*M3+LC2*M2)-(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[20])*0.5-L1*cos(xt[5])*sin(xt[4])*sin(xt[6])*xt[13]^2*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[13]*(L2*M3+LC2*M2))-z[27]*(L2*cos(xt[5])*sin(xt[6])*xt[14]+L2*cos(xt[6])*sin(xt[5])*xt[15])-z[25]*((L2*cos(xt[5])*cos(xt[6])*xt[14])*0.5-(L2*sin(xt[5])*sin(xt[6])*xt[15])*0.5)+z[15]*(L2*cos(xt[6])*sin(xt[5])*dxt[21]-(L2*sin(xt[5])*sin(xt[6])*dxt[19])*0.5-0.0*cos(xt[6])*sin(xt[5])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[20])*0.5-L1*cos(xt[6])*sin(xt[4])*sin(xt[5])*xt[13]^2*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[13]*(L2*M3+LC2*M2))+z[13]*(L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[14]*(L2*M3+LC2*M2)-L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*xt[15]^2*(L2*M3+LC2*M2)-L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*xt[14]^2*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[15]*(L2*M3+LC2*M2)+2*L1*cos(xt[4])*cos(xt[5])*cos(xt[6])*xt[14]*xt[15]*(L2*M3+LC2*M2))-z[5]*((L2*cos(xt[5])*cos(xt[6])*dxt[25])*0.5+L2*cos(xt[5])*sin(xt[6])*dxt[27]-(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[26])*0.5)-z[6]*(L2*cos(xt[6])*sin(xt[5])*dxt[27]-(L2*sin(xt[5])*sin(xt[6])*dxt[25])*0.5+(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[26])*0.5)+z[26]*((sqrt(3)*L2*cos(xt[5])*cos(xt[6])*xt[14])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*xt[15])*0.5)-(L2*cos(xt[6])*sin(xt[5])*z[19])*0.5-L2*sin(xt[5])*sin(xt[6])*z[21]+(sqrt(3)*L2*cos(xt[6])*sin(xt[5])*z[20])*0.5
            res[7] = dz[7]-z[17]*(L1*dxt[16]*(L2*M3+LC2*M2)*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))-L1*xt[16]^2*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9])))-z[7]*(L1*sin(xt[7])*dxt[30]-(L1*cos(xt[7])*dxt[29])*0.5+(sqrt(3)*L1*cos(xt[7])*dxt[28])*0.5)-z[18]*(L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]^2*(L2*M3+LC2*M2)+L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*dxt[16]*(L2*M3+LC2*M2))-z[16]*(0.0*sin(xt[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(xt[7])*dxt[23])*0.5-L1*sin(xt[7])*dxt[24]-(sqrt(3)*L1*cos(xt[7])*dxt[22])*0.5+L1*dxt[17]*(L2*M3+LC2*M2)*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))+L1*xt[17]^2*(L2*M3+LC2*M2)*(cos(xt[7])*cos(xt[8])+cos(xt[9])*sin(xt[7])*sin(xt[8]))+L1*cos(xt[9])*sin(xt[7])*sin(xt[8])*xt[18]^2*(L2*M3+LC2*M2)+L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*dxt[18]*(L2*M3+LC2*M2)+2*L1*cos(xt[8])*sin(xt[7])*sin(xt[9])*xt[17]*xt[18]*(L2*M3+LC2*M2))+L1*cos(xt[7])*z[24]+(L1*sin(xt[7])*z[23])*0.5-(sqrt(3)*L1*sin(xt[7])*z[22])*0.5+(L1*cos(xt[7])*z[29]*xt[16])*0.5-L1*sin(xt[7])*z[30]*xt[16]-(sqrt(3)*L1*cos(xt[7])*z[28]*xt[16])*0.5
            res[8] = dz[8]-z[30]*(L2*cos(xt[9])*sin(xt[8])*xt[17]+L2*cos(xt[8])*sin(xt[9])*xt[18])-z[28]*((L2*cos(xt[8])*cos(xt[9])*xt[18])*0.5+(sqrt(3)*L2*cos(xt[8])*xt[17])*0.5-(L2*sin(xt[8])*sin(xt[9])*xt[17])*0.5)-z[9]*((L2*cos(xt[8])*cos(xt[9])*dxt[28])*0.5+L2*cos(xt[8])*sin(xt[9])*dxt[30]+(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[29])*0.5)-z[22]*((L2*cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*L2*sin(xt[8]))*0.5)+z[23]*((L2*sin(xt[8]))*0.5-(sqrt(3)*L2*cos(xt[8])*sin(xt[9]))*0.5)-z[8]*(dxt[28]*((sqrt(3)*L2*cos(xt[8]))*0.5-(L2*sin(xt[8])*sin(xt[9]))*0.5)-dxt[29]*((L2*cos(xt[8]))*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9]))*0.5)+L2*cos(xt[9])*sin(xt[8])*dxt[30])+z[18]*((L2*cos(xt[8])*cos(xt[9])*dxt[22])*0.5+L2*cos(xt[8])*sin(xt[9])*dxt[24]-2*cos(xt[8])*sin(xt[8])*dxt[18]*(J2+L2^2*M3+LC2^2*M2)-2*cos(2*xt[8])*xt[17]*xt[18]*(J2+L2^2*M3+LC2^2*M2)-0.0*cos(xt[8])*sin(xt[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[23])*0.5-L1*cos(xt[8])*sin(xt[7])*sin(xt[9])*xt[16]^2*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[16]*(L2*M3+LC2*M2))+z[29]*((L2*cos(xt[8])*xt[17])*0.5-(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*xt[18])*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*xt[17])*0.5)+z[16]*(L1*xt[17]^2*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-L1*dxt[17]*(L2*M3+LC2*M2)*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))+L1*cos(xt[7])*cos(xt[8])*cos(xt[9])*xt[18]^2*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[18]*(L2*M3+LC2*M2)-2*L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*xt[17]*xt[18]*(L2*M3+LC2*M2))-z[17]*(dxt[23]*((L2*cos(xt[8]))*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9]))*0.5)-dxt[22]*((sqrt(3)*L2*cos(xt[8]))*0.5-(L2*sin(xt[8])*sin(xt[9]))*0.5)-cos(xt[8])^2*xt[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(xt[8])^2*xt[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(xt[9])*sin(xt[8])*dxt[24]+L1*dxt[16]*(L2*M3+LC2*M2)*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))+0.0*cos(xt[9])*sin(xt[8])*(L2*M3+LC2*M2)+L1*xt[16]^2*(L2*M3+LC2*M2)*(cos(xt[7])*cos(xt[8])+cos(xt[9])*sin(xt[7])*sin(xt[8])))+L2*cos(xt[8])*cos(xt[9])*z[24]
            res[9] = dz[9]+z[17]*((L2*cos(xt[8])*cos(xt[9])*dxt[22])*0.5+L2*cos(xt[8])*sin(xt[9])*dxt[24]-0.0*cos(xt[8])*sin(xt[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[23])*0.5-L1*cos(xt[8])*sin(xt[7])*sin(xt[9])*xt[16]^2*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[16]*(L2*M3+LC2*M2))-z[30]*(L2*cos(xt[8])*sin(xt[9])*xt[17]+L2*cos(xt[9])*sin(xt[8])*xt[18])-z[28]*((L2*cos(xt[8])*cos(xt[9])*xt[17])*0.5-(L2*sin(xt[8])*sin(xt[9])*xt[18])*0.5)-z[18]*((L2*sin(xt[8])*sin(xt[9])*dxt[22])*0.5-L2*cos(xt[9])*sin(xt[8])*dxt[24]+0.0*cos(xt[9])*sin(xt[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[23])*0.5+L1*cos(xt[9])*sin(xt[7])*sin(xt[8])*xt[16]^2*(L2*M3+LC2*M2)-L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[16]*(L2*M3+LC2*M2))+z[16]*(L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[17]*(L2*M3+LC2*M2)-L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*xt[18]^2*(L2*M3+LC2*M2)-L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*xt[17]^2*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[18]*(L2*M3+LC2*M2)+2*L1*cos(xt[7])*cos(xt[8])*cos(xt[9])*xt[17]*xt[18]*(L2*M3+LC2*M2))-z[8]*((L2*cos(xt[8])*cos(xt[9])*dxt[28])*0.5+L2*cos(xt[8])*sin(xt[9])*dxt[30]+(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[29])*0.5)+z[9]*((L2*sin(xt[8])*sin(xt[9])*dxt[28])*0.5-L2*cos(xt[9])*sin(xt[8])*dxt[30]+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[29])*0.5)-z[29]*((sqrt(3)*L2*cos(xt[8])*cos(xt[9])*xt[17])*0.5-(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*xt[18])*0.5)-(L2*cos(xt[9])*sin(xt[8])*z[22])*0.5-L2*sin(xt[8])*sin(xt[9])*z[24]-(sqrt(3)*L2*cos(xt[9])*sin(xt[8])*z[23])*0.5
            res[10] = z[1]+dz[10]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[11]*(L1*(L2*M3+LC2*M2)*(cos(xt[2])*cos(xt[3])*sin(xt[1])*dxt[1]-cos(xt[2])*sin(xt[1])*dxt[2]-cos(xt[1])*sin(xt[2])*dxt[1]+cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[2]+cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[3])+2*L1*xt[10]*(L2*M3+LC2*M2)*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1])))-γ*z[10]-z[12]*(L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[2]*(L2*M3+LC2*M2)+L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[3]*(L2*M3+LC2*M2)-L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*dxt[1]*(L2*M3+LC2*M2)+2*L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]*(L2*M3+LC2*M2))-L1*cos(xt[1])*z[27]-L1*cos(xt[1])*z[30]+L1*sin(xt[1])*z[26]+L1*sin(xt[1])*z[29]+L1*dz[11]*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*dz[12]*(L2*M3+LC2*M2)
            res[11] = z[2]-z[10]*(L1*(L2*M3+LC2*M2)*(cos(xt[2])*cos(xt[3])*sin(xt[1])*dxt[1]-cos(xt[2])*sin(xt[1])*dxt[2]-cos(xt[1])*sin(xt[2])*dxt[1]+cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[2]+cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[3])+2*L1*xt[11]*(L2*M3+LC2*M2)*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))-2*L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[12]*(L2*M3+LC2*M2))+dz[11]*(J2+L2^2*M3+LC2^2*M2)-γ*z[11]+L2*sin(xt[2])*z[26]+L2*sin(xt[2])*z[29]-L2*cos(xt[2])*cos(xt[3])*z[27]-L2*cos(xt[2])*cos(xt[3])*z[30]-L2*cos(xt[2])*sin(xt[3])*z[25]-L2*cos(xt[2])*sin(xt[3])*z[28]-sin(2*xt[2])*z[12]*xt[12]*(J2+L2^2*M3+LC2^2*M2)+L1*dz[10]*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))
            res[12] = z[3]-z[12]*(γ+sin(2*xt[2])*xt[11]*(J2+L2^2*M3+LC2^2*M2)-2*cos(xt[2])*sin(xt[2])*dxt[2]*(J2+L2^2*M3+LC2^2*M2))+z[10]*(2*L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[11]*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*dxt[3]*(L2*M3+LC2*M2)-L1*cos(xt[1])*cos(xt[2])*sin(xt[3])*dxt[2]*(L2*M3+LC2*M2)+2*L1*cos(xt[1])*cos(xt[3])*sin(xt[2])*xt[12]*(L2*M3+LC2*M2)+L1*sin(xt[1])*sin(xt[2])*sin(xt[3])*dxt[1]*(L2*M3+LC2*M2))+sin(xt[2])^2*dz[12]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(xt[3])*sin(xt[2])*z[25]-L2*cos(xt[3])*sin(xt[2])*z[28]+L2*sin(xt[2])*sin(xt[3])*z[27]+L2*sin(xt[2])*sin(xt[3])*z[30]+2*cos(xt[2])*sin(xt[2])*z[11]*xt[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(xt[1])*sin(xt[2])*sin(xt[3])*dz[10]*(L2*M3+LC2*M2)
            res[13] = z[4]+dz[13]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[14]*(L1*(L2*M3+LC2*M2)*(cos(xt[5])*cos(xt[6])*sin(xt[4])*dxt[4]-cos(xt[5])*sin(xt[4])*dxt[5]-cos(xt[4])*sin(xt[5])*dxt[4]+cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[5]+cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[6])+2*L1*xt[13]*(L2*M3+LC2*M2)*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4])))-γ*z[13]-z[15]*(L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[5]*(L2*M3+LC2*M2)+L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[6]*(L2*M3+LC2*M2)-L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*dxt[4]*(L2*M3+LC2*M2)+2*L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]*(L2*M3+LC2*M2))+L1*cos(xt[4])*z[27]+(L1*sin(xt[4])*z[26])*0.5+(sqrt(3)*L1*sin(xt[4])*z[25])*0.5+L1*dz[14]*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*dz[15]*(L2*M3+LC2*M2)
            res[14] = z[5]-z[25]*((L2*cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*L2*sin(xt[5]))*0.5)+z[26]*((L2*sin(xt[5]))*0.5+(sqrt(3)*L2*cos(xt[5])*sin(xt[6]))*0.5)-z[13]*(L1*(L2*M3+LC2*M2)*(cos(xt[5])*cos(xt[6])*sin(xt[4])*dxt[4]-cos(xt[5])*sin(xt[4])*dxt[5]-cos(xt[4])*sin(xt[5])*dxt[4]+cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[5]+cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[6])+2*L1*xt[14]*(L2*M3+LC2*M2)*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))-2*L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[15]*(L2*M3+LC2*M2))+dz[14]*(J2+L2^2*M3+LC2^2*M2)-γ*z[14]+L2*cos(xt[5])*cos(xt[6])*z[27]-sin(2*xt[5])*z[15]*xt[15]*(J2+L2^2*M3+LC2^2*M2)+L1*dz[13]*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))
            res[15] = z[6]-z[15]*(γ+sin(2*xt[5])*xt[14]*(J2+L2^2*M3+LC2^2*M2)-2*cos(xt[5])*sin(xt[5])*dxt[5]*(J2+L2^2*M3+LC2^2*M2))+z[13]*(2*L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[14]*(L2*M3+LC2*M2)-L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*dxt[6]*(L2*M3+LC2*M2)-L1*cos(xt[4])*cos(xt[5])*sin(xt[6])*dxt[5]*(L2*M3+LC2*M2)+2*L1*cos(xt[4])*cos(xt[6])*sin(xt[5])*xt[15]*(L2*M3+LC2*M2)+L1*sin(xt[4])*sin(xt[5])*sin(xt[6])*dxt[4]*(L2*M3+LC2*M2))+sin(xt[5])^2*dz[15]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(xt[6])*sin(xt[5])*z[25])*0.5-L2*sin(xt[5])*sin(xt[6])*z[27]+2*cos(xt[5])*sin(xt[5])*z[14]*xt[15]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(xt[6])*sin(xt[5])*z[26])*0.5-L1*cos(xt[4])*sin(xt[5])*sin(xt[6])*dz[13]*(L2*M3+LC2*M2)
            res[16] = z[7]+dz[16]*(J1+L1^2*(M2+M3)+LC1^2*M1)-z[17]*(L1*(L2*M3+LC2*M2)*(cos(xt[8])*cos(xt[9])*sin(xt[7])*dxt[7]-cos(xt[8])*sin(xt[7])*dxt[8]-cos(xt[7])*sin(xt[8])*dxt[7]+cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[8]+cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[9])+2*L1*xt[16]*(L2*M3+LC2*M2)*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7])))-γ*z[16]-z[18]*(L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[8]*(L2*M3+LC2*M2)+L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[9]*(L2*M3+LC2*M2)-L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*dxt[7]*(L2*M3+LC2*M2)+2*L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]*(L2*M3+LC2*M2))+L1*cos(xt[7])*z[30]+(L1*sin(xt[7])*z[29])*0.5-(sqrt(3)*L1*sin(xt[7])*z[28])*0.5+L1*dz[17]*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*dz[18]*(L2*M3+LC2*M2)
            res[17] = z[8]-z[28]*((L2*cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*L2*sin(xt[8]))*0.5)+z[29]*((L2*sin(xt[8]))*0.5-(sqrt(3)*L2*cos(xt[8])*sin(xt[9]))*0.5)-z[16]*(L1*(L2*M3+LC2*M2)*(cos(xt[8])*cos(xt[9])*sin(xt[7])*dxt[7]-cos(xt[8])*sin(xt[7])*dxt[8]-cos(xt[7])*sin(xt[8])*dxt[7]+cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[8]+cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[9])+2*L1*xt[17]*(L2*M3+LC2*M2)*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))-2*L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[18]*(L2*M3+LC2*M2))+dz[17]*(J2+L2^2*M3+LC2^2*M2)-γ*z[17]+L2*cos(xt[8])*cos(xt[9])*z[30]-sin(2*xt[8])*z[18]*xt[18]*(J2+L2^2*M3+LC2^2*M2)+L1*dz[16]*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))
            res[18] = z[9]-z[18]*(γ+sin(2*xt[8])*xt[17]*(J2+L2^2*M3+LC2^2*M2)-2*cos(xt[8])*sin(xt[8])*dxt[8]*(J2+L2^2*M3+LC2^2*M2))+z[16]*(2*L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[17]*(L2*M3+LC2*M2)-L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*dxt[9]*(L2*M3+LC2*M2)-L1*cos(xt[7])*cos(xt[8])*sin(xt[9])*dxt[8]*(L2*M3+LC2*M2)+2*L1*cos(xt[7])*cos(xt[9])*sin(xt[8])*xt[18]*(L2*M3+LC2*M2)+L1*sin(xt[7])*sin(xt[8])*sin(xt[9])*dxt[7]*(L2*M3+LC2*M2))+sin(xt[8])^2*dz[18]*(J2+L2^2*M3+LC2^2*M2)-(L2*cos(xt[9])*sin(xt[8])*z[28])*0.5-L2*sin(xt[8])*sin(xt[9])*z[30]+2*cos(xt[8])*sin(xt[8])*z[17]*xt[18]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(xt[9])*sin(xt[8])*z[29])*0.5-L1*cos(xt[7])*sin(xt[8])*sin(xt[9])*dz[16]*(L2*M3+LC2*M2)
            res[19] = z[14]*((sqrt(3)*L2*cos(xt[5])*dxt[5])*0.5-(L2*cos(xt[5])*cos(xt[6])*dxt[6])*0.5+(L2*sin(xt[5])*sin(xt[6])*dxt[5])*0.5)-dz[14]*((L2*cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*L2*sin(xt[5]))*0.5)-z[11]*(L2*cos(xt[2])*cos(xt[3])*dxt[3]-L2*sin(xt[2])*sin(xt[3])*dxt[2])-z[12]*(L2*cos(xt[2])*cos(xt[3])*dxt[2]-L2*sin(xt[2])*sin(xt[3])*dxt[3])-z[15]*((L2*cos(xt[5])*cos(xt[6])*dxt[5])*0.5-(L2*sin(xt[5])*sin(xt[6])*dxt[6])*0.5)-L2*cos(xt[2])*sin(xt[3])*dz[11]-L2*cos(xt[3])*sin(xt[2])*dz[12]-(L2*cos(xt[6])*sin(xt[5])*dz[15])*0.5+(sqrt(3)*L1*sin(xt[4])*dz[13])*0.5+(sqrt(3)*L1*cos(xt[4])*dxt[4]*z[13])*0.5
            res[20] = dz[14]*((L2*sin(xt[5]))*0.5+(sqrt(3)*L2*cos(xt[5])*sin(xt[6]))*0.5)+z[14]*((L2*cos(xt[5])*dxt[5])*0.5+(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[6])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[5])*0.5)+z[15]*((sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[5])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[6])*0.5)+L1*sin(xt[1])*dz[10]+L2*sin(xt[2])*dz[11]+(L1*sin(xt[4])*dz[13])*0.5+L1*cos(xt[1])*dxt[1]*z[10]+L2*cos(xt[2])*dxt[2]*z[11]+(L1*cos(xt[4])*dxt[4]*z[13])*0.5+(sqrt(3)*L2*cos(xt[6])*sin(xt[5])*dz[15])*0.5
            res[21] = z[11]*(L2*cos(xt[3])*sin(xt[2])*dxt[2]+L2*cos(xt[2])*sin(xt[3])*dxt[3])+z[12]*(L2*cos(xt[2])*sin(xt[3])*dxt[2]+L2*cos(xt[3])*sin(xt[2])*dxt[3])-z[14]*(L2*cos(xt[6])*sin(xt[5])*dxt[5]+L2*cos(xt[5])*sin(xt[6])*dxt[6])-z[15]*(L2*cos(xt[5])*sin(xt[6])*dxt[5]+L2*cos(xt[6])*sin(xt[5])*dxt[6])-L1*cos(xt[1])*dz[10]+L1*cos(xt[4])*dz[13]-L2*cos(xt[2])*cos(xt[3])*dz[11]+L2*cos(xt[5])*cos(xt[6])*dz[14]+L2*sin(xt[2])*sin(xt[3])*dz[12]-L2*sin(xt[5])*sin(xt[6])*dz[15]+L1*sin(xt[1])*dxt[1]*z[10]-L1*sin(xt[4])*dxt[4]*z[13]
            res[22] = -z[17]*((L2*cos(xt[8])*cos(xt[9])*dxt[9])*0.5+(sqrt(3)*L2*cos(xt[8])*dxt[8])*0.5-(L2*sin(xt[8])*sin(xt[9])*dxt[8])*0.5)-dz[17]*((L2*cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*L2*sin(xt[8]))*0.5)-z[11]*(L2*cos(xt[2])*cos(xt[3])*dxt[3]-L2*sin(xt[2])*sin(xt[3])*dxt[2])-z[12]*(L2*cos(xt[2])*cos(xt[3])*dxt[2]-L2*sin(xt[2])*sin(xt[3])*dxt[3])-z[18]*((L2*cos(xt[8])*cos(xt[9])*dxt[8])*0.5-(L2*sin(xt[8])*sin(xt[9])*dxt[9])*0.5)-L2*cos(xt[2])*sin(xt[3])*dz[11]-L2*cos(xt[3])*sin(xt[2])*dz[12]-(L2*cos(xt[9])*sin(xt[8])*dz[18])*0.5-(sqrt(3)*L1*sin(xt[7])*dz[16])*0.5-(sqrt(3)*L1*cos(xt[7])*dxt[7]*z[16])*0.5
            res[23] = dz[17]*((L2*sin(xt[8]))*0.5-(sqrt(3)*L2*cos(xt[8])*sin(xt[9]))*0.5)+z[17]*((L2*cos(xt[8])*dxt[8])*0.5-(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[9])*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[8])*0.5)-z[18]*((sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[8])*0.5-(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[9])*0.5)+L1*sin(xt[1])*dz[10]+L2*sin(xt[2])*dz[11]+(L1*sin(xt[7])*dz[16])*0.5+L1*cos(xt[1])*dxt[1]*z[10]+L2*cos(xt[2])*dxt[2]*z[11]+(L1*cos(xt[7])*dxt[7]*z[16])*0.5-(sqrt(3)*L2*cos(xt[9])*sin(xt[8])*dz[18])*0.5
            res[24] = z[11]*(L2*cos(xt[3])*sin(xt[2])*dxt[2]+L2*cos(xt[2])*sin(xt[3])*dxt[3])+z[12]*(L2*cos(xt[2])*sin(xt[3])*dxt[2]+L2*cos(xt[3])*sin(xt[2])*dxt[3])-z[17]*(L2*cos(xt[9])*sin(xt[8])*dxt[8]+L2*cos(xt[8])*sin(xt[9])*dxt[9])-z[18]*(L2*cos(xt[8])*sin(xt[9])*dxt[8]+L2*cos(xt[9])*sin(xt[8])*dxt[9])-L1*cos(xt[1])*dz[10]+L1*cos(xt[7])*dz[16]-L2*cos(xt[2])*cos(xt[3])*dz[11]+L2*cos(xt[8])*cos(xt[9])*dz[17]+L2*sin(xt[2])*sin(xt[3])*dz[12]-L2*sin(xt[8])*sin(xt[9])*dz[18]+L1*sin(xt[1])*dxt[1]*z[10]-L1*sin(xt[7])*dxt[7]*z[16]
            res[25] = dz[5]*((L2*cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*L2*sin(xt[5]))*0.5)-z[5]*((sqrt(3)*L2*cos(xt[5])*dxt[5])*0.5-(L2*cos(xt[5])*cos(xt[6])*dxt[6])*0.5+(L2*sin(xt[5])*sin(xt[6])*dxt[5])*0.5)+z[2]*(L2*cos(xt[2])*cos(xt[3])*dxt[3]-L2*sin(xt[2])*sin(xt[3])*dxt[2])+z[3]*(L2*cos(xt[2])*cos(xt[3])*dxt[2]-L2*sin(xt[2])*sin(xt[3])*dxt[3])+z[6]*((L2*cos(xt[5])*cos(xt[6])*dxt[5])*0.5-(L2*sin(xt[5])*sin(xt[6])*dxt[6])*0.5)+L2*cos(xt[2])*sin(xt[3])*dz[2]+L2*cos(xt[3])*sin(xt[2])*dz[3]+(L2*cos(xt[6])*sin(xt[5])*dz[6])*0.5-(sqrt(3)*L1*sin(xt[4])*dz[4])*0.5-(sqrt(3)*L1*cos(xt[4])*dxt[4]*z[4])*0.5
            res[26] = -dz[5]*((L2*sin(xt[5]))*0.5+(sqrt(3)*L2*cos(xt[5])*sin(xt[6]))*0.5)-z[5]*((L2*cos(xt[5])*dxt[5])*0.5+(sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[6])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[5])*0.5)-z[6]*((sqrt(3)*L2*cos(xt[5])*cos(xt[6])*dxt[5])*0.5-(sqrt(3)*L2*sin(xt[5])*sin(xt[6])*dxt[6])*0.5)-L1*sin(xt[1])*dz[1]-L2*sin(xt[2])*dz[2]-(L1*sin(xt[4])*dz[4])*0.5-L1*cos(xt[1])*dxt[1]*z[1]-L2*cos(xt[2])*dxt[2]*z[2]-(L1*cos(xt[4])*dxt[4]*z[4])*0.5-(sqrt(3)*L2*cos(xt[6])*sin(xt[5])*dz[6])*0.5
            res[27] = z[5]*(L2*cos(xt[6])*sin(xt[5])*dxt[5]+L2*cos(xt[5])*sin(xt[6])*dxt[6])-z[3]*(L2*cos(xt[2])*sin(xt[3])*dxt[2]+L2*cos(xt[3])*sin(xt[2])*dxt[3])-z[2]*(L2*cos(xt[3])*sin(xt[2])*dxt[2]+L2*cos(xt[2])*sin(xt[3])*dxt[3])+z[6]*(L2*cos(xt[5])*sin(xt[6])*dxt[5]+L2*cos(xt[6])*sin(xt[5])*dxt[6])+L1*cos(xt[1])*dz[1]-L1*cos(xt[4])*dz[4]+L2*cos(xt[2])*cos(xt[3])*dz[2]-L2*cos(xt[5])*cos(xt[6])*dz[5]-L2*sin(xt[2])*sin(xt[3])*dz[3]+L2*sin(xt[5])*sin(xt[6])*dz[6]-L1*sin(xt[1])*dxt[1]*z[1]+L1*sin(xt[4])*dxt[4]*z[4]
            res[28] = z[8]*((L2*cos(xt[8])*cos(xt[9])*dxt[9])*0.5+(sqrt(3)*L2*cos(xt[8])*dxt[8])*0.5-(L2*sin(xt[8])*sin(xt[9])*dxt[8])*0.5)+dz[8]*((L2*cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*L2*sin(xt[8]))*0.5)+z[2]*(L2*cos(xt[2])*cos(xt[3])*dxt[3]-L2*sin(xt[2])*sin(xt[3])*dxt[2])+z[3]*(L2*cos(xt[2])*cos(xt[3])*dxt[2]-L2*sin(xt[2])*sin(xt[3])*dxt[3])+z[9]*((L2*cos(xt[8])*cos(xt[9])*dxt[8])*0.5-(L2*sin(xt[8])*sin(xt[9])*dxt[9])*0.5)+L2*cos(xt[2])*sin(xt[3])*dz[2]+L2*cos(xt[3])*sin(xt[2])*dz[3]+(L2*cos(xt[9])*sin(xt[8])*dz[9])*0.5+(sqrt(3)*L1*sin(xt[7])*dz[7])*0.5+(sqrt(3)*L1*cos(xt[7])*dxt[7]*z[7])*0.5
            res[29] = z[9]*((sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[8])*0.5-(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[9])*0.5)-z[8]*((L2*cos(xt[8])*dxt[8])*0.5-(sqrt(3)*L2*cos(xt[8])*cos(xt[9])*dxt[9])*0.5+(sqrt(3)*L2*sin(xt[8])*sin(xt[9])*dxt[8])*0.5)-dz[8]*((L2*sin(xt[8]))*0.5-(sqrt(3)*L2*cos(xt[8])*sin(xt[9]))*0.5)-L1*sin(xt[1])*dz[1]-L2*sin(xt[2])*dz[2]-(L1*sin(xt[7])*dz[7])*0.5-L1*cos(xt[1])*dxt[1]*z[1]-L2*cos(xt[2])*dxt[2]*z[2]-(L1*cos(xt[7])*dxt[7]*z[7])*0.5+(sqrt(3)*L2*cos(xt[9])*sin(xt[8])*dz[9])*0.5
            res[30] = z[8]*(L2*cos(xt[9])*sin(xt[8])*dxt[8]+L2*cos(xt[8])*sin(xt[9])*dxt[9])-z[3]*(L2*cos(xt[2])*sin(xt[3])*dxt[2]+L2*cos(xt[3])*sin(xt[2])*dxt[3])-z[2]*(L2*cos(xt[3])*sin(xt[2])*dxt[2]+L2*cos(xt[2])*sin(xt[3])*dxt[3])+z[9]*(L2*cos(xt[8])*sin(xt[9])*dxt[8]+L2*cos(xt[9])*sin(xt[8])*dxt[9])+L1*cos(xt[1])*dz[1]-L1*cos(xt[7])*dz[7]+L2*cos(xt[2])*cos(xt[3])*dz[2]-L2*cos(xt[8])*cos(xt[9])*dz[8]-L2*sin(xt[2])*sin(xt[3])*dz[3]+L2*sin(xt[8])*sin(xt[9])*dz[9]-L1*sin(xt[1])*dxt[1]*z[1]+L1*sin(xt[7])*dxt[7]*z[7]
            res[31] = -z[31]-2*(yt[1]-xt[31])/T
            res[32] = -z[32]-2*(yt[2]-xt[32])/T
            res[33] = -z[33]-2*(yt[3]-xt[33])/T
            # ---------- Disturbance adjoint system ---------- (This part is hard-coded and assumes nxw=2, nw=1)
            # 0 = dλₓᵀ + λₓᵀǍ + λwᵀČ                                 # Analytical form
            # 0 = dzₓ' + (zₓ')*Ǎ + (zw')*Č                           # Matrix form
            res[nx+1:nx+nxw] = dz[nx+1:nx+nxw]' + (z[nx+1:nx+nxw]')*ad.Ǎ + (z[nx+nxw+1:nx+ndist]')*ad.Č
            # 0 = λwᵀ + λᵀFw                                        # Analytical form              
            # 0 = zw' + (z')*Fw(t)                                  # Matrix form
            res[nx+nxw+1:nx+ndist] = z[nx+nxw+1:nx+ndist]' + (z[1:nx]')*Fw(t)
            # ---------- β-equations ----------
            # 0 = dβᵢ - gθᵢ + λᵀFθᵢ + λₓᵀ(Ǎθᵢ*xw(t) + B̌θᵢ*v(t)) + λwᵀČθᵢxw(t)                                     # Analytical form

            # For dynamical parameters, only dβᵢ - λᵀFθᵢ
            res[nx+ndist+1] = dz[nx+ndist+1] - ((3*z[20])*0.5+(3*z[23])*0.5-z[32]+(sqrt(3)*z[19])*0.5-(sqrt(3)*z[22])*0.5)
            res[nx+ndist+2] = dz[nx+ndist+2] - (z[12]*(sin(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]^2*(L2*M3+LC2*M2)-cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[10]*(L2*M3+LC2*M2))+z[15]*(sin(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]^2*(L2*M3+LC2*M2)-cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[13]*(L2*M3+LC2*M2))+z[18]*(sin(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]^2*(L2*M3+LC2*M2)-cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[16]*(L2*M3+LC2*M2))+z[11]*(dxt[10]*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))+xt[10]^2*(L2*M3+LC2*M2)*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1])))+z[14]*(dxt[13]*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))+xt[13]^2*(L2*M3+LC2*M2)*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4])))+z[17]*(dxt[16]*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))+xt[16]^2*(L2*M3+LC2*M2)*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7])))-cos(xt[1])*z[32]+z[20]*(cos(xt[1])+cos(xt[4])*0.5)+z[23]*(cos(xt[1])+cos(xt[7])*0.5)-sin(xt[1])*z[33]-z[4]*(cos(xt[4])*dxt[27]+(sin(xt[4])*dxt[26])*0.5+(sqrt(3)*sin(xt[4])*dxt[25])*0.5)-z[7]*(cos(xt[7])*dxt[30]+(sin(xt[7])*dxt[29])*0.5-(sqrt(3)*sin(xt[7])*dxt[28])*0.5)+z[21]*(sin(xt[1])-sin(xt[4]))+z[24]*(sin(xt[1])-sin(xt[7]))+z[1]*(cos(xt[1])*dxt[27]+cos(xt[1])*dxt[30]-sin(xt[1])*dxt[26]-sin(xt[1])*dxt[29])+z[27]*(cos(xt[1])*xt[10]-cos(xt[4])*xt[13])+z[30]*(cos(xt[1])*xt[10]-cos(xt[7])*xt[16])+z[13]*(cos(xt[4])*dxt[21]+(sin(xt[4])*dxt[20])*0.5-0.0*cos(xt[4])*(M2+M3)+dxt[14]*(L2*M3+LC2*M2)*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))+2*L1*dxt[13]*(M2+M3)+xt[14]^2*(L2*M3+LC2*M2)*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))+(sqrt(3)*sin(xt[4])*dxt[19])*0.5-cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[15]*(L2*M3+LC2*M2)-cos(xt[4])*cos(xt[6])*sin(xt[5])*xt[15]^2*(L2*M3+LC2*M2)-2*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[14]*xt[15]*(L2*M3+LC2*M2))+z[16]*(cos(xt[7])*dxt[24]+(sin(xt[7])*dxt[23])*0.5-0.0*cos(xt[7])*(M2+M3)+dxt[17]*(L2*M3+LC2*M2)*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))+2*L1*dxt[16]*(M2+M3)+xt[17]^2*(L2*M3+LC2*M2)*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))-(sqrt(3)*sin(xt[7])*dxt[22])*0.5-cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[18]*(L2*M3+LC2*M2)-cos(xt[7])*cos(xt[9])*sin(xt[8])*xt[18]^2*(L2*M3+LC2*M2)-2*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[17]*xt[18]*(L2*M3+LC2*M2))-z[26]*(sin(xt[1])*xt[10]+(sin(xt[4])*xt[13])*0.5)-z[29]*(sin(xt[1])*xt[10]+(sin(xt[7])*xt[16])*0.5)-z[10]*(cos(xt[1])*dxt[21]+cos(xt[1])*dxt[24]-sin(xt[1])*dxt[20]-sin(xt[1])*dxt[23]+0.0*cos(xt[1])*(M2+M3)-dxt[11]*(L2*M3+LC2*M2)*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-2*L1*dxt[10]*(M2+M3)-xt[11]^2*(L2*M3+LC2*M2)*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))+cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[12]*(L2*M3+LC2*M2)+cos(xt[1])*cos(xt[3])*sin(xt[2])*xt[12]^2*(L2*M3+LC2*M2)+2*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[11]*xt[12]*(L2*M3+LC2*M2))+(sqrt(3)*cos(xt[4])*z[19])*0.5-(sqrt(3)*cos(xt[7])*z[22])*0.5-(sqrt(3)*sin(xt[4])*z[25]*xt[13])*0.5+(sqrt(3)*sin(xt[7])*z[28]*xt[16])*0.5)
            res[nx+ndist+3] = dz[nx+ndist+3] - (z[2]*(cos(xt[2])*cos(xt[3])*dxt[27]-sin(xt[2])*dxt[29]-sin(xt[2])*dxt[26]+cos(xt[2])*cos(xt[3])*dxt[30]+cos(xt[2])*sin(xt[3])*dxt[25]+cos(xt[2])*sin(xt[3])*dxt[28])+z[12]*(sin(xt[2])*sin(xt[3])*dxt[21]-cos(xt[3])*sin(xt[2])*dxt[22]-cos(xt[3])*sin(xt[2])*dxt[19]+sin(xt[2])*sin(xt[3])*dxt[24]+2*L2*M3*sin(xt[2])^2*dxt[12]+M3*0.0*sin(xt[2])*sin(xt[3])+2*L2*M3*sin(2*xt[2])*xt[11]*xt[12]+L1*M3*sin(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]^2-L1*M3*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[10])+z[3]*(cos(xt[3])*sin(xt[2])*dxt[25]+cos(xt[3])*sin(xt[2])*dxt[28]-sin(xt[2])*sin(xt[3])*dxt[27]-sin(xt[2])*sin(xt[3])*dxt[30])+z[27]*(cos(xt[2])*cos(xt[3])*xt[11]-cos(xt[5])*cos(xt[6])*xt[14]-sin(xt[2])*sin(xt[3])*xt[12]+sin(xt[5])*sin(xt[6])*xt[15])+z[30]*(cos(xt[2])*cos(xt[3])*xt[11]-cos(xt[8])*cos(xt[9])*xt[17]-sin(xt[2])*sin(xt[3])*xt[12]+sin(xt[8])*sin(xt[9])*xt[18])+z[25]*(cos(xt[2])*sin(xt[3])*xt[11]-(sqrt(3)*sin(xt[5])*xt[14])*0.5+cos(xt[3])*sin(xt[2])*xt[12]+(cos(xt[5])*sin(xt[6])*xt[14])*0.5+(cos(xt[6])*sin(xt[5])*xt[15])*0.5)+z[28]*((sqrt(3)*sin(xt[8])*xt[17])*0.5+cos(xt[2])*sin(xt[3])*xt[11]+cos(xt[3])*sin(xt[2])*xt[12]+(cos(xt[8])*sin(xt[9])*xt[17])*0.5+(cos(xt[9])*sin(xt[8])*xt[18])*0.5)-z[26]*(sin(xt[2])*xt[11]+(sin(xt[5])*xt[14])*0.5+(sqrt(3)*cos(xt[5])*sin(xt[6])*xt[14])*0.5+(sqrt(3)*cos(xt[6])*sin(xt[5])*xt[15])*0.5)-z[29]*(sin(xt[2])*xt[11]+(sin(xt[8])*xt[17])*0.5-(sqrt(3)*cos(xt[8])*sin(xt[9])*xt[17])*0.5-(sqrt(3)*cos(xt[9])*sin(xt[8])*xt[18])*0.5)+z[15]*((sqrt(3)*cos(xt[6])*sin(xt[5])*dxt[20])*0.5-sin(xt[5])*sin(xt[6])*dxt[21]-(cos(xt[6])*sin(xt[5])*dxt[19])*0.5+2*L2*M3*sin(xt[5])^2*dxt[15]+M3*0.0*sin(xt[5])*sin(xt[6])+2*L2*M3*sin(2*xt[5])*xt[14]*xt[15]+L1*M3*sin(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]^2-L1*M3*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[13])-z[18]*((cos(xt[9])*sin(xt[8])*dxt[22])*0.5+sin(xt[8])*sin(xt[9])*dxt[24]+(sqrt(3)*cos(xt[9])*sin(xt[8])*dxt[23])*0.5-2*L2*M3*sin(xt[8])^2*dxt[18]-M3*0.0*sin(xt[8])*sin(xt[9])-2*L2*M3*sin(2*xt[8])*xt[17]*xt[18]-L1*M3*sin(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]^2+L1*M3*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[16])+z[14]*(dxt[20]*(sin(xt[5])*0.5+(sqrt(3)*cos(xt[5])*sin(xt[6]))*0.5)-dxt[19]*((cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*sin(xt[5]))*0.5)+cos(xt[5])*cos(xt[6])*dxt[21]+2*L2*M3*dxt[14]+L1*M3*dxt[13]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-M3*0.0*cos(xt[5])*cos(xt[6])+L1*M3*xt[13]^2*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))-2*L2*M3*cos(xt[5])*sin(xt[5])*xt[15]^2)+z[17]*(dxt[23]*(sin(xt[8])*0.5-(sqrt(3)*cos(xt[8])*sin(xt[9]))*0.5)-dxt[22]*((cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*sin(xt[8]))*0.5)+cos(xt[8])*cos(xt[9])*dxt[24]+2*L2*M3*dxt[17]+L1*M3*dxt[16]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-M3*0.0*cos(xt[8])*cos(xt[9])+L1*M3*xt[16]^2*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))-2*L2*M3*cos(xt[8])*sin(xt[8])*xt[18]^2)-cos(xt[2])*z[32]+z[6]*((cos(xt[6])*sin(xt[5])*dxt[25])*0.5+sin(xt[5])*sin(xt[6])*dxt[27]-(sqrt(3)*cos(xt[6])*sin(xt[5])*dxt[26])*0.5)+z[9]*((cos(xt[9])*sin(xt[8])*dxt[28])*0.5+sin(xt[8])*sin(xt[9])*dxt[30]+(sqrt(3)*cos(xt[9])*sin(xt[8])*dxt[29])*0.5)+z[21]*(cos(xt[3])*sin(xt[2])-cos(xt[6])*sin(xt[5]))+z[24]*(cos(xt[3])*sin(xt[2])-cos(xt[9])*sin(xt[8]))-z[10]*(L1*M3*cos(xt[1])*cos(xt[3])*sin(xt[2])*xt[12]^2-L1*M3*xt[11]^2*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))-L1*M3*dxt[11]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))+L1*M3*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[12]+2*L1*M3*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[11]*xt[12])-z[13]*(L1*M3*cos(xt[4])*cos(xt[6])*sin(xt[5])*xt[15]^2-L1*M3*xt[14]^2*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))-L1*M3*dxt[14]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))+L1*M3*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[15]+2*L1*M3*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[14]*xt[15])-z[16]*(L1*M3*cos(xt[7])*cos(xt[9])*sin(xt[8])*xt[18]^2-L1*M3*xt[17]^2*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))-L1*M3*dxt[17]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))+L1*M3*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[18]+2*L1*M3*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[17]*xt[18])-z[11]*(cos(xt[2])*cos(xt[3])*dxt[21]-sin(xt[2])*dxt[23]-sin(xt[2])*dxt[20]+cos(xt[2])*cos(xt[3])*dxt[24]-2*L2*M3*dxt[11]+cos(xt[2])*sin(xt[3])*dxt[19]+cos(xt[2])*sin(xt[3])*dxt[22]-L1*M3*dxt[10]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))+M3*0.0*cos(xt[2])*cos(xt[3])-L1*M3*xt[10]^2*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))+2*L2*M3*cos(xt[2])*sin(xt[2])*xt[12]^2)-z[5]*(dxt[26]*(sin(xt[5])*0.5+(sqrt(3)*cos(xt[5])*sin(xt[6]))*0.5)-dxt[25]*((cos(xt[5])*sin(xt[6]))*0.5-(sqrt(3)*sin(xt[5]))*0.5)+cos(xt[5])*cos(xt[6])*dxt[27])-z[8]*(dxt[29]*(sin(xt[8])*0.5-(sqrt(3)*cos(xt[8])*sin(xt[9]))*0.5)-dxt[28]*((cos(xt[8])*sin(xt[9]))*0.5+(sqrt(3)*sin(xt[8]))*0.5)+cos(xt[8])*cos(xt[9])*dxt[30])+z[19]*((sqrt(3)*cos(xt[5]))*0.5+sin(xt[2])*sin(xt[3])+(sin(xt[5])*sin(xt[6]))*0.5)+z[22]*(sin(xt[2])*sin(xt[3])-(sqrt(3)*cos(xt[8]))*0.5+(sin(xt[8])*sin(xt[9]))*0.5)+z[20]*(cos(xt[2])+cos(xt[5])*0.5-(sqrt(3)*sin(xt[5])*sin(xt[6]))*0.5)+z[23]*(cos(xt[2])+cos(xt[8])*0.5+(sqrt(3)*sin(xt[8])*sin(xt[9]))*0.5)-cos(xt[3])*sin(xt[2])*z[33]-sin(xt[2])*sin(xt[3])*z[31])
            res[nx+ndist+4] = dz[nx+ndist+4] - (z[32]-(3*z[23])*0.5-(3*z[20])*0.5-(sqrt(3)*z[19])*0.5+(sqrt(3)*z[22])*0.5)
            res[nx+ndist+5] = dz[nx+ndist+5] - (-z[10]*(M1*0.0*cos(xt[1])-2*LC1*M1*dxt[10])-z[13]*(M1*0.0*cos(xt[4])-2*LC1*M1*dxt[13])-z[16]*(M1*0.0*cos(xt[7])-2*LC1*M1*dxt[16]))
            res[nx+ndist+6] = dz[nx+ndist+6] - (z[11]*(2*LC2*M2*dxt[11]+L1*M2*dxt[10]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-M2*0.0*cos(xt[2])*cos(xt[3])+L1*M2*xt[10]^2*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))-2*LC2*M2*cos(xt[2])*sin(xt[2])*xt[12]^2)+z[14]*(2*LC2*M2*dxt[14]+L1*M2*dxt[13]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-M2*0.0*cos(xt[5])*cos(xt[6])+L1*M2*xt[13]^2*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))-2*LC2*M2*cos(xt[5])*sin(xt[5])*xt[15]^2)+z[17]*(2*LC2*M2*dxt[17]+L1*M2*dxt[16]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-M2*0.0*cos(xt[8])*cos(xt[9])+L1*M2*xt[16]^2*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))-2*LC2*M2*cos(xt[8])*sin(xt[8])*xt[18]^2)+z[12]*(2*LC2*M2*sin(xt[2])^2*dxt[12]+M2*0.0*sin(xt[2])*sin(xt[3])+2*LC2*M2*sin(2*xt[2])*xt[11]*xt[12]+L1*M2*sin(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]^2-L1*M2*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[10])+z[15]*(2*LC2*M2*sin(xt[5])^2*dxt[15]+M2*0.0*sin(xt[5])*sin(xt[6])+2*LC2*M2*sin(2*xt[5])*xt[14]*xt[15]+L1*M2*sin(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]^2-L1*M2*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[13])+z[18]*(2*LC2*M2*sin(xt[8])^2*dxt[18]+M2*0.0*sin(xt[8])*sin(xt[9])+2*LC2*M2*sin(2*xt[8])*xt[17]*xt[18]+L1*M2*sin(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]^2-L1*M2*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[16])-z[10]*(L1*M2*cos(xt[1])*cos(xt[3])*sin(xt[2])*xt[12]^2-L1*M2*xt[11]^2*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))-L1*M2*dxt[11]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))+L1*M2*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[12]+2*L1*M2*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[11]*xt[12])-z[13]*(L1*M2*cos(xt[4])*cos(xt[6])*sin(xt[5])*xt[15]^2-L1*M2*xt[14]^2*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))-L1*M2*dxt[14]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))+L1*M2*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[15]+2*L1*M2*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[14]*xt[15])-z[16]*(L1*M2*cos(xt[7])*cos(xt[9])*sin(xt[8])*xt[18]^2-L1*M2*xt[17]^2*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))-L1*M2*dxt[17]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))+L1*M2*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[18]+2*L1*M2*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[17]*xt[18]))
            res[nx+ndist+7] = dz[nx+ndist+7] - (z[10]*(LC1^2*dxt[10]-LC1*0.0*cos(xt[1]))+z[13]*(LC1^2*dxt[13]-LC1*0.0*cos(xt[4]))+z[16]*(LC1^2*dxt[16]-LC1*0.0*cos(xt[7])))
            res[nx+ndist+8] = dz[nx+ndist+8] - (z[11]*(LC2^2*dxt[11]+L1*LC2*dxt[10]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-LC2*0.0*cos(xt[2])*cos(xt[3])+L1*LC2*xt[10]^2*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))-LC2^2*cos(xt[2])*sin(xt[2])*xt[12]^2)+z[14]*(LC2^2*dxt[14]+L1*LC2*dxt[13]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-LC2*0.0*cos(xt[5])*cos(xt[6])+L1*LC2*xt[13]^2*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))-LC2^2*cos(xt[5])*sin(xt[5])*xt[15]^2)+z[17]*(LC2^2*dxt[17]+L1*LC2*dxt[16]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-LC2*0.0*cos(xt[8])*cos(xt[9])+L1*LC2*xt[16]^2*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))-LC2^2*cos(xt[8])*sin(xt[8])*xt[18]^2)+z[12]*(LC2^2*sin(xt[2])^2*dxt[12]+LC2^2*sin(2*xt[2])*xt[11]*xt[12]+LC2*0.0*sin(xt[2])*sin(xt[3])+L1*LC2*sin(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]^2-L1*LC2*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[10])+z[15]*(LC2^2*sin(xt[5])^2*dxt[15]+LC2^2*sin(2*xt[5])*xt[14]*xt[15]+LC2*0.0*sin(xt[5])*sin(xt[6])+L1*LC2*sin(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]^2-L1*LC2*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[13])+z[18]*(LC2^2*sin(xt[8])^2*dxt[18]+LC2^2*sin(2*xt[8])*xt[17]*xt[18]+LC2*0.0*sin(xt[8])*sin(xt[9])+L1*LC2*sin(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]^2-L1*LC2*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[16])-z[10]*(L1*0.0*cos(xt[1])-L1^2*dxt[10]-L1*LC2*dxt[11]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-L1*LC2*xt[11]^2*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))+L1*LC2*cos(xt[1])*cos(xt[3])*sin(xt[2])*xt[12]^2+L1*LC2*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[12]+2*L1*LC2*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[11]*xt[12])-z[13]*(L1*0.0*cos(xt[4])-L1^2*dxt[13]-L1*LC2*dxt[14]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-L1*LC2*xt[14]^2*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))+L1*LC2*cos(xt[4])*cos(xt[6])*sin(xt[5])*xt[15]^2+L1*LC2*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[15]+2*L1*LC2*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[14]*xt[15])-z[16]*(L1*0.0*cos(xt[7])-L1^2*dxt[16]-L1*LC2*dxt[17]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-L1*LC2*xt[17]^2*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))+L1*LC2*cos(xt[7])*cos(xt[9])*sin(xt[8])*xt[18]^2+L1*LC2*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[18]+2*L1*LC2*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[17]*xt[18]))
            res[nx+ndist+9] = dz[nx+ndist+9] - (z[11]*(L2^2*dxt[11]+L1*L2*dxt[10]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-L2*0.0*cos(xt[2])*cos(xt[3])+L1*L2*xt[10]^2*(cos(xt[1])*sin(xt[2])-cos(xt[2])*cos(xt[3])*sin(xt[1]))-L2^2*cos(xt[2])*sin(xt[2])*xt[12]^2)+z[14]*(L2^2*dxt[14]+L1*L2*dxt[13]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-L2*0.0*cos(xt[5])*cos(xt[6])+L1*L2*xt[13]^2*(cos(xt[4])*sin(xt[5])-cos(xt[5])*cos(xt[6])*sin(xt[4]))-L2^2*cos(xt[5])*sin(xt[5])*xt[15]^2)+z[17]*(L2^2*dxt[17]+L1*L2*dxt[16]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-L2*0.0*cos(xt[8])*cos(xt[9])+L1*L2*xt[16]^2*(cos(xt[7])*sin(xt[8])-cos(xt[8])*cos(xt[9])*sin(xt[7]))-L2^2*cos(xt[8])*sin(xt[8])*xt[18]^2)+z[12]*(L2^2*sin(xt[2])^2*dxt[12]+L2^2*sin(2*xt[2])*xt[11]*xt[12]+L2*0.0*sin(xt[2])*sin(xt[3])+L1*L2*sin(xt[1])*sin(xt[2])*sin(xt[3])*xt[10]^2-L1*L2*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[10])+z[15]*(L2^2*sin(xt[5])^2*dxt[15]+L2^2*sin(2*xt[5])*xt[14]*xt[15]+L2*0.0*sin(xt[5])*sin(xt[6])+L1*L2*sin(xt[4])*sin(xt[5])*sin(xt[6])*xt[13]^2-L1*L2*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[13])+z[18]*(L2^2*sin(xt[8])^2*dxt[18]+L2^2*sin(2*xt[8])*xt[17]*xt[18]+L2*0.0*sin(xt[8])*sin(xt[9])+L1*L2*sin(xt[7])*sin(xt[8])*sin(xt[9])*xt[16]^2-L1*L2*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[16])-z[10]*(L1*0.0*cos(xt[1])-L1^2*dxt[10]-L1*L2*dxt[11]*(sin(xt[1])*sin(xt[2])+cos(xt[1])*cos(xt[2])*cos(xt[3]))-L1*L2*xt[11]^2*(cos(xt[2])*sin(xt[1])-cos(xt[1])*cos(xt[3])*sin(xt[2]))+L1*L2*cos(xt[1])*cos(xt[3])*sin(xt[2])*xt[12]^2+L1*L2*cos(xt[1])*sin(xt[2])*sin(xt[3])*dxt[12]+2*L1*L2*cos(xt[1])*cos(xt[2])*sin(xt[3])*xt[11]*xt[12])-z[13]*(L1*0.0*cos(xt[4])-L1^2*dxt[13]-L1*L2*dxt[14]*(sin(xt[4])*sin(xt[5])+cos(xt[4])*cos(xt[5])*cos(xt[6]))-L1*L2*xt[14]^2*(cos(xt[5])*sin(xt[4])-cos(xt[4])*cos(xt[6])*sin(xt[5]))+L1*L2*cos(xt[4])*cos(xt[6])*sin(xt[5])*xt[15]^2+L1*L2*cos(xt[4])*sin(xt[5])*sin(xt[6])*dxt[15]+2*L1*L2*cos(xt[4])*cos(xt[5])*sin(xt[6])*xt[14]*xt[15])-z[16]*(L1*0.0*cos(xt[7])-L1^2*dxt[16]-L1*L2*dxt[17]*(sin(xt[7])*sin(xt[8])+cos(xt[7])*cos(xt[8])*cos(xt[9]))-L1*L2*xt[17]^2*(cos(xt[8])*sin(xt[7])-cos(xt[7])*cos(xt[9])*sin(xt[8]))+L1*L2*cos(xt[7])*cos(xt[9])*sin(xt[8])*xt[18]^2+L1*L2*cos(xt[7])*sin(xt[8])*sin(xt[9])*dxt[18]+2*L1*L2*cos(xt[7])*cos(xt[8])*sin(xt[9])*xt[17]*xt[18]))
            res[nx+ndist+10] = dz[nx+ndist+10] - (dxt[10]*z[10]+dxt[13]*z[13]+dxt[16]*z[16])
            res[nx+ndist+11] = dz[nx+ndist+11] - (z[12]*(sin(xt[2])^2*dxt[12]+sin(2*xt[2])*xt[11]*xt[12])+z[15]*(sin(xt[5])^2*dxt[15]+sin(2*xt[5])*xt[14]*xt[15])+z[18]*(sin(xt[8])^2*dxt[18]+sin(2*xt[8])*xt[17]*xt[18])+z[11]*(dxt[11]-cos(xt[2])*sin(xt[2])*xt[12]^2)+z[14]*(dxt[14]-cos(xt[5])*sin(xt[5])*xt[15]^2)+z[17]*(dxt[17]-cos(xt[8])*sin(xt[8])*xt[18]^2))
            res[nx+ndist+12] = dz[nx+ndist+12] - (z[10]*xt[10]+z[11]*xt[11]+z[12]*xt[12]+z[13]*xt[13]+z[14]*xt[14]+z[15]*xt[15]+z[16]*xt[16]+z[17]*xt[17]+z[18]*xt[18])

            # For ODE disdturbance parameters, only dβᵢ + λₓᵀ(Ǎθᵢ*xw(t) + B̌θᵢ*v(t)) + λwᵀČθᵢxw(t)
            xwt = ad.xw(t)
            vt = ad.v(t)
            for ind=1:ad.nη
                # TODO: To avoid having these blocks in A, B, and C that we know are zero, we could simply use the variable na and do a seprate iteration before and after ind=na
                res[nx+ndist+12+ind] =  # 12 because nθ - nη = 12
                    dz[nx+ndist+12+ind] + z[nx+1:nx+nxw]⋅(ad.Ǎη[(ind-1)nxw+1:ind*nxw,:]*xwt + ad.B̌η[(ind-1)nxw+1:ind*nxw,:]*vt) + z[nx+nxw+1:nx+ndist]⋅(ad.Čη[(ind-1)nw+1:ind*nw,:]*xwt)
            end

            nothing
        end

        # At least for the two forms of index 1 DAEs in my licentiate thesis, λd are always differential and λa are always algebraic.
        # λd always correspond to the differential equations in F, which are equations 1,....,18, from which we get the following dinds and ainds
        # The delta robot is an index 1 DAE exactly on one of these forms
        dinds  = 1:18           # Indices of differential variables
        ainds  = 19:33          # Indices of algebraic variables
        xwinds = 33+1:33+nxw

        ######################## INITIALIZING ADJOINT SYSTEM (Computing terminal values) ####################
        λT, dλT = get_initial_adjoint(dinds, ainds, gₓT, dgₓT, FxT, Fdx(T), dFdxT)
        λdistT, dλdistT = get_initial_adjoint_ODEdist(λT, ad.Č, Fw(T))
        βT, dβT = get_initial_adjoint_beta(λT, FθT, zeros(nθ-ad.nη))
        βdistT, dβdistT = get_initial_adjoint_ODEdistbeta(λdistT[1:nxw], λdistT[nxw+1:end], ad, T, length(w(0.0)))
        z0 = vcat(λT, λdistT, βT, βdistT)
        dz0 = vcat(dλT, dλdistT, dβT, dβdistT)

        # Function returning Gθ given adjoint solution
        function get_Gθ(adj_sol::DAESolution)
            # Because the problem is solved backward in time, the end of the solution corresponds to t=0
            # Gθᵢ = βᵢ(0) + (λᵀFdx xθᵢ)(0) + (λₓᵀ xwθᵢ)(0), though we assume xwθᵢ(0) = 0
            Gθ = adj_sol.u[end][nx+ndist+1:nx+ndist+nθ] + (((adj_sol.u[end][1:nx]')*Fdx(0.0))*xθ0)[:]
        end

        dvars = fill(false, nx+ndist+nθ)
        dvars[dinds] .= true
        dvars[xwinds] .= true
        dvars[end-nθ:end] .= true

        r0 = zeros(length(z0))
        f!(r0, dz0, z0, [], T)

        # t -> 0.0 is just a dummy function, not to be used
        return Model(f!, t -> 0.0, z0, dz0, dvars, r0), get_Gθ
    end
end

################################ DELTA INITIALIZATIONS ################################

function get_delta_initial_with_mats(pars::Vector{Float64}, u0::Vector{Float64}, w0::Vector{Float64})::Tuple{Vector{Float64}, Vector{Float64}, DeltaInitData}
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]

        z  = zeros(30)
        dz = zeros(30)
        z[1:3] = [π/2; acos((L3-L0)/L2); 0.0]
        z[4:6] = [π/2; acos((L3-L0)/L2); 0.0]
        z[7:9] = [π/2; acos((L3-L0)/L2); 0.0]

        H = [
            0.0   L2*cos(z[2])*sin(z[3])   L2*cos(z[3])*sin(z[2])   -(sqrt(3)*L1*sin(z[4]))*0.5   (L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5   (L2*cos(z[6])*sin(z[5]))*0.5   0.0   0.0   0.0
            -L1*sin(z[1])   -L2*sin(z[2])   0.0   -(L1*sin(z[4]))*0.5   -(L2*sin(z[5]))*0.5-(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5   -(sqrt(3)*L2*cos(z[6])*sin(z[5]))*0.5   0.0   0.0   0.0
            L1*cos(z[1])   L2*cos(z[2])*cos(z[3])   -L2*sin(z[2])*sin(z[3])   -L1*cos(z[4])   -L2*cos(z[5])*cos(z[6])   L2*sin(z[5])*sin(z[6])   0.0   0.0   0.0
            0.0   L2*cos(z[2])*sin(z[3])   L2*cos(z[3])*sin(z[2])   0.0   0.0   0.0   (sqrt(3)*L1*sin(z[7]))*0.5   (L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5   (L2*cos(z[9])*sin(z[8]))*0.5
            -L1*sin(z[1])   -L2*sin(z[2])   0.0   0.0   0.0   0.0   -(L1*sin(z[7]))*0.5   (sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5-(L2*sin(z[8]))*0.5   (sqrt(3)*L2*cos(z[9])*sin(z[8]))*0.5
            L1*cos(z[1])   L2*cos(z[2])*cos(z[3])   -L2*sin(z[2])*sin(z[3])   0.0   0.0   0.0   -L1*cos(z[7])   -L2*cos(z[8])*cos(z[9])   L2*sin(z[8])*sin(z[9])
        ]

        m1 = [
            J1+L1^2*(M2+M3)+LC1^2*M1   L1*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))   -L1*cos(z[1])*sin(z[2])*sin(z[3])*(L2*M3+LC2*M2)
            L1*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))   J2+L2^2*M3+LC2^2*M2   0.0
            -L1*cos(z[1])*sin(z[2])*sin(z[3])*(L2*M3+LC2*M2)   0.0   sin(z[2])^2*(J2+L2^2*M3+LC2^2*M2)
        ]
        m2 = [
            J1+L1^2*(M2+M3)+LC1^2*M1   L1*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))   -L1*cos(z[4])*sin(z[5])*sin(z[6])*(L2*M3+LC2*M2)
            L1*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))   J2+L2^2*M3+LC2^2*M2   0
            -L1*cos(z[4])*sin(z[5])*sin(z[6])*(L2*M3+LC2*M2)   0.0   sin(z[5])^2*(J2+L2^2*M3+LC2^2*M2)
        ]
        m3 = [
            J1+L1^2*(M2+M3)+LC1^2*M1   L1*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))   -L1*cos(z[7])*sin(z[8])*sin(z[9])*(L2*M3+LC2*M2)
            L1*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))   J2+L2^2*M3+LC2^2*M2   0
            -L1*cos(z[7])*sin(z[8])*sin(z[9])*(L2*M3+LC2*M2)   0.0   sin(z[8])^2*(J2+L2^2*M3+LC2^2*M2)
        ]

        HinvM = [
            H[:,1:3]/m1   H[:,4:6]/m2   H[:,7:9]/m3
        ]

        cgBu = [
            γ*z[10]-u0[1]+w0[1]^2-g*cos(z[1])*(L1*(M2+M3)+LC1*M1)+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2)
            γ*z[11]-cos(z[2])*sin(z[2])*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[2])*cos(z[3])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))
            γ*z[12]+sin(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*sin(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)
            γ*z[13]-u0[2]+w0[2]^2-g*cos(z[4])*(L1*(M2+M3)+LC1*M1)+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2)
            γ*z[14]-cos(z[5])*sin(z[5])*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[5])*cos(z[6])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))
            γ*z[15]+sin(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+g*sin(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)
            γ*z[16]-u0[3]+w0[3]^2-g*cos(z[7])*(L1*(M2+M3)+LC1*M1)+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2)
            γ*z[17]-cos(z[8])*sin(z[8])*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[8])*cos(z[9])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))
            γ*z[18]+sin(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+g*sin(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)
        ]

        # dκ = (HinvM*transpose(H))\(HinvM*cgBu)
        dz[19:24] = (HinvM*transpose(H))\(HinvM*cgBu)

        # dv = inv(M)*Mvterm
        dz[10:18] = [
            m1\[
                u0[1]+w0[1]^2-γ*z[10]+g*cos(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[21]+L1*cos(z[1])*dz[24]-L1*sin(z[1])*dz[20]-L1*sin(z[1])*dz[23]-L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))+L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2)
                L2*cos(z[2])*cos(z[3])*dz[21]-L2*sin(z[2])*dz[20]-L2*sin(z[2])*dz[23]-γ*z[11]+L2*cos(z[2])*cos(z[3])*dz[24]+L2*cos(z[2])*sin(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[22]+cos(z[2])*sin(z[2])*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*cos(z[3])*(L2*M3+LC2*M2)-L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))
                L2*cos(z[3])*sin(z[2])*dz[19]-γ*z[12]+L2*cos(z[3])*sin(z[2])*dz[22]-L2*sin(z[2])*sin(z[3])*dz[21]-L2*sin(z[2])*sin(z[3])*dz[24]-sin(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-g*sin(z[2])*sin(z[3])*(L2*M3+LC2*M2)-L1*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)
            ]
            m2\[
                u0[2]+w0[2]^2-γ*z[13]+g*cos(z[4])*(L1*(M2+M3)+LC1*M1)-L1*cos(z[4])*dz[21]-(L1*sin(z[4])*dz[20])*0.5-(sqrt(3)*L1*sin(z[4])*dz[19])*0.5-L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))+L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2)
                dz[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dz[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-γ*z[14]-L2*cos(z[5])*cos(z[6])*dz[21]+cos(z[5])*sin(z[5])*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[5])*cos(z[6])*(L2*M3+LC2*M2)-L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))
                (L2*cos(z[6])*sin(z[5])*dz[19])*0.5-γ*z[15]+L2*sin(z[5])*sin(z[6])*dz[21]-sin(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-g*sin(z[5])*sin(z[6])*(L2*M3+LC2*M2)-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dz[20])*0.5-L1*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)
            ]
            m3\[
                u0[3]+w0[3]^2-γ*z[16]+g*cos(z[7])*(L1*(M2+M3)+LC1*M1)-L1*cos(z[7])*dz[24]-(L1*sin(z[7])*dz[23])*0.5+(sqrt(3)*L1*sin(z[7])*dz[22])*0.5-L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))+L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2)
                dz[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dz[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)-γ*z[17]-L2*cos(z[8])*cos(z[9])*dz[24]+cos(z[8])*sin(z[8])*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[8])*cos(z[9])*(L2*M3+LC2*M2)-L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))
                (L2*cos(z[9])*sin(z[8])*dz[22])*0.5-γ*z[18]+L2*sin(z[8])*sin(z[9])*dz[24]-sin(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-g*sin(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dz[23])*0.5-L1*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)
            ]
        ]

        return z, dz, DeltaInitData(H, m1, m2, m3, HinvM, cgBu)
    end
end

function get_delta_initial_L0sens(pars::Vector{Float64}, z::Vector{Float64}, dz::Vector{Float64}, did::DeltaInitData)::Tuple{Vector{Float64}, Vector{Float64}}
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]

        znew  = zeros(30)
        dznew = zeros(30)

        # Sensitivity of initial value wrt to L1 NOT L0, THIS WASN'T UPDATED
        # znew[2] = sqrt(3)/(2*L2*(1-(L0-L3+(sqrt(3)*L1)*0.5)^2/L2^2)^(0.5))
        # znew[5] = sqrt(3)/(2*L2*(1-(L0-L3+(sqrt(3)*L1)*0.5)^2/L2^2)^(0.5))
        # znew[8] = sqrt(3)/(2*L2*(1-(L0-L3+(sqrt(3)*L1)*0.5)^2/L2^2)^(0.5))
        # NEW
        znew[2] = 1/sqrt(L2^2 - (L3-L0)^2)
        znew[5] = 1/sqrt(L2^2 - (L3-L0)^2)
        znew[8] = 1/sqrt(L2^2 - (L3-L0)^2)

        ############################# INITIALIZING SENSITIVITY PART ####################################

        # Block matrix product behaviour reminder
        # [a11 a12 a13] [inv(m1) 0 0]   [a11*inv(m1) a12*inv(m2) a13*inv(m3)]
        # [a21 a22 a23]*[0 inv(m2) 0] = [a21*inv(m1) a22*inv(m2) a23*inv(m3)] = [a_1*inv(m1) a_2*inv(m2) a_3*inv(m3)]
        # [a31 a32 a33] [0 0 inv(m3)]   [a31*inv(m1) a32*inv(m2) a33*inv(m3)]
        # and
        # [inv(m1) 0 0] [a11 a12 a13]   [inv(m1)*a11 inv(m2)*a12 inv(m3)*a13]   [inv(m1)*a_1]
        # [0 inv(m2) 0]*[a21 a22 a23] = [inv(m1)*a21 inv(m2)*a22 inv(m3)*a23] = [inv(m2)*a_2]
        # [0 0 inv(m3)] [a31 a32 a33]   [inv(m1)*a31 inv(m2)*a32 inv(m3)*a33]   [inv(m3)*a_3]

        dH_dp = [    # Hp_sansp
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   -(sqrt(3)*L1*cos(z[4])*znew[4])*0.5   (L2*cos(z[5])*cos(z[6])*znew[6])*0.5-znew[5]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)   (L2*cos(z[5])*cos(z[6])*znew[5])*0.5-(L2*sin(z[5])*sin(z[6])*znew[6])*0.5   0.0   0.0   0
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   -(L1*cos(z[4])*znew[4])*0.5   -znew[5]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[6])*0.5   (sqrt(3)*L2*sin(z[5])*sin(z[6])*znew[6])*0.5-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[5])*0.5   0.0   0.0   0
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   L1*sin(z[4])*znew[4]   L2*cos(z[6])*sin(z[5])*znew[5]+L2*cos(z[5])*sin(z[6])*znew[6]   L2*cos(z[5])*sin(z[6])*znew[5]+L2*cos(z[6])*sin(z[5])*znew[6]   0.0   0.0   0
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   0.0   0.0   0.0   (sqrt(3)*L1*cos(z[7])*znew[7])*0.5   znew[8]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)+(L2*cos(z[8])*cos(z[9])*znew[9])*0.5   (L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   0.0   0.0   0.0   -(L1*cos(z[7])*znew[7])*0.5   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[9])*0.5-znew[8]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   0.0   0.0   0.0   L1*sin(z[7])*znew[7]   L2*cos(z[9])*sin(z[8])*znew[8]+L2*cos(z[8])*sin(z[9])*znew[9]   L2*cos(z[8])*sin(z[9])*znew[8]+L2*cos(z[9])*sin(z[8])*znew[9]        
        ] #+ 0.0 = Hp for p=L0

        dM_dp = [   # Mp_sansp
            0.0   2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0
            2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0
            2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   2*cos(z[2])*sin(z[2])*znew[2]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   0.0   0
            0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   2*cos(z[5])*sin(z[5])*znew[5]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)
            0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)   0.0   2*cos(z[8])*sin(z[8])*znew[8]*(J2+L2^2*M3+LC2^2*M2)        
        ] #+ 0.0 = Mp for p=L0

        dM_dpinvM = [dM_dp[:,1:3]/did.m1   dM_dp[:,4:6]/did.m2   dM_dp[:,7:9]/did.m3]
        dH_dpinvM = [dH_dp[:,1:3]/did.m1   dH_dp[:,4:6]/did.m2   dH_dp[:,7:9]/did.m3]

        orange_term = dH_dpinvM - did.HinvM*dM_dpinvM
        HinvMHT_dp = orange_term*transpose(did.H) + did.HinvM*transpose(dH_dp)

        # dκp = [H*inv(M)*transpose(did.H)]\{orange_term*did.cgBu + H*inv(M)*ddid.cgBu/dp) - [orange_term*transpose(did.H)+H*inv(M)*transpose(dH/dp)] }
        dznew[19:24] = (did.HinvM*transpose(did.H))\(orange_term*did.cgBu + did.HinvM*([    #dz[49:54] =
            # cgBu_p_sansp
            znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))-znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*znew[10]+znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))
            znew[3]*(g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+γ*znew[11]+znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+znew[3]*(g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))+znew[2]*(2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))-znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*znew[13]+znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))
            znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+γ*znew[14]+znew[5]*(sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+znew[6]*(g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))+znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))-znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*znew[16]+znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))
            znew[9]*(g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+γ*znew[17]+znew[8]*(sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))+znew[9]*(g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+znew[8]*(2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ]) - HinvMHT_dp*z[19:24])

        dMvterm_dp = [
            znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-γ*znew[10]-znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+L1*cos(z[1])*dznew[21]+L1*cos(z[1])*dznew[24]-L1*sin(z[1])*dznew[20]-L1*sin(z[1])*dznew[23]
            L2*cos(z[2])*cos(z[3])*dznew[21]-γ*znew[11]-znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-L2*sin(z[2])*dznew[20]-L2*sin(z[2])*dznew[23]-znew[3]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[2])*cos(z[3])*dznew[24]+L2*cos(z[2])*sin(z[3])*dznew[19]+L2*cos(z[2])*sin(z[3])*dznew[22]+2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            L2*cos(z[3])*sin(z[2])*dznew[19]-znew[3]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))-znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))-znew[2]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[3])*sin(z[2])*dznew[22]-L2*sin(z[2])*sin(z[3])*dznew[21]-L2*sin(z[2])*sin(z[3])*dznew[24]-sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)-2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-γ*znew[13]-znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-L1*cos(z[4])*dznew[21]-(L1*sin(z[4])*dznew[20])*0.5-(sqrt(3)*L1*sin(z[4])*dznew[19])*0.5
            dznew[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dznew[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[5]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-γ*znew[14]-L2*cos(z[5])*cos(z[6])*dznew[21]+2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            (L2*cos(z[6])*sin(z[5])*dznew[19])*0.5-znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[6]*((L2*sin(z[5])*sin(z[6])*dz[19])*0.5-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))-znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+L2*sin(z[5])*sin(z[6])*dznew[21]-sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dznew[20])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)-2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-γ*znew[16]-znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-L1*cos(z[7])*dznew[24]-(L1*sin(z[7])*dznew[23])*0.5+(sqrt(3)*L1*sin(z[7])*dznew[22])*0.5
            dznew[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dznew[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+znew[9]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[8]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-γ*znew[17]-L2*cos(z[8])*cos(z[9])*dznew[24]+2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[8]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-znew[9]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+(L2*cos(z[9])*sin(z[8])*dznew[22])*0.5+L2*sin(z[8])*sin(z[9])*dznew[24]-sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dznew[23])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)-2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] # Mvterm_p = 0.0 for p=L0

        # dvp = inv(M)*(dMvterm_dp - rp(dM/dp, dv)), rp is my special product
        dznew[10:18] = [did.m1\(dMvterm_dp[1:3,:] - dM_dp[1:3,:]*dz[10:18])
            did.m2\(dMvterm_dp[4:6,:] - dM_dp[4:6,:]*dz[10:18])
            did.m3\(dMvterm_dp[7:9,:] - dM_dp[7:9,:]*dz[10:18])]

        return znew, dznew
    end
end

function get_delta_initial_L1sens(pars::Vector{Float64}, z::Vector{Float64}, dz::Vector{Float64}, did::DeltaInitData)::Tuple{Vector{Float64}, Vector{Float64}}
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]

        znew  = zeros(30)
        dznew = zeros(30)

        # Sensitivity of initial value wrt to L1 OLD
        # znew[2] = sqrt(3)/(2*L2*(1-(L0-L3+(sqrt(3)*L1)*0.5)^2/L2^2)^(0.5))
        # znew[5] = sqrt(3)/(2*L2*(1-(L0-L3+(sqrt(3)*L1)*0.5)^2/L2^2)^(0.5))
        # znew[8] = sqrt(3)/(2*L2*(1-(L0-L3+(sqrt(3)*L1)*0.5)^2/L2^2)^(0.5))
        # NEW Sensitivity is zero in this case, so there is no need to compute it
        # znew[2] = 0.0
        # znew[5] = 0.0
        # znew[8] = 0.0

        ############################# INITIALIZING SENSITIVITY PART ####################################

        # Block matrix product behaviour reminder
        # [a11 a12 a13] [inv(m1) 0 0]   [a11*inv(m1) a12*inv(m2) a13*inv(m3)]
        # [a21 a22 a23]*[0 inv(m2) 0] = [a21*inv(m1) a22*inv(m2) a23*inv(m3)] = [a_1*inv(m1) a_2*inv(m2) a_3*inv(m3)]
        # [a31 a32 a33] [0 0 inv(m3)]   [a31*inv(m1) a32*inv(m2) a33*inv(m3)]
        # and
        # [inv(m1) 0 0] [a11 a12 a13]   [inv(m1)*a11 inv(m2)*a12 inv(m3)*a13]   [inv(m1)*a_1]
        # [0 inv(m2) 0]*[a21 a22 a23] = [inv(m1)*a21 inv(m2)*a22 inv(m3)*a23] = [inv(m2)*a_2]
        # [0 0 inv(m3)] [a31 a32 a33]   [inv(m1)*a31 inv(m2)*a32 inv(m3)*a33]   [inv(m3)*a_3]

        dH_dp = [    # Hp_sansp
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   -(sqrt(3)*L1*cos(z[4])*znew[4])*0.5   (L2*cos(z[5])*cos(z[6])*znew[6])*0.5-znew[5]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)   (L2*cos(z[5])*cos(z[6])*znew[5])*0.5-(L2*sin(z[5])*sin(z[6])*znew[6])*0.5   0.0   0.0   0
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   -(L1*cos(z[4])*znew[4])*0.5   -znew[5]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[6])*0.5   (sqrt(3)*L2*sin(z[5])*sin(z[6])*znew[6])*0.5-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[5])*0.5   0.0   0.0   0
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   L1*sin(z[4])*znew[4]   L2*cos(z[6])*sin(z[5])*znew[5]+L2*cos(z[5])*sin(z[6])*znew[6]   L2*cos(z[5])*sin(z[6])*znew[5]+L2*cos(z[6])*sin(z[5])*znew[6]   0.0   0.0   0
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   0.0   0.0   0.0   (sqrt(3)*L1*cos(z[7])*znew[7])*0.5   znew[8]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)+(L2*cos(z[8])*cos(z[9])*znew[9])*0.5   (L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   0.0   0.0   0.0   -(L1*cos(z[7])*znew[7])*0.5   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[9])*0.5-znew[8]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   0.0   0.0   0.0   L1*sin(z[7])*znew[7]   L2*cos(z[9])*sin(z[8])*znew[8]+L2*cos(z[8])*sin(z[9])*znew[9]   L2*cos(z[8])*sin(z[9])*znew[8]+L2*cos(z[9])*sin(z[8])*znew[9]        
        ] + [   # Hp for p=L1
            0.0	0.0	0.0	-(sqrt(3)*sin(z[4]))*0.5	0.0	0.0	0.0	0.0	0.0
            -sin(z[1])	0.0	0.0	-sin(z[4])*0.5	0.0	0.0	0.0	0.0	0.0
            cos(z[1])	0.0	0.0	-cos(z[4])	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	(sqrt(3)*sin(z[7]))*0.5	0.0	0.0
            -sin(z[1])	0.0	0.0	0.0	0.0	0.0	-sin(z[7])*0.5	0.0	0.0
            cos(z[1])	0.0	0.0	0.0	0.0	0.0	-cos(z[7])	0.0	0.0
        ]

        dM_dp = [   # Mp_sansp
            0.0   2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0
            2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0
            2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   2*cos(z[2])*sin(z[2])*znew[2]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   0.0   0
            0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   2*cos(z[5])*sin(z[5])*znew[5]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)
            0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)   0.0   2*cos(z[8])*sin(z[8])*znew[8]*(J2+L2^2*M3+LC2^2*M2)        
        ] + [   # Mp for p=L1
            2*L1*(M2+M3)	(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))	-cos(z[1])*sin(z[2])*sin(z[3])*(L2*M3+LC2*M2)	0.0	0.0	0.0	0.0	0.0	0.0
            (L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            -cos(z[1])*sin(z[2])*sin(z[3])*(L2*M3+LC2*M2)	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	2*L1*(M2+M3)	(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))	-cos(z[4])*sin(z[5])*sin(z[6])*(L2*M3+LC2*M2)	0.0	0.0	0.0
            0.0	0.0	0.0	(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	-cos(z[4])*sin(z[5])*sin(z[6])*(L2*M3+LC2*M2)	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	2*L1*(M2+M3)	(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))	-cos(z[7])*sin(z[8])*sin(z[9])*(L2*M3+LC2*M2)
            0.0	0.0	0.0	0.0	0.0	0.0	(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	-cos(z[7])*sin(z[8])*sin(z[9])*(L2*M3+LC2*M2)	0.0	0.0
        ]

        dM_dpinvM = [dM_dp[:,1:3]/did.m1   dM_dp[:,4:6]/did.m2   dM_dp[:,7:9]/did.m3]
        dH_dpinvM = [dH_dp[:,1:3]/did.m1   dH_dp[:,4:6]/did.m2   dH_dp[:,7:9]/did.m3]

        orange_term = dH_dpinvM - did.HinvM*dM_dpinvM
        HinvMHT_dp = orange_term*transpose(did.H) + did.HinvM*transpose(dH_dp)

        # dκp = [H*inv(M)*transpose(did.H)]\{orange_term*did.cgBu + H*inv(M)*ddid.cgBu/dp) - [orange_term*transpose(did.H)+H*inv(M)*transpose(dH/dp)] }
        dznew[19:24] = (did.HinvM*transpose(did.H))\(orange_term*did.cgBu + did.HinvM*([    #dz[49:54] =
            # cgBu_p_sansp
            znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))-znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*znew[10]+znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))
            znew[3]*(g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+γ*znew[11]+znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+znew[3]*(g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))+znew[2]*(2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))-znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*znew[13]+znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))
            znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+γ*znew[14]+znew[5]*(sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+znew[6]*(g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))+znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))-znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*znew[16]+znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))
            znew[9]*(g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+γ*znew[17]+znew[8]*(sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))+znew[9]*(g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+znew[8]*(2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   #cgBu_p for p=L1
            z[11]^2*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-g*cos(z[1])*(M2+M3)-cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)-2*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2)
            z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))
            sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)
            z[14]^2*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-g*cos(z[4])*(M2+M3)-cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)-2*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2)
            z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))
            sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)
            z[17]^2*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-g*cos(z[7])*(M2+M3)-cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)-2*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2)
            z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))
            sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)        
        ]) - HinvMHT_dp*z[19:24])

        dMvterm_dp = [
            znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-γ*znew[10]-znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+L1*cos(z[1])*dznew[21]+L1*cos(z[1])*dznew[24]-L1*sin(z[1])*dznew[20]-L1*sin(z[1])*dznew[23]
            L2*cos(z[2])*cos(z[3])*dznew[21]-γ*znew[11]-znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-L2*sin(z[2])*dznew[20]-L2*sin(z[2])*dznew[23]-znew[3]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[2])*cos(z[3])*dznew[24]+L2*cos(z[2])*sin(z[3])*dznew[19]+L2*cos(z[2])*sin(z[3])*dznew[22]+2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            L2*cos(z[3])*sin(z[2])*dznew[19]-znew[3]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))-znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))-znew[2]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[3])*sin(z[2])*dznew[22]-L2*sin(z[2])*sin(z[3])*dznew[21]-L2*sin(z[2])*sin(z[3])*dznew[24]-sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)-2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-γ*znew[13]-znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-L1*cos(z[4])*dznew[21]-(L1*sin(z[4])*dznew[20])*0.5-(sqrt(3)*L1*sin(z[4])*dznew[19])*0.5
            dznew[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dznew[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[5]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-γ*znew[14]-L2*cos(z[5])*cos(z[6])*dznew[21]+2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            (L2*cos(z[6])*sin(z[5])*dznew[19])*0.5-znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[6]*((L2*sin(z[5])*sin(z[6])*dz[19])*0.5-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))-znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+L2*sin(z[5])*sin(z[6])*dznew[21]-sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dznew[20])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)-2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-γ*znew[16]-znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-L1*cos(z[7])*dznew[24]-(L1*sin(z[7])*dznew[23])*0.5+(sqrt(3)*L1*sin(z[7])*dznew[22])*0.5
            dznew[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dznew[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+znew[9]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[8]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-γ*znew[17]-L2*cos(z[8])*cos(z[9])*dznew[24]+2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[8]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-znew[9]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+(L2*cos(z[9])*sin(z[8])*dznew[22])*0.5+L2*sin(z[8])*sin(z[9])*dznew[24]-sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dznew[23])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)-2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   # Mvterm_p for p=L1
            cos(z[1])*dz[21]+cos(z[1])*dz[24]-sin(z[1])*dz[20]-sin(z[1])*dz[23]+g*cos(z[1])*(M2+M3)-z[11]^2*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))+cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2)
            -z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))
            -sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2)
            g*cos(z[4])*(M2+M3)-(sin(z[4])*dz[20])*0.5-cos(z[4])*dz[21]-z[14]^2*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-(sqrt(3)*sin(z[4])*dz[19])*0.5+cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2)
            -z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))
            -sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2)
            g*cos(z[7])*(M2+M3)-(sin(z[7])*dz[23])*0.5-cos(z[7])*dz[24]-z[17]^2*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))+(sqrt(3)*sin(z[7])*dz[22])*0.5+cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2)
            -z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))
            -sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2)        
        ]

        # dvp = inv(M)*(dMvterm_dp - rp(dM/dp, dv)), rp is my special product
        dznew[10:18] = [did.m1\(dMvterm_dp[1:3,:] - dM_dp[1:3,:]*dz[10:18])
            did.m2\(dMvterm_dp[4:6,:] - dM_dp[4:6,:]*dz[10:18])
            did.m3\(dMvterm_dp[7:9,:] - dM_dp[7:9,:]*dz[10:18])]

        return znew, dznew
    end
end

function get_delta_initial_L2sens(pars::Vector{Float64}, z::Vector{Float64}, dz::Vector{Float64}, did::DeltaInitData)::Tuple{Vector{Float64}, Vector{Float64}}
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]

        znew  = zeros(30)
        dznew = zeros(30)

        # # Sensitivity of initial value wrt to L1 NOT L2, THIS WASN'T UPDATED
        # znew[2] = sqrt(3)/(2*L2*(1-(L0-L3+(sqrt(3)*L1)*0.5)^2/L2^2)^(0.5))
        # znew[5] = sqrt(3)/(2*L2*(1-(L0-L3+(sqrt(3)*L1)*0.5)^2/L2^2)^(0.5))
        # znew[8] = sqrt(3)/(2*L2*(1-(L0-L3+(sqrt(3)*L1)*0.5)^2/L2^2)^(0.5))
        # NEW
        znew[2] = (L3-L0)/(L2*sqrt(L2^2 - (L3-L0)^2))
        znew[5] = (L3-L0)/(L2*sqrt(L2^2 - (L3-L0)^2))
        znew[8] = (L3-L0)/(L2*sqrt(L2^2 - (L3-L0)^2))

        ############################# INITIALIZING SENSITIVITY PART ####################################

        # Block matrix product behaviour reminder
        # [a11 a12 a13] [inv(m1) 0 0]   [a11*inv(m1) a12*inv(m2) a13*inv(m3)]
        # [a21 a22 a23]*[0 inv(m2) 0] = [a21*inv(m1) a22*inv(m2) a23*inv(m3)] = [a_1*inv(m1) a_2*inv(m2) a_3*inv(m3)]
        # [a31 a32 a33] [0 0 inv(m3)]   [a31*inv(m1) a32*inv(m2) a33*inv(m3)]
        # and
        # [inv(m1) 0 0] [a11 a12 a13]   [inv(m1)*a11 inv(m2)*a12 inv(m3)*a13]   [inv(m1)*a_1]
        # [0 inv(m2) 0]*[a21 a22 a23] = [inv(m1)*a21 inv(m2)*a22 inv(m3)*a23] = [inv(m2)*a_2]
        # [0 0 inv(m3)] [a31 a32 a33]   [inv(m1)*a31 inv(m2)*a32 inv(m3)*a33]   [inv(m3)*a_3]

        dH_dp = [    # Hp_sansp
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   -(sqrt(3)*L1*cos(z[4])*znew[4])*0.5   (L2*cos(z[5])*cos(z[6])*znew[6])*0.5-znew[5]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)   (L2*cos(z[5])*cos(z[6])*znew[5])*0.5-(L2*sin(z[5])*sin(z[6])*znew[6])*0.5   0.0   0.0   0
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   -(L1*cos(z[4])*znew[4])*0.5   -znew[5]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[6])*0.5   (sqrt(3)*L2*sin(z[5])*sin(z[6])*znew[6])*0.5-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[5])*0.5   0.0   0.0   0
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   L1*sin(z[4])*znew[4]   L2*cos(z[6])*sin(z[5])*znew[5]+L2*cos(z[5])*sin(z[6])*znew[6]   L2*cos(z[5])*sin(z[6])*znew[5]+L2*cos(z[6])*sin(z[5])*znew[6]   0.0   0.0   0
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   0.0   0.0   0.0   (sqrt(3)*L1*cos(z[7])*znew[7])*0.5   znew[8]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)+(L2*cos(z[8])*cos(z[9])*znew[9])*0.5   (L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   0.0   0.0   0.0   -(L1*cos(z[7])*znew[7])*0.5   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[9])*0.5-znew[8]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   0.0   0.0   0.0   L1*sin(z[7])*znew[7]   L2*cos(z[9])*sin(z[8])*znew[8]+L2*cos(z[8])*sin(z[9])*znew[9]   L2*cos(z[8])*sin(z[9])*znew[8]+L2*cos(z[9])*sin(z[8])*znew[9]        
        ] + [   # Hp for p=L2
            0.0	cos(z[2])*sin(z[3])	cos(z[3])*sin(z[2])	0.0	(cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*sin(z[5]))*0.5	(cos(z[6])*sin(z[5]))*0.5	0.0	0.0	0.0
            0.0	-sin(z[2])	0.0	0.0	-sin(z[5])*0.5-(sqrt(3)*cos(z[5])*sin(z[6]))*0.5	-(sqrt(3)*cos(z[6])*sin(z[5]))*0.5	0.0	0.0	0.0
            0.0	cos(z[2])*cos(z[3])	-sin(z[2])*sin(z[3])	0.0	-cos(z[5])*cos(z[6])	sin(z[5])*sin(z[6])	0.0	0.0	0
            0.0	cos(z[2])*sin(z[3])	cos(z[3])*sin(z[2])	0.0	0.0	0.0	0.0	(cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*sin(z[8]))*0.5	(cos(z[9])*sin(z[8]))*0.5
            0.0	-sin(z[2])	0.0	0.0	0.0	0.0	0.0	(sqrt(3)*cos(z[8])*sin(z[9]))*0.5-sin(z[8])*0.5	(sqrt(3)*cos(z[9])*sin(z[8]))*0.5
            0.0	cos(z[2])*cos(z[3])	-sin(z[2])*sin(z[3])	0.0	0.0	0.0	0.0	-cos(z[8])*cos(z[9])	sin(z[8])*sin(z[9])        
        ]

        dM_dp = [   # Mp_sansp
            0.0   2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0
            2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0
            2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   2*cos(z[2])*sin(z[2])*znew[2]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   0.0   0
            0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   2*cos(z[5])*sin(z[5])*znew[5]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)
            0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)   0.0   2*cos(z[8])*sin(z[8])*znew[8]*(J2+L2^2*M3+LC2^2*M2)        
        ] + [   # Mp for p=L2
            0.0	L1*M3*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))	-L1*M3*cos(z[1])*sin(z[2])*sin(z[3])	0.0	0.0	0.0	0.0	0.0	0.0
            L1*M3*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))	2*L2*M3	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            -L1*M3*cos(z[1])*sin(z[2])*sin(z[3])	0.0	2*L2*M3*sin(z[2])^2	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	L1*M3*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))	-L1*M3*cos(z[4])*sin(z[5])*sin(z[6])	0.0	0.0	0.0
            0.0	0.0	0.0	L1*M3*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))	2*L2*M3	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	-L1*M3*cos(z[4])*sin(z[5])*sin(z[6])	0.0	2*L2*M3*sin(z[5])^2	0.0	0.0	0
            0.0	0.0	0.0	0.0	0.0	0.0	0.0	L1*M3*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))	-L1*M3*cos(z[7])*sin(z[8])*sin(z[9])
            0.0	0.0	0.0	0.0	0.0	0.0	L1*M3*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))	2*L2*M3	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	-L1*M3*cos(z[7])*sin(z[8])*sin(z[9])	0.0	2*L2*M3*sin(z[8])^2
        ]

        dM_dpinvM = [dM_dp[:,1:3]/did.m1   dM_dp[:,4:6]/did.m2   dM_dp[:,7:9]/did.m3]
        dH_dpinvM = [dH_dp[:,1:3]/did.m1   dH_dp[:,4:6]/did.m2   dH_dp[:,7:9]/did.m3]

        orange_term = dH_dpinvM - did.HinvM*dM_dpinvM
        HinvMHT_dp = orange_term*transpose(did.H) + did.HinvM*transpose(dH_dp)

        # dκp = [H*inv(M)*transpose(did.H)]\{orange_term*did.cgBu + H*inv(M)*ddid.cgBu/dp) - [orange_term*transpose(did.H)+H*inv(M)*transpose(dH/dp)] }
        dznew[19:24] = (did.HinvM*transpose(did.H))\(orange_term*did.cgBu + did.HinvM*([    #dz[49:54] =
            # cgBu_p_sansp
            znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))-znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*znew[10]+znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))
            znew[3]*(g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+γ*znew[11]+znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+znew[3]*(g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))+znew[2]*(2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))-znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*znew[13]+znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))
            znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+γ*znew[14]+znew[5]*(sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+znew[6]*(g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))+znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))-znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*znew[16]+znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))
            znew[9]*(g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+γ*znew[17]+znew[8]*(sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))+znew[9]*(g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+znew[8]*(2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   #cgBu_p for p=L2
            L1*M3*z[11]^2*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*M3*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2-2*L1*M3*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]
            L1*M3*z[10]^2*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-M3*g*cos(z[2])*cos(z[3])-2*L2*M3*cos(z[2])*sin(z[2])*z[12]^2
            M3*g*sin(z[2])*sin(z[3])+2*L2*M3*sin(2*z[2])*z[11]*z[12]+L1*M3*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2
            L1*M3*z[14]^2*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*M3*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2-2*L1*M3*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]
            L1*M3*z[13]^2*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-M3*g*cos(z[5])*cos(z[6])-2*L2*M3*cos(z[5])*sin(z[5])*z[15]^2
            M3*g*sin(z[5])*sin(z[6])+2*L2*M3*sin(2*z[5])*z[14]*z[15]+L1*M3*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2
            L1*M3*z[17]^2*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*M3*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2-2*L1*M3*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]
            L1*M3*z[16]^2*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-M3*g*cos(z[8])*cos(z[9])-2*L2*M3*cos(z[8])*sin(z[8])*z[18]^2
            M3*g*sin(z[8])*sin(z[9])+2*L2*M3*sin(2*z[8])*z[17]*z[18]+L1*M3*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2              
        ]) - HinvMHT_dp*z[19:24])

        dMvterm_dp = [
            znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-γ*znew[10]-znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+L1*cos(z[1])*dznew[21]+L1*cos(z[1])*dznew[24]-L1*sin(z[1])*dznew[20]-L1*sin(z[1])*dznew[23]
            L2*cos(z[2])*cos(z[3])*dznew[21]-γ*znew[11]-znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-L2*sin(z[2])*dznew[20]-L2*sin(z[2])*dznew[23]-znew[3]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[2])*cos(z[3])*dznew[24]+L2*cos(z[2])*sin(z[3])*dznew[19]+L2*cos(z[2])*sin(z[3])*dznew[22]+2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            L2*cos(z[3])*sin(z[2])*dznew[19]-znew[3]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))-znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))-znew[2]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[3])*sin(z[2])*dznew[22]-L2*sin(z[2])*sin(z[3])*dznew[21]-L2*sin(z[2])*sin(z[3])*dznew[24]-sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)-2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-γ*znew[13]-znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-L1*cos(z[4])*dznew[21]-(L1*sin(z[4])*dznew[20])*0.5-(sqrt(3)*L1*sin(z[4])*dznew[19])*0.5
            dznew[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dznew[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[5]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-γ*znew[14]-L2*cos(z[5])*cos(z[6])*dznew[21]+2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            (L2*cos(z[6])*sin(z[5])*dznew[19])*0.5-znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[6]*((L2*sin(z[5])*sin(z[6])*dz[19])*0.5-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))-znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+L2*sin(z[5])*sin(z[6])*dznew[21]-sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dznew[20])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)-2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-γ*znew[16]-znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-L1*cos(z[7])*dznew[24]-(L1*sin(z[7])*dznew[23])*0.5+(sqrt(3)*L1*sin(z[7])*dznew[22])*0.5
            dznew[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dznew[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+znew[9]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[8]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-γ*znew[17]-L2*cos(z[8])*cos(z[9])*dznew[24]+2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[8]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-znew[9]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+(L2*cos(z[9])*sin(z[8])*dznew[22])*0.5+L2*sin(z[8])*sin(z[9])*dznew[24]-sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dznew[23])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)-2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   # Mvterm_p for p=L2
            L1*M3*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2-L1*M3*z[11]^2*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))+2*L1*M3*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]
            cos(z[2])*cos(z[3])*dz[21]-sin(z[2])*dz[23]-sin(z[2])*dz[20]+cos(z[2])*cos(z[3])*dz[24]+cos(z[2])*sin(z[3])*dz[19]+cos(z[2])*sin(z[3])*dz[22]+M3*g*cos(z[2])*cos(z[3])-L1*M3*z[10]^2*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+2*L2*M3*cos(z[2])*sin(z[2])*z[12]^2
            cos(z[3])*sin(z[2])*dz[19]+cos(z[3])*sin(z[2])*dz[22]-sin(z[2])*sin(z[3])*dz[21]-sin(z[2])*sin(z[3])*dz[24]-M3*g*sin(z[2])*sin(z[3])-2*L2*M3*sin(2*z[2])*z[11]*z[12]-L1*M3*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2
            L1*M3*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2-L1*M3*z[14]^2*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))+2*L1*M3*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]
            dz[19]*((cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*sin(z[5]))*0.5)-dz[20]*(sin(z[5])*0.5+(sqrt(3)*cos(z[5])*sin(z[6]))*0.5)-cos(z[5])*cos(z[6])*dz[21]+M3*g*cos(z[5])*cos(z[6])-L1*M3*z[13]^2*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+2*L2*M3*cos(z[5])*sin(z[5])*z[15]^2
            (cos(z[6])*sin(z[5])*dz[19])*0.5+sin(z[5])*sin(z[6])*dz[21]-(sqrt(3)*cos(z[6])*sin(z[5])*dz[20])*0.5-M3*g*sin(z[5])*sin(z[6])-2*L2*M3*sin(2*z[5])*z[14]*z[15]-L1*M3*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2
            L1*M3*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2-L1*M3*z[17]^2*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))+2*L1*M3*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]
            dz[22]*((cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*sin(z[8]))*0.5)-dz[23]*(sin(z[8])*0.5-(sqrt(3)*cos(z[8])*sin(z[9]))*0.5)-cos(z[8])*cos(z[9])*dz[24]+M3*g*cos(z[8])*cos(z[9])-L1*M3*z[16]^2*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+2*L2*M3*cos(z[8])*sin(z[8])*z[18]^2
            (cos(z[9])*sin(z[8])*dz[22])*0.5+sin(z[8])*sin(z[9])*dz[24]+(sqrt(3)*cos(z[9])*sin(z[8])*dz[23])*0.5-M3*g*sin(z[8])*sin(z[9])-2*L2*M3*sin(2*z[8])*z[17]*z[18]-L1*M3*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2              
        ]

        # dvp = inv(M)*(dMvterm_dp - rp(dM/dp, dv)), rp is my special product
        dznew[10:18] = [did.m1\(dMvterm_dp[1:3,:] - dM_dp[1:3,:]*dz[10:18])
            did.m2\(dMvterm_dp[4:6,:] - dM_dp[4:6,:]*dz[10:18])
            did.m3\(dMvterm_dp[7:9,:] - dM_dp[7:9,:]*dz[10:18])]

        return znew, dznew
    end
end

function get_delta_initial_L3sens(pars::Vector{Float64}, z::Vector{Float64}, dz::Vector{Float64}, did::DeltaInitData)::Tuple{Vector{Float64}, Vector{Float64}}
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]

        znew  = zeros(30)
        dznew = zeros(30)

        # # Sensitivity of initial value wrt to L1 NOT L3, THIS WASN'T UPDATED
        # znew[2] = sqrt(3)/(2*L2*(1-(L0-L3+(sqrt(3)*L1)*0.5)^2/L2^2)^(0.5))
        # znew[5] = sqrt(3)/(2*L2*(1-(L0-L3+(sqrt(3)*L1)*0.5)^2/L2^2)^(0.5))
        # znew[8] = sqrt(3)/(2*L2*(1-(L0-L3+(sqrt(3)*L1)*0.5)^2/L2^2)^(0.5))
        # NEW
        znew[2] = -1/sqrt(L2^2 - (L3-L0)^2)
        znew[5] = -1/sqrt(L2^2 - (L3-L0)^2)
        znew[8] = -1/sqrt(L2^2 - (L3-L0)^2)

        ############################# INITIALIZING SENSITIVITY PART ####################################

        # Block matrix product behaviour reminder
        # [a11 a12 a13] [inv(m1) 0 0]   [a11*inv(m1) a12*inv(m2) a13*inv(m3)]
        # [a21 a22 a23]*[0 inv(m2) 0] = [a21*inv(m1) a22*inv(m2) a23*inv(m3)] = [a_1*inv(m1) a_2*inv(m2) a_3*inv(m3)]
        # [a31 a32 a33] [0 0 inv(m3)]   [a31*inv(m1) a32*inv(m2) a33*inv(m3)]
        # and
        # [inv(m1) 0 0] [a11 a12 a13]   [inv(m1)*a11 inv(m2)*a12 inv(m3)*a13]   [inv(m1)*a_1]
        # [0 inv(m2) 0]*[a21 a22 a23] = [inv(m1)*a21 inv(m2)*a22 inv(m3)*a23] = [inv(m2)*a_2]
        # [0 0 inv(m3)] [a31 a32 a33]   [inv(m1)*a31 inv(m2)*a32 inv(m3)*a33]   [inv(m3)*a_3]

        dH_dp = [    # Hp_sansp
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   -(sqrt(3)*L1*cos(z[4])*znew[4])*0.5   (L2*cos(z[5])*cos(z[6])*znew[6])*0.5-znew[5]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)   (L2*cos(z[5])*cos(z[6])*znew[5])*0.5-(L2*sin(z[5])*sin(z[6])*znew[6])*0.5   0.0   0.0   0
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   -(L1*cos(z[4])*znew[4])*0.5   -znew[5]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[6])*0.5   (sqrt(3)*L2*sin(z[5])*sin(z[6])*znew[6])*0.5-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[5])*0.5   0.0   0.0   0
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   L1*sin(z[4])*znew[4]   L2*cos(z[6])*sin(z[5])*znew[5]+L2*cos(z[5])*sin(z[6])*znew[6]   L2*cos(z[5])*sin(z[6])*znew[5]+L2*cos(z[6])*sin(z[5])*znew[6]   0.0   0.0   0
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   0.0   0.0   0.0   (sqrt(3)*L1*cos(z[7])*znew[7])*0.5   znew[8]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)+(L2*cos(z[8])*cos(z[9])*znew[9])*0.5   (L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   0.0   0.0   0.0   -(L1*cos(z[7])*znew[7])*0.5   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[9])*0.5-znew[8]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   0.0   0.0   0.0   L1*sin(z[7])*znew[7]   L2*cos(z[9])*sin(z[8])*znew[8]+L2*cos(z[8])*sin(z[9])*znew[9]   L2*cos(z[8])*sin(z[9])*znew[8]+L2*cos(z[9])*sin(z[8])*znew[9]        
        ] #  + 0.0 = Hp for p=L3

        dM_dp = [   # Mp_sansp
            0.0   2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0
            2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0
            2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   2*cos(z[2])*sin(z[2])*znew[2]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   0.0   0
            0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   2*cos(z[5])*sin(z[5])*znew[5]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)
            0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)   0.0   2*cos(z[8])*sin(z[8])*znew[8]*(J2+L2^2*M3+LC2^2*M2)        
        ] # + 0.0 =  Mp for p=L3

        dM_dpinvM = [dM_dp[:,1:3]/did.m1   dM_dp[:,4:6]/did.m2   dM_dp[:,7:9]/did.m3]
        dH_dpinvM = [dH_dp[:,1:3]/did.m1   dH_dp[:,4:6]/did.m2   dH_dp[:,7:9]/did.m3]

        orange_term = dH_dpinvM - did.HinvM*dM_dpinvM
        HinvMHT_dp = orange_term*transpose(did.H) + did.HinvM*transpose(dH_dp)

        # dκp = [H*inv(M)*transpose(did.H)]\{orange_term*did.cgBu + H*inv(M)*ddid.cgBu/dp) - [orange_term*transpose(did.H)+H*inv(M)*transpose(dH/dp)] }
        dznew[19:24] = (did.HinvM*transpose(did.H))\(orange_term*did.cgBu + did.HinvM*([    #dz[49:54] =
            # cgBu_p_sansp
            znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))-znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*znew[10]+znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))
            znew[3]*(g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+γ*znew[11]+znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+znew[3]*(g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))+znew[2]*(2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))-znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*znew[13]+znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))
            znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+γ*znew[14]+znew[5]*(sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+znew[6]*(g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))+znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))-znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*znew[16]+znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))
            znew[9]*(g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+γ*znew[17]+znew[8]*(sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))+znew[9]*(g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+znew[8]*(2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ]) - HinvMHT_dp*z[19:24])

        dMvterm_dp = [
            znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-γ*znew[10]-znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+L1*cos(z[1])*dznew[21]+L1*cos(z[1])*dznew[24]-L1*sin(z[1])*dznew[20]-L1*sin(z[1])*dznew[23]
            L2*cos(z[2])*cos(z[3])*dznew[21]-γ*znew[11]-znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-L2*sin(z[2])*dznew[20]-L2*sin(z[2])*dznew[23]-znew[3]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[2])*cos(z[3])*dznew[24]+L2*cos(z[2])*sin(z[3])*dznew[19]+L2*cos(z[2])*sin(z[3])*dznew[22]+2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            L2*cos(z[3])*sin(z[2])*dznew[19]-znew[3]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))-znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))-znew[2]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[3])*sin(z[2])*dznew[22]-L2*sin(z[2])*sin(z[3])*dznew[21]-L2*sin(z[2])*sin(z[3])*dznew[24]-sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)-2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-γ*znew[13]-znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-L1*cos(z[4])*dznew[21]-(L1*sin(z[4])*dznew[20])*0.5-(sqrt(3)*L1*sin(z[4])*dznew[19])*0.5
            dznew[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dznew[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[5]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-γ*znew[14]-L2*cos(z[5])*cos(z[6])*dznew[21]+2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            (L2*cos(z[6])*sin(z[5])*dznew[19])*0.5-znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[6]*((L2*sin(z[5])*sin(z[6])*dz[19])*0.5-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))-znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+L2*sin(z[5])*sin(z[6])*dznew[21]-sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dznew[20])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)-2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-γ*znew[16]-znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-L1*cos(z[7])*dznew[24]-(L1*sin(z[7])*dznew[23])*0.5+(sqrt(3)*L1*sin(z[7])*dznew[22])*0.5
            dznew[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dznew[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+znew[9]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[8]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-γ*znew[17]-L2*cos(z[8])*cos(z[9])*dznew[24]+2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[8]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-znew[9]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+(L2*cos(z[9])*sin(z[8])*dznew[22])*0.5+L2*sin(z[8])*sin(z[9])*dznew[24]-sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dznew[23])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)-2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ]

        # dvp = inv(M)*(dMvterm_dp - rp(dM/dp, dv)), rp is my special product
        dznew[10:18] = [did.m1\(dMvterm_dp[1:3,:] - dM_dp[1:3,:]*dz[10:18])
            did.m2\(dMvterm_dp[4:6,:] - dM_dp[4:6,:]*dz[10:18])
            did.m3\(dMvterm_dp[7:9,:] - dM_dp[7:9,:]*dz[10:18])]

        return znew, dznew
    end
end

function get_delta_initial_LC1sens(pars::Vector{Float64}, z::Vector{Float64}, dz::Vector{Float64}, did::DeltaInitData)::Tuple{Vector{Float64}, Vector{Float64}}
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]

        znew  = zeros(30)
        dznew = zeros(30)

        # Sensitivity of initial value wrt to LC1
        # znew[2] = 0.0
        # znew[5] = 0.0
        # znew[8] = 0.0

        ############################# INITIALIZING SENSITIVITY PART ####################################

        # Block matrix product behaviour reminder
        # [a11 a12 a13] [inv(m1) 0 0]   [a11*inv(m1) a12*inv(m2) a13*inv(m3)]
        # [a21 a22 a23]*[0 inv(m2) 0] = [a21*inv(m1) a22*inv(m2) a23*inv(m3)] = [a_1*inv(m1) a_2*inv(m2) a_3*inv(m3)]
        # [a31 a32 a33] [0 0 inv(m3)]   [a31*inv(m1) a32*inv(m2) a33*inv(m3)]
        # and
        # [inv(m1) 0 0] [a11 a12 a13]   [inv(m1)*a11 inv(m2)*a12 inv(m3)*a13]   [inv(m1)*a_1]
        # [0 inv(m2) 0]*[a21 a22 a23] = [inv(m1)*a21 inv(m2)*a22 inv(m3)*a23] = [inv(m2)*a_2]
        # [0 0 inv(m3)] [a31 a32 a33]   [inv(m1)*a31 inv(m2)*a32 inv(m3)*a33]   [inv(m3)*a_3]

        dH_dp = [    # Hp_sansp
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   -(sqrt(3)*L1*cos(z[4])*znew[4])*0.5   (L2*cos(z[5])*cos(z[6])*znew[6])*0.5-znew[5]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)   (L2*cos(z[5])*cos(z[6])*znew[5])*0.5-(L2*sin(z[5])*sin(z[6])*znew[6])*0.5   0.0   0.0   0
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   -(L1*cos(z[4])*znew[4])*0.5   -znew[5]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[6])*0.5   (sqrt(3)*L2*sin(z[5])*sin(z[6])*znew[6])*0.5-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[5])*0.5   0.0   0.0   0
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   L1*sin(z[4])*znew[4]   L2*cos(z[6])*sin(z[5])*znew[5]+L2*cos(z[5])*sin(z[6])*znew[6]   L2*cos(z[5])*sin(z[6])*znew[5]+L2*cos(z[6])*sin(z[5])*znew[6]   0.0   0.0   0
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   0.0   0.0   0.0   (sqrt(3)*L1*cos(z[7])*znew[7])*0.5   znew[8]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)+(L2*cos(z[8])*cos(z[9])*znew[9])*0.5   (L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   0.0   0.0   0.0   -(L1*cos(z[7])*znew[7])*0.5   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[9])*0.5-znew[8]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   0.0   0.0   0.0   L1*sin(z[7])*znew[7]   L2*cos(z[9])*sin(z[8])*znew[8]+L2*cos(z[8])*sin(z[9])*znew[9]   L2*cos(z[8])*sin(z[9])*znew[8]+L2*cos(z[9])*sin(z[8])*znew[9]        
        ]   # + 0.0 = Hp for p=LC1

        dM_dp = [   # Mp_sansp
            0.0   2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0
            2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0
            2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   2*cos(z[2])*sin(z[2])*znew[2]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   0.0   0
            0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   2*cos(z[5])*sin(z[5])*znew[5]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)
            0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)   0.0   2*cos(z[8])*sin(z[8])*znew[8]*(J2+L2^2*M3+LC2^2*M2)        
        ] + [   # Mp for p=LC1
            2*LC1*M1	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	2*LC1*M1	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	2*LC1*M1	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0   
        ]

        dM_dpinvM = [dM_dp[:,1:3]/did.m1   dM_dp[:,4:6]/did.m2   dM_dp[:,7:9]/did.m3]
        dH_dpinvM = [dH_dp[:,1:3]/did.m1   dH_dp[:,4:6]/did.m2   dH_dp[:,7:9]/did.m3]

        orange_term = dH_dpinvM - did.HinvM*dM_dpinvM
        HinvMHT_dp = orange_term*transpose(did.H) + did.HinvM*transpose(dH_dp)

        # dκp = [H*inv(M)*transpose(did.H)]\{orange_term*did.cgBu + H*inv(M)*ddid.cgBu/dp) - [orange_term*transpose(did.H)+H*inv(M)*transpose(dH/dp)] }
        dznew[19:24] = (did.HinvM*transpose(did.H))\(orange_term*did.cgBu + did.HinvM*([    #dz[49:54] =
            # cgBu_p_sansp
            znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))-znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*znew[10]+znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))
            znew[3]*(g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+γ*znew[11]+znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+znew[3]*(g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))+znew[2]*(2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))-znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*znew[13]+znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))
            znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+γ*znew[14]+znew[5]*(sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+znew[6]*(g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))+znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))-znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*znew[16]+znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))
            znew[9]*(g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+γ*znew[17]+znew[8]*(sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))+znew[9]*(g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+znew[8]*(2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   #cgBu_p for p=LC1
            -M1*g*cos(z[1])
            0.0
            0.0
            -M1*g*cos(z[4])
            0.0
            0.0
            -M1*g*cos(z[7])
            0.0
            0.0              
        ]) - HinvMHT_dp*z[19:24])

        dMvterm_dp = [
            znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-γ*znew[10]-znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+L1*cos(z[1])*dznew[21]+L1*cos(z[1])*dznew[24]-L1*sin(z[1])*dznew[20]-L1*sin(z[1])*dznew[23]
            L2*cos(z[2])*cos(z[3])*dznew[21]-γ*znew[11]-znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-L2*sin(z[2])*dznew[20]-L2*sin(z[2])*dznew[23]-znew[3]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[2])*cos(z[3])*dznew[24]+L2*cos(z[2])*sin(z[3])*dznew[19]+L2*cos(z[2])*sin(z[3])*dznew[22]+2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            L2*cos(z[3])*sin(z[2])*dznew[19]-znew[3]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))-znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))-znew[2]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[3])*sin(z[2])*dznew[22]-L2*sin(z[2])*sin(z[3])*dznew[21]-L2*sin(z[2])*sin(z[3])*dznew[24]-sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)-2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-γ*znew[13]-znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-L1*cos(z[4])*dznew[21]-(L1*sin(z[4])*dznew[20])*0.5-(sqrt(3)*L1*sin(z[4])*dznew[19])*0.5
            dznew[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dznew[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[5]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-γ*znew[14]-L2*cos(z[5])*cos(z[6])*dznew[21]+2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            (L2*cos(z[6])*sin(z[5])*dznew[19])*0.5-znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[6]*((L2*sin(z[5])*sin(z[6])*dz[19])*0.5-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))-znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+L2*sin(z[5])*sin(z[6])*dznew[21]-sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dznew[20])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)-2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-γ*znew[16]-znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-L1*cos(z[7])*dznew[24]-(L1*sin(z[7])*dznew[23])*0.5+(sqrt(3)*L1*sin(z[7])*dznew[22])*0.5
            dznew[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dznew[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+znew[9]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[8]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-γ*znew[17]-L2*cos(z[8])*cos(z[9])*dznew[24]+2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[8]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-znew[9]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+(L2*cos(z[9])*sin(z[8])*dznew[22])*0.5+L2*sin(z[8])*sin(z[9])*dznew[24]-sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dznew[23])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)-2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   # Mvterm_p for p=LC1
            M1*g*cos(z[1])
            0.0
            0.0
            M1*g*cos(z[4])
            0.0
            0.0
            M1*g*cos(z[7])
            0.0
            0.0          
        ]

        # dvp = inv(M)*(dMvterm_dp - rp(dM/dp, dv)), rp is my special product
        dznew[10:18] = [did.m1\(dMvterm_dp[1:3,:] - dM_dp[1:3,:]*dz[10:18])
            did.m2\(dMvterm_dp[4:6,:] - dM_dp[4:6,:]*dz[10:18])
            did.m3\(dMvterm_dp[7:9,:] - dM_dp[7:9,:]*dz[10:18])]

        return znew, dznew
    end
end

function get_delta_initial_LC2sens(pars::Vector{Float64}, z::Vector{Float64}, dz::Vector{Float64}, did::DeltaInitData)::Tuple{Vector{Float64}, Vector{Float64}}
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]

        znew  = zeros(30)
        dznew = zeros(30)

        # Sensitivity of initial value wrt to LC2
        # znew[2] = 0.0
        # znew[5] = 0.0
        # znew[8] = 0.0

        ############################# INITIALIZING SENSITIVITY PART ####################################

        # Block matrix product behaviour reminder
        # [a11 a12 a13] [inv(m1) 0 0]   [a11*inv(m1) a12*inv(m2) a13*inv(m3)]
        # [a21 a22 a23]*[0 inv(m2) 0] = [a21*inv(m1) a22*inv(m2) a23*inv(m3)] = [a_1*inv(m1) a_2*inv(m2) a_3*inv(m3)]
        # [a31 a32 a33] [0 0 inv(m3)]   [a31*inv(m1) a32*inv(m2) a33*inv(m3)]
        # and
        # [inv(m1) 0 0] [a11 a12 a13]   [inv(m1)*a11 inv(m2)*a12 inv(m3)*a13]   [inv(m1)*a_1]
        # [0 inv(m2) 0]*[a21 a22 a23] = [inv(m1)*a21 inv(m2)*a22 inv(m3)*a23] = [inv(m2)*a_2]
        # [0 0 inv(m3)] [a31 a32 a33]   [inv(m1)*a31 inv(m2)*a32 inv(m3)*a33]   [inv(m3)*a_3]

        dH_dp = [    # Hp_sansp
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   -(sqrt(3)*L1*cos(z[4])*znew[4])*0.5   (L2*cos(z[5])*cos(z[6])*znew[6])*0.5-znew[5]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)   (L2*cos(z[5])*cos(z[6])*znew[5])*0.5-(L2*sin(z[5])*sin(z[6])*znew[6])*0.5   0.0   0.0   0
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   -(L1*cos(z[4])*znew[4])*0.5   -znew[5]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[6])*0.5   (sqrt(3)*L2*sin(z[5])*sin(z[6])*znew[6])*0.5-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[5])*0.5   0.0   0.0   0
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   L1*sin(z[4])*znew[4]   L2*cos(z[6])*sin(z[5])*znew[5]+L2*cos(z[5])*sin(z[6])*znew[6]   L2*cos(z[5])*sin(z[6])*znew[5]+L2*cos(z[6])*sin(z[5])*znew[6]   0.0   0.0   0
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   0.0   0.0   0.0   (sqrt(3)*L1*cos(z[7])*znew[7])*0.5   znew[8]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)+(L2*cos(z[8])*cos(z[9])*znew[9])*0.5   (L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   0.0   0.0   0.0   -(L1*cos(z[7])*znew[7])*0.5   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[9])*0.5-znew[8]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   0.0   0.0   0.0   L1*sin(z[7])*znew[7]   L2*cos(z[9])*sin(z[8])*znew[8]+L2*cos(z[8])*sin(z[9])*znew[9]   L2*cos(z[8])*sin(z[9])*znew[8]+L2*cos(z[9])*sin(z[8])*znew[9]        
        ] # + 0.0 = Hp for p=LC2

        dM_dp = [   # Mp_sansp
            0.0   2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0
            2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0
            2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   2*cos(z[2])*sin(z[2])*znew[2]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   0.0   0
            0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   2*cos(z[5])*sin(z[5])*znew[5]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)
            0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)   0.0   2*cos(z[8])*sin(z[8])*znew[8]*(J2+L2^2*M3+LC2^2*M2)        
        ] + [   # Mp for p=LC2
            0.0	L1*M2*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))	-L1*M2*cos(z[1])*sin(z[2])*sin(z[3])	0.0	0.0	0.0	0.0	0.0	0.0
            L1*M2*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))	2*LC2*M2	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            -L1*M2*cos(z[1])*sin(z[2])*sin(z[3])	0.0	2*LC2*M2*sin(z[2])^2	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	L1*M2*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))	-L1*M2*cos(z[4])*sin(z[5])*sin(z[6])	0.0	0.0	0.0
            0.0	0.0	0.0	L1*M2*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))	2*LC2*M2	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	-L1*M2*cos(z[4])*sin(z[5])*sin(z[6])	0.0	2*LC2*M2*sin(z[5])^2	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	0.0	L1*M2*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))	-L1*M2*cos(z[7])*sin(z[8])*sin(z[9])
            0.0	0.0	0.0	0.0	0.0	0.0	L1*M2*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))	2*LC2*M2	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	-L1*M2*cos(z[7])*sin(z[8])*sin(z[9])	0.0	2*LC2*M2*sin(z[8])^2        
        ]

        dM_dpinvM = [dM_dp[:,1:3]/did.m1   dM_dp[:,4:6]/did.m2   dM_dp[:,7:9]/did.m3]
        dH_dpinvM = [dH_dp[:,1:3]/did.m1   dH_dp[:,4:6]/did.m2   dH_dp[:,7:9]/did.m3]

        orange_term = dH_dpinvM - did.HinvM*dM_dpinvM
        HinvMHT_dp = orange_term*transpose(did.H) + did.HinvM*transpose(dH_dp)

        # dκp = [H*inv(M)*transpose(did.H)]\{orange_term*did.cgBu + H*inv(M)*ddid.cgBu/dp) - [orange_term*transpose(did.H)+H*inv(M)*transpose(dH/dp)] }
        dznew[19:24] = (did.HinvM*transpose(did.H))\(orange_term*did.cgBu + did.HinvM*([    #dz[49:54] =
            # cgBu_p_sansp
            znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))-znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*znew[10]+znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))
            znew[3]*(g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+γ*znew[11]+znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+znew[3]*(g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))+znew[2]*(2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))-znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*znew[13]+znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))
            znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+γ*znew[14]+znew[5]*(sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+znew[6]*(g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))+znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))-znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*znew[16]+znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))
            znew[9]*(g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+γ*znew[17]+znew[8]*(sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))+znew[9]*(g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+znew[8]*(2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   #cgBu_p for p=LC2
            L1*M2*z[11]^2*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*M2*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2-2*L1*M2*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]
            L1*M2*z[10]^2*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-M2*g*cos(z[2])*cos(z[3])-2*LC2*M2*cos(z[2])*sin(z[2])*z[12]^2
            M2*g*sin(z[2])*sin(z[3])+2*LC2*M2*sin(2*z[2])*z[11]*z[12]+L1*M2*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2
            L1*M2*z[14]^2*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*M2*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2-2*L1*M2*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]
            L1*M2*z[13]^2*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-M2*g*cos(z[5])*cos(z[6])-2*LC2*M2*cos(z[5])*sin(z[5])*z[15]^2
            M2*g*sin(z[5])*sin(z[6])+2*LC2*M2*sin(2*z[5])*z[14]*z[15]+L1*M2*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2
            L1*M2*z[17]^2*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*M2*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2-2*L1*M2*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]
            L1*M2*z[16]^2*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-M2*g*cos(z[8])*cos(z[9])-2*LC2*M2*cos(z[8])*sin(z[8])*z[18]^2
            M2*g*sin(z[8])*sin(z[9])+2*LC2*M2*sin(2*z[8])*z[17]*z[18]+L1*M2*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2              
        ]) - HinvMHT_dp*z[19:24])

        dMvterm_dp = [
            znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-γ*znew[10]-znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+L1*cos(z[1])*dznew[21]+L1*cos(z[1])*dznew[24]-L1*sin(z[1])*dznew[20]-L1*sin(z[1])*dznew[23]
            L2*cos(z[2])*cos(z[3])*dznew[21]-γ*znew[11]-znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-L2*sin(z[2])*dznew[20]-L2*sin(z[2])*dznew[23]-znew[3]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[2])*cos(z[3])*dznew[24]+L2*cos(z[2])*sin(z[3])*dznew[19]+L2*cos(z[2])*sin(z[3])*dznew[22]+2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            L2*cos(z[3])*sin(z[2])*dznew[19]-znew[3]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))-znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))-znew[2]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[3])*sin(z[2])*dznew[22]-L2*sin(z[2])*sin(z[3])*dznew[21]-L2*sin(z[2])*sin(z[3])*dznew[24]-sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)-2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-γ*znew[13]-znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-L1*cos(z[4])*dznew[21]-(L1*sin(z[4])*dznew[20])*0.5-(sqrt(3)*L1*sin(z[4])*dznew[19])*0.5
            dznew[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dznew[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[5]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-γ*znew[14]-L2*cos(z[5])*cos(z[6])*dznew[21]+2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            (L2*cos(z[6])*sin(z[5])*dznew[19])*0.5-znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[6]*((L2*sin(z[5])*sin(z[6])*dz[19])*0.5-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))-znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+L2*sin(z[5])*sin(z[6])*dznew[21]-sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dznew[20])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)-2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-γ*znew[16]-znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-L1*cos(z[7])*dznew[24]-(L1*sin(z[7])*dznew[23])*0.5+(sqrt(3)*L1*sin(z[7])*dznew[22])*0.5
            dznew[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dznew[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+znew[9]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[8]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-γ*znew[17]-L2*cos(z[8])*cos(z[9])*dznew[24]+2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[8]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-znew[9]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+(L2*cos(z[9])*sin(z[8])*dznew[22])*0.5+L2*sin(z[8])*sin(z[9])*dznew[24]-sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dznew[23])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)-2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   # Mvterm_p for p=LC2
            L1*M2*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2-L1*M2*z[11]^2*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))+2*L1*M2*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]
            M2*g*cos(z[2])*cos(z[3])-L1*M2*z[10]^2*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+2*LC2*M2*cos(z[2])*sin(z[2])*z[12]^2
            -M2*g*sin(z[2])*sin(z[3])-2*LC2*M2*sin(2*z[2])*z[11]*z[12]-L1*M2*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2
            L1*M2*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2-L1*M2*z[14]^2*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))+2*L1*M2*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]
            M2*g*cos(z[5])*cos(z[6])-L1*M2*z[13]^2*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+2*LC2*M2*cos(z[5])*sin(z[5])*z[15]^2
            -M2*g*sin(z[5])*sin(z[6])-2*LC2*M2*sin(2*z[5])*z[14]*z[15]-L1*M2*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2
            L1*M2*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2-L1*M2*z[17]^2*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))+2*L1*M2*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]
            M2*g*cos(z[8])*cos(z[9])-L1*M2*z[16]^2*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+2*LC2*M2*cos(z[8])*sin(z[8])*z[18]^2
            -M2*g*sin(z[8])*sin(z[9])-2*LC2*M2*sin(2*z[8])*z[17]*z[18]-L1*M2*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2            
        ]

        # dvp = inv(M)*(dMvterm_dp - rp(dM/dp, dv)), rp is my special product
        dznew[10:18] = [did.m1\(dMvterm_dp[1:3,:] - dM_dp[1:3,:]*dz[10:18])
            did.m2\(dMvterm_dp[4:6,:] - dM_dp[4:6,:]*dz[10:18])
            did.m3\(dMvterm_dp[7:9,:] - dM_dp[7:9,:]*dz[10:18])]

        return znew, dznew
    end
end

function get_delta_initial_M1sens(pars::Vector{Float64}, z::Vector{Float64}, dz::Vector{Float64}, did::DeltaInitData)::Tuple{Vector{Float64}, Vector{Float64}}
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]
        znew  = zeros(30)
        dznew = zeros(30)

        # Sensitivity of initial value wrt to M1
        # znew[2] = 0.0
        # znew[5] = 0.0
        # znew[8] = 0.0

        ############################# INITIALIZING SENSITIVITY PART ####################################

        # Block matrix product behaviour reminder
        # [a11 a12 a13] [inv(m1) 0 0]   [a11*inv(m1) a12*inv(m2) a13*inv(m3)]
        # [a21 a22 a23]*[0 inv(m2) 0] = [a21*inv(m1) a22*inv(m2) a23*inv(m3)] = [a_1*inv(m1) a_2*inv(m2) a_3*inv(m3)]
        # [a31 a32 a33] [0 0 inv(m3)]   [a31*inv(m1) a32*inv(m2) a33*inv(m3)]
        # and
        # [inv(m1) 0 0] [a11 a12 a13]   [inv(m1)*a11 inv(m2)*a12 inv(m3)*a13]   [inv(m1)*a_1]
        # [0 inv(m2) 0]*[a21 a22 a23] = [inv(m1)*a21 inv(m2)*a22 inv(m3)*a23] = [inv(m2)*a_2]
        # [0 0 inv(m3)] [a31 a32 a33]   [inv(m1)*a31 inv(m2)*a32 inv(m3)*a33]   [inv(m3)*a_3]

        dH_dp = [    # Hp_sansp
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   -(sqrt(3)*L1*cos(z[4])*znew[4])*0.5   (L2*cos(z[5])*cos(z[6])*znew[6])*0.5-znew[5]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)   (L2*cos(z[5])*cos(z[6])*znew[5])*0.5-(L2*sin(z[5])*sin(z[6])*znew[6])*0.5   0.0   0.0   0
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   -(L1*cos(z[4])*znew[4])*0.5   -znew[5]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[6])*0.5   (sqrt(3)*L2*sin(z[5])*sin(z[6])*znew[6])*0.5-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[5])*0.5   0.0   0.0   0
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   L1*sin(z[4])*znew[4]   L2*cos(z[6])*sin(z[5])*znew[5]+L2*cos(z[5])*sin(z[6])*znew[6]   L2*cos(z[5])*sin(z[6])*znew[5]+L2*cos(z[6])*sin(z[5])*znew[6]   0.0   0.0   0
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   0.0   0.0   0.0   (sqrt(3)*L1*cos(z[7])*znew[7])*0.5   znew[8]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)+(L2*cos(z[8])*cos(z[9])*znew[9])*0.5   (L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   0.0   0.0   0.0   -(L1*cos(z[7])*znew[7])*0.5   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[9])*0.5-znew[8]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   0.0   0.0   0.0   L1*sin(z[7])*znew[7]   L2*cos(z[9])*sin(z[8])*znew[8]+L2*cos(z[8])*sin(z[9])*znew[9]   L2*cos(z[8])*sin(z[9])*znew[8]+L2*cos(z[9])*sin(z[8])*znew[9]        
        ] # + 0.0 = Hp for p=M1

        dM_dp = [   # Mp_sansp
            0.0   2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0
            2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0
            2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   2*cos(z[2])*sin(z[2])*znew[2]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   0.0   0
            0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   2*cos(z[5])*sin(z[5])*znew[5]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)
            0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)   0.0   2*cos(z[8])*sin(z[8])*znew[8]*(J2+L2^2*M3+LC2^2*M2)        
        ] + [   # Mp for p=M1
            LC1^2	0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    0.0	0.0
            0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    0.0	0.0
            0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    0.0	0.0
            0.0	    0.0	    0.0	    LC1^2	0.0	    0.0	    0.0	    0.0	0.0
            0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    0.0	0.0
            0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    0.0	0.0
            0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    LC1^2	0.0	0.0
            0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    0.0	0.0
            0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    0.0	    0.0	0.0
        ]

        dM_dpinvM = [dM_dp[:,1:3]/did.m1   dM_dp[:,4:6]/did.m2   dM_dp[:,7:9]/did.m3]
        dH_dpinvM = [dH_dp[:,1:3]/did.m1   dH_dp[:,4:6]/did.m2   dH_dp[:,7:9]/did.m3]

        orange_term = dH_dpinvM - did.HinvM*dM_dpinvM
        HinvMHT_dp = orange_term*transpose(did.H) + did.HinvM*transpose(dH_dp)

        # dκp = [H*inv(M)*transpose(did.H)]\{orange_term*did.cgBu + H*inv(M)*ddid.cgBu/dp) - [orange_term*transpose(did.H)+H*inv(M)*transpose(dH/dp)] }
        dznew[19:24] = (did.HinvM*transpose(did.H))\(orange_term*did.cgBu + did.HinvM*([    #dz[49:54] =
            # cgBu_p_sansp
            znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))-znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*znew[10]+znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))
            znew[3]*(g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+γ*znew[11]+znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+znew[3]*(g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))+znew[2]*(2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))-znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*znew[13]+znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))
            znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+γ*znew[14]+znew[5]*(sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+znew[6]*(g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))+znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))-znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*znew[16]+znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))
            znew[9]*(g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+γ*znew[17]+znew[8]*(sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))+znew[9]*(g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+znew[8]*(2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   #cgBu_p for p=M1
            -LC1*g*cos(z[1])
            0.0
            0.0
            -LC1*g*cos(z[4])
            0.0
            0.0
            -LC1*g*cos(z[7])
            0.0
            0.0
        ]) - HinvMHT_dp*z[19:24])

        dMvterm_dp = [
            znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-γ*znew[10]-znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+L1*cos(z[1])*dznew[21]+L1*cos(z[1])*dznew[24]-L1*sin(z[1])*dznew[20]-L1*sin(z[1])*dznew[23]
            L2*cos(z[2])*cos(z[3])*dznew[21]-γ*znew[11]-znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-L2*sin(z[2])*dznew[20]-L2*sin(z[2])*dznew[23]-znew[3]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[2])*cos(z[3])*dznew[24]+L2*cos(z[2])*sin(z[3])*dznew[19]+L2*cos(z[2])*sin(z[3])*dznew[22]+2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            L2*cos(z[3])*sin(z[2])*dznew[19]-znew[3]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))-znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))-znew[2]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[3])*sin(z[2])*dznew[22]-L2*sin(z[2])*sin(z[3])*dznew[21]-L2*sin(z[2])*sin(z[3])*dznew[24]-sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)-2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-γ*znew[13]-znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-L1*cos(z[4])*dznew[21]-(L1*sin(z[4])*dznew[20])*0.5-(sqrt(3)*L1*sin(z[4])*dznew[19])*0.5
            dznew[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dznew[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[5]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-γ*znew[14]-L2*cos(z[5])*cos(z[6])*dznew[21]+2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            (L2*cos(z[6])*sin(z[5])*dznew[19])*0.5-znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[6]*((L2*sin(z[5])*sin(z[6])*dz[19])*0.5-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))-znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+L2*sin(z[5])*sin(z[6])*dznew[21]-sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dznew[20])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)-2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-γ*znew[16]-znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-L1*cos(z[7])*dznew[24]-(L1*sin(z[7])*dznew[23])*0.5+(sqrt(3)*L1*sin(z[7])*dznew[22])*0.5
            dznew[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dznew[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+znew[9]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[8]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-γ*znew[17]-L2*cos(z[8])*cos(z[9])*dznew[24]+2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[8]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-znew[9]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+(L2*cos(z[9])*sin(z[8])*dznew[22])*0.5+L2*sin(z[8])*sin(z[9])*dznew[24]-sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dznew[23])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)-2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   # Mvterm_p for p=M1
            LC1*g*cos(z[1])
            0.0
            0.0
            LC1*g*cos(z[4])
            0.0
            0.0
            LC1*g*cos(z[7])
            0.0
            0.0
        ]

        # dvp = inv(M)*(dMvterm_dp - rp(dM/dp, dv)), rp is my special product
        dznew[10:18] = [did.m1\(dMvterm_dp[1:3,:] - dM_dp[1:3,:]*dz[10:18])
            did.m2\(dMvterm_dp[4:6,:] - dM_dp[4:6,:]*dz[10:18])
            did.m3\(dMvterm_dp[7:9,:] - dM_dp[7:9,:]*dz[10:18])]

        return znew, dznew

    end
end

function get_delta_initial_M2sens(pars::Vector{Float64}, z::Vector{Float64}, dz::Vector{Float64}, did::DeltaInitData)::Tuple{Vector{Float64}, Vector{Float64}}
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]
        znew  = zeros(30)
        dznew = zeros(30)

        # Sensitivity of initial value wrt to M2
        # znew[2] = 0.0
        # znew[5] = 0.0
        # znew[8] = 0.0

        ############################# INITIALIZING SENSITIVITY PART ####################################

        # Block matrix product behaviour reminder
        # [a11 a12 a13] [inv(m1) 0 0]   [a11*inv(m1) a12*inv(m2) a13*inv(m3)]
        # [a21 a22 a23]*[0 inv(m2) 0] = [a21*inv(m1) a22*inv(m2) a23*inv(m3)] = [a_1*inv(m1) a_2*inv(m2) a_3*inv(m3)]
        # [a31 a32 a33] [0 0 inv(m3)]   [a31*inv(m1) a32*inv(m2) a33*inv(m3)]
        # and
        # [inv(m1) 0 0] [a11 a12 a13]   [inv(m1)*a11 inv(m2)*a12 inv(m3)*a13]   [inv(m1)*a_1]
        # [0 inv(m2) 0]*[a21 a22 a23] = [inv(m1)*a21 inv(m2)*a22 inv(m3)*a23] = [inv(m2)*a_2]
        # [0 0 inv(m3)] [a31 a32 a33]   [inv(m1)*a31 inv(m2)*a32 inv(m3)*a33]   [inv(m3)*a_3]

        dH_dp = [    # Hp_sansp
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   -(sqrt(3)*L1*cos(z[4])*znew[4])*0.5   (L2*cos(z[5])*cos(z[6])*znew[6])*0.5-znew[5]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)   (L2*cos(z[5])*cos(z[6])*znew[5])*0.5-(L2*sin(z[5])*sin(z[6])*znew[6])*0.5   0.0   0.0   0
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   -(L1*cos(z[4])*znew[4])*0.5   -znew[5]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[6])*0.5   (sqrt(3)*L2*sin(z[5])*sin(z[6])*znew[6])*0.5-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[5])*0.5   0.0   0.0   0
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   L1*sin(z[4])*znew[4]   L2*cos(z[6])*sin(z[5])*znew[5]+L2*cos(z[5])*sin(z[6])*znew[6]   L2*cos(z[5])*sin(z[6])*znew[5]+L2*cos(z[6])*sin(z[5])*znew[6]   0.0   0.0   0
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   0.0   0.0   0.0   (sqrt(3)*L1*cos(z[7])*znew[7])*0.5   znew[8]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)+(L2*cos(z[8])*cos(z[9])*znew[9])*0.5   (L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   0.0   0.0   0.0   -(L1*cos(z[7])*znew[7])*0.5   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[9])*0.5-znew[8]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   0.0   0.0   0.0   L1*sin(z[7])*znew[7]   L2*cos(z[9])*sin(z[8])*znew[8]+L2*cos(z[8])*sin(z[9])*znew[9]   L2*cos(z[8])*sin(z[9])*znew[8]+L2*cos(z[9])*sin(z[8])*znew[9]        
        ] # + 0.0 = Hp for p=M2

        dM_dp = [   # Mp_sansp
            0.0   2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0
            2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0
            2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   2*cos(z[2])*sin(z[2])*znew[2]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   0.0   0
            0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   2*cos(z[5])*sin(z[5])*znew[5]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)
            0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)   0.0   2*cos(z[8])*sin(z[8])*znew[8]*(J2+L2^2*M3+LC2^2*M2)        
        ] + [   # Mp for p=M2
            L1^2	L1*LC2*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))	-L1*LC2*cos(z[1])*sin(z[2])*sin(z[3])	0.0	0.0	0.0	0.0	0.0	0.0
            L1*LC2*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))	LC2^2	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            -L1*LC2*cos(z[1])*sin(z[2])*sin(z[3])	0.0	LC2^2*sin(z[2])^2	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	L1^2	L1*LC2*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))	-L1*LC2*cos(z[4])*sin(z[5])*sin(z[6])	0.0	0.0	0.0
            0.0	0.0	0.0	L1*LC2*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))	LC2^2	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	-L1*LC2*cos(z[4])*sin(z[5])*sin(z[6])	0.0	LC2^2*sin(z[5])^2	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	L1^2	L1*LC2*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))	-L1*LC2*cos(z[7])*sin(z[8])*sin(z[9])
            0.0	0.0	0.0	0.0	0.0	0.0	L1*LC2*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))	LC2^2	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	-L1*LC2*cos(z[7])*sin(z[8])*sin(z[9])	0.0	LC2^2*sin(z[8])^2
        ]

        dM_dpinvM = [dM_dp[:,1:3]/did.m1   dM_dp[:,4:6]/did.m2   dM_dp[:,7:9]/did.m3]
        dH_dpinvM = [dH_dp[:,1:3]/did.m1   dH_dp[:,4:6]/did.m2   dH_dp[:,7:9]/did.m3]

        orange_term = dH_dpinvM - did.HinvM*dM_dpinvM
        HinvMHT_dp = orange_term*transpose(did.H) + did.HinvM*transpose(dH_dp)

        # dκp = [H*inv(M)*transpose(did.H)]\{orange_term*did.cgBu + H*inv(M)*ddid.cgBu/dp) - [orange_term*transpose(did.H)+H*inv(M)*transpose(dH/dp)] }
        dznew[19:24] = (did.HinvM*transpose(did.H))\(orange_term*did.cgBu + did.HinvM*([    #dz[49:54] =
            # cgBu_p_sansp
            znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))-znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*znew[10]+znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))
            znew[3]*(g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+γ*znew[11]+znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+znew[3]*(g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))+znew[2]*(2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))-znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*znew[13]+znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))
            znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+γ*znew[14]+znew[5]*(sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+znew[6]*(g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))+znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))-znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*znew[16]+znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))
            znew[9]*(g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+γ*znew[17]+znew[8]*(sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))+znew[9]*(g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+znew[8]*(2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   #cgBu_p for p=M2
            L1*LC2*z[11]^2*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*g*cos(z[1])-L1*LC2*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2-2*L1*LC2*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]
            L1*LC2*z[10]^2*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-LC2*g*cos(z[2])*cos(z[3])-LC2^2*cos(z[2])*sin(z[2])*z[12]^2
            LC2^2*sin(2*z[2])*z[11]*z[12]+LC2*g*sin(z[2])*sin(z[3])+L1*LC2*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2
            L1*LC2*z[14]^2*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*g*cos(z[4])-L1*LC2*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2-2*L1*LC2*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]
            L1*LC2*z[13]^2*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-LC2*g*cos(z[5])*cos(z[6])-LC2^2*cos(z[5])*sin(z[5])*z[15]^2
            LC2^2*sin(2*z[5])*z[14]*z[15]+LC2*g*sin(z[5])*sin(z[6])+L1*LC2*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2
            L1*LC2*z[17]^2*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*g*cos(z[7])-L1*LC2*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2-2*L1*LC2*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]
            L1*LC2*z[16]^2*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-LC2*g*cos(z[8])*cos(z[9])-LC2^2*cos(z[8])*sin(z[8])*z[18]^2
            LC2^2*sin(2*z[8])*z[17]*z[18]+LC2*g*sin(z[8])*sin(z[9])+L1*LC2*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2        
        ]) - HinvMHT_dp*z[19:24])

        dMvterm_dp = [
            znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-γ*znew[10]-znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+L1*cos(z[1])*dznew[21]+L1*cos(z[1])*dznew[24]-L1*sin(z[1])*dznew[20]-L1*sin(z[1])*dznew[23]
            L2*cos(z[2])*cos(z[3])*dznew[21]-γ*znew[11]-znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-L2*sin(z[2])*dznew[20]-L2*sin(z[2])*dznew[23]-znew[3]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[2])*cos(z[3])*dznew[24]+L2*cos(z[2])*sin(z[3])*dznew[19]+L2*cos(z[2])*sin(z[3])*dznew[22]+2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            L2*cos(z[3])*sin(z[2])*dznew[19]-znew[3]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))-znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))-znew[2]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[3])*sin(z[2])*dznew[22]-L2*sin(z[2])*sin(z[3])*dznew[21]-L2*sin(z[2])*sin(z[3])*dznew[24]-sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)-2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-γ*znew[13]-znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-L1*cos(z[4])*dznew[21]-(L1*sin(z[4])*dznew[20])*0.5-(sqrt(3)*L1*sin(z[4])*dznew[19])*0.5
            dznew[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dznew[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[5]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-γ*znew[14]-L2*cos(z[5])*cos(z[6])*dznew[21]+2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            (L2*cos(z[6])*sin(z[5])*dznew[19])*0.5-znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[6]*((L2*sin(z[5])*sin(z[6])*dz[19])*0.5-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))-znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+L2*sin(z[5])*sin(z[6])*dznew[21]-sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dznew[20])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)-2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-γ*znew[16]-znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-L1*cos(z[7])*dznew[24]-(L1*sin(z[7])*dznew[23])*0.5+(sqrt(3)*L1*sin(z[7])*dznew[22])*0.5
            dznew[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dznew[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+znew[9]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[8]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-γ*znew[17]-L2*cos(z[8])*cos(z[9])*dznew[24]+2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[8]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-znew[9]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+(L2*cos(z[9])*sin(z[8])*dznew[22])*0.5+L2*sin(z[8])*sin(z[9])*dznew[24]-sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dznew[23])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)-2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   # Mvterm_p for p=M2
            L1*g*cos(z[1])-L1*LC2*z[11]^2*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))+L1*LC2*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2+2*L1*LC2*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]
            LC2*g*cos(z[2])*cos(z[3])-L1*LC2*z[10]^2*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+LC2^2*cos(z[2])*sin(z[2])*z[12]^2
            -LC2^2*sin(2*z[2])*z[11]*z[12]-LC2*g*sin(z[2])*sin(z[3])-L1*LC2*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2
            L1*g*cos(z[4])-L1*LC2*z[14]^2*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))+L1*LC2*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2+2*L1*LC2*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]
            LC2*g*cos(z[5])*cos(z[6])-L1*LC2*z[13]^2*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+LC2^2*cos(z[5])*sin(z[5])*z[15]^2
            -LC2^2*sin(2*z[5])*z[14]*z[15]-LC2*g*sin(z[5])*sin(z[6])-L1*LC2*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2
            L1*g*cos(z[7])-L1*LC2*z[17]^2*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))+L1*LC2*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2+2*L1*LC2*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]
            LC2*g*cos(z[8])*cos(z[9])-L1*LC2*z[16]^2*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+LC2^2*cos(z[8])*sin(z[8])*z[18]^2
            -LC2^2*sin(2*z[8])*z[17]*z[18]-LC2*g*sin(z[8])*sin(z[9])-L1*LC2*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2        
        ]

        # dvp = inv(M)*(dMvterm_dp - rp(dM/dp, dv)), rp is my special product
        dznew[10:18] = [did.m1\(dMvterm_dp[1:3,:] - dM_dp[1:3,:]*dz[10:18])
            did.m2\(dMvterm_dp[4:6,:] - dM_dp[4:6,:]*dz[10:18])
            did.m3\(dMvterm_dp[7:9,:] - dM_dp[7:9,:]*dz[10:18])]

        return znew, dznew

    end
end

function get_delta_initial_M3sens(pars::Vector{Float64}, z::Vector{Float64}, dz::Vector{Float64}, did::DeltaInitData)::Tuple{Vector{Float64}, Vector{Float64}}
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]
        znew  = zeros(30)
        dznew = zeros(30)

        # Sensitivity of initial value wrt to M3
        # znew[2] = 0.0
        # znew[5] = 0.0
        # znew[8] = 0.0

        ############################# INITIALIZING SENSITIVITY PART ####################################

        # Block matrix product behaviour reminder
        # [a11 a12 a13] [inv(m1) 0 0]   [a11*inv(m1) a12*inv(m2) a13*inv(m3)]
        # [a21 a22 a23]*[0 inv(m2) 0] = [a21*inv(m1) a22*inv(m2) a23*inv(m3)] = [a_1*inv(m1) a_2*inv(m2) a_3*inv(m3)]
        # [a31 a32 a33] [0 0 inv(m3)]   [a31*inv(m1) a32*inv(m2) a33*inv(m3)]
        # and
        # [inv(m1) 0 0] [a11 a12 a13]   [inv(m1)*a11 inv(m2)*a12 inv(m3)*a13]   [inv(m1)*a_1]
        # [0 inv(m2) 0]*[a21 a22 a23] = [inv(m1)*a21 inv(m2)*a22 inv(m3)*a23] = [inv(m2)*a_2]
        # [0 0 inv(m3)] [a31 a32 a33]   [inv(m1)*a31 inv(m2)*a32 inv(m3)*a33]   [inv(m3)*a_3]

        dH_dp = [    # Hp_sansp
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   -(sqrt(3)*L1*cos(z[4])*znew[4])*0.5   (L2*cos(z[5])*cos(z[6])*znew[6])*0.5-znew[5]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)   (L2*cos(z[5])*cos(z[6])*znew[5])*0.5-(L2*sin(z[5])*sin(z[6])*znew[6])*0.5   0.0   0.0   0
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   -(L1*cos(z[4])*znew[4])*0.5   -znew[5]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[6])*0.5   (sqrt(3)*L2*sin(z[5])*sin(z[6])*znew[6])*0.5-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[5])*0.5   0.0   0.0   0
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   L1*sin(z[4])*znew[4]   L2*cos(z[6])*sin(z[5])*znew[5]+L2*cos(z[5])*sin(z[6])*znew[6]   L2*cos(z[5])*sin(z[6])*znew[5]+L2*cos(z[6])*sin(z[5])*znew[6]   0.0   0.0   0
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   0.0   0.0   0.0   (sqrt(3)*L1*cos(z[7])*znew[7])*0.5   znew[8]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)+(L2*cos(z[8])*cos(z[9])*znew[9])*0.5   (L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   0.0   0.0   0.0   -(L1*cos(z[7])*znew[7])*0.5   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[9])*0.5-znew[8]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   0.0   0.0   0.0   L1*sin(z[7])*znew[7]   L2*cos(z[9])*sin(z[8])*znew[8]+L2*cos(z[8])*sin(z[9])*znew[9]   L2*cos(z[8])*sin(z[9])*znew[8]+L2*cos(z[9])*sin(z[8])*znew[9]        
        ] # + 0.0 = Hp for p=M3

        dM_dp = [   # Mp_sansp
            0.0   2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0
            2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0
            2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   2*cos(z[2])*sin(z[2])*znew[2]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   0.0   0
            0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   2*cos(z[5])*sin(z[5])*znew[5]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)
            0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)   0.0   2*cos(z[8])*sin(z[8])*znew[8]*(J2+L2^2*M3+LC2^2*M2)        
        ] + [   # Mp for p=M3
            L1^2	L1*L2*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))	-L1*L2*cos(z[1])*sin(z[2])*sin(z[3])	0.0	0.0	0.0	0.0	0.0	0.0
            L1*L2*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))	L2^2	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            -L1*L2*cos(z[1])*sin(z[2])*sin(z[3])	0.0	L2^2*sin(z[2])^2	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	L1^2	L1*L2*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))	-L1*L2*cos(z[4])*sin(z[5])*sin(z[6])	0.0	0.0	0.0
            0.0	0.0	0.0	L1*L2*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))	L2^2	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	-L1*L2*cos(z[4])*sin(z[5])*sin(z[6])	0.0	L2^2*sin(z[5])^2	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	L1^2	L1*L2*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))	-L1*L2*cos(z[7])*sin(z[8])*sin(z[9])
            0.0	0.0	0.0	0.0	0.0	0.0	L1*L2*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))	L2^2	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	-L1*L2*cos(z[7])*sin(z[8])*sin(z[9])	0.0	L2^2*sin(z[8])^2        
        ]

        dM_dpinvM = [dM_dp[:,1:3]/did.m1   dM_dp[:,4:6]/did.m2   dM_dp[:,7:9]/did.m3]
        dH_dpinvM = [dH_dp[:,1:3]/did.m1   dH_dp[:,4:6]/did.m2   dH_dp[:,7:9]/did.m3]

        orange_term = dH_dpinvM - did.HinvM*dM_dpinvM
        HinvMHT_dp = orange_term*transpose(did.H) + did.HinvM*transpose(dH_dp)

        # dκp = [H*inv(M)*transpose(did.H)]\{orange_term*did.cgBu + H*inv(M)*ddid.cgBu/dp) - [orange_term*transpose(did.H)+H*inv(M)*transpose(dH/dp)] }
        dznew[19:24] = (did.HinvM*transpose(did.H))\(orange_term*did.cgBu + did.HinvM*([    #dz[49:54] =
            # cgBu_p_sansp
            znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))-znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*znew[10]+znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))
            znew[3]*(g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+γ*znew[11]+znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+znew[3]*(g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))+znew[2]*(2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))-znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*znew[13]+znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))
            znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+γ*znew[14]+znew[5]*(sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+znew[6]*(g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))+znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))-znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*znew[16]+znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))
            znew[9]*(g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+γ*znew[17]+znew[8]*(sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))+znew[9]*(g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+znew[8]*(2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   #cgBu_p for p=M3
            L1*L2*z[11]^2*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*g*cos(z[1])-L1*L2*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2-2*L1*L2*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]
            L1*L2*z[10]^2*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L2*g*cos(z[2])*cos(z[3])-L2^2*cos(z[2])*sin(z[2])*z[12]^2
            L2^2*sin(2*z[2])*z[11]*z[12]+L2*g*sin(z[2])*sin(z[3])+L1*L2*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2
            L1*L2*z[14]^2*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*g*cos(z[4])-L1*L2*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2-2*L1*L2*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]
            L1*L2*z[13]^2*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L2*g*cos(z[5])*cos(z[6])-L2^2*cos(z[5])*sin(z[5])*z[15]^2
            L2^2*sin(2*z[5])*z[14]*z[15]+L2*g*sin(z[5])*sin(z[6])+L1*L2*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2
            L1*L2*z[17]^2*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*g*cos(z[7])-L1*L2*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2-2*L1*L2*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]
            L1*L2*z[16]^2*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L2*g*cos(z[8])*cos(z[9])-L2^2*cos(z[8])*sin(z[8])*z[18]^2
            L2^2*sin(2*z[8])*z[17]*z[18]+L2*g*sin(z[8])*sin(z[9])+L1*L2*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2        
        ]) - HinvMHT_dp*z[19:24])

        dMvterm_dp = [
            znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-γ*znew[10]-znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+L1*cos(z[1])*dznew[21]+L1*cos(z[1])*dznew[24]-L1*sin(z[1])*dznew[20]-L1*sin(z[1])*dznew[23]
            L2*cos(z[2])*cos(z[3])*dznew[21]-γ*znew[11]-znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-L2*sin(z[2])*dznew[20]-L2*sin(z[2])*dznew[23]-znew[3]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[2])*cos(z[3])*dznew[24]+L2*cos(z[2])*sin(z[3])*dznew[19]+L2*cos(z[2])*sin(z[3])*dznew[22]+2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            L2*cos(z[3])*sin(z[2])*dznew[19]-znew[3]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))-znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))-znew[2]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[3])*sin(z[2])*dznew[22]-L2*sin(z[2])*sin(z[3])*dznew[21]-L2*sin(z[2])*sin(z[3])*dznew[24]-sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)-2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-γ*znew[13]-znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-L1*cos(z[4])*dznew[21]-(L1*sin(z[4])*dznew[20])*0.5-(sqrt(3)*L1*sin(z[4])*dznew[19])*0.5
            dznew[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dznew[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[5]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-γ*znew[14]-L2*cos(z[5])*cos(z[6])*dznew[21]+2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            (L2*cos(z[6])*sin(z[5])*dznew[19])*0.5-znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[6]*((L2*sin(z[5])*sin(z[6])*dz[19])*0.5-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))-znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+L2*sin(z[5])*sin(z[6])*dznew[21]-sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dznew[20])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)-2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-γ*znew[16]-znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-L1*cos(z[7])*dznew[24]-(L1*sin(z[7])*dznew[23])*0.5+(sqrt(3)*L1*sin(z[7])*dznew[22])*0.5
            dznew[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dznew[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+znew[9]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[8]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-γ*znew[17]-L2*cos(z[8])*cos(z[9])*dznew[24]+2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[8]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-znew[9]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+(L2*cos(z[9])*sin(z[8])*dznew[22])*0.5+L2*sin(z[8])*sin(z[9])*dznew[24]-sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dznew[23])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)-2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   # Mvterm_p for p=M3
            L1*g*cos(z[1])-L1*L2*z[11]^2*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))+L1*L2*cos(z[1])*cos(z[3])*sin(z[2])*z[12]^2+2*L1*L2*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*z[12]
            L2*g*cos(z[2])*cos(z[3])-L1*L2*z[10]^2*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L2^2*cos(z[2])*sin(z[2])*z[12]^2
            -L2^2*sin(2*z[2])*z[11]*z[12]-L2*g*sin(z[2])*sin(z[3])-L1*L2*sin(z[1])*sin(z[2])*sin(z[3])*z[10]^2
            L1*g*cos(z[4])-L1*L2*z[14]^2*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))+L1*L2*cos(z[4])*cos(z[6])*sin(z[5])*z[15]^2+2*L1*L2*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*z[15]
            L2*g*cos(z[5])*cos(z[6])-L1*L2*z[13]^2*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L2^2*cos(z[5])*sin(z[5])*z[15]^2
            -L2^2*sin(2*z[5])*z[14]*z[15]-L2*g*sin(z[5])*sin(z[6])-L1*L2*sin(z[4])*sin(z[5])*sin(z[6])*z[13]^2
            L1*g*cos(z[7])-L1*L2*z[17]^2*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))+L1*L2*cos(z[7])*cos(z[9])*sin(z[8])*z[18]^2+2*L1*L2*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*z[18]
            L2*g*cos(z[8])*cos(z[9])-L1*L2*z[16]^2*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L2^2*cos(z[8])*sin(z[8])*z[18]^2
            -L2^2*sin(2*z[8])*z[17]*z[18]-L2*g*sin(z[8])*sin(z[9])-L1*L2*sin(z[7])*sin(z[8])*sin(z[9])*z[16]^2        
        ]

        # dvp = inv(M)*(dMvterm_dp - rp(dM/dp, dv)), rp is my special product
        dznew[10:18] = [did.m1\(dMvterm_dp[1:3,:] - dM_dp[1:3,:]*dz[10:18])
            did.m2\(dMvterm_dp[4:6,:] - dM_dp[4:6,:]*dz[10:18])
            did.m3\(dMvterm_dp[7:9,:] - dM_dp[7:9,:]*dz[10:18])]

        return znew, dznew

    end
end

function get_delta_initial_J1sens(pars::Vector{Float64}, z::Vector{Float64}, dz::Vector{Float64}, did::DeltaInitData)::Tuple{Vector{Float64}, Vector{Float64}}
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]

        znew  = zeros(30)
        dznew = zeros(30)

        # Sensitivity of initial value is zero wrt to J1, so no need to compute it in this case
        # znew[2] = 0.0
        # znew[5] = 0.0
        # znew[8] = 0.0

        ############################# INITIALIZING SENSITIVITY PART ####################################

        # Block matrix product behaviour reminder
        # [a11 a12 a13] [inv(m1) 0 0]   [a11*inv(m1) a12*inv(m2) a13*inv(m3)]
        # [a21 a22 a23]*[0 inv(m2) 0] = [a21*inv(m1) a22*inv(m2) a23*inv(m3)] = [a_1*inv(m1) a_2*inv(m2) a_3*inv(m3)]
        # [a31 a32 a33] [0 0 inv(m3)]   [a31*inv(m1) a32*inv(m2) a33*inv(m3)]
        # and
        # [inv(m1) 0 0] [a11 a12 a13]   [inv(m1)*a11 inv(m2)*a12 inv(m3)*a13]   [inv(m1)*a_1]
        # [0 inv(m2) 0]*[a21 a22 a23] = [inv(m1)*a21 inv(m2)*a22 inv(m3)*a23] = [inv(m2)*a_2]
        # [0 0 inv(m3)] [a31 a32 a33]   [inv(m1)*a31 inv(m2)*a32 inv(m3)*a33]   [inv(m3)*a_3]

        dH_dp = [   # only sans_p-part, partial derivative wrt J1 is zero
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   -(sqrt(3)*L1*cos(z[4])*znew[4])*0.5   (L2*cos(z[5])*cos(z[6])*znew[6])*0.5-znew[5]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)   (L2*cos(z[5])*cos(z[6])*znew[5])*0.5-(L2*sin(z[5])*sin(z[6])*znew[6])*0.5   0.0   0.0   0
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   -(L1*cos(z[4])*znew[4])*0.5   -znew[5]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[6])*0.5   (sqrt(3)*L2*sin(z[5])*sin(z[6])*znew[6])*0.5-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[5])*0.5   0.0   0.0   0
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   L1*sin(z[4])*znew[4]   L2*cos(z[6])*sin(z[5])*znew[5]+L2*cos(z[5])*sin(z[6])*znew[6]   L2*cos(z[5])*sin(z[6])*znew[5]+L2*cos(z[6])*sin(z[5])*znew[6]   0.0   0.0   0
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   0.0   0.0   0.0   (sqrt(3)*L1*cos(z[7])*znew[7])*0.5   znew[8]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)+(L2*cos(z[8])*cos(z[9])*znew[9])*0.5   (L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   0.0   0.0   0.0   -(L1*cos(z[7])*znew[7])*0.5   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[9])*0.5-znew[8]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   0.0   0.0   0.0   L1*sin(z[7])*znew[7]   L2*cos(z[9])*sin(z[8])*znew[8]+L2*cos(z[8])*sin(z[9])*znew[9]   L2*cos(z[8])*sin(z[9])*znew[8]+L2*cos(z[9])*sin(z[8])*znew[9]        
        ]

        dM_dp = [   # Summed together sans_p- and p-term, since p-term was so simple (just a couple of ones)
            1.0   2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0
            2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0
            2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   2*cos(z[2])*sin(z[2])*znew[2]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   1.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   0.0   0
            0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   2*cos(z[5])*sin(z[5])*znew[5]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   1.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)
            0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)   0.0   2*cos(z[8])*sin(z[8])*znew[8]*(J2+L2^2*M3+LC2^2*M2)        
        ]

        dM_dpinvM = [dM_dp[:,1:3]/did.m1   dM_dp[:,4:6]/did.m2   dM_dp[:,7:9]/did.m3]
        dH_dpinvM = [dH_dp[:,1:3]/did.m1   dH_dp[:,4:6]/did.m2   dH_dp[:,7:9]/did.m3]

        orange_term = dH_dpinvM - did.HinvM*dM_dpinvM
        HinvMHT_dp = orange_term*transpose(did.H) + did.HinvM*transpose(dH_dp)

        # dκp = [H*inv(M)*transpose(did.H)]\{orange_term*did.cgBu + H*inv(M)*ddid.cgBu/dp) - [orange_term*transpose(did.H)+H*inv(M)*transpose(dH/dp)] }
        dznew[19:24] = (did.HinvM*transpose(did.H))\(orange_term*did.cgBu + did.HinvM*[    #dz[49:54] =
            # This matrix is ddid.cgBu_p_sansp, p-part it zero for p=J1
            znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))-znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*znew[10]+znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))
            znew[3]*(g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+γ*znew[11]+znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+znew[3]*(g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))+znew[2]*(2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))-znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*znew[13]+znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))
            znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+γ*znew[14]+znew[5]*(sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+znew[6]*(g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))+znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))-znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*znew[16]+znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))
            znew[9]*(g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+γ*znew[17]+znew[8]*(sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))+znew[9]*(g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+znew[8]*(2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] - HinvMHT_dp*z[19:24])

        dMvterm_dp = [
            znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-γ*znew[10]-znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+L1*cos(z[1])*dznew[21]+L1*cos(z[1])*dznew[24]-L1*sin(z[1])*dznew[20]-L1*sin(z[1])*dznew[23]
            L2*cos(z[2])*cos(z[3])*dznew[21]-γ*znew[11]-znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-L2*sin(z[2])*dznew[20]-L2*sin(z[2])*dznew[23]-znew[3]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[2])*cos(z[3])*dznew[24]+L2*cos(z[2])*sin(z[3])*dznew[19]+L2*cos(z[2])*sin(z[3])*dznew[22]+2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            L2*cos(z[3])*sin(z[2])*dznew[19]-znew[3]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))-znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))-znew[2]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[3])*sin(z[2])*dznew[22]-L2*sin(z[2])*sin(z[3])*dznew[21]-L2*sin(z[2])*sin(z[3])*dznew[24]-sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)-2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-γ*znew[13]-znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-L1*cos(z[4])*dznew[21]-(L1*sin(z[4])*dznew[20])*0.5-(sqrt(3)*L1*sin(z[4])*dznew[19])*0.5
            dznew[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dznew[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[5]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-γ*znew[14]-L2*cos(z[5])*cos(z[6])*dznew[21]+2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            (L2*cos(z[6])*sin(z[5])*dznew[19])*0.5-znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[6]*((L2*sin(z[5])*sin(z[6])*dz[19])*0.5-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))-znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+L2*sin(z[5])*sin(z[6])*dznew[21]-sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dznew[20])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)-2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-γ*znew[16]-znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-L1*cos(z[7])*dznew[24]-(L1*sin(z[7])*dznew[23])*0.5+(sqrt(3)*L1*sin(z[7])*dznew[22])*0.5
            dznew[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dznew[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+znew[9]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[8]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-γ*znew[17]-L2*cos(z[8])*cos(z[9])*dznew[24]+2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[8]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-znew[9]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+(L2*cos(z[9])*sin(z[8])*dznew[22])*0.5+L2*sin(z[8])*sin(z[9])*dznew[24]-sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dznew[23])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)-2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ]   # only sans_p-term, partial derivative wrt to J1 is zero

        # dvp = inv(M)*(dMvterm_dp - rp(dM/dp, dv)), rp is my special product
        dznew[10:18] = [did.m1\(dMvterm_dp[1:3,:] - dM_dp[1:3,:]*dz[10:18])
            did.m2\(dMvterm_dp[4:6,:] - dM_dp[4:6,:]*dz[10:18])
            did.m3\(dMvterm_dp[7:9,:] - dM_dp[7:9,:]*dz[10:18])]

        return znew, dznew
    end
end

function get_delta_initial_J2sens(pars::Vector{Float64}, z::Vector{Float64}, dz::Vector{Float64}, did::DeltaInitData)::Tuple{Vector{Float64}, Vector{Float64}}
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]

        znew  = zeros(30)
        dznew = zeros(30)

        # Sensitivity of initial value is zero wrt to J2, so no need to compute it in this case
        # znew[2] = 0.0
        # znew[5] = 0.0
        # znew[8] = 0.0

        ############################# INITIALIZING SENSITIVITY PART ####################################

        # Block matrix product behaviour reminder
        # [a11 a12 a13] [inv(m1) 0 0]   [a11*inv(m1) a12*inv(m2) a13*inv(m3)]
        # [a21 a22 a23]*[0 inv(m2) 0] = [a21*inv(m1) a22*inv(m2) a23*inv(m3)] = [a_1*inv(m1) a_2*inv(m2) a_3*inv(m3)]
        # [a31 a32 a33] [0 0 inv(m3)]   [a31*inv(m1) a32*inv(m2) a33*inv(m3)]
        # and
        # [inv(m1) 0 0] [a11 a12 a13]   [inv(m1)*a11 inv(m2)*a12 inv(m3)*a13]   [inv(m1)*a_1]
        # [0 inv(m2) 0]*[a21 a22 a23] = [inv(m1)*a21 inv(m2)*a22 inv(m3)*a23] = [inv(m2)*a_2]
        # [0 0 inv(m3)] [a31 a32 a33]   [inv(m1)*a31 inv(m2)*a32 inv(m3)*a33]   [inv(m3)*a_3]

        dH_dp = [   # only sans_p-part, partial derivative wrt J1 is zero
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   -(sqrt(3)*L1*cos(z[4])*znew[4])*0.5   (L2*cos(z[5])*cos(z[6])*znew[6])*0.5-znew[5]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)   (L2*cos(z[5])*cos(z[6])*znew[5])*0.5-(L2*sin(z[5])*sin(z[6])*znew[6])*0.5   0.0   0.0   0
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   -(L1*cos(z[4])*znew[4])*0.5   -znew[5]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[6])*0.5   (sqrt(3)*L2*sin(z[5])*sin(z[6])*znew[6])*0.5-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[5])*0.5   0.0   0.0   0
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   L1*sin(z[4])*znew[4]   L2*cos(z[6])*sin(z[5])*znew[5]+L2*cos(z[5])*sin(z[6])*znew[6]   L2*cos(z[5])*sin(z[6])*znew[5]+L2*cos(z[6])*sin(z[5])*znew[6]   0.0   0.0   0
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   0.0   0.0   0.0   (sqrt(3)*L1*cos(z[7])*znew[7])*0.5   znew[8]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)+(L2*cos(z[8])*cos(z[9])*znew[9])*0.5   (L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   0.0   0.0   0.0   -(L1*cos(z[7])*znew[7])*0.5   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[9])*0.5-znew[8]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   0.0   0.0   0.0   L1*sin(z[7])*znew[7]   L2*cos(z[9])*sin(z[8])*znew[8]+L2*cos(z[8])*sin(z[9])*znew[9]   L2*cos(z[8])*sin(z[9])*znew[8]+L2*cos(z[9])*sin(z[8])*znew[9]        
        ]

        dM_dp = [   # Summed together sans_p- and p-term, since p-term was so simple (just a couple of ones)
            1.0   2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0
            2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0
            2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   2*cos(z[2])*sin(z[2])*znew[2]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   1.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   0.0   0
            0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   2*cos(z[5])*sin(z[5])*znew[5]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   1.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)
            0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)   0.0   2*cos(z[8])*sin(z[8])*znew[8]*(J2+L2^2*M3+LC2^2*M2)        
        ] + [ # Mp for p=J2
            0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	1.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	sin(z[2])^2	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	1.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	sin(z[5])^2	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	0.0	1.0	0.0
            0.0	0.0	0.0	0.0	0.0	0.0	0.0	0.0	sin(z[8])^2
        ]

        dM_dpinvM = [dM_dp[:,1:3]/did.m1   dM_dp[:,4:6]/did.m2   dM_dp[:,7:9]/did.m3]
        dH_dpinvM = [dH_dp[:,1:3]/did.m1   dH_dp[:,4:6]/did.m2   dH_dp[:,7:9]/did.m3]

        orange_term = dH_dpinvM - did.HinvM*dM_dpinvM
        HinvMHT_dp = orange_term*transpose(did.H) + did.HinvM*transpose(dH_dp)

        # dκp = [H*inv(M)*transpose(did.H)]\{orange_term*did.cgBu + H*inv(M)*ddid.cgBu/dp) - [orange_term*transpose(did.H)+H*inv(M)*transpose(dH/dp)] }
        dznew[19:24] = (did.HinvM*transpose(did.H))\(orange_term*did.cgBu + did.HinvM*([    #dz[49:54] =
            # cgBu_p_sansp
            znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))-znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*znew[10]+znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))
            znew[3]*(g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+γ*znew[11]+znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+znew[3]*(g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))+znew[2]*(2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))-znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*znew[13]+znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))
            znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+γ*znew[14]+znew[5]*(sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+znew[6]*(g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))+znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))-znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*znew[16]+znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))
            znew[9]*(g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+γ*znew[17]+znew[8]*(sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))+znew[9]*(g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+znew[8]*(2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   # cgBup_p for p=J2
            0.0
            -cos(z[2])*sin(z[2])*z[12]^2
            sin(2*z[2])*z[11]*z[12]
            0.0
            -cos(z[5])*sin(z[5])*z[15]^2
            sin(2*z[5])*z[14]*z[15]
            0.0
            -cos(z[8])*sin(z[8])*z[18]^2
            sin(2*z[8])*z[17]*z[18]
        ]) - HinvMHT_dp*z[19:24])

        dMvterm_dp = [
            znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-γ*znew[10]-znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+L1*cos(z[1])*dznew[21]+L1*cos(z[1])*dznew[24]-L1*sin(z[1])*dznew[20]-L1*sin(z[1])*dznew[23]
            L2*cos(z[2])*cos(z[3])*dznew[21]-γ*znew[11]-znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-L2*sin(z[2])*dznew[20]-L2*sin(z[2])*dznew[23]-znew[3]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[2])*cos(z[3])*dznew[24]+L2*cos(z[2])*sin(z[3])*dznew[19]+L2*cos(z[2])*sin(z[3])*dznew[22]+2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            L2*cos(z[3])*sin(z[2])*dznew[19]-znew[3]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))-znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))-znew[2]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[3])*sin(z[2])*dznew[22]-L2*sin(z[2])*sin(z[3])*dznew[21]-L2*sin(z[2])*sin(z[3])*dznew[24]-sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)-2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-γ*znew[13]-znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-L1*cos(z[4])*dznew[21]-(L1*sin(z[4])*dznew[20])*0.5-(sqrt(3)*L1*sin(z[4])*dznew[19])*0.5
            dznew[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dznew[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[5]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-γ*znew[14]-L2*cos(z[5])*cos(z[6])*dznew[21]+2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            (L2*cos(z[6])*sin(z[5])*dznew[19])*0.5-znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[6]*((L2*sin(z[5])*sin(z[6])*dz[19])*0.5-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))-znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+L2*sin(z[5])*sin(z[6])*dznew[21]-sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dznew[20])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)-2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-γ*znew[16]-znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-L1*cos(z[7])*dznew[24]-(L1*sin(z[7])*dznew[23])*0.5+(sqrt(3)*L1*sin(z[7])*dznew[22])*0.5
            dznew[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dznew[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+znew[9]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[8]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-γ*znew[17]-L2*cos(z[8])*cos(z[9])*dznew[24]+2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[8]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-znew[9]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+(L2*cos(z[9])*sin(z[8])*dznew[22])*0.5+L2*sin(z[8])*sin(z[9])*dznew[24]-sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dznew[23])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)-2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   # Mvterm_p for p=J2
            0.0
            cos(z[2])*sin(z[2])*z[12]^2
            -sin(2*z[2])*z[11]*z[12]
            0.0
            cos(z[5])*sin(z[5])*z[15]^2
            -sin(2*z[5])*z[14]*z[15]
            0.0
            cos(z[8])*sin(z[8])*z[18]^2
            -sin(2*z[8])*z[17]*z[18]
        ]

        # dvp = inv(M)*(dMvterm_dp - rp(dM/dp, dv)), rp is my special product
        dznew[10:18] = [did.m1\(dMvterm_dp[1:3,:] - dM_dp[1:3,:]*dz[10:18])
            did.m2\(dMvterm_dp[4:6,:] - dM_dp[4:6,:]*dz[10:18])
            did.m3\(dMvterm_dp[7:9,:] - dM_dp[7:9,:]*dz[10:18])]

        return znew, dznew
    end
end

function get_delta_initial_γsens(pars::Vector{Float64}, z::Vector{Float64}, dz::Vector{Float64}, did::DeltaInitData)::Tuple{Vector{Float64}, Vector{Float64}}
    let L0 = pars[1], L1 = pars[2], L2 = pars[3], L3 = pars[4], LC1 = pars[5], LC2 = pars[6], M1 = pars[7], M2 = pars[8], M3 = pars[9], J1 = pars[10], J2 = pars[11], g = 0.0, γ = pars[13]
        znew  = zeros(30)
        dznew = zeros(30)

        # Sensitivity of initial value is zero wrt to γ so no need to compute it in this case
        # znew[2] = 0.0
        # znew[5] = 0.0
        # znew[8] = 0.0

        ############################# INITIALIZING SENSITIVITY PART ####################################

        # Block matrix product behaviour reminder
        # [a11 a12 a13] [inv(m1) 0 0]   [a11*inv(m1) a12*inv(m2) a13*inv(m3)]
        # [a21 a22 a23]*[0 inv(m2) 0] = [a21*inv(m1) a22*inv(m2) a23*inv(m3)] = [a_1*inv(m1) a_2*inv(m2) a_3*inv(m3)]
        # [a31 a32 a33] [0 0 inv(m3)]   [a31*inv(m1) a32*inv(m2) a33*inv(m3)]
        # and
        # [inv(m1) 0 0] [a11 a12 a13]   [inv(m1)*a11 inv(m2)*a12 inv(m3)*a13]   [inv(m1)*a_1]
        # [0 inv(m2) 0]*[a21 a22 a23] = [inv(m1)*a21 inv(m2)*a22 inv(m3)*a23] = [inv(m2)*a_2]
        # [0 0 inv(m3)] [a31 a32 a33]   [inv(m1)*a31 inv(m2)*a32 inv(m3)*a33]   [inv(m3)*a_3]

        dH_dp = [    # Hp_sansp
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   -(sqrt(3)*L1*cos(z[4])*znew[4])*0.5   (L2*cos(z[5])*cos(z[6])*znew[6])*0.5-znew[5]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)   (L2*cos(z[5])*cos(z[6])*znew[5])*0.5-(L2*sin(z[5])*sin(z[6])*znew[6])*0.5   0.0   0.0   0
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   -(L1*cos(z[4])*znew[4])*0.5   -znew[5]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[6])*0.5   (sqrt(3)*L2*sin(z[5])*sin(z[6])*znew[6])*0.5-(sqrt(3)*L2*cos(z[5])*cos(z[6])*znew[5])*0.5   0.0   0.0   0
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   L1*sin(z[4])*znew[4]   L2*cos(z[6])*sin(z[5])*znew[5]+L2*cos(z[5])*sin(z[6])*znew[6]   L2*cos(z[5])*sin(z[6])*znew[5]+L2*cos(z[6])*sin(z[5])*znew[6]   0.0   0.0   0
            0.0   L2*cos(z[2])*cos(z[3])*znew[3]-L2*sin(z[2])*sin(z[3])*znew[2]   L2*cos(z[2])*cos(z[3])*znew[2]-L2*sin(z[2])*sin(z[3])*znew[3]   0.0   0.0   0.0   (sqrt(3)*L1*cos(z[7])*znew[7])*0.5   znew[8]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)+(L2*cos(z[8])*cos(z[9])*znew[9])*0.5   (L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*cos(z[1])*znew[1]   -L2*cos(z[2])*znew[2]   0.0   0.0   0.0   0.0   -(L1*cos(z[7])*znew[7])*0.5   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[9])*0.5-znew[8]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)   (sqrt(3)*L2*cos(z[8])*cos(z[9])*znew[8])*0.5-(sqrt(3)*L2*sin(z[8])*sin(z[9])*znew[9])*0.5
            -2*L1*sin(z[1])*znew[1]   -L2*cos(z[3])*sin(z[2])*znew[2]-L2*cos(z[2])*sin(z[3])*znew[3]   -L2*cos(z[2])*sin(z[3])*znew[2]-L2*cos(z[3])*sin(z[2])*znew[3]   0.0   0.0   0.0   L1*sin(z[7])*znew[7]   L2*cos(z[9])*sin(z[8])*znew[8]+L2*cos(z[8])*sin(z[9])*znew[9]   L2*cos(z[8])*sin(z[9])*znew[8]+L2*cos(z[9])*sin(z[8])*znew[9]        
        ] #+ 0.0 = Hp for p=γ
            

        dM_dp = [   # Mp_sansp
            0.0   2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0
            2*L1*znew[1]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[2]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[3]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0.0   0.0   0.0   0
            2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[1]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[3])*sin(z[2])*znew[3]*(L2*M3+LC2*M2)-L1*cos(z[1])*cos(z[2])*sin(z[3])*znew[2]*(L2*M3+LC2*M2)   0.0   2*cos(z[2])*sin(z[2])*znew[2]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   0.0   0
            0.0   0.0   0.0   L1*znew[4]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[5]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[6]*(L2*M3+LC2*M2)   0.0   0.0   0.0   0.0   0
            0.0   0.0   0.0   L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[4]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[6])*sin(z[5])*znew[6]*(L2*M3+LC2*M2)-L1*cos(z[4])*cos(z[5])*sin(z[6])*znew[5]*(L2*M3+LC2*M2)   0.0   2*cos(z[5])*sin(z[5])*znew[5]*(J2+L2^2*M3+LC2^2*M2)   0.0   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)
            0.0   0.0   0.0   0.0   0.0   0.0   L1*znew[7]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[8]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[9]*(L2*M3+LC2*M2)   0.0   0
            0.0   0.0   0.0   0.0   0.0   0.0   L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[7]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[9])*sin(z[8])*znew[9]*(L2*M3+LC2*M2)-L1*cos(z[7])*cos(z[8])*sin(z[9])*znew[8]*(L2*M3+LC2*M2)   0.0   2*cos(z[8])*sin(z[8])*znew[8]*(J2+L2^2*M3+LC2^2*M2)        
        ] # + 0.0 = Mp for p=γ

        dM_dpinvM = [dM_dp[:,1:3]/did.m1   dM_dp[:,4:6]/did.m2   dM_dp[:,7:9]/did.m3]
        dH_dpinvM = [dH_dp[:,1:3]/did.m1   dH_dp[:,4:6]/did.m2   dH_dp[:,7:9]/did.m3]

        orange_term = dH_dpinvM - did.HinvM*dM_dpinvM
        d_HinvMHT_dp = orange_term*transpose(did.H) + did.HinvM*transpose(dH_dp)

        # dκp = [H*inv(M)*transpose(H)]\{orange_term*cgBu + H*inv(M)*dcgBu/dp) - [orange_term*transpose(H)+H*inv(M)*transpose(dH/dp)] }
        dznew[19:24] = (did.HinvM*transpose(did.H))\(orange_term*did.cgBu + did.HinvM*([    #dz[49:54] =
            # cgBu_p_sansp
            znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))-znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+γ*znew[10]+znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))
            znew[3]*(g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+γ*znew[11]+znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))-L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))+znew[3]*(g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))+znew[2]*(2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)+2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))-znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+γ*znew[13]+znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))+znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))
            znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+γ*znew[14]+znew[5]*(sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))-L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+znew[6]*(g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))+znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))+sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)+2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))-znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+γ*znew[16]+znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))+znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))
            znew[9]*(g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+γ*znew[17]+znew[8]*(sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)+2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))-L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))+znew[9]*(g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+znew[8]*(2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))+sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)+2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   #cgBu_p for p=γ
            z[10]
            z[11]
            z[12]
            z[13]
            z[14]
            z[15]
            z[16]
            z[17]
            z[18]               
        ]) - d_HinvMHT_dp*z[19:24])

        dMvterm_dp = [
            znew[12]*(2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[11]*(L2*M3+LC2*M2)+2*L1*cos(z[1])*cos(z[3])*sin(z[2])*z[12]*(L2*M3+LC2*M2))-znew[1]*(g*sin(z[1])*(L1*(M2+M3)+LC1*M1)+L1*cos(z[1])*dz[20]+L1*cos(z[1])*dz[23]+L1*sin(z[1])*dz[21]+L1*sin(z[1])*dz[24]+L1*z[11]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2]))+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[12]^2*(L2*M3+LC2*M2)+2*L1*cos(z[2])*sin(z[1])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-znew[11]*(2*L1*z[11]*(L2*M3+LC2*M2)*(cos(z[2])*sin(z[1])-cos(z[1])*cos(z[3])*sin(z[2]))-2*L1*cos(z[1])*cos(z[2])*sin(z[3])*z[12]*(L2*M3+LC2*M2))+znew[2]*(L1*z[11]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))+L1*cos(z[1])*cos(z[2])*cos(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))-γ*znew[10]-znew[3]*(L1*cos(z[1])*sin(z[2])*sin(z[3])*z[11]^2*(L2*M3+LC2*M2)+L1*cos(z[1])*sin(z[2])*sin(z[3])*z[12]^2*(L2*M3+LC2*M2)-2*L1*cos(z[1])*cos(z[2])*cos(z[3])*z[11]*z[12]*(L2*M3+LC2*M2))+L1*cos(z[1])*dznew[21]+L1*cos(z[1])*dznew[24]-L1*sin(z[1])*dznew[20]-L1*sin(z[1])*dznew[23]
            L2*cos(z[2])*cos(z[3])*dznew[21]-γ*znew[11]-znew[2]*(sin(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)-cos(z[2])^2*z[12]^2*(J2+L2^2*M3+LC2^2*M2)+L2*cos(z[2])*dz[20]+L2*cos(z[2])*dz[23]+L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*z[10]^2*(L2*M3+LC2*M2)*(cos(z[1])*cos(z[2])+cos(z[3])*sin(z[1])*sin(z[2])))-L2*sin(z[2])*dznew[20]-L2*sin(z[2])*dznew[23]-znew[3]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[2])*cos(z[3])*dznew[24]+L2*cos(z[2])*sin(z[3])*dznew[19]+L2*cos(z[2])*sin(z[3])*dznew[22]+2*cos(z[2])*sin(z[2])*znew[12]*z[12]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[10]*z[10]*(L2*M3+LC2*M2)*(cos(z[1])*sin(z[2])-cos(z[2])*cos(z[3])*sin(z[1]))+L1*znew[1]*z[10]^2*(L2*M3+LC2*M2)*(sin(z[1])*sin(z[2])+cos(z[1])*cos(z[2])*cos(z[3]))
            L2*cos(z[3])*sin(z[2])*dznew[19]-znew[3]*(L2*cos(z[3])*sin(z[2])*dz[21]+L2*cos(z[3])*sin(z[2])*dz[24]+L2*sin(z[2])*sin(z[3])*dz[19]+L2*sin(z[2])*sin(z[3])*dz[22]+g*cos(z[3])*sin(z[2])*(L2*M3+LC2*M2)+L1*cos(z[3])*sin(z[1])*sin(z[2])*z[10]^2*(L2*M3+LC2*M2))-znew[12]*(γ+sin(2*z[2])*z[11]*(J2+L2^2*M3+LC2^2*M2))-znew[2]*(L2*cos(z[2])*sin(z[3])*dz[21]-L2*cos(z[2])*cos(z[3])*dz[22]-L2*cos(z[2])*cos(z[3])*dz[19]+L2*cos(z[2])*sin(z[3])*dz[24]+2*cos(2*z[2])*z[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)+g*cos(z[2])*sin(z[3])*(L2*M3+LC2*M2)+L1*cos(z[2])*sin(z[1])*sin(z[3])*z[10]^2*(L2*M3+LC2*M2))+L2*cos(z[3])*sin(z[2])*dznew[22]-L2*sin(z[2])*sin(z[3])*dznew[21]-L2*sin(z[2])*sin(z[3])*dznew[24]-sin(2*z[2])*znew[11]*z[12]*(J2+L2^2*M3+LC2^2*M2)-L1*cos(z[1])*sin(z[2])*sin(z[3])*znew[1]*z[10]^2*(L2*M3+LC2*M2)-2*L1*sin(z[1])*sin(z[2])*sin(z[3])*znew[10]*z[10]*(L2*M3+LC2*M2)
            znew[15]*(2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[14]*(L2*M3+LC2*M2)+2*L1*cos(z[4])*cos(z[6])*sin(z[5])*z[15]*(L2*M3+LC2*M2))-znew[14]*(2*L1*z[14]*(L2*M3+LC2*M2)*(cos(z[5])*sin(z[4])-cos(z[4])*cos(z[6])*sin(z[5]))-2*L1*cos(z[4])*cos(z[5])*sin(z[6])*z[15]*(L2*M3+LC2*M2))+znew[5]*(L1*z[14]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))+L1*cos(z[4])*cos(z[5])*cos(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-znew[4]*(g*sin(z[4])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[4])*dz[20])*0.5-L1*sin(z[4])*dz[21]+(sqrt(3)*L1*cos(z[4])*dz[19])*0.5+L1*z[14]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5]))+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[15]^2*(L2*M3+LC2*M2)+2*L1*cos(z[5])*sin(z[4])*sin(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-γ*znew[13]-znew[6]*(L1*cos(z[4])*sin(z[5])*sin(z[6])*z[14]^2*(L2*M3+LC2*M2)+L1*cos(z[4])*sin(z[5])*sin(z[6])*z[15]^2*(L2*M3+LC2*M2)-2*L1*cos(z[4])*cos(z[5])*cos(z[6])*z[14]*z[15]*(L2*M3+LC2*M2))-L1*cos(z[4])*dznew[21]-(L1*sin(z[4])*dznew[20])*0.5-(sqrt(3)*L1*sin(z[4])*dznew[19])*0.5
            dznew[19]*((L2*cos(z[5])*sin(z[6]))*0.5-(sqrt(3)*L2*sin(z[5]))*0.5)-dznew[20]*((L2*sin(z[5]))*0.5+(sqrt(3)*L2*cos(z[5])*sin(z[6]))*0.5)-znew[6]*(g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[5]*(dz[19]*((sqrt(3)*L2*cos(z[5]))*0.5+(L2*sin(z[5])*sin(z[6]))*0.5)+dz[20]*((L2*cos(z[5]))*0.5-(sqrt(3)*L2*sin(z[5])*sin(z[6]))*0.5)-cos(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[5])^2*z[15]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)+L1*z[13]^2*(L2*M3+LC2*M2)*(cos(z[4])*cos(z[5])+cos(z[6])*sin(z[4])*sin(z[5])))-γ*znew[14]-L2*cos(z[5])*cos(z[6])*dznew[21]+2*cos(z[5])*sin(z[5])*znew[15]*z[15]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[13]*z[13]*(L2*M3+LC2*M2)*(cos(z[4])*sin(z[5])-cos(z[5])*cos(z[6])*sin(z[4]))+L1*znew[4]*z[13]^2*(L2*M3+LC2*M2)*(sin(z[4])*sin(z[5])+cos(z[4])*cos(z[5])*cos(z[6]))
            (L2*cos(z[6])*sin(z[5])*dznew[19])*0.5-znew[5]*(2*cos(2*z[5])*z[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[5])*sin(z[6])*dz[21]-(L2*cos(z[5])*cos(z[6])*dz[19])*0.5+g*cos(z[5])*sin(z[6])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[5])*cos(z[6])*dz[20])*0.5+L1*cos(z[5])*sin(z[4])*sin(z[6])*z[13]^2*(L2*M3+LC2*M2))-znew[6]*((L2*sin(z[5])*sin(z[6])*dz[19])*0.5-L2*cos(z[6])*sin(z[5])*dz[21]+g*cos(z[6])*sin(z[5])*(L2*M3+LC2*M2)-(sqrt(3)*L2*sin(z[5])*sin(z[6])*dz[20])*0.5+L1*cos(z[6])*sin(z[4])*sin(z[5])*z[13]^2*(L2*M3+LC2*M2))-znew[15]*(γ+sin(2*z[5])*z[14]*(J2+L2^2*M3+LC2^2*M2))+L2*sin(z[5])*sin(z[6])*dznew[21]-sin(2*z[5])*znew[14]*z[15]*(J2+L2^2*M3+LC2^2*M2)-(sqrt(3)*L2*cos(z[6])*sin(z[5])*dznew[20])*0.5-L1*cos(z[4])*sin(z[5])*sin(z[6])*znew[4]*z[13]^2*(L2*M3+LC2*M2)-2*L1*sin(z[4])*sin(z[5])*sin(z[6])*znew[13]*z[13]*(L2*M3+LC2*M2)
            znew[18]*(2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[17]*(L2*M3+LC2*M2)+2*L1*cos(z[7])*cos(z[9])*sin(z[8])*z[18]*(L2*M3+LC2*M2))-znew[17]*(2*L1*z[17]*(L2*M3+LC2*M2)*(cos(z[8])*sin(z[7])-cos(z[7])*cos(z[9])*sin(z[8]))-2*L1*cos(z[7])*cos(z[8])*sin(z[9])*z[18]*(L2*M3+LC2*M2))+znew[8]*(L1*z[17]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))+L1*cos(z[7])*cos(z[8])*cos(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-znew[7]*(g*sin(z[7])*(L1*(M2+M3)+LC1*M1)+(L1*cos(z[7])*dz[23])*0.5-L1*sin(z[7])*dz[24]-(sqrt(3)*L1*cos(z[7])*dz[22])*0.5+L1*z[17]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8]))+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[18]^2*(L2*M3+LC2*M2)+2*L1*cos(z[8])*sin(z[7])*sin(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-γ*znew[16]-znew[9]*(L1*cos(z[7])*sin(z[8])*sin(z[9])*z[17]^2*(L2*M3+LC2*M2)+L1*cos(z[7])*sin(z[8])*sin(z[9])*z[18]^2*(L2*M3+LC2*M2)-2*L1*cos(z[7])*cos(z[8])*cos(z[9])*z[17]*z[18]*(L2*M3+LC2*M2))-L1*cos(z[7])*dznew[24]-(L1*sin(z[7])*dznew[23])*0.5+(sqrt(3)*L1*sin(z[7])*dznew[22])*0.5
            dznew[22]*((L2*cos(z[8])*sin(z[9]))*0.5+(sqrt(3)*L2*sin(z[8]))*0.5)-dznew[23]*((L2*sin(z[8]))*0.5-(sqrt(3)*L2*cos(z[8])*sin(z[9]))*0.5)+znew[9]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[8]*(dz[23]*((L2*cos(z[8]))*0.5+(sqrt(3)*L2*sin(z[8])*sin(z[9]))*0.5)-dz[22]*((sqrt(3)*L2*cos(z[8]))*0.5-(L2*sin(z[8])*sin(z[9]))*0.5)-cos(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)+sin(z[8])^2*z[18]^2*(J2+L2^2*M3+LC2^2*M2)-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+L1*z[16]^2*(L2*M3+LC2*M2)*(cos(z[7])*cos(z[8])+cos(z[9])*sin(z[7])*sin(z[8])))-γ*znew[17]-L2*cos(z[8])*cos(z[9])*dznew[24]+2*cos(z[8])*sin(z[8])*znew[18]*z[18]*(J2+L2^2*M3+LC2^2*M2)-2*L1*znew[16]*z[16]*(L2*M3+LC2*M2)*(cos(z[7])*sin(z[8])-cos(z[8])*cos(z[9])*sin(z[7]))+L1*znew[7]*z[16]^2*(L2*M3+LC2*M2)*(sin(z[7])*sin(z[8])+cos(z[7])*cos(z[8])*cos(z[9]))
            znew[8]*((L2*cos(z[8])*cos(z[9])*dz[22])*0.5+L2*cos(z[8])*sin(z[9])*dz[24]-2*cos(2*z[8])*z[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)-g*cos(z[8])*sin(z[9])*(L2*M3+LC2*M2)+(sqrt(3)*L2*cos(z[8])*cos(z[9])*dz[23])*0.5-L1*cos(z[8])*sin(z[7])*sin(z[9])*z[16]^2*(L2*M3+LC2*M2))-znew[18]*(γ+sin(2*z[8])*z[17]*(J2+L2^2*M3+LC2^2*M2))-znew[9]*((L2*sin(z[8])*sin(z[9])*dz[22])*0.5-L2*cos(z[9])*sin(z[8])*dz[24]+g*cos(z[9])*sin(z[8])*(L2*M3+LC2*M2)+(sqrt(3)*L2*sin(z[8])*sin(z[9])*dz[23])*0.5+L1*cos(z[9])*sin(z[7])*sin(z[8])*z[16]^2*(L2*M3+LC2*M2))+(L2*cos(z[9])*sin(z[8])*dznew[22])*0.5+L2*sin(z[8])*sin(z[9])*dznew[24]-sin(2*z[8])*znew[17]*z[18]*(J2+L2^2*M3+LC2^2*M2)+(sqrt(3)*L2*cos(z[9])*sin(z[8])*dznew[23])*0.5-L1*cos(z[7])*sin(z[8])*sin(z[9])*znew[7]*z[16]^2*(L2*M3+LC2*M2)-2*L1*sin(z[7])*sin(z[8])*sin(z[9])*znew[16]*z[16]*(L2*M3+LC2*M2)
        ] + [   # Mvterm_p for p=γ
            -z[10]
            -z[11]
            -z[12]
            -z[13]
            -z[14]
            -z[15]
            -z[16]
            -z[17]
            -z[18]            
        ]

        # dvp = inv(M)*(dMvterm_dp - rp(dM/dp, dv)), rp is my special product
        dznew[10:18] = [did.m1\(dMvterm_dp[1:3,:] - dM_dp[1:3,:]*dz[10:18])
                        did.m2\(dMvterm_dp[4:6,:] - dM_dp[4:6,:]*dz[10:18])
                        did.m3\(dMvterm_dp[7:9,:] - dM_dp[7:9,:]*dz[10:18])]

        return znew, dznew
    end
end

############################### ADJOINT INITIALIZATIONS ################################
# Assumes that initial conditions are independent of the disturbance parameters
function get_pendulum_initial_distsens(kwargs...)::Tuple{Vector{Float64}, Vector{Float64}}
    zeros(7), zeros(7)
end

# TODO: There's difference compred to thesis! 1. Check thesis derivation! 2. Check if changing it here affects performance!
function get_initial_adjoint(dinds::UnitRange{Int64}, ainds::UnitRange{Int64}, gₓT::Matrix{Float64}, dgₓT::Matrix{Float64}, FxT::Matrix{Float64}, FdxT::Matrix{Float64}, dFdxT::Matrix{Float64})::Tuple{Vector{Float64}, Vector{Float64}}
    λT  = zeros(length(dinds)+length(ainds))
    dλT = zeros(length(dinds)+length(ainds))
    temp = (-gₓT)/vcat(FdxT[dinds,:], -FxT[ainds,:])
    # λT[dinds] = zeros(length(dinds))  # Already are zero, so no need to execute this line
    λT[ainds] = temp[ainds]
    dλT[dinds] = temp[dinds]                                                                    # Different compared to pg 92 in thesis!!!!!!!!!!!!!!!!!!!!!!!
    # temp = (-dgₓT + (dλT[dinds]')*(FxT[dinds,:] - dFdxT[dinds,:] - FdxT[dinds,:]) + (λT[ainds]')*FxT[ainds,:])/vcat(FdxT[dinds,:], -FxT[ainds,:])     # How I have had it in all experiments
    temp = (-dgₓT + (dλT[dinds]')*(FxT[dinds,:] - dFdxT[dinds,:] - FdxT[dinds,:]) + (λT[ainds]')*FdxT[ainds,:])/vcat(FdxT[dinds,:], -FxT[ainds,:])      # How it should be according to pg 92 in thesis!
    dλT[ainds] = temp[ainds]
    λT, dλT
end

# This function does a particular improvement, specific for the delta robot, to increase numerical accuracy
function get_initial_adjoint_deltaversion(dinds::UnitRange{Int64}, ainds::UnitRange{Int64}, gₓT::Matrix{Float64}, dgₓT::Matrix{Float64}, FxT::Matrix{Float64}, FdxT::Matrix{Float64}, dFdxT::Matrix{Float64}, xT::Vector{Float64}, yT::Vector{Float64}, T::Float64)::Tuple{Vector{Float64}, Vector{Float64}}
    λT  = zeros(length(dinds)+length(ainds))
    dλT = zeros(length(dinds)+length(ainds))
    # λT[dinds] = zeros(length(dinds))  # Already are zero, so no need to execute this line
    
    # For the delta robot, the values λT[31:33] are trivial to compute analytically from the residual function f!
    # (these values correspond to z[31:33] in the residual function). Because of numerical inaccuracy from the inversion
    # in the computation of the first temp-variable, these values generally don't end up exactly with this values when using
    # the normal function get_initial_adjoint(). For the delta robot, the error is often large enough so that the IDAS
    # solver is not satisfied with the magnitude of the initial residual. IDAS tries to improve this initial value but fails.
    # Using the below analytical expression for λT[31:33] below and then solving only for the remaining λT here significantly
    # reduces the initial residual.
    λT[31:33] = 2(xT[31:33]-yT[1:3])/T  # Easy to obtain analytically straight from adjoin system
    temp = (-gₓT[:,1:30] + (λT[31:33]')*FxT[31:33,1:30])/vcat(FdxT[dinds,1:30], -FxT[19:30,1:30])

    λT[19:30] = temp[19:30]
    dλT[dinds] = temp[dinds]
                                                                    # Different compared to pg 92 in thesis!!!!!!!!!!!!!!!!!!!!!!!
    # temp = (-dgₓT + (dλT[dinds]')*(FxT[dinds,:] - dFdxT[dinds,:] - FdxT[dinds,:]) + (λT[ainds]')*FxT[ainds,:])/vcat(FdxT[dinds,:], -FxT[ainds,:])     # How I have had it in all experiments
    temp = (-dgₓT + (dλT[dinds]')*(FxT[dinds,:] - dFdxT[dinds,:] - FdxT[dinds,:]) + (λT[ainds]')*FdxT[ainds,:])/vcat(FdxT[dinds,:], -FxT[ainds,:])      # How it should be according to pg 92 in thesis!
    dλT[ainds] = temp[ainds]
    λT, dλT
end

function get_initial_adjoint_ODEdist(λT::Vector{Float64}, C::Matrix{Float64}, FwT::Matrix{Float64})::Tuple{Vector{Float64}, Vector{Float64}}
    λwT = (FwT')*λT
    dλxwT = -(λwT')*C
    dλwT = zeros(length(λwT))
    λxwT = zeros(length(dλxwT))
    vcat(λxwT, λwT[:]), vcat(dλxwT[:], dλwT)
end

function get_initial_adjoint_beta(λT::Vector{Float64}, FθT::Matrix{Float64}, gθ::Vector{Float64})::Tuple{Vector{Float64}, Vector{Float64}}
    # dβᵢ = gθ - λᵀFθ
    zeros(length(gθ)), gθ - ((λT')*FθT)[:]
end

function get_initial_adjoint_ODEdistbeta(λxwT::Vector{Float64}, λwT::Vector{Float64}, ad::AdjointSDEApproxData, T::Float64, nw::Int64)::Tuple{Vector{Float64}, Vector{Float64}}
    dβ = zeros(ad.nη)
    # dβᵢ = - λₓᵀ(Ǎηᵢ*xw + B̌ηᵢ*v) - λwᵀČηᵢ
    for ind=1:ad.nη
        Ǎηᵢ = ad.Ǎη[(ind-1)*ad.nxw+1:ind*ad.nxw,:]
        B̌ηᵢ = ad.B̌η[(ind-1)*ad.nxw+1:ind*ad.nxw,:]
        Čηᵢ = ad.Čη[(ind-1)*nw+1:ind*nw,:]
        dβ[ind] = (λxwT')*(Ǎηᵢ*ad.xw(T) + B̌ηᵢ*ad.v(T)) + (λwT')*Čηᵢ*ad.xw(T)
    end
    zeros(ad.nη), dβ
end

# TODO: Old, for scalar case. Delete if new for multivariate case works well
# function get_initial_adjoint_beta_dist(λT::Vector{Float64}, FwT::Matrix{Float64}, wθᵢT::Vector{Float64})::Tuple{Float64, Float64}
#     # Assuming parameter parametrizes ONLY disturbance model, we have:
#     # dβᵢ = - λᵀ(Fw wθᵢ)
#     0.0, - (λT')*FwT*wθᵢT
# end

function get_initial_adjoint_beta_dist(λT::Vector{Float64}, FwT::Matrix{Float64}, wηT::Vector{Float64}, nη::Int64)::Tuple{Vector{Float64}, Vector{Float64}}
    nw = length(wηT)÷nη
    β = zeros(nη)
    dβ = zeros(nη)
    for ind = eachindex(1:nη)
        # Assuming parameter parametrizes ONLY disturbance model, we have:
        # dβᵢ = - λᵀ(Fw wθᵢ)
        dβ[ind] =  - (λT')*FwT*wηT[(ind-1)*nw+1:ind*nw]
    end
    β, dβ
end

end # This is the end of the module clause