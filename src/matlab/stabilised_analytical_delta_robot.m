%% NOMINAL MODEL, PARAMETERS, AND VARIABLES
syms L0 L1 L2 L3 LC1 LC2 M1 M2 M3 J1 J2 g gamma
syms q1(t)  q2(t)  q3(t)  [3,1]
syms dq1(t) dq2(t) dq3(t) [3,1]
syms v1(t)  v2(t)  v3(t)  [3,1]
syms dv1(t) dv2(t) dv3(t) [3,1]
syms k(t) dk(t) [6,1]
syms mu(t) dmu(t) [6, 1]
syms m(f1,f2,f3) [3,3]
syms c(f1,f2,f3,w1,w2,w3) G(f1,f2,f3) [3,1]
syms c1(f1,f2,f3) c2(f1,f2,f3) c3(f1,f2,f3) [3,1]
syms c4(f1,f2,f3) c5(f1,f2,f3) c6(f1,f2,f3) [3,1]
syms tau1_1 tau1_2 tau1_3
syms tau2_1 tau2_2 tau2_3
syms tau3_1 tau3_2 tau3_3
syms dpsi(f1,f2,f3) [3,3]
syms u1(t) u2(t) u3(t)
syms a0 a1

b = [1; 0; 0];
B = blkdiag(b,b,b);
u = [u1(t); u2(t); u3(t)];

q = [q1(t); q2(t); q3(t)];
dq = [dq1(t); dq2(t); dq3(t)];
v = [v1(t); v2(t); v3(t)];
dv = [dv1(t); dv2(t); dv3(t)];
dk = [dk1(t);dk2(t);dk3(t);dk4(t);dk5(t);dk6(t)];
dmu = [dmu1(t);dmu2(t);dmu3(t);dmu4(t);dmu5(t);dmu6(t)];

m1_1(f1,f2,f3) = J1+LC1^2*M1+L1^2*(M2+M3);
m1_2(f1,f2,f3) = L1*(LC2*M2+L2*M3)*(cos(f1)*cos(f2)*cos(f3)+sin(f1)*sin(f2));
m1_3(f1,f2,f3) = -L1*(LC2*M2+L2*M3)*cos(f1)*sin(f2)*sin(f3);
m2_1(f1,f2,f3) = m1_2(f1,f2,f3);
m2_2(f1,f2,f3) = J2+M2*LC2^2+M3*L2^2;
m2_3(f1,f2,f3) = 0;
m3_1(f1,f2,f3) = m1_3(f1,f2,f3);
m3_2(f1,f2,f3) = 0;
m3_3(f1,f2,f3) = (J2+M2*LC2^2+M3*L2^2)*sin(f2)^2;

m(f1,f2,f3) = [m1_1(f1,f2,f3)   m1_2(f1,f2,f3)  m1_3(f1,f2,f3)
               m2_1(f1,f2,f3)   m2_2(f1,f2,f3)  m2_3(f1,f2,f3)
               m3_1(f1,f2,f3)   m3_2(f1,f2,f3)  m3_3(f1,f2,f3)];

M = blkdiag(m(q11(t),q12(t),q13(t)),m(q21(t),q22(t),q23(t)),m(q31(t),q32(t),q33(t)));
           
c11(f1,f2,f3) = 0;
c12(f1,f2,f3) = L1*(LC2*M2+L2*M3)*(cos(f1)*sin(f2) - cos(f2)*cos(f3)*sin(f1));
c13(f1,f2,f3) = L1*(LC2*M2+L2*M3)*sin(f1)*sin(f2)*sin(f3);
c21(f1,f2,f3) = L1*(LC2*M2+L2*M3)*(cos(f2)*sin(f1)-cos(f1)*cos(f3)*sin(f2));
c22(f1,f2,f3) = 0;
c23(f1,f2,f3) = 0;
c31(f1,f2,f3) = -L1*(LC2*M2+L2*M3)*cos(f3)*cos(f1)*sin(f2);
c32(f1,f2,f3) = -(J2+LC2^2*M2+L2^2*M3)*cos(f2)*sin(f2);
c33(f1,f2,f3) = 0;
c41(f1,f2,f3) = 0;
c42(f1,f2,f3) = 0;
c43(f1,f2,f3) = 0;
c51(f1,f2,f3) = -2.0*L1*(LC2*M2+L2*M3)*cos(f1)*cos(f2)*sin(f3);
c52(f1,f2,f3) = 0;
c53(f1,f2,f3) = (J2+LC2^2*M2+L2^2*M3)*sin(2.0*f2);
c61(f1,f2,f3) = 0;
c62(f1,f2,f3) = 0;
c63(f1,f2,f3) = 0;

% TODO: Is this rly right??? Edit: I think so since it works?
c1(f1,f2,f3,w1,w2,w3) = c11(f1,f2,f3)*w1^2 + c21(f1,f2,f3)*w2^2 ...
    + c31(f1,f2,f3)*w3^2 + c41(f1,f2,f3)*w1*w2 + c51(f1,f2,f3)*w2*w3 + c61(f1,f2,f3)*w1*w3;
c2(f1,f2,f3,w1,w2,w3) = c12(f1,f2,f3)*w1^2 + c22(f1,f2,f3)*w2^2 ...
    + c32(f1,f2,f3)*w3^2 + c42(f1,f2,f3)*w1*w2 + c52(f1,f2,f3)*w2*w3 + c62(f1,f2,f3)*w1*w3;
c3(f1,f2,f3,w1,w2,w3) = c13(f1,f2,f3)*w1^2 + c23(f1,f2,f3)*w2^2 ...
    + c33(f1,f2,f3)*w3^2 + c43(f1,f2,f3)*w1*w2 + c53(f1,f2,f3)*w2*w3 + c63(f1,f2,f3)*w1*w3;

c(f1,f2,f3,w1,w2,w3) = [c1(f1,f2,f3,w1,w2,w3); c2(f1,f2,f3,w1,w2,w3); c3(f1,f2,f3,w1,w2,w3)];
C = [c(q11(t),q12(t),q13(t),v11(t),v12(t),v13(t))
     c(q21(t),q22(t),q23(t),v21(t),v22(t),v23(t))
     c(q31(t),q32(t),q33(t),v31(t),v32(t),v33(t))];

g1(f1,f2,f3) = -g*(LC1*M1+L1*(M2+M3))*cos(f1);
g2(f1,f2,f3) = -g*(LC2*M2+L2*M3)*cos(f2)*cos(f3);
g3(f1,f2,f3) =  g*(LC2*M2+L2*M3)*sin(f2)*sin(f3);

gvec(f1,f2,f3) = [g1(f1,f2,f3); g2(f1,f2,f3); g3(f1,f2,f3)];
G = [gvec(q11(t),q12(t),q13(t))
     gvec(q21(t),q22(t),q23(t))
     gvec(q31(t),q32(t),q33(t))];
 
dG = diff(G,t);
dG = subs(dG, {diff(q11(t),t),diff(q12(t),t),diff(q13(t),t),...
    diff(q21(t),t),diff(q22(t),t),diff(q23(t),t),...
    diff(q31(t),t),diff(q32(t),t),diff(q33(t),t)},...
    {dq11(t),dq12(t),dq13(t),dq21(t),dq22(t),dq23(t),dq31(t),dq32(t),dq33(t)});

dpsi1_1(f1,f2,f3) = 0;
dpsi1_2(f1,f2,f3) = L2*cos(f2)*sin(f3);
dpsi1_3(f1,f2,f3) = L2*sin(f2)*cos(f3);
dpsi2_1(f1,f2,f3) =-L1*sin(f1);
dpsi2_2(f1,f2,f3) =-L2*sin(f2);
dpsi2_3(f1,f2,f3) = 0;
dpsi3_1(f1,f2,f3) = L1*cos(f1);
dpsi3_2(f1,f2,f3) = L2*cos(f2)*cos(f3);
dpsi3_3(f1,f2,f3) =-L2*sin(f2)*sin(f3);

R1 = sym([  -1/2   -sqrt(3)/2   0
          sqrt(3)/2   -1/2      0
              0         0       1]);

R2 = sym([  -1/2   sqrt(3)/2   0
        -sqrt(3)/2   -1/2      0
             0         0       1]);

psi1mat =[dpsi1_1(q11(t),q12(t),q13(t))  dpsi1_2(q11(t),q12(t),q13(t))   dpsi1_3(q11(t),q12(t),q13(t))
          dpsi2_1(q11(t),q12(t),q13(t))  dpsi2_2(q11(t),q12(t),q13(t))   dpsi2_3(q11(t),q12(t),q13(t))
          dpsi3_1(q11(t),q12(t),q13(t))  dpsi3_2(q11(t),q12(t),q13(t))   dpsi3_3(q11(t),q12(t),q13(t))];

psi2mat =[dpsi1_1(q21(t),q22(t),q23(t))  dpsi1_2(q21(t),q22(t),q23(t))   dpsi1_3(q21(t),q22(t),q23(t))
          dpsi2_1(q21(t),q22(t),q23(t))  dpsi2_2(q21(t),q22(t),q23(t))   dpsi2_3(q21(t),q22(t),q23(t))
          dpsi3_1(q21(t),q22(t),q23(t))  dpsi3_2(q21(t),q22(t),q23(t))   dpsi3_3(q21(t),q22(t),q23(t))];
      
psi3mat =[dpsi1_1(q31(t),q32(t),q33(t))  dpsi1_2(q31(t),q32(t),q33(t))   dpsi1_3(q31(t),q32(t),q33(t))
          dpsi2_1(q31(t),q32(t),q33(t))  dpsi2_2(q31(t),q32(t),q33(t))   dpsi2_3(q31(t),q32(t),q33(t))
          dpsi3_1(q31(t),q32(t),q33(t))  dpsi3_2(q31(t),q32(t),q33(t))   dpsi3_3(q31(t),q32(t),q33(t))];

psi(f1,f2,f3) = [L2*sin(f2)*sin(f3)
                 L1*cos(f1) + L2*cos(f2) + L0 - L3
                 L1*sin(f1) + L2*sin(f2)*cos(f3)];
h = [psi(q11(t),q12(t),q13(t)) - R1*psi(q21(t),q22(t),q23(t))
     psi(q11(t),q12(t),q13(t)) - R2*psi(q31(t),q32(t),q33(t))];
 
dh = diff(h, t);
% Replacing derivatives of q with corresponding v gives the correct form
% for the last block of equations of the stabilised system
dh = subs(dh, {diff(q11(t),t),diff(q12(t),t),diff(q13(t),t),...
    diff(q21(t),t),diff(q22(t),t),diff(q23(t),t),...
    diff(q31(t),t),diff(q32(t),t),diff(q33(t),t)},...
    {v11(t),v12(t),v13(t),v21(t),v22(t),v23(t),v31(t),v32(t),v33(t)});
 
H = [psi1mat    -R1*psi2mat     zeros(3,3)
     psi1mat    zeros(3,3)      -R2*psi3mat];
  
% ------------------------- Index reduction -------------------------------

F = [   dq - v + transpose(H)*dmu
        M*dv + C + G - B*u + gamma*v - transpose(H)*dk
        h
        dh
    ];

Mvterm = transpose(H)*dk - C - gamma*v - G + B*u;
cgBu   = C + gamma*v + G - B*u;

fileID = fopen('F.txt', 'w'); fprintf(fileID, char(F)); fclose(fileID);
fileID = fopen('Mvterm.txt', 'w'); fprintf(fileID, char(Mvterm)); fclose(fileID);
fileID = fopen('cgBu.txt', 'w'); fprintf(fileID, char(cgBu)); fclose(fileID);

% I think we only need the F equations, and then steal initialisation from
% non-stabiilsed index-1 implementation, should be the same (kappa should
% probably be initialised to zero in this case here)

%% FORWARD SENSITIVITY MODEL
syms s1(t) s2(t) s3(t) [3,1]
syms ds1(t) ds2(t) ds3(t) [3,1]
syms r1(t) r2(t) r3(t) [3,1]
syms dr1(t) dr2(t) dr3(t) [3,1]
syms l(t) dl(t) [6,1]   % Here I let l denote the sensitivity of k
syms nu(t) dnu(t) [6,1] % Here I let nu denote the sensitivity of mu
syms w1(p) w2(p) w3(p)


xp = [s1(t); s2(t); s3(t); r1(t); r2(t); r3(t); l(t); nu(t)];
dxp = [ds1(t); ds2(t); ds3(t); dr1(t); dr2(t); dr3(t); dl(t); dnu(t)];

Fx = [diff(F,q11(t)) diff(F,q12(t)) diff(F,q13(t)) ...
       diff(F,q21(t)) diff(F,q22(t)) diff(F,q23(t)) ...
       diff(F,q31(t)) diff(F,q32(t)) diff(F,q33(t)) ...
       diff(F,v11(t)) diff(F,v12(t)) diff(F,v13(t)) ...
       diff(F,v21(t)) diff(F,v22(t)) diff(F,v23(t)) ...
       diff(F,v31(t)) diff(F,v32(t)) diff(F,v33(t)) ...
       diff(F, k1(t)) diff(F, k2(t)) diff(F, k3(t)) ...
       diff(F, k4(t)) diff(F, k5(t)) diff(F, k6(t)) ...
       diff(F, mu1(t)) diff(F, mu2(t)) diff(F, mu3(t)) ...
       diff(F, mu4(t)) diff(F, mu5(t)) diff(F, mu6(t))];

Fdx = [diff(F,dq11(t)) diff(F,dq12(t)) diff(F,dq13(t)) ...
        diff(F,dq21(t)) diff(F,dq22(t)) diff(F,dq23(t)) ...
        diff(F,dq31(t)) diff(F,dq32(t)) diff(F,dq33(t)) ...
        diff(F,dv11(t)) diff(F,dv12(t)) diff(F,dv13(t)) ...
        diff(F,dv21(t)) diff(F,dv22(t)) diff(F,dv23(t)) ...
        diff(F,dv31(t)) diff(F,dv32(t)) diff(F,dv33(t)) ...
        diff(F, dk1(t)) diff(F, dk2(t)) diff(F, dk3(t)) ...
        diff(F, dk4(t)) diff(F, dk5(t)) diff(F, dk6(t)) ...
        diff(F, dmu1(t)) diff(F, dmu2(t)) diff(F, dmu3(t)) ...
        diff(F, dmu4(t)) diff(F, dmu5(t)) diff(F, dmu6(t))];
    
Fp = [diff(F,L0) diff(F,L1) diff(F,L2) diff(F,L3) diff(F,LC1) diff(F,LC2)...
       diff(F,M1) diff(F,M2) diff(F,M3) diff(F,J1) diff(F,J2) diff(F,g)...
       diff(F,gamma)];
   
Fp_sansp = Fx*xp + Fdx*dxp;

Fnoise = subs(F, u1(t),u1(t)+w1(p)^2); 
Fnoise = subs(Fnoise, u2(t),u2(t)+w2(p)^2); 
Fnoise = subs(Fnoise, u3(t),u3(t)+w3(p)^2);
Fw = diff(Fnoise, p);



fileID = fopen('Fp_sansp.txt', 'w'); fprintf(fileID, char(Fp_sansp)); fclose(fileID);
fileID = fopen('Fp.txt', 'w'); fprintf(fileID, char(Fp)); fclose(fileID);
fileID = fopen('Fw.txt', 'w'); fprintf(fileID, char(Fw)); fclose(fileID);

%% INITIALIZATION OF FORWARD SENSITIVITY MODEL

% Hp_sansp = diff(H,q11(t))*s11(t) + diff(H,q11(t))*s11(t) + ...
%     diff(H,q12(t))*s12(t) + diff(H,q13(t))*s13(t) + diff(H,q21(t))*s21(t) + ...
%     diff(H,q22(t))*s22(t) + diff(H,q23(t))*s23(t) + diff(H,q31(t))*s31(t) + ...
%     diff(H,q32(t))*s32(t) + diff(H,q33(t))*s33(t) + diff(H,v11(t))*r11(t) + ...
%     diff(H,v12(t))*r12(t) + diff(H,v13(t))*r13(t) + diff(H,v21(t))*r21(t) + ...
%     diff(H,v22(t))*r22(t) + diff(H,v23(t))*r23(t) + diff(H,v31(t))*r31(t) + ...
%     diff(H,v32(t))*r32(t) + diff(H,v33(t))*r33(t) + ...
%     diff(H,dq11(t))*ds11(t) + diff(H,dq11(t))*ds11(t) + ...
%     diff(H,dq12(t))*ds12(t) + diff(H,dq13(t))*ds13(t) + diff(H,dq21(t))*ds21(t) + ...
%     diff(H,dq22(t))*ds22(t) + diff(H,dq23(t))*ds23(t) + diff(H,dq31(t))*ds31(t) + ...
%     diff(H,dq32(t))*ds32(t) + diff(H,dq33(t))*ds33(t) + diff(H,dv11(t))*dr11(t) + ...
%     diff(H,dv12(t))*dr12(t) + diff(H,dv13(t))*dr13(t) + diff(H,dv21(t))*dr21(t) + ...
%     diff(H,dv22(t))*dr22(t) + diff(H,dv23(t))*dr23(t) + diff(H,dv31(t))*dr31(t) + ...
%     diff(H,dv32(t))*dr32(t) + diff(H,dv33(t))*dr33(t);
% 
% Hp = [diff(H,L0) diff(H,L1) diff(H,L2) diff(H,L3) diff(H,LC1) diff(H,LC2)...
%       diff(H,M1) diff(H,M2) diff(H,M3) diff(H,J1) diff(H,J2) diff(H,g)...
%       diff(H,gamma)];

Mvterm_x = [diff(Mvterm,q11(t)) diff(Mvterm,q12(t)) diff(Mvterm,q13(t)) ...
           diff(Mvterm,q21(t)) diff(Mvterm,q22(t)) diff(Mvterm,q23(t)) ...
           diff(Mvterm,q31(t)) diff(Mvterm,q32(t)) diff(Mvterm,q33(t)) ...
           diff(Mvterm,v11(t)) diff(Mvterm,v12(t)) diff(Mvterm,v13(t)) ...
           diff(Mvterm,v21(t)) diff(Mvterm,v22(t)) diff(Mvterm,v23(t)) ...
           diff(Mvterm,v31(t)) diff(Mvterm,v32(t)) diff(Mvterm,v33(t)) ...
           diff(Mvterm,k1(t)) diff(Mvterm,k2(t)) diff(Mvterm,k3(t)) ...
           diff(Mvterm,k4(t)) diff(Mvterm,k5(t)) diff(Mvterm,k6(t)) ...
           diff(Mvterm,mu1(t)) diff(Mvterm,mu2(t)) diff(Mvterm,mu3(t)) ...
           diff(Mvterm,mu4(t)) diff(Mvterm,mu5(t)) diff(Mvterm,mu6(t))];
       
Mvterm_dx = [diff(Mvterm,dq11(t)) diff(Mvterm,dq12(t)) diff(Mvterm,dq13(t)) ...
            diff(Mvterm,dq21(t)) diff(Mvterm,dq22(t)) diff(Mvterm,dq23(t)) ...
            diff(Mvterm,dq31(t)) diff(Mvterm,dq32(t)) diff(Mvterm,dq33(t)) ...
            diff(Mvterm,dv11(t)) diff(Mvterm,dv12(t)) diff(Mvterm,dv13(t)) ...
            diff(Mvterm,dv21(t)) diff(Mvterm,dv22(t)) diff(Mvterm,dv23(t)) ...
            diff(Mvterm,dv31(t)) diff(Mvterm,dv32(t)) diff(Mvterm,dv33(t)) ...
            diff(Mvterm,dk1(t)) diff(Mvterm,dk2(t)) diff(Mvterm,dk3(t)) ...
            diff(Mvterm,dk4(t)) diff(Mvterm,dk5(t)) diff(Mvterm,dk6(t)) ...
            diff(Mvterm,dmu1(t)) diff(Mvterm,dmu2(t)) diff(Mvterm,dmu3(t)) ...
            diff(Mvterm,dmu4(t)) diff(Mvterm,dmu5(t)) diff(Mvterm,dmu6(t))];
    
Mvterm_p = [diff(Mvterm,L0) diff(Mvterm,L1) diff(Mvterm,L2) diff(Mvterm,L3)...
           diff(Mvterm,LC1) diff(Mvterm,LC2) diff(Mvterm,M1) diff(Mvterm,M2)...
           diff(Mvterm,M3) diff(Mvterm,J1) diff(Mvterm,J2) diff(Mvterm,g)...
           diff(Mvterm,gamma)];

Mvterm_p_sansp = Mvterm_x*xp + Mvterm_dx*dxp;

cgBu_x = [diff(cgBu,q11(t)) diff(cgBu,q12(t)) diff(cgBu,q13(t)) ...
          diff(cgBu,q21(t)) diff(cgBu,q22(t)) diff(cgBu,q23(t)) ...
          diff(cgBu,q31(t)) diff(cgBu,q32(t)) diff(cgBu,q33(t)) ...
          diff(cgBu,v11(t)) diff(cgBu,v12(t)) diff(cgBu,v13(t)) ...
          diff(cgBu,v21(t)) diff(cgBu,v22(t)) diff(cgBu,v23(t)) ...
          diff(cgBu,v31(t)) diff(cgBu,v32(t)) diff(cgBu,v33(t)) ...
          diff(cgBu,k1(t)) diff(cgBu,k2(t)) diff(cgBu,k3(t)) ...
          diff(cgBu,k4(t)) diff(cgBu,k5(t)) diff(cgBu,k6(t)) ...
          diff(cgBu,mu1(t)) diff(cgBu,mu2(t)) diff(cgBu,mu3(t)) ...
          diff(cgBu,mu4(t)) diff(cgBu,mu5(t)) diff(cgBu,mu6(t))];
       
cgBu_dx = [diff(cgBu,dq11(t)) diff(cgBu,dq12(t)) diff(cgBu,dq13(t)) ...
           diff(cgBu,dq21(t)) diff(cgBu,dq22(t)) diff(cgBu,dq23(t)) ...
           diff(cgBu,dq31(t)) diff(cgBu,dq32(t)) diff(cgBu,dq33(t)) ...
           diff(cgBu,dv11(t)) diff(cgBu,dv12(t)) diff(cgBu,dv13(t)) ...
           diff(cgBu,dv21(t)) diff(cgBu,dv22(t)) diff(cgBu,dv23(t)) ...
           diff(cgBu,dv31(t)) diff(cgBu,dv32(t)) diff(cgBu,dv33(t)) ...
           diff(cgBu,dk1(t)) diff(cgBu,dk2(t)) diff(cgBu,dk3(t)) ...
           diff(cgBu,dk4(t)) diff(cgBu,dk5(t)) diff(cgBu,dk6(t)) ...
           diff(cgBu,dmu1(t)) diff(cgBu,dmu2(t)) diff(cgBu,dmu3(t)) ...
           diff(cgBu,dmu4(t)) diff(cgBu,dmu5(t)) diff(cgBu,dmu6(t))];
    
cgBu_p = [diff(cgBu,L0) diff(cgBu,L1) diff(cgBu,L2) diff(cgBu,L3)...
          diff(cgBu,LC1) diff(cgBu,LC2) diff(cgBu,M1) diff(cgBu,M2)...
          diff(cgBu,M3) diff(cgBu,J1) diff(cgBu,J2) diff(cgBu,g)...
          diff(cgBu,gamma)];

cgBu_p_sansp = cgBu_x*xp + cgBu_dx*dxp;

% Okay my new idea is that we actually only need C:
c_x = [diff(C,q11(t)) diff(C,q12(t)) diff(C,q13(t)) ...
          diff(C,q21(t)) diff(C,q22(t)) diff(C,q23(t)) ...
          diff(C,q31(t)) diff(C,q32(t)) diff(C,q33(t)) ...
          diff(C,v11(t)) diff(C,v12(t)) diff(C,v13(t)) ...
          diff(C,v21(t)) diff(C,v22(t)) diff(C,v23(t)) ...
          diff(C,v31(t)) diff(C,v32(t)) diff(C,v33(t)) ...
          diff(C,k1(t)) diff(C,k2(t)) diff(C,k3(t)) ...
          diff(C,k4(t)) diff(C,k5(t)) diff(C,k6(t)) ...
          diff(C,mu1(t)) diff(C,mu2(t)) diff(C,mu3(t)) ...
          diff(C,mu4(t)) diff(C,mu5(t)) diff(C,mu6(t))];
       
c_dx = [diff(C,dq11(t)) diff(C,dq12(t)) diff(C,dq13(t)) ...
           diff(C,dq21(t)) diff(C,dq22(t)) diff(C,dq23(t)) ...
           diff(C,dq31(t)) diff(C,dq32(t)) diff(C,dq33(t)) ...
           diff(C,dv11(t)) diff(C,dv12(t)) diff(C,dv13(t)) ...
           diff(C,dv21(t)) diff(C,dv22(t)) diff(C,dv23(t)) ...
           diff(C,dv31(t)) diff(C,dv32(t)) diff(C,dv33(t)) ...
           diff(C,dk1(t)) diff(C,dk2(t)) diff(C,dk3(t)) ...
           diff(C,dk4(t)) diff(C,dk5(t)) diff(C,dk6(t)) ...
           diff(C,dmu1(t)) diff(C,dmu2(t)) diff(C,dmu3(t)) ...
           diff(C,dmu4(t)) diff(C,dmu5(t)) diff(C,dmu6(t))];
       
c_p = [diff(C,L0) diff(C,L1) diff(C,L2) diff(C,L3)...
          diff(C,LC1) diff(C,LC2) diff(C,M1) diff(C,M2)...
          diff(C,M3) diff(C,J1) diff(C,J2) diff(C,g)...
          diff(C,gamma)];
       
c_p_sansp = c_x*xp + c_dx*dxp;
       
% -------------------------------------

Mp_sansp = diff(M,q11(t))*s11(t) + diff(M,q11(t))*s11(t) + ...
    diff(M,q12(t))*s12(t) + diff(M,q13(t))*s13(t) + diff(M,q21(t))*s21(t) + ...
    diff(M,q22(t))*s22(t) + diff(M,q23(t))*s23(t) + diff(M,q31(t))*s31(t) + ...
    diff(M,q32(t))*s32(t) + diff(M,q33(t))*s33(t) + diff(M,v11(t))*r11(t) + ...
    diff(M,v12(t))*r12(t) + diff(M,v13(t))*r13(t) + diff(M,v21(t))*r21(t) + ...
    diff(M,v22(t))*r22(t) + diff(M,v23(t))*r23(t) + diff(M,v31(t))*r31(t) + ...
    diff(M,v32(t))*r32(t) + diff(M,v33(t))*r33(t) + ...
    diff(M,dq11(t))*ds11(t) + diff(M,dq11(t))*ds11(t) + ...
    diff(M,dq12(t))*ds12(t) + diff(M,dq13(t))*ds13(t) + diff(M,dq21(t))*ds21(t) + ...
    diff(M,dq22(t))*ds22(t) + diff(M,dq23(t))*ds23(t) + diff(M,dq31(t))*ds31(t) + ...
    diff(M,dq32(t))*ds32(t) + diff(M,dq33(t))*ds33(t) + diff(M,dv11(t))*dr11(t) + ...
    diff(M,dv12(t))*dr12(t) + diff(M,dv13(t))*dr13(t) + diff(M,dv21(t))*dr21(t) + ...
    diff(M,dv22(t))*dr22(t) + diff(M,dv23(t))*dr23(t) + diff(M,dv31(t))*dr31(t) + ...
    diff(M,dv32(t))*dr32(t) + diff(M,dv33(t))*dr33(t);

Mp = [diff(M,L0) diff(M,L1) diff(M,L2) diff(M,L3) diff(M,LC1) diff(M,LC2)...
      diff(M,M1) diff(M,M2) diff(M,M3) diff(M,J1) diff(M,J2) diff(M,g)...
      diff(M,gamma)];
  
Hp_sansp = diff(H,q11(t))*s11(t) + diff(H,q11(t))*s11(t) + ...
    diff(H,q12(t))*s12(t) + diff(H,q13(t))*s13(t) + diff(H,q21(t))*s21(t) + ...
    diff(H,q22(t))*s22(t) + diff(H,q23(t))*s23(t) + diff(H,q31(t))*s31(t) + ...
    diff(H,q32(t))*s32(t) + diff(H,q33(t))*s33(t) + diff(H,v11(t))*r11(t) + ...
    diff(H,v12(t))*r12(t) + diff(H,v13(t))*r13(t) + diff(H,v21(t))*r21(t) + ...
    diff(H,v22(t))*r22(t) + diff(H,v23(t))*r23(t) + diff(H,v31(t))*r31(t) + ...
    diff(H,v32(t))*r32(t) + diff(H,v33(t))*r33(t) + ...
    diff(H,dq11(t))*ds11(t) + diff(H,dq11(t))*ds11(t) + ...
    diff(H,dq12(t))*ds12(t) + diff(H,dq13(t))*ds13(t) + diff(H,dq21(t))*ds21(t) + ...
    diff(H,dq22(t))*ds22(t) + diff(H,dq23(t))*ds23(t) + diff(H,dq31(t))*ds31(t) + ...
    diff(H,dq32(t))*ds32(t) + diff(H,dq33(t))*ds33(t) + diff(H,dv11(t))*dr11(t) + ...
    diff(H,dv12(t))*dr12(t) + diff(H,dv13(t))*dr13(t) + diff(H,dv21(t))*dr21(t) + ...
    diff(H,dv22(t))*dr22(t) + diff(H,dv23(t))*dr23(t) + diff(H,dv31(t))*dr31(t) + ...
    diff(H,dv32(t))*dr32(t) + diff(H,dv33(t))*dr33(t);

Hp = [diff(H,L0) diff(H,L1) diff(H,L2) diff(H,L3) diff(H,LC1) diff(H,LC2)...
      diff(H,M1) diff(H,M2) diff(H,M3) diff(H,J1) diff(H,J2) diff(H,g)...
      diff(H,gamma)];

fileID = fopen('Mvterm_p.txt', 'w'); fprintf(fileID, char(Mvterm_p)); fclose(fileID);
fileID = fopen('Mvterm_p_sansp.txt', 'w'); fprintf(fileID, char(Mvterm_p_sansp)); fclose(fileID);
fileID = fopen('cgBu_p.txt', 'w'); fprintf(fileID, char(cgBu_p)); fclose(fileID);
fileID = fopen('cgBu_p_sansp.txt', 'w'); fprintf(fileID, char(cgBu_p_sansp)); fclose(fileID);
fileID = fopen('c_p.txt', 'w'); fprintf(fileID, char(cgBu_p)); fclose(fileID);
fileID = fopen('c_p_sansp.txt', 'w'); fprintf(fileID, char(cgBu_p_sansp)); fclose(fileID);
fileID = fopen('Mp.txt', 'w'); fprintf(fileID, char(Mp)); fclose(fileID);
fileID = fopen('Mp_sansp.txt', 'w'); fprintf(fileID, char(Mp_sansp)); fclose(fileID);
fileID = fopen('Hp.txt', 'w'); fprintf(fileID, char(Hp)); fclose(fileID);
fileID = fopen('Hp_sansp.txt', 'w'); fprintf(fileID, char(Hp_sansp)); fclose(fileID);

%% OUTPUT EQUATION OF FORWARD SENSITIVITY MODEL

psi(f1,f2,f3) = [L2*sin(f2)*sin(f3)
                 L1*cos(f1) + L2*cos(f2) + L0 - L3
                 L1*sin(f1) + L2*sin(f2)*cos(f3)];
% Taking the output as function of angles of first arm
my_psi = psi(q11(t), q12(t), q13(t));
my_psi_q = [diff(my_psi, q11(t)) diff(my_psi, q12(t)) diff(my_psi, q13(t))];
my_psi_p = [diff(my_psi,L0) diff(my_psi,L1) diff(my_psi,L2) diff(my_psi,L3)...
           diff(my_psi,LC1) diff(my_psi,LC2) diff(my_psi,M1) diff(my_psi,M2)...
           diff(my_psi,M3) diff(my_psi,J1) diff(my_psi,J2) diff(my_psi,g)...
           diff(my_psi,gamma)];
my_psi_p_sans_p = my_psi_q*[s11(t); s12(t); s13(t)];

fileID = fopen('my_psi_p_sans_p.txt', 'w'); fprintf(fileID, char(my_psi_p_sans_p)); fclose(fileID);
fileID = fopen('my_psi_p.txt', 'w'); fprintf(fileID, char(my_psi_p)); fclose(fileID);

% %% L1 debugging
% 
% out_dt = diff(my_psi, t);
% out_dt = subs(out_dt, {diff(q11(t),t),diff(q12(t),t),diff(q13(t),t),...
%     diff(q21(t),t),diff(q22(t),t),diff(q23(t),t),...
%     diff(q31(t),t),diff(q32(t),t),diff(q33(t),t)},...
%     {v11(t),v12(t),v13(t),v21(t),v22(t),v23(t),v31(t),v32(t),v33(t)});
% outsens = my_psi_p_sans_p + diff(my_psi, L1);
% outsens_dt = diff(outsens, t);
% outsens_dt = subs(outsens_dt, {diff(q11(t),t),diff(q12(t),t),diff(q13(t),t),...
%     diff(q21(t),t),diff(q22(t),t),diff(q23(t),t),...
%     diff(q31(t),t),diff(q32(t),t),diff(q33(t),t)},...
%     {v11(t),v12(t),v13(t),v21(t),v22(t),v23(t),v31(t),v32(t),v33(t)});
% % We replace derivative of s with ds. Should we replace with r instead?
% % REPLACE WITH r, WE DON't HAVE ACCESS TO ds!!!
% outsens_dt = subs(outsens_dt, {diff(s11(t),t),diff(s12(t),t),diff(s13(t),t),...
%     diff(s21(t),t),diff(s22(t),t),diff(s23(t),t),...
%     diff(s31(t),t),diff(s32(t),t),diff(s33(t),t), diff(r11(t),t),diff(r12(t),t),diff(r13(t),t),...
%     diff(r21(t),t),diff(r22(t),t),diff(r23(t),t),...
%     diff(r31(t),t),diff(r32(t),t),diff(r33(t),t)},...
%     {r11(t),r12(t),r13(t),r21(t),r22(t),r23(t),r31(t),r32(t),r33(t),...
%     dr11(t),dr12(t),dr13(t),dr21(t),dr22(t),dr23(t),dr31(t),dr32(t),dr33(t)});
% 
% fileID = fopen('deb_out_dt.txt', 'w'); fprintf(fileID, char(out_dt)); fclose(fileID);
% fileID = fopen('deb_outsens_dt.txt', 'w'); fprintf(fileID, char(outsens_dt)); fclose(fileID);
